using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Data.SqlClient;
using System.Data;
using System.Net.Mail;
using System.Net;
using System.IO;
using System.Net.Mime;
using System.Transactions;
using System.Configuration;
//using System.Web.Mail;

namespace WinningLifeInternational.Model
{
    public class Register
    {
        public int GoSN;
        public int startSN;
        public int stopSN;
        public int trailer = 0;
        public string CompName1;
        public string CompID1;
        public string CompName2;
        public string CompID2;
        public string CompName3;
        public string CompID3;
        public string CompName4;
        public string CompID4;
        public string CompRank0;
        public string CompRank1;
        public string CompRank2;
        public string CompRank3;
        public string CompRank4;
        private int newbalance = 0;
        private int countRef = 0;
        public string getuserid;
        public string getusername;
        public string getrank;
        public string Checker;
        public double Silver1;
        public double Silver1_1;
        public double Silver1_2;
        public double Silver1_3;
        public double Silver1_4;
        public double Silver1_5;
        public double Silver1_6;
        public double Silver1_7;
        public double Silver1_8;
        public double Silver1_9;
        public double Silver1_10;
        public double Silver1_11;
        public double Silver1_12;
        public double Silver1_13;
        public double Silver1_14;
        public double Silver1_15;
        public double Silver1_16;
        public double Silver2;
        public double Silver2_1;
        public double Silver2_2;
        public double Silver2_3;
        public double Silver2_4;
        public double Silver2_5;
        public double Silver2_6;
        public double Silver2_7;
        public double Silver2_8;
        public double Silver2_9;
        public double Silver2_10;
        public double Silver2_11;
        public double Silver2_12;
        public double Silver2_13;
        public double Silver2_14;
        public double Silver2_15;
        public double Silver2_16;
        public double Gold1;
        public double Gold1_1;
        public double Gold1_2;
        public double Gold1_3;
        public double Gold1_4;
        public double Gold1_5;
        public double Gold1_6;
        public double Gold1_7;
        public double Gold1_8;
        public double Gold1_9;
        public double Gold1_10;
        public double Gold1_11;
        public double Gold1_12;
        public double Gold1_13;
        public double Gold1_14;
        public double Gold1_15;
        public double Gold1_16;
        public double Gold2;
        public double Gold2_1;
        public double Gold2_2;
        public double Gold2_3;
        public double Gold2_4;
        public double Gold2_5;
        public double Gold2_6;
        public double Gold2_7;
        public double Gold2_8;
        public double Gold2_9;
        public double Gold2_10;
        public double Gold2_11;
        public double Gold2_12;
        public double Gold2_13;
        public double Gold2_14;
        public double Gold2_15;
        public double Gold2_16;
        public double Diamond1;
        public double Diamond1_1;
        public double Diamond1_2;
        public double Diamond1_3;
        public double Diamond1_4;
        public double Diamond1_5;
        public double Diamond1_6;
        public double Diamond1_7;
        public double Diamond1_8;
        public double Diamond1_9;
        public double Diamond1_10;
        public double Diamond1_11;
        public double Diamond1_12;
        public double Diamond1_13;
        public double Diamond1_14;
        public double Diamond1_15;
        public double Diamond1_16;
        public double Diamond2;
        public double Diamond2_1;
        public double Diamond2_2;
        public double Diamond2_3;
        public double Diamond2_4;
        public double Diamond2_5;
        public double Diamond2_6;
        public double Diamond2_7;
        public double Diamond2_8;
        public double Diamond2_9;
        public double Diamond2_10;
        public double Diamond2_11;
        public double Diamond2_12;
        public double Diamond2_13;
        public double Diamond2_14;
        public double Diamond2_15;
        public double Diamond2_16;
        public double Sapphire1;
        public double Sapphire1_1;
        public double Sapphire1_2;
        public double Sapphire1_3;
        public double Sapphire1_4;
        public double Sapphire1_5;
        public double Sapphire1_6;
        public double Sapphire1_7;
        public double Sapphire1_8;
        public double Sapphire1_9;
        public double Sapphire1_10;
        public double Sapphire1_11;
        public double Sapphire1_12;
        public double Sapphire1_13;
        public double Sapphire1_14;
        public double Sapphire1_15;
        public double Sapphire1_16;
        public double Sapphire2;
        public double Sapphire2_1;
        public double Sapphire2_2;
        public double Sapphire2_3;
        public double Sapphire2_4;
        public double Sapphire2_5;
        public double Sapphire2_6;
        public double Sapphire2_7;
        public double Sapphire2_8;
        public double Sapphire2_9;
        public double Sapphire2_10;
        public double Sapphire2_11;
        public double Sapphire2_12;
        public double Sapphire2_13;
        public double Sapphire2_14;
        public double Sapphire2_15;
        public double Sapphire2_16;
        //public double Emerald;
        public double Emerald1;
        public double Emerald2;
        public double Emerald3;
        public double Emerald4;
        public double IDPlaceTrack1;
        public double IDPlaceTrack2;
        public double IDPlaceTrack3;
        public double IDPlaceTrack4;
        public double SID;
        public string PID;
        public string SessionUserId;
        public string emailConfCODE;
        public string body = string.Empty;
        public string idplacetrack;
        public string useridname;
        public string referralname;
        public string referralID;
        public string gender;
        public string Referrer;
        public string LoadUserID;
        public string RespUserId;
        public string UserId;
        public string businessname;
        public string domainname;
        public string businessnature;
        //private string body;
        public int percentearned;
        public string referAfriendlink;
        public decimal amountbtc;
        public decimal amountusd;
        public string tranid;
        public string testimonyname;
        public string testimony;
        public string testimonylocation;
        public string testimonycurrency;
        public string getEmailBonus;
        public string autoOption;
        public int WalletbalanceWithdrawable;
        public int WalletbalanceRetained;
        public string placementIDs;
        public string programPack;
        public string withdrawrequestamount;
        public string totalwalletbalance;
        public string totalreusablebalance;
        public string totalbalanceperprogram;
        public string totalwithdrawal;
        public string emailcode;
        public string nokname;
        public string nokrelationship;
        public string LoadEmail;
        public string LoadName;
        public string LoadPhone;
        public string newpassword;
        public string oldpassword;
        public string bookname;
        public string bookurl;
        public int walletBalanceInt;
        public int WalletAmount;
        public int TransferAmount;
        public string SessionEmail;
        public string GetProgram;
        public string GetNGN;
        public string GetUSD;
        public int cost;
        public int qty;
        public int Pay1SN;
        public int Pay2SN;
        public int AssignedSN;
        public int C1Pay1SN;
        public int C1Pay2SN;
        public int C1Pay3SN;
        public int C1Pay4SN;
        public int C1Pay5SN;
        public int C1Pay1Amt;
        public int C1Pay2Amt;
        public int C1Pay3Amt;
        public int C1Pay4Amt;
        public int C1Pay5Amt;
        /// <summary>
        /// C2 Pay SN
        /// </summary>
        public int C2Pay1SN;
        public int C2Pay2SN;
        public int C2Pay3SN;
        public int C2Pay4SN;
        public int C2Pay5SN;
        public int C2Pay6SN;
        public int C2Pay7SN;
        public int C2Pay8SN;
        public int C2Pay9SN;
        public int C2Pay10SN;
        public int C2Pay11SN;
        public int C2Pay12SN;
        public int C2Pay13SN;
        public int C2Pay14SN;
        public int C2Pay15SN;
        public int C2Pay16SN;
        public int C2Pay17SN;
        public int C2Pay18SN;
        public int C2Pay19SN;
        public int C2Pay20SN;
        public int C2Pay21SN;
        public int C2Pay22SN;
        public int C2Pay23SN;
        public int C2Pay24SN;
        public int C2Pay25SN;
        public int C2Pay26SN;
        public int C2Pay27SN;
        public int C2Pay28SN;
        public int C2Pay29SN;
        public int C2Pay30SN;
        public int C2Pay31SN;
        public int C2Pay32SN;
        public int C2Pay33SN;
        public int C2Pay34SN;
        public int C2Pay35SN;
        public int C2Pay36SN;
        public int C2Pay37SN;
        public int C2Pay38SN;
        public int C2Pay39SN;
        public int C2Pay40SN;
        public int C2Pay41SN;
        public int C2Pay42SN;
        public int C2Pay43SN;
        public int C2Pay44SN;
        public int C2Pay45SN;
        public int C2Pay46SN;
        public int C2Pay47SN;
        public int C2Pay48SN;
        public int C2Pay49SN;
        public int C2Pay50SN;
        public int C2Pay51SN;
        public int C2Pay52SN;
        public int C2Pay53SN;
        public int C2Pay54SN;
        public int C2Pay55SN;
        public int C2Pay56SN;
        public int C2Pay57SN;
        public int C2Pay58SN;
        public int C2Pay59SN;
        public int C2Pay60SN;
        public int C2Pay61SN;
        public int C2Pay62SN;
        public int C2Pay63SN;
        public int C2Pay64SN;
        public int C2Pay65SN;
        public int C2Pay66SN;
        public int C2Pay67SN;
        public int C2Pay68SN;
        public int C2Pay69SN;
        public int C2Pay70SN;
        public int C2Pay71SN;
        public int C2Pay72SN;
        public int C2Pay73SN;
        public int C2Pay74SN;
        public int C2Pay75SN;
        public int C2Pay76SN;
        public int C2Pay77SN;
        public int C2Pay78SN;
        public int C2Pay79SN;
        public int C2Pay80SN;
        /// <summary>
        /// C2 Pay Amt
        /// </summary>
        public int C2Pay1Amt;
        public int C2Pay2Amt;
        public int C2Pay3Amt;
        public int C2Pay4Amt;
        public int C2Pay5Amt;
        public int C2Pay6Amt;
        public int C2Pay7Amt;
        public int C2Pay8Amt;
        public int C2Pay9Amt;
        public int C2Pay10Amt;
        public int C2Pay11Amt;
        public int C2Pay12Amt;
        public int C2Pay13Amt;
        public int C2Pay14Amt;
        public int C2Pay15Amt;
        public int C2Pay16Amt;
        public int C2Pay17Amt;
        public int C2Pay18Amt;
        public int C2Pay19Amt;
        public int C2Pay20Amt;
        public int C2Pay21Amt;
        public int C2Pay22Amt;
        public int C2Pay23Amt;
        public int C2Pay24Amt;
        public int C2Pay25Amt;
        public int C2Pay26Amt;
        public int C2Pay27Amt;
        public int C2Pay28Amt;
        public int C2Pay29Amt;
        public int C2Pay30Amt;
        public int C2Pay31Amt;
        public int C2Pay32Amt;
        public int C2Pay33Amt;
        public int C2Pay34Amt;
        public int C2Pay35Amt;
        public int C2Pay36Amt;
        public int C2Pay37Amt;
        public int C2Pay38Amt;
        public int C2Pay39Amt;
        public int C2Pay40Amt;
        public int C2Pay41Amt;
        public int C2Pay42Amt;
        public int C2Pay43Amt;
        public int C2Pay44Amt;
        public int C2Pay45Amt;
        public int C2Pay46Amt;
        public int C2Pay47Amt;
        public int C2Pay48Amt;
        public int C2Pay49Amt;
        public int C2Pay50Amt;
        public int C2Pay51Amt;
        public int C2Pay52Amt;
        public int C2Pay53Amt;
        public int C2Pay54Amt;
        public int C2Pay55Amt;
        public int C2Pay56Amt;
        public int C2Pay57Amt;
        public int C2Pay58Amt;
        public int C2Pay59Amt;
        public int C2Pay60Amt;
        public int C2Pay61Amt;
        public int C2Pay62Amt;
        public int C2Pay63Amt;
        public int C2Pay64Amt;
        public int C2Pay65Amt;
        public int C2Pay66Amt;
        public int C2Pay67Amt;
        public int C2Pay68Amt;
        public int C2Pay69Amt;
        public int C2Pay70Amt;
        public int C2Pay71Amt;
        public int C2Pay72Amt;
        public int C2Pay73Amt;
        public int C2Pay74Amt;
        public int C2Pay75Amt;
        public int C2Pay76Amt;
        public int C2Pay77Amt;
        public int C2Pay78Amt;
        public int C2Pay79Amt;
        public int C2Pay80Amt;
        public int EndSN;
        public int ParentSN;
        public string USD;
        public string NGN;
        public string program;
        public string accountstatus;
        public int totalearnings;
        public int totpurchases;
        public int totmonthpurchases;
        public int totwithdrawals;
        public decimal totexistingprograms;
        public decimal totalearningprograms;
        public decimal totalnilearningprograms;
        public decimal cmaisrating;
        public string reglocation;
        public string membersince;
        public string username;
        public string getUsername;
        public string Status;
        private string error1 = "";
        private string error2 = "";
        private string error3 = "";
        public int SN;
        public string respM = "";
        public string alpha;
        public string RegisterAlpha;
        public string RegisterRootId;
        public decimal depositamount;
        public string depositname;
        public string depositemail;
        public string RespDepositName;
        public string RespDepositAmount;
        public string RespDepositEmail;
        private int amount;
        private int getmonibags;
        private int result;
        public string regloginphone;
        public string regloginemail = "";
        public string reglogpassword;
        public int todayCount;
        public int updateCount;
        public string ResponseMsg = "";
        public string ResponseMsgCode = "";
        public string customerid;
        public string password;
        public string partnername;
        public string sponsorname;
        public string sponsorid;
        public string placementname;
        public string placementid;
        public string position;
        public string email;
        public string phone;
        public string city;
        public string state;
        public string country;
        public string nationality;
        public string bankname;
        public string accountno;
        public string monibagsbought;
        public string monibagsinuse;
        public string lastlogin;
        public string datereg;
        private string registrarcode = "None";
        private string currentdate = DateTime.Now.ToShortDateString();
        private int currentdayofweek = DateTime.Now.Day;
        private SqlDataAdapter da;
        private SqlConnection con;
        private SqlConnection con1;
        private SqlConnection con2;
        private SqlCommand cmd;
        private SqlCommand cmd1;
        private SqlDataReader dr;
        private SqlDataReader dr1;
        private string conn = System.Configuration.ConfigurationManager.ConnectionStrings["con"].ConnectionString;
        //depositorname,email,amount,paymode,bankname,tellerno,remarks,paydate
        public string depositorname;
        public string depositoremail;
        public string depositoramount;
        public string depositorpaymode;
        public string depositbank = "";
        public string tellerno = "";
        public string remarks = "";
        public string depositorpaydate;
        public string walletbalance;
        public string GetSBAUsername;
        public string GetBALinkUsername;
        public string GetSBALinkUsername;
        public string GetBALinkUrl;
        public string GetSBALinkUrl;
        public string GetBALinkCode;
        public string GetSBALinkCode;
        public string refCode;
        public string matrixUserid;
        public string matrixUsername;
        public string matrixRank;
        public int DrawMatrixNewCounter;
        public string UserIdsKeep;
        public string MatrixLink;
        public int getBalance;
        public int getDownlines;
        public string getReferralBonus;
        public string EarningsRank;
        public string EarningsName;
        public string EarningsAmount;
        public string EarningsStatus;
        public string EarningsDate;
        public string EarningsGender;
        public string MatrixRank;   
        public string LoadReferralName1;
        public string LoadReferralID1;
        public string LoadReferralDate1;
        public string LoadReferralName2;
        public string LoadReferralID2;
        public string LoadReferralDate2;
        public string LoadReferralName3;
        public string LoadReferralID3;
        public string LoadReferralDate3;
        public string LoadReferralName4;
        public string LoadReferralID4;
        public string LoadReferralDate4;
        public string AmountWithdraw;
        public string AmountFood;
        public string AmountCash;
        public string Amountcar;
        public string AmountTrip;
        public string AmountSUV;
        public string AmountScholarship;
        public string AmountLand;
        public string DurationWithdraw;
        public string nameW;
        public string rankW;
        public string totearningW;
        public string totwithdrawW;
        public string prevbalanceW;
        public string thiswithdrawW;
        public string newbalanceW;
        public int ddW = DateTime.Now.Day;
        public int mmW = DateTime.Now.Day;
        public int yyW = DateTime.Now.Year;
        public string dateW = DateTime.Now.ToString();
        public string categoryW;
        public string deductionW;
        public string amountW;
        public string balanceW;
        public string statusW;
        public string durationW;
        private int countLine;
        private int Silver = 0;
        private int Gold = 0;
        private int Diamond = 0;
        private int Sapphire = 0;
        private int Emerald = 0;
        private string WRank;
        private string Wuserid;
        public string AnalysisUpline;
        public string AnalysisDownlines;
        public string AnalysisDeposits;
        public string AnalysisEarnings;
        public string AnalysisWithdrawals;
        public string AnalysisPaid;
        public string AnalysisName;
        public string AnalysisEmail;
        public string AnalysisPhone;
        public string AnalysisBankName;
        public string AnalysisAccountNo;
        public string AnalysisNOKName;
        public string AnalysisNOKRelationship;
        public string AnalysisNOKPhone;
        public string AnalysisCode;
        public string switchMode;
        public string videoUrl;
        private string newsMonth;
        public string title1;
        public string news1;
        public string title2;
        public string news2;
        public string title3;
        public string news3;
        public string LoadTitle1;
        public string LoadNewss1;
        public string LoadDay1;
        public string LoadMonth1;
        public string LoadTitle2;
        public string LoadNewss2;
        public string LoadDay2;
        public string LoadMonth2;
        public string LoadTitle3;
        public string LoadNewss3;
        public string LoadDay3;
        public string LoadMonth3;
        public string GalleryName;


        public void UploadGallery()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Select count(name) from gallery", con))
                {
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read() && !dr.IsDBNull(0))
                        {
                            int countName = int.Parse(dr.GetValue(0).ToString());
                            if(countName < 6)
                            {
                                //Insert fresh records
                                if (countName == 0)
                                {
                                    GalleryName = "gallery-V3-1";
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Insert into gallery(name,status) values (@name,@status)", con))
                                    {
                                        cmd.Parameters.AddWithValue("@name", GalleryName);
                                        cmd.Parameters.AddWithValue("@status", 1);
                                        cmd.ExecuteNonQuery();
                                    }
                                }
                                else if (countName == 1)
                                {
                                    GalleryName = "gallery-V3-2";
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Insert into gallery(name,status) values (@name,@status)", con))
                                    {
                                        cmd.Parameters.AddWithValue("@name", GalleryName);
                                        cmd.Parameters.AddWithValue("@status", 1);
                                        cmd.ExecuteNonQuery();
                                    }
                                }
                                else if (countName == 2)
                                {
                                    GalleryName = "gallery-V3-3";
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Insert into gallery(name,status) values (@name,@status)", con))
                                    {
                                        cmd.Parameters.AddWithValue("@name", GalleryName);
                                        cmd.Parameters.AddWithValue("@status", 1);
                                        cmd.ExecuteNonQuery();
                                    }
                                }
                                else if (countName == 3)
                                {
                                    GalleryName = "gallery-V3-4";
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Insert into gallery(name,status) values (@name,@status)", con))
                                    {
                                        cmd.Parameters.AddWithValue("@name", GalleryName);
                                        cmd.Parameters.AddWithValue("@status", 1);
                                        cmd.ExecuteNonQuery();
                                    }
                                }
                                else if (countName == 4)
                                {
                                    GalleryName = "gallery-V3-5";
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Insert into gallery(name,status) values (@name,@status)", con))
                                    {
                                        cmd.Parameters.AddWithValue("@name", GalleryName);
                                        cmd.Parameters.AddWithValue("@status", 1);
                                        cmd.ExecuteNonQuery();
                                    }
                                }
                                else if (countName == 5)
                                {
                                    GalleryName = "gallery-V3-6";
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Insert into gallery(name,status) values (@name,@status)", con))
                                    {
                                        cmd.Parameters.AddWithValue("@name", GalleryName);
                                        cmd.Parameters.AddWithValue("@status", 1);
                                        cmd.ExecuteNonQuery();
                                    }

                                    using (cmd = new SqlCommand("Select SN from gallery where SN=@sn", con))
                                    {
                                        cmd.Parameters.AddWithValue("@sn", 6);
                                        using (dr = cmd.ExecuteReader())
                                        {
                                            if (dr.Read())
                                            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Update gallery set status=@status where sn=@sn", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@sn", 1);
                                                    cmd.Parameters.AddWithValue("@status", 0);
                                                    cmd.ExecuteNonQuery();
                                                }
                                            }
                                        }
                                    }
                                }                                
                            }
                            else if(countName == 6)
                            {
                                //start updating each with status of 0
                                dr.Dispose();
                                using(cmd = new SqlCommand("Select status,sn from gallery where status=@status",con))
                                {
                                    cmd.Parameters.AddWithValue("@status", 0);
                                    using(dr = cmd.ExecuteReader())
                                    {
                                        if(dr.Read())
                                        {
                                            string status = dr.GetValue(0).ToString();
                                            int sn = int.Parse(dr.GetValue(1).ToString());
                                            if(sn == 6)
                                            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Update gallery set status=@status where sn=@sn", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@sn", 1);
                                                    cmd.Parameters.AddWithValue("@status", 0);
                                                    cmd.ExecuteNonQuery();
                                                    GalleryName = "gallery-V3-1";

                                                    using (cmd = new SqlCommand("Update gallery set status=@status where sn=@sn", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@sn", 6);
                                                        cmd.Parameters.AddWithValue("@status", 1);
                                                        cmd.ExecuteNonQuery();
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                int newSN = sn + 1;
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Update gallery set status=@status where sn=@sn", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@sn", newSN);
                                                    cmd.Parameters.AddWithValue("@status", 0);
                                                    cmd.ExecuteNonQuery();
                                                    GalleryName = "gallery-V3-"+sn;

                                                    using (cmd = new SqlCommand("Update gallery set status=@status where sn=@sn", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@sn", sn);
                                                        cmd.Parameters.AddWithValue("@status", 1);
                                                        cmd.ExecuteNonQuery();
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        public void DBbackUp()
        {
            using (this.con = new SqlConnection(this.conn))
            {
                DateTime.Now.ToShortTimeString();
                this.con.Open();
                this.cmd = new SqlCommand("BackupData", this.con);
                this.cmd.CommandType = CommandType.StoredProcedure;
                this.cmd.Parameters.Add(new SqlParameter("@backupPath", "~/Backoffice/Admin/WinningLife.bak"));
                this.cmd.Parameters.Add(new SqlParameter("@databaseName", "WinningLife1"));
                ResponseMsg = "Done";
            }
        }

        public void TransferAccount()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                int counting = 0;
                //BKRetrieve
                using(cmd = new SqlCommand("Select userid from bkretrieve where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            dr.Dispose();
                            using(cmd = new SqlCommand("Delete bkretrieve where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserId);
                                cmd.ExecuteNonQuery();
                                counting++;
                            }
                        }
                        else
                        {
                            counting++;
                        }
                    }
                }

                //CommissionsRef
                int i;
                using(cmd = new SqlCommand("Select count(username) from CommissionsRef where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if(count == 1)
                            {
                                dr.Dispose();
                                using(cmd = new SqlCommand("Update CommissionsRef set username=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                    counting++;
                                }
                            }
                            else if(count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select username from CommissionsRef where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update CommissionsRef set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                        counting++;
                                    }
                                }
                            }                            
                        }
                    }
                }

                //Earnings
                using (cmd = new SqlCommand("Select count(username) from Earnings where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update Earnings set username=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                    counting++;
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select username from Earnings where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update Earnings set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                        counting++;
                                    }
                                }
                            }
                        }
                    }
                }


                //EarningByRank
                using (cmd = new SqlCommand("Select count(username) from EarningsByRank where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update EarningsByRank set username=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select username from EarningsByRank where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update EarningsByRank set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }


                //FamilyHierarchy
                using (cmd = new SqlCommand("Select count(name) from FamilyHierarchy where memberid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update FamilyHierarchy set name=@username where memberid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername + " " + UserId);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select name from FamilyHierarchy where memberid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string fullname = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update EarningsByRank set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername + " " + UserId);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }


                //MatrixPlace - Placement name
                using (cmd = new SqlCommand("Select count(placementname) from MatrixPlace where placementid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update MatrixPlace set placementname=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select placementname from MatrixPlace where placementid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update MatrixPlace set placementname=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //MatrixPlace - User ID name
                using (cmd = new SqlCommand("Select count(useridname) from MatrixPlace where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update MatrixPlace set useridname=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select useridname from MatrixPlace where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update MatrixPlace set useridname=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //MatrixPlace1 - Placement name
                using (cmd = new SqlCommand("Select count(placementname) from MatrixPlace1 where placementid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update MatrixPlace1 set placementname=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select placementname from MatrixPlace1 where placementid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update MatrixPlace1 set placementname=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //MatrixPlace1 - User ID name
                using (cmd = new SqlCommand("Select count(useridname) from MatrixPlace1 where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update MatrixPlace1 set useridname=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select useridname from MatrixPlace1 where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update MatrixPlace1 set useridname=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                //NOK
                using (cmd = new SqlCommand("Select userid from nok where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Delete nok where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserId);
                                cmd.ExecuteNonQuery();
                                counting++;
                            }
                        }
                        else
                        {
                            counting++;
                        }
                    }
                }

                //PayDetails
                using (cmd = new SqlCommand("Select count(email) from PayDetails where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update PayDetails set email=@email where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select email from PayDetails where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update PayDetails set email=@email where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@email", email);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Placement - Referralname
                using (cmd = new SqlCommand("Select count(referralname) from Placement where referralid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update Placement set referralname=@referralname where referralid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@referralname", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select referralname from Placement where referralid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update Placement set referralname=@username where referralid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Placement - Placement Name
                using (cmd = new SqlCommand("Select count(placementname) from Placement where placementid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update Placement set placementname=@placementname where placementid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@placementname", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select placementname from Placement where placementid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update Placement set placementname=@username where placementid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Placement - User ID Name
                using (cmd = new SqlCommand("Select count(useridname) from Placement where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update Placement set useridname=@placementname where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@placementname", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select useridname from Placement where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update Placement set useridname=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Placement - UserName - Email
                using (cmd = new SqlCommand("Select count(username) from Placement where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update Placement set username=@email where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select username from Placement where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update Placement set username=@email where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@email", email);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //RankIDs
                using (cmd = new SqlCommand("Select count(username) from RankIds where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update RankIds set username=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select username from RankIds where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update RankIds set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //ReferralEarnings
                using (cmd = new SqlCommand("Select count(username) from ReferralEarnings where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update ReferralEarnings set username=@email where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select username from ReferralEarnings where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update ReferralEarnings set username=@email where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@email", email);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Register
                using (cmd = new SqlCommand("Select count(email) from Register where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update Register set partnername=@partnername,email=@email,phone=@phone where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@partnername", partnername);
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@phone", phone);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select partnername,email,phone from Register where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string partnername = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update ReferralEarnings set set partnername=@partnername,email=@email,phone=@phone where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@partnername", partnername);
                                                cmd.Parameters.AddWithValue("@email", email);
                                                cmd.Parameters.AddWithValue("@phone", phone);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Wallet
                using (cmd = new SqlCommand("Select count(email) from Wallet where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update Wallet set email=@email where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select email from Wallet where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update Wallet set email=@email where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@email", email);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //WalletTrace
                using (cmd = new SqlCommand("Select count(email) from WalletTrace where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update WalletTrace set email=@email where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select email from WalletTrace where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update WalletTrace set email=@email where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@email", email);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //WithdrawalPending
                using (cmd = new SqlCommand("Select count(name) from WithdrawalPending where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update WithdrawalPending set name=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select name from WithdrawalPending where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update WithdrawalPending set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //Withdrawals
                using (cmd = new SqlCommand("Select count(name) from Withdrawals where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update Withdrawals set name=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select name from Withdrawals where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update Withdrawals set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //WithdrawalTraceRun
                using (cmd = new SqlCommand("Select count(name) from WithdrawalTraceRun where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update WithdrawalTraceRun set name=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select name from WithdrawalTraceRun where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update WithdrawalTraceRun set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //WithdrawalTracker
                using (cmd = new SqlCommand("Select count(name) from WithdrawTracker where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update WithdrawTracker set name=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select name from WithdrawTracker where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update WithdrawTracker set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                //WithdrawTrail
                using (cmd = new SqlCommand("Select count(name) from WithdrawTrail where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int count = int.Parse(dr.GetValue(0).ToString());
                            if (count == 1)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update WithdrawTrail set name=@username where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", partnername);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                }
                            }
                            else if (count > 1)
                            {
                                using (da = new SqlDataAdapter())
                                {
                                    dr.Dispose();
                                    DataSet ds = new DataSet();
                                    string sql = null;
                                    sql = "Select name from WithdrawTrail where userid=@userid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@userid", UserId);
                                        //dr.Dispose();
                                        da.Fill(ds);

                                        //CommissionsRef
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string username = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                                            using (cmd = new SqlCommand("Update WithdrawTrail set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@username", partnername);
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.ExecuteNonQuery();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                ResponseMsg = "Done!";


            }
        }

        void NewsMonth()
        {
            int month = DateTime.Now.Month;
            if(month == 1)
            {
                newsMonth = "Jan";
            }
            else if (month == 2)
            {
                newsMonth = "Feb";
            }
            else if (month == 3)
            {
                newsMonth = "Mar";
            }
            else if (month == 4)
            {
                newsMonth = "Apr";
            }
            else if (month == 5)
            {
                newsMonth = "May";
            }
            else if (month == 6)
            {
                newsMonth = "June";
            }
            else if (month == 7)
            {
                newsMonth = "July";
            }
            else if (month == 8)
            {
                newsMonth = "Aug";
            }
            else if (month == 9)
            {
                newsMonth = "Sep";
            }
            else if (month == 10)
            {
                newsMonth = "Oct";
            }
            else if (month == 11)
            {
                newsMonth = "Nov";
            }
            else if (month == 12)
            {
                newsMonth = "Dec";
            }
        }

        public void LoadNews1()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select title,news,day,month from News1", con))
                {
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            LoadTitle1 = dr.GetValue(0).ToString();
                            LoadNewss1 = dr.GetValue(1).ToString();
                            LoadDay1 = dr.GetValue(2).ToString();
                            LoadMonth1 = dr.GetValue(3).ToString();
                        }
                    }
                }
            }
        }

        public void SaveNews1()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select title from news1 where sn=@sn", con))
                {
                    cmd.Parameters.AddWithValue("@sn", 1);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Update news1 set title=@title,news=@news,day=@day,month=@month", con))
                            {
                                cmd.Parameters.AddWithValue("@title", title1);
                                cmd.Parameters.AddWithValue("@news", news1);
                                cmd.Parameters.AddWithValue("@day", DateTime.Now.Day);
                                NewsMonth();
                                cmd.Parameters.AddWithValue("@month", newsMonth);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Insert into news1(title,news,day,month) values (@title,@news,@day,@month)", con))
                            {
                                cmd.Parameters.AddWithValue("@title", title1);
                                cmd.Parameters.AddWithValue("@news", news1);
                                cmd.Parameters.AddWithValue("@day", DateTime.Now.Day);
                                NewsMonth();
                                cmd.Parameters.AddWithValue("@month", newsMonth);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                    }
                }
            }
        }
        ////////////////////////////////////////////
        public void LoadNews2()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select title,news,day,month from News2", con))
                {
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            LoadTitle2 = dr.GetValue(0).ToString();
                            LoadNewss2 = dr.GetValue(1).ToString();
                            LoadDay2 = dr.GetValue(2).ToString();
                            LoadMonth2 = dr.GetValue(3).ToString();
                        }
                    }
                }
            }
        }

        public void SaveNews2()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select title from news2", con))
                {
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Update news2 set title=@title,news=@news,day=@day,month=@month", con))
                            {
                                cmd.Parameters.AddWithValue("@title", title2);
                                cmd.Parameters.AddWithValue("@news", news2);
                                cmd.Parameters.AddWithValue("@day", DateTime.Now.Day);
                                NewsMonth();
                                cmd.Parameters.AddWithValue("@month", newsMonth);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Insert into news2(title,news,day,month) values (@title,@news,@day,@month)", con))
                            {
                                cmd.Parameters.AddWithValue("@title", title2);
                                cmd.Parameters.AddWithValue("@news", news2);
                                cmd.Parameters.AddWithValue("@day", DateTime.Now.Day);
                                NewsMonth();
                                cmd.Parameters.AddWithValue("@month", newsMonth);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                    }
                }
            }
        }
        //////////////////////////////////////////////////////////////////
        public void LoadNews3()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select title,news,day,month from News3", con))
                {
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            LoadTitle3 = dr.GetValue(0).ToString();
                            LoadNewss3 = dr.GetValue(1).ToString();
                            LoadDay3 = dr.GetValue(2).ToString();
                            LoadMonth3 = dr.GetValue(3).ToString();
                        }
                    }
                }
            }
        }

        public void SaveNews3()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select title from news3", con))
                {
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Update news3 set title=@title,news=@news,day=@day,month=@month", con))
                            {
                                cmd.Parameters.AddWithValue("@title", title3);
                                cmd.Parameters.AddWithValue("@news", news3);
                                cmd.Parameters.AddWithValue("@day", DateTime.Now.Day);
                                NewsMonth();
                                cmd.Parameters.AddWithValue("@month", newsMonth);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Insert into news3(title,news,day,month) values (@title,@news,@day,@month)", con))
                            {
                                cmd.Parameters.AddWithValue("@title", title3);
                                cmd.Parameters.AddWithValue("@news", news3);
                                cmd.Parameters.AddWithValue("@day", DateTime.Now.Day);
                                NewsMonth();
                                cmd.Parameters.AddWithValue("@month", newsMonth);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                    }
                }
            }
        }




        /// <summary>
        /// 
        /// </summary>
        public void LoadVideoURL()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select url from VideoURL", con))
                {
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            ResponseMsg = dr.GetValue(0).ToString();
                        }
                    }
                }
            }
        }

        public void SaveVideoURL()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select url from VideoURL", con))
                {
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Update VideoURL set url=@url", con))
                            {
                                cmd.Parameters.AddWithValue("@url", videoUrl);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Insert into VideoURL(url) values (@url)", con))
                            {
                                cmd.Parameters.AddWithValue("@url", videoUrl);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                    }
                }
            }
        }


        /// <summary>
        /// /////////////////////////////
        /// </summary>
        public void LoadSwitchAdvert()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Select switch from AdvertMode", con))
                {
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            ResponseMsg = dr.GetValue(0).ToString(); 
                        }
                    }
                }
            }
        }

        public void SwitchAdvert()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Select switch from AdvertMode", con))
                {
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read() && !dr.IsDBNull(0))
                        {
                            dr.Dispose();
                            using(cmd = new SqlCommand("Update Advertmode set switch=@switch", con))
                            {
                                cmd.Parameters.AddWithValue("@switch", switchMode);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                        else
                        {
                            dr.Dispose();
                            using(cmd = new SqlCommand("Insert into AdvertMode(switch) values (@switch)", con))
                            {
                                cmd.Parameters.AddWithValue("@switch", switchMode);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Saved!";
                            }
                        }
                    }
                }
            }
        }


        public void UserAnalysis()
        {
            DrawMatrixNew();
            FinalRankChecker();
            using(con = new SqlConnection(conn))
            {
                con.Open();

                //Get Code
                using(cmd = new SqlCommand("Select code from register where codestatus=@codestatus and userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@codestatus", "0");
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisCode = dr.GetValue(0).ToString();
                        }
                        else
                        {
                            AnalysisCode = "None";
                        }
                    }
                }

                //Get Upline
                using(cmd = new SqlCommand("Select placementid from placement where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisUpline = dr.GetValue(0).ToString();
                        }
                    }
                }

                //Get Downlines
                dr.Dispose();
                using (cmd = new SqlCommand("Select downlines from downlinescount where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisDownlines = dr.GetValue(0).ToString();
                        }
                    }
                }

                //Get Total Deposits
                dr.Dispose();
                //using (cmd = new SqlCommand("Select SUM(amount) from wallet where userid=@userid", con))
                //{
                //    cmd.Parameters.AddWithValue("@userid", placementid);
                //    using (dr = cmd.ExecuteReader())
                //    {
                //        if (dr.Read() && !dr.IsDBNull(0))
                //        {
                //            AnalysisDeposits = dr.GetValue(0).ToString();
                //        }
                //    }
                //}

                using (da = new SqlDataAdapter())
                {
                    //, con
                    DataSet ds = new DataSet();
                    int i = 0;
                    string sql = null;
                    sql = "Select addamount,purpose from wallettrace where userid=@userid";
                    using (cmd = new SqlCommand(sql, con))
                    {
                        da.SelectCommand = cmd;
                        da.SelectCommand.Parameters.AddWithValue("@userid", placementid);
                        //dr.Dispose();
                        da.Fill(ds);
                        depositamount = 0;

                        //CommissionsRef
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string addamount = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string purpose = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                            int totalamount = int.Parse(addamount); 
                            if(purpose.Contains("Confirmation of payments deposit of"))
                            {
                                depositamount = depositamount + totalamount;
                            }
                        }
                        AnalysisDeposits = depositamount.ToString();
                    }
                }



                //Get Total Earnings
                dr.Dispose();
                using (cmd = new SqlCommand("Select SUM(amountdue) from earnings where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisEarnings = dr.GetValue(0).ToString();
                        }
                    }
                }

                //Get Total Withdrawals Requests
                dr.Dispose();
                using (cmd = new SqlCommand("Select SUM(thiswithdraw) from withdrawals where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisWithdrawals = dr.GetValue(0).ToString();
                        }
                    }
                }

                //Get Total Withdrawals Paid
                dr.Dispose();
                using (cmd = new SqlCommand("Select SUM(thiswithdraw) from withdrawals where userid=@userid and status=@status", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    cmd.Parameters.AddWithValue("@status", "Paid");
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisPaid = dr.GetValue(0).ToString();
                        }
                    }
                }

                //Get Personal Information
                dr.Dispose();
                using (cmd = new SqlCommand("Select partnername,email,phone from register where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisName = dr.GetValue(0).ToString();
                            AnalysisEmail = dr.GetValue(1).ToString();
                            AnalysisPhone = dr.GetValue(2).ToString();
                        }
                    }
                }

                //Get Personal Bank Information
                dr.Dispose();
                using (cmd = new SqlCommand("Select bankname,accountno from bkretrieve where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisBankName = dr.GetValue(0).ToString();
                            AnalysisAccountNo = dr.GetValue(1).ToString();
                        }
                    }
                }

                //Get NOK Information
                dr.Dispose();
                using (cmd = new SqlCommand("Select nokname,nokrelationship,phone from NOK where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            AnalysisNOKName = dr.GetValue(0).ToString();
                            AnalysisNOKRelationship = dr.GetValue(1).ToString();
                            AnalysisNOKPhone = dr.GetValue(2).ToString();
                        }
                    }
                }


            }
        }

        public void RegulariseNames()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();

                using (da = new SqlDataAdapter())
                {
                    //, con
                    DataSet ds = new DataSet();
                    int i = 0;
                    string sql = null;
                    sql = "Select userid,partnername from register order by sn";
                    using (cmd = new SqlCommand(sql, con))
                    {
                        da.SelectCommand = cmd;
                        //da.SelectCommand.Parameters.AddWithValue("@placementid", placementid);
                        //dr.Dispose();
                        da.Fill(ds);

                        //CommissionsRef
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using(cmd = new SqlCommand("Select username from commissionsref where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using(dr = cmd.ExecuteReader())
                                {
                                    if(dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if(getName != UserName)
                                        {
                                            dr.Dispose();
                                            using(cmd = new SqlCommand("Update commissionsref set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Commissionsref:" + i + ", ";
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update commissionsref set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Commissionsref:" + i + ", ";
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //Earnings
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using (cmd = new SqlCommand("Select username from earnings where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if (getName != UserName)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update earnings set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Earnings:" + i + ", ";
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update earnings set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Earnings:" + i + ", ";
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //NOK
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using (cmd = new SqlCommand("Select username from NOK where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if (getName != UserName)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update NOK set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "NOK:" + i + ", ";
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update NOK set username=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "NOK:" + i + ", ";
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //Placement - ReferralName
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using (cmd = new SqlCommand("Select referralname from placement where referralid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if (getName != UserName)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update placement set referralname=@username where referralid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Place-ref:" + UserName + "-" + getName;
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update placement set referralname=@username where referralid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Place-ref:" + UserName + "-" + getName;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //Placement - UserName
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using (cmd = new SqlCommand("Select UserIDname from placement where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if (getName != UserName)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update placement set UserIDname=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Place-UserN:" + UserName + "-" + getName;
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update placement set UserIDname=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Place-UserN:" + UserName + "-" + getName;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //Placement - PlacementName
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using (cmd = new SqlCommand("Select placementname from placement where placementid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if (getName != UserName)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update placement set placementname=@username where placementid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Place-NamePlace:" + UserName + "-" + getName;
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update placement set placementname=@username where placementid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Place-NamePlace:" + UserName + "-" + getName;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        //Withdrawals
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using (cmd = new SqlCommand("Select name from withdrawals where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if (getName != UserName)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update withdrawals set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Withdrawals:" + i + ", ";
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update withdrawals set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "Withdrawals:" + i + ", ";
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //WithdrawTracker
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using (cmd = new SqlCommand("Select name from withdrawtracker where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if (getName != UserName)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update withdrawtracker set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "WithdrawalTracker:" + i + ", ";
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update withdrawtracker set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "WithdrawalTracker:" + i + ", ";
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //WithdrawTrail
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string UserID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string UserName = ds.Tables[0].Rows[i].ItemArray[1].ToString();

                            using (cmd = new SqlCommand("Select name from withdrawtrail where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserID);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        string getName = dr.GetValue(0).ToString();
                                        if (getName != UserName)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update withdrawtrail set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "WithdrawalTracker:" + i + ", ";
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update withdrawtrail set name=@username where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                cmd.Parameters.AddWithValue("@username", UserName);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg += "WithdrawalTracker:" + i + ", ";
                                            }
                                        }
                                    }
                                }
                            }
                        }








                    }
                }
            }
        }

        public void RegularisePreviousPaid()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();

                using (da = new SqlDataAdapter())
                {
                    //, con
                    DataSet ds = new DataSet();
                    int i = 0;
                    string sql = null;
                    sql = "Select userid,rank,status,name,thiswithdraw from withdrawals";
                    using (cmd = new SqlCommand(sql, con))
                    {
                        da.SelectCommand = cmd;
                        //da.SelectCommand.Parameters.AddWithValue("@placementid", placementid);
                        //dr.Dispose();
                        da.Fill(ds);

                        int rankcount = 0;
                        //Silver Stage 1
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string id = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string idrank = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                            string idstatus = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                            string idname = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                            string idwithdraw = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                            if (id == "174FDF")
                            {
                                string idd = "ID";
                            }

                            if(idrank == "SilverLife 1")
                            {
                                idwithdraw = "5000";
                            }
                            else if (idrank == "SilverLife 2")
                            {
                                idwithdraw = "40000";
                            }
                            else if (idrank == "GoldLife 1")
                            {
                                idwithdraw = "72000";
                            }
                            else if (idrank == "GoldLife 2")
                            {
                                idwithdraw = "150000";
                            }
                            else if (idrank == "DiamondLife 1")
                            {
                                //idwithdraw = "5000";
                            }
                            else if (idrank == "DiamomndLife 2")
                            {
                                //idwithdraw = "5000";
                            }
                            else if (idrank == "SapphireLife 1")
                            {
                                //idwithdraw = "5000";
                            }
                            else if (idrank == "SapphireLife 2")
                            {
                                //idwithdraw = "5000";
                            }
                            else if (idrank == "EmeraldLife")
                            {
                                //idwithdraw = "5000";
                            }

                            using(cmd = new SqlCommand("Select status from earnings where rank=@rank and userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@rank", idrank);
                                cmd.Parameters.AddWithValue("@userid", id);
                                using(dr = cmd.ExecuteReader())
                                {
                                    if(dr.Read())
                                    {
                                        string earningStatus = dr.GetValue(0).ToString();
                                        if(earningStatus != idstatus)
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update earnings set status=@status where rank=@rank and userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@status", idstatus);
                                                cmd.Parameters.AddWithValue("@rank", idrank);
                                                cmd.Parameters.AddWithValue("@userid", id);
                                                cmd.ExecuteNonQuery();
                                                rankcount++;
                                                ResponseMsg += " " + rankcount.ToString() + " " + idrank + " ";
                                            }
                                        }
                                    }
                                    else
                                    {
                                        int rankcount1 = 0;
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@userid", id);
                                            cmd.Parameters.AddWithValue("@rank", idrank);
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                string getRank;
                                                if (dr.Read() && !dr.IsDBNull(0))
                                                {
                                                    //do nothing
                                                    getRank = dr.GetValue(0).ToString();
                                                }
                                                else
                                                {
                                                    if (getrank == idrank)
                                                    {

                                                    }
                                                    else
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Max(Balance) from earnings where userid=@userid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", id);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    string SN = dr.GetValue(0).ToString();

                                                                    using (cmd = new SqlCommand("Select balance from earnings where balance=@sn", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                                        dr.Dispose();
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                        cmd.Parameters.AddWithValue("@userid", id);
                                                                        cmd.Parameters.AddWithValue("@username", idname);
                                                                        cmd.Parameters.AddWithValue("@rank", idrank);
                                                                        cmd.Parameters.AddWithValue("@amountdue", int.Parse(idwithdraw));
                                                                        cmd.Parameters.AddWithValue("@deductions", 0);
                                                                        cmd.Parameters.AddWithValue("@balance", getBalance + int.Parse(idwithdraw));
                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                        cmd.Parameters.AddWithValue("@status", idstatus);
                                                                        cmd.ExecuteNonQuery();
                                                                        rankcount1++;
                                                                        ResponseMsg += " " + rankcount1.ToString() + " Insert: " + idrank + " ";
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                        cmd.Parameters.AddWithValue("@userid", id);
                                                                        cmd.Parameters.AddWithValue("@username", idname);
                                                                        cmd.Parameters.AddWithValue("@rank", idrank);
                                                                        cmd.Parameters.AddWithValue("@amountdue", idwithdraw);
                                                                        cmd.Parameters.AddWithValue("@deductions", 0);
                                                                        cmd.Parameters.AddWithValue("@balance", idwithdraw);
                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                        cmd.Parameters.AddWithValue("@status", idstatus);
                                                                        cmd.ExecuteNonQuery();
                                                                        rankcount1++;
                                                                        ResponseMsg += " " + rankcount1.ToString() + " Insert: " + idrank + " ";
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        public void RegulariseWrongAttainedRanks()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();

                using (da = new SqlDataAdapter())
                {
                    //, con
                    DataSet ds = new DataSet();
                    int i = 0;
                    string sql = null;
                    sql = "Select userid,partnername from register";
                    using (cmd = new SqlCommand(sql, con))
                    {
                        da.SelectCommand = cmd;
                        //da.SelectCommand.Parameters.AddWithValue("@placementid", placementid);
                        //dr.Dispose();
                        da.Fill(ds);

                        //Silver Stage 1
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            placementid= ds.Tables[0].Rows[i].ItemArray[0].ToString();


                            DrawMatrixNew();

                            DrawMatrix();

                            using (con = new SqlConnection(conn))
                            {
                                con.Open();
                                int TotalDownlines = 0;
                                int Silver1 = 4;
                                int Silver1Counter = 0;
                                string Silver1Ids = "";

                                int Silver2 = 16;
                                int Silver2Counter = 0;
                                string Silver2Ids = "";

                                int Gold1 = 64;
                                int Gold1Counter = 0;
                                string Gold1Ids = "";

                                int Gold2 = 256;
                                int Gold2Counter = 0;
                                string Gold2Ids = "";

                                int Diamond1 = 1024;
                                int Diamond1Counter = 0;
                                string Diamond1Ids = "";

                                int Diamond2 = 4096;
                                int Diamond2Counter = 0;
                                string Diamond2Ids = "";

                                int Sapphire1 = 16384;
                                int Sapphire1Counter = 0;
                                string Sapphire1Ids = "";

                                int Sapphire2 = 65536;
                                int Sapphire2Counter = 0;
                                string Sapphire2Ids = "";

                                int Emerald = 262144;
                                int EmeraldCounter = 0;
                                string EmeraldIds = "";

                                string RankFinal = "";
                                int TotalCounters = 0;

                                //Get Total Downlines
                                using (cmd = new SqlCommand("Select count(sn) from familyhierarchy", con))
                                {
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            TotalDownlines = int.Parse(dr.GetValue(0).ToString());
                                        }
                                    }
                                }

                                //Get the Ranks

                                using (cmd = new SqlCommand("Select count(parentid) from familyhierarchy where parentid=@parentid", con))
                                {
                                    cmd.Parameters.AddWithValue("@parentid", placementid);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            Silver1 = int.Parse(dr.GetValue(0).ToString());
                                            if (Silver1 == 4)
                                            {
                                                RankFinal = "Silver1";
                                            }
                                            else if (Silver1 < 4 && Silver1 > 0)
                                            {
                                                RankFinal = "Silver1";
                                            }
                                            if (TotalDownlines > 4)
                                            {
                                                //Check for Silver 1 Ids to get Silver 2 Downlines
                                                using (da = new SqlDataAdapter())
                                                {
                                                    DataSet dss = new DataSet();
                                                    int ii = 0;
                                                    string sqll = null;
                                                    sqll = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                    using (cmd = new SqlCommand(sqll, con))
                                                    {
                                                        da.SelectCommand = cmd;
                                                        da.SelectCommand.Parameters.AddWithValue("@parentid", placementid);
                                                        dr.Dispose();
                                                        da.Fill(dss);

                                                        for (ii = 0; ii <= dss.Tables[0].Rows.Count - 1; ii++)
                                                        {
                                                            string MemberID = dss.Tables[0].Rows[ii].ItemArray[0].ToString();
                                                            if (ii < dss.Tables[0].Rows.Count - 1)
                                                            {
                                                                Silver1Ids += MemberID + " ";
                                                                Silver1Counter++;
                                                            }
                                                            else if (ii == dss.Tables[0].Rows.Count - 1)
                                                            {
                                                                Silver1Ids += MemberID;
                                                                Silver1Counter++;
                                                            }
                                                        }
                                                    }
                                                    if (Silver1Counter < 4 && Silver1Counter > 0)
                                                    {
                                                        RankFinal = "Silver1";

                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                        cmd.ExecuteNonQuery();

                                                                        countLine++;
                                                                        ResponseMsg += placementid + ", "; countLine++;
                                                                    }

                                                                    using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                string STATUSWithd = dr.GetValue(1).ToString();
                                                                                if (STATUSWithd == "Paid")
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                    {//userid,rank,amount,dated,status
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                                        cmd.Parameters.AddWithValue("@amount", 5000);
                                                                                        cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else if (STATUSWithd == "Pending")
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                    {//userid,rank,amount,dated,status
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else if (Silver1Counter == 4)
                                                    {
                                                        /////////////////////////////////////
                                                        //      Inject Earnings Codes      //
                                                        ////////////////////////////////////
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                string getRank;
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    //do nothing
                                                                    getRank = dr.GetValue(0).ToString();
                                                                }
                                                                else
                                                                {
                                                                    if (getrank == "SilverLife 1")
                                                                    {

                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    string SN = dr.GetValue(0).ToString();

                                                                                    using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                                                        dr.Dispose();
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                            {
                                                                                                getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                    { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@username", placementname);
                                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                                        cmd.Parameters.AddWithValue("@amountdue", 5000);
                                                                                        cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                        cmd.Parameters.AddWithValue("@balance", getBalance + 5000);
                                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                        cmd.ExecuteNonQuery();

                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                    { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@username", placementname);
                                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                                        cmd.Parameters.AddWithValue("@amountdue", 5000);
                                                                                        cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                        cmd.Parameters.AddWithValue("@balance", 5000);
                                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        ////////////////////////////////////


                                                        RankFinal = "Silver1";
                                                        TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                        int count;
                                                        string[] splitUserIds;
                                                        char[] splitchar1 = { ' ' };
                                                        splitUserIds = Silver1Ids.Split(splitchar1);
                                                        UserIdsKeep = "";
                                                        //DrawMatrixNewCounter = 0;
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            string SplitedUserID = splitUserIds[count];

                                                            if (TotalCounters <= TotalDownlines)
                                                            {
                                                                da.Dispose();
                                                                using (da = new SqlDataAdapter())
                                                                {
                                                                    ds = new DataSet();
                                                                    i = 0;
                                                                    sql = null;
                                                                    sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                    using (cmd = new SqlCommand(sql, con))
                                                                    {
                                                                        da.SelectCommand = cmd;
                                                                        da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                        dr.Dispose();
                                                                        da.Fill(ds);

                                                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                        {
                                                                            string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                            if (i < ds.Tables[0].Rows.Count - 1)
                                                                            {
                                                                                Silver2Ids += MemberID + " ";
                                                                                Silver2Counter++;
                                                                            }
                                                                            else if (i == ds.Tables[0].Rows.Count - 1)
                                                                            {
                                                                                Silver2Ids += MemberID;
                                                                                Silver2Counter++;
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        //Set the Silver 2 Rank
                                                        if (Silver2Counter < 16 && Silver2Counter > 0)
                                                        {
                                                            RankFinal = "Silver2";


                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                            cmd.ExecuteNonQuery();

                                                                            countLine++;
                                                                            ResponseMsg += placementid + ", ";
                                                                        }

                                                                        using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string STATUSWithd = dr.GetValue(1).ToString();
                                                                                    if (STATUSWithd == "Paid")
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                        {//userid,rank,amount,dated,status
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                                            cmd.Parameters.AddWithValue("@amount", 40000);
                                                                                            cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                    else if (STATUSWithd == "Pending")
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                        {//userid,rank,amount,dated,status
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else if (Silver2Counter == 16)
                                                        {
                                                            /////////////////////////////////////
                                                            //      Inject Earnings Codes      //
                                                            ////////////////////////////////////
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    string getRank;
                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    {
                                                                        //do nothing
                                                                        getRank = dr.GetValue(0).ToString();
                                                                    }
                                                                    else
                                                                    {
                                                                        if (getrank == "SilverLife 2")
                                                                        {

                                                                        }
                                                                        else
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                    {
                                                                                        string SN = dr.GetValue(0).ToString();

                                                                                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                                            dr.Dispose();
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                                {
                                                                                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                                            cmd.Parameters.AddWithValue("@amountdue", 40000);
                                                                                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                            cmd.Parameters.AddWithValue("@balance", getBalance + 40000);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                            cmd.ExecuteNonQuery();

                                                                                        }
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                                            cmd.Parameters.AddWithValue("@amountdue", 40000);
                                                                                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                            cmd.Parameters.AddWithValue("@balance", 40000);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            ////////////////////////////////////

                                                            RankFinal = "Gold";
                                                            TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                            splitUserIds = Silver2Ids.Split(splitchar1);
                                                            UserIdsKeep = "";
                                                            //DrawMatrixNewCounter = 0;
                                                            fullLength = splitUserIds.Length;

                                                            for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                            {
                                                                string SplitedUserID = splitUserIds[count];

                                                                if (TotalCounters <= TotalDownlines)
                                                                {
                                                                    da.Dispose();
                                                                    using (da = new SqlDataAdapter())
                                                                    {
                                                                        ds = new DataSet();
                                                                        i = 0;
                                                                        sql = null;
                                                                        sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                        using (cmd = new SqlCommand(sql, con))
                                                                        {
                                                                            da.SelectCommand = cmd;
                                                                            da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                            dr.Dispose();
                                                                            da.Fill(ds);

                                                                            for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                            {
                                                                                string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                if (i < ds.Tables[0].Rows.Count - 1)
                                                                                {
                                                                                    Gold1Ids += MemberID + " ";
                                                                                    Gold1Counter++;
                                                                                }
                                                                                else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                {
                                                                                    Gold1Ids += MemberID;
                                                                                    Gold1Counter++;
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Set the Gold 1 Rank
                                                            if (Gold1Counter < 64 && Gold1Counter > 0)
                                                            {
                                                                RankFinal = "Gold1";

                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                cmd.ExecuteNonQuery();

                                                                                countLine++;
                                                                                ResponseMsg += placementid + ", ";
                                                                            }

                                                                            using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        string STATUSWithd = dr.GetValue(1).ToString();
                                                                                        if (STATUSWithd == "Paid")
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                            {//userid,rank,amount,dated,status
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                                cmd.Parameters.AddWithValue("@amount", 72000);
                                                                                                cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                cmd.ExecuteNonQuery();
                                                                                            }
                                                                                        }
                                                                                        else if (STATUSWithd == "Pending")
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                            {//userid,rank,amount,dated,status
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                                cmd.ExecuteNonQuery();
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                            else if (Gold1Counter == 64)
                                                            {
                                                                /////////////////////////////////////
                                                                //      Inject Earnings Codes      //
                                                                ////////////////////////////////////
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        string getRank;
                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                        {
                                                                            //do nothing
                                                                            getRank = dr.GetValue(0).ToString();
                                                                        }
                                                                        else
                                                                        {
                                                                            if (getrank == "GoldLife 1")
                                                                            {

                                                                            }
                                                                            else
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                        {
                                                                                            string SN = dr.GetValue(0).ToString();

                                                                                            using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                dr.Dispose();
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                                    {
                                                                                                        getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                            { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                                cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                                                                cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                cmd.Parameters.AddWithValue("@balance", getBalance + 72000);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                cmd.ExecuteNonQuery();

                                                                                            }
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                            { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                                cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                                                                cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                cmd.Parameters.AddWithValue("@balance", 72000);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                cmd.ExecuteNonQuery();
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                ////////////////////////////////////

                                                                RankFinal = "Gold1";
                                                                TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                                splitUserIds = Gold1Ids.Split(splitchar1);
                                                                UserIdsKeep = "";
                                                                //DrawMatrixNewCounter = 0;
                                                                fullLength = splitUserIds.Length;

                                                                for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                                {
                                                                    string SplitedUserID = splitUserIds[count];

                                                                    if (TotalCounters <= TotalDownlines)
                                                                    {
                                                                        da.Dispose();
                                                                        using (da = new SqlDataAdapter())
                                                                        {
                                                                            ds = new DataSet();
                                                                            i = 0;
                                                                            sql = null;
                                                                            sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                            using (cmd = new SqlCommand(sql, con))
                                                                            {
                                                                                da.SelectCommand = cmd;
                                                                                da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                                dr.Dispose();
                                                                                da.Fill(ds);

                                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                                {
                                                                                    string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                    if (i < ds.Tables[0].Rows.Count - 1)
                                                                                    {
                                                                                        Gold2Ids += MemberID + " ";
                                                                                        Gold2Counter++;
                                                                                    }
                                                                                    else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                    {
                                                                                        Gold2Ids += MemberID;
                                                                                        Gold2Counter++;
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                //Set the Gold 2 Rank
                                                                if (Gold2Counter < 256 && Gold2Counter > 0)
                                                                {
                                                                    RankFinal = "Gold2";

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.ExecuteNonQuery();

                                                                                    countLine++;
                                                                                    ResponseMsg += placementid + ", ";
                                                                                }

                                                                                using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read())
                                                                                        {
                                                                                            string STATUSWithd = dr.GetValue(1).ToString();
                                                                                            if (STATUSWithd == "Paid")
                                                                                            {
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                                {//userid,rank,amount,dated,status
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                                    cmd.Parameters.AddWithValue("@amount", 150000);
                                                                                                    cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                            else if (STATUSWithd == "Pending")
                                                                                            {
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                                {//userid,rank,amount,dated,status
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else if (Gold2Counter == 256)
                                                                {
                                                                    /////////////////////////////////////
                                                                    //      Inject Earnings Codes      //
                                                                    ////////////////////////////////////
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            string getRank;
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                //do nothing
                                                                                getRank = dr.GetValue(0).ToString();
                                                                            }
                                                                            else
                                                                            {
                                                                                if (getrank == "GoldLife 2")
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                            {
                                                                                                string SN = dr.GetValue(0).ToString();

                                                                                                using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                    dr.Dispose();
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                                        {
                                                                                                            getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                                    cmd.Parameters.AddWithValue("@amountdue", 150000);
                                                                                                    cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                    cmd.Parameters.AddWithValue("@balance", getBalance + 150000);
                                                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                    cmd.ExecuteNonQuery();

                                                                                                }
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                                    cmd.Parameters.AddWithValue("@amountdue", 150000);
                                                                                                    cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                    cmd.Parameters.AddWithValue("@balance", 150000);
                                                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }

                                                                    ////////////////////////////////////

                                                                    RankFinal = "Diamond";
                                                                    TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                                    splitUserIds = Gold2Ids.Split(splitchar1);
                                                                    UserIdsKeep = "";
                                                                    //DrawMatrixNewCounter = 0;
                                                                    fullLength = splitUserIds.Length;

                                                                    for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                                    {
                                                                        string SplitedUserID = splitUserIds[count];

                                                                        if (TotalCounters <= TotalDownlines)
                                                                        {
                                                                            da.Dispose();
                                                                            using (da = new SqlDataAdapter())
                                                                            {
                                                                                ds = new DataSet();
                                                                                i = 0;
                                                                                sql = null;
                                                                                sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                                using (cmd = new SqlCommand(sql, con))
                                                                                {
                                                                                    da.SelectCommand = cmd;
                                                                                    da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                                    dr.Dispose();
                                                                                    da.Fill(ds);

                                                                                    for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                                    {
                                                                                        string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                        if (i < ds.Tables[0].Rows.Count - 1)
                                                                                        {
                                                                                            Diamond1Ids += MemberID + " ";
                                                                                            Diamond1Counter++;
                                                                                        }
                                                                                        else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                        {
                                                                                            Diamond1Ids += MemberID;
                                                                                            Diamond1Counter++;
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    //Set the Diaomond 1 Rank
                                                                    if (Diamond1Counter < 1024 && Diamond1Counter > 0)
                                                                    {
                                                                        RankFinal = "Diamond1";

                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                        cmd.ExecuteNonQuery();

                                                                                        countLine++;
                                                                                        ResponseMsg += placementid + ", ";
                                                                                    }

                                                                                    using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string STATUSWithd = dr.GetValue(1).ToString();
                                                                                                if (STATUSWithd == "Paid")
                                                                                                {
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                                    {//userid,rank,amount,dated,status
                                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                                        cmd.Parameters.AddWithValue("@amount", 300000);
                                                                                                        cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                        cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }
                                                                                                else if (STATUSWithd == "Pending")
                                                                                                {
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                                    {//userid,rank,amount,dated,status
                                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else if (Diamond1Counter == 1024)
                                                                    {
                                                                        /////////////////////////////////////
                                                                        //      Inject Earnings Codes      //
                                                                        ////////////////////////////////////
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                string getRank;
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    //do nothing
                                                                                    getRank = dr.GetValue(0).ToString();
                                                                                }
                                                                                else
                                                                                {
                                                                                    if (getrank == "DiamondLife 1")
                                                                                    {

                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                                {
                                                                                                    string SN = dr.GetValue(0).ToString();

                                                                                                    using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                                    {
                                                                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                        dr.Dispose();
                                                                                                        using (dr = cmd.ExecuteReader())
                                                                                                        {
                                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                                            {
                                                                                                                getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                    { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                        cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                                        cmd.Parameters.AddWithValue("@amountdue", 300000);
                                                                                                        cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                        cmd.Parameters.AddWithValue("@balance", getBalance + 300000);
                                                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                        cmd.ExecuteNonQuery();

                                                                                                    }
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                    { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                        cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                                        cmd.Parameters.AddWithValue("@amountdue", 300000);
                                                                                                        cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                        cmd.Parameters.AddWithValue("@balance", 300000);
                                                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }

                                                                        ////////////////////////////////////

                                                                        RankFinal = "Diamond1";
                                                                        TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                                        splitUserIds = Diamond1Ids.Split(splitchar1);
                                                                        UserIdsKeep = "";
                                                                        //DrawMatrixNewCounter = 0;
                                                                        fullLength = splitUserIds.Length;

                                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                                        {
                                                                            string SplitedUserID = splitUserIds[count];

                                                                            if (TotalCounters <= TotalDownlines)
                                                                            {
                                                                                da.Dispose();
                                                                                using (da = new SqlDataAdapter())
                                                                                {
                                                                                    ds = new DataSet();
                                                                                    i = 0;
                                                                                    sql = null;
                                                                                    sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                                    using (cmd = new SqlCommand(sql, con))
                                                                                    {
                                                                                        da.SelectCommand = cmd;
                                                                                        da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                                        dr.Dispose();
                                                                                        da.Fill(ds);

                                                                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                                        {
                                                                                            string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                            if (i < ds.Tables[0].Rows.Count - 1)
                                                                                            {
                                                                                                Diamond2Ids += MemberID + " ";
                                                                                                Diamond2Counter++;
                                                                                            }
                                                                                            else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                            {
                                                                                                Diamond2Ids += MemberID;
                                                                                                Diamond2Counter++;
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                        //Set the Diaomond 2 Rank
                                                                        if (Diamond2Counter < 4096 && Diamond2Counter > 0)
                                                                        {
                                                                            RankFinal = "Diamond2";

                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                            cmd.ExecuteNonQuery();

                                                                                            countLine++;
                                                                                            ResponseMsg += placementid + ", ";
                                                                                        }

                                                                                        using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read())
                                                                                                {
                                                                                                    string STATUSWithd = dr.GetValue(1).ToString();
                                                                                                    if (STATUSWithd == "Paid")
                                                                                                    {
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                                        {//userid,rank,amount,dated,status
                                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                                            cmd.Parameters.AddWithValue("@amount", 600000);
                                                                                                            cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                            cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                    else if (STATUSWithd == "Pending")
                                                                                                    {
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                                        {//userid,rank,amount,dated,status
                                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                        else if (Diamond2Counter == 4096)
                                                                        {
                                                                            /////////////////////////////////////
                                                                            //      Inject Earnings Codes      //
                                                                            ////////////////////////////////////
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    string getRank;
                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                    {
                                                                                        //do nothing
                                                                                        getRank = dr.GetValue(0).ToString();
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        if (getrank == "DiamondLife 2")
                                                                                        {

                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                                    {
                                                                                                        string SN = dr.GetValue(0).ToString();

                                                                                                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                            dr.Dispose();
                                                                                                            using (dr = cmd.ExecuteReader())
                                                                                                            {
                                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                                                {
                                                                                                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                                            cmd.Parameters.AddWithValue("@amountdue", 600000);
                                                                                                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                            cmd.Parameters.AddWithValue("@balance", getBalance + 600000);
                                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                            cmd.ExecuteNonQuery();

                                                                                                        }
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                                            cmd.Parameters.AddWithValue("@amountdue", 600000);
                                                                                                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                            cmd.Parameters.AddWithValue("@balance", 600000);
                                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }

                                                                            ////////////////////////////////////

                                                                            RankFinal = "Sapphire";
                                                                            TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                                            splitUserIds = Diamond2Ids.Split(splitchar1);
                                                                            UserIdsKeep = "";
                                                                            //DrawMatrixNewCounter = 0;
                                                                            fullLength = splitUserIds.Length;

                                                                            for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                                            {
                                                                                string SplitedUserID = splitUserIds[count];

                                                                                if (TotalCounters <= TotalDownlines)
                                                                                {
                                                                                    da.Dispose();
                                                                                    using (da = new SqlDataAdapter())
                                                                                    {
                                                                                        ds = new DataSet();
                                                                                        i = 0;
                                                                                        sql = null;
                                                                                        sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                                        using (cmd = new SqlCommand(sql, con))
                                                                                        {
                                                                                            da.SelectCommand = cmd;
                                                                                            da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                                            dr.Dispose();
                                                                                            da.Fill(ds);

                                                                                            for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                                            {
                                                                                                string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                                if (i < ds.Tables[0].Rows.Count - 1)
                                                                                                {
                                                                                                    Sapphire1Ids += MemberID + " ";
                                                                                                    Sapphire1Counter++;
                                                                                                }
                                                                                                else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                                {
                                                                                                    Sapphire1Ids += MemberID;
                                                                                                    Sapphire1Counter++;
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            //Set the Sapphire 1 Rank
                                                                            if (Sapphire1Counter < 16384 && Sapphire1Counter > 0)
                                                                            {
                                                                                RankFinal = "Sapphire1";

                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                cmd.ExecuteNonQuery();

                                                                                                countLine++;
                                                                                                ResponseMsg += placementid + ", ";
                                                                                            }

                                                                                            using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string STATUSWithd = dr.GetValue(1).ToString();
                                                                                                        if (STATUSWithd == "Paid")
                                                                                                        {
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                                            {//userid,rank,amount,dated,status
                                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                                cmd.Parameters.AddWithValue("@amount", 1500000);
                                                                                                                cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                                cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        else if (STATUSWithd == "Pending")
                                                                                                        {
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                                            {//userid,rank,amount,dated,status
                                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            else if (Sapphire1Counter == 16384)
                                                                            {
                                                                                /////////////////////////////////////
                                                                                //      Inject Earnings Codes      //
                                                                                ////////////////////////////////////
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        string getRank = dr.GetValue(0).ToString();
                                                                                        if (getrank == "SapphireLife 1")
                                                                                        {

                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                                    {
                                                                                                        string SN = dr.GetValue(0).ToString();

                                                                                                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                            dr.Dispose();
                                                                                                            using (dr = cmd.ExecuteReader())
                                                                                                            {
                                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                                                {
                                                                                                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                            cmd.Parameters.AddWithValue("@amountdue", 1500000);
                                                                                                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                            cmd.Parameters.AddWithValue("@balance", getBalance + 1500000);
                                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                            cmd.ExecuteNonQuery();

                                                                                                        }
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                            cmd.Parameters.AddWithValue("@amountdue", 1500000);
                                                                                                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                            cmd.Parameters.AddWithValue("@balance", 1500000);
                                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }

                                                                            ////////////////////////////////////

                                                                            RankFinal = "Sapphire1";
                                                                            TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                                            splitUserIds = Sapphire1Ids.Split(splitchar1);
                                                                            UserIdsKeep = "";
                                                                            //DrawMatrixNewCounter = 0;
                                                                            fullLength = splitUserIds.Length;

                                                                            for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                                            {
                                                                                string SplitedUserID = splitUserIds[count];

                                                                                if (TotalCounters <= TotalDownlines)
                                                                                {
                                                                                    da.Dispose();
                                                                                    using (da = new SqlDataAdapter())
                                                                                    {
                                                                                        ds = new DataSet();
                                                                                        i = 0;
                                                                                        sql = null;
                                                                                        sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                                        using (cmd = new SqlCommand(sql, con))
                                                                                        {
                                                                                            da.SelectCommand = cmd;
                                                                                            da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                                            dr.Dispose();
                                                                                            da.Fill(ds);

                                                                                            for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                                            {
                                                                                                string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                                if (i < ds.Tables[0].Rows.Count - 1)
                                                                                                {
                                                                                                    Sapphire2Ids += MemberID + " ";
                                                                                                    Sapphire2Counter++;
                                                                                                }
                                                                                                else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                                {
                                                                                                    Sapphire2Ids += MemberID;
                                                                                                    Sapphire2Counter++;
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            //Set the Sapphire 2 Rank
                                                                            if (Sapphire2Counter < 65536 && Sapphire2Counter > 0)
                                                                            {
                                                                                RankFinal = "Sapphire2";

                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                cmd.ExecuteNonQuery();

                                                                                                countLine++;
                                                                                                ResponseMsg += placementid + ", ";
                                                                                            }

                                                                                            using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string STATUSWithd = dr.GetValue(1).ToString();
                                                                                                        if (STATUSWithd == "Paid")
                                                                                                        {
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                                            {//userid,rank,amount,dated,status
                                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                                cmd.Parameters.AddWithValue("@amount", 6500000);
                                                                                                                cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                                cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        else if (STATUSWithd == "Pending")
                                                                                                        {
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                                            {//userid,rank,amount,dated,status
                                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            else if (Sapphire2Counter == 65536)
                                                                            {
                                                                                /////////////////////////////////////
                                                                                //      Inject Earnings Codes      //
                                                                                ////////////////////////////////////
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        string getRank;
                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                        {
                                                                                            //do nothing
                                                                                            getRank = dr.GetValue(0).ToString();
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            if (getrank == "SapphireLife 2")
                                                                                            {

                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                                        {
                                                                                                            string SN = dr.GetValue(0).ToString();

                                                                                                            using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                                dr.Dispose();
                                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                                {
                                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                                                    {
                                                                                                                        getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                            { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                                cmd.Parameters.AddWithValue("@amountdue", 6500000);
                                                                                                                cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                                cmd.Parameters.AddWithValue("@balance", getBalance + 6500000);
                                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                                cmd.ExecuteNonQuery();

                                                                                                            }
                                                                                                        }
                                                                                                        else
                                                                                                        {
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                            { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                                cmd.Parameters.AddWithValue("@amountdue", 6500000);
                                                                                                                cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                                cmd.Parameters.AddWithValue("@balance", 6500000);
                                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }

                                                                                ////////////////////////////////////

                                                                                RankFinal = "Emerald";
                                                                                TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                                                splitUserIds = Sapphire2Ids.Split(splitchar1);
                                                                                UserIdsKeep = "";
                                                                                //DrawMatrixNewCounter = 0;
                                                                                fullLength = splitUserIds.Length;

                                                                                for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                                                {
                                                                                    string SplitedUserID = splitUserIds[count];

                                                                                    if (TotalCounters <= TotalDownlines)
                                                                                    {
                                                                                        da.Dispose();
                                                                                        using (da = new SqlDataAdapter())
                                                                                        {
                                                                                            ds = new DataSet();
                                                                                            i = 0;
                                                                                            sql = null;
                                                                                            sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                                            using (cmd = new SqlCommand(sql, con))
                                                                                            {
                                                                                                da.SelectCommand = cmd;
                                                                                                da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                                                dr.Dispose();
                                                                                                da.Fill(ds);

                                                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                                                {
                                                                                                    string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                                    if (i < ds.Tables[0].Rows.Count - 1)
                                                                                                    {
                                                                                                        EmeraldIds += MemberID + " ";
                                                                                                        EmeraldCounter++;
                                                                                                    }
                                                                                                    else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                                    {
                                                                                                        EmeraldIds += MemberID;
                                                                                                        EmeraldCounter++;
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                                //Set the Emerald Rank
                                                                                if (EmeraldCounter < 262144 && EmeraldCounter > 0)
                                                                                {
                                                                                    RankFinal = "Emerald";

                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                            {
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                    cmd.ExecuteNonQuery();

                                                                                                    countLine++;
                                                                                                    ResponseMsg += placementid + ", ";
                                                                                                }

                                                                                                using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string STATUSWithd = dr.GetValue(1).ToString();
                                                                                                            if (STATUSWithd == "Paid")
                                                                                                            {
                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                                                {//userid,rank,amount,dated,status
                                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                                    cmd.Parameters.AddWithValue("@amount", 28000000);
                                                                                                                    cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                                    cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            else if (STATUSWithd == "Pending")
                                                                                                            {
                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                                                {//userid,rank,amount,dated,status
                                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                                else if (EmeraldCounter == 262144)
                                                                                {
                                                                                    /////////////////////////////////////
                                                                                    //      Inject Earnings Codes      //
                                                                                    ////////////////////////////////////
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            string getRank;
                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                            {
                                                                                                //do nothing
                                                                                                getRank = dr.GetValue(0).ToString();
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                if (getrank == "EmeraldLife")
                                                                                                {

                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                                    {
                                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                        using (dr = cmd.ExecuteReader())
                                                                                                        {
                                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                                            {
                                                                                                                string SN = dr.GetValue(0).ToString();

                                                                                                                using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                                    dr.Dispose();
                                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                                    {
                                                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                                                        {
                                                                                                                            getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                                        }
                                                                                                                    }
                                                                                                                }
                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                                { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                    cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                                    cmd.Parameters.AddWithValue("@amountdue", 28000000);
                                                                                                                    cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                                    cmd.Parameters.AddWithValue("@balance", getBalance + 28000000);
                                                                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                                    cmd.ExecuteNonQuery();

                                                                                                                }
                                                                                                            }
                                                                                                            else
                                                                                                            {
                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                                { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                    cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                                    cmd.Parameters.AddWithValue("@amountdue", 28000000);
                                                                                                                    cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                                    cmd.Parameters.AddWithValue("@balance", 28000000);
                                                                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }

                                                                                    ////////////////////////////////////

                                                                                    RankFinal = "Emerald Life Complete";
                                                                                    TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            RankFinal = "No Rank";
                                        }
                                    }

                                    //Update Downlines Count
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Select userid from downlinescount where userid=@userid", con))
                                    {
                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                        using (dr = cmd.ExecuteReader())
                                        {
                                            if (dr.Read())
                                            {
                                                //Update
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Update downlinescount set downlines=@downlines,rank=@rank where userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@downlines", TotalDownlines);
                                                    cmd.Parameters.AddWithValue("@rank", RankFinal);
                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                    cmd.ExecuteNonQuery();
                                                }
                                            }
                                            else
                                            {
                                                //Insert
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Insert into downlinescount (userid,downlines,rank) values (@userid,@downlines,@rank)", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                    cmd.Parameters.AddWithValue("@downlines", TotalDownlines);
                                                    cmd.Parameters.AddWithValue("@rank", RankFinal);
                                                    cmd.ExecuteNonQuery();
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                ResponseMsg += placementid + ", " + countLine;
            }
        }
        
        public void Regularise()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();

                using (da = new SqlDataAdapter())
                {
                    //, con
                    DataSet ds = new DataSet();
                    int i = 0;
                    string sql = null;
                    sql = "Select userid,partnername from register";
                    using (cmd = new SqlCommand(sql, con))
                    {
                        da.SelectCommand = cmd;
                        //da.SelectCommand.Parameters.AddWithValue("@placementid", placementid);
                        //dr.Dispose();
                        da.Fill(ds);

                        //Silver Stage 1
                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                        {
                            countLine = 1;
                            string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                            //string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                            //string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                            //string Rank = "SilverLife 1";
                            //string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                            if (PlacementID == "EE2BD0")
                            {
                                Checker = "Seen";    
                            }

                            //Regularise Earnings
                            using(cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                            {
                                cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                cmd.Parameters.AddWithValue("@userid", PlacementID);
                                cmd.Parameters.AddWithValue("@status", "Paid");
                                using(dr = cmd.ExecuteReader())
                                {
                                    if(dr.Read())
                                    {
                                        UserIdsKeep = dr.GetValue(0).ToString();
                                        Checker = "Paid";
                                        //SilverLife 1
                                        if (UserIdsKeep == "SilverLife 1")
                                        {
                                            dr.Dispose();
                                            using(cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                using(dr = cmd.ExecuteReader())
                                                {
                                                    if(dr.Read() && !dr.IsDBNull(0))
                                                    {
                                                        countLine = int.Parse(dr.GetValue(0).ToString());
                                                        if(countLine > 1)
                                                        {
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    {
                                                                        SN = int.Parse(dr.GetValue(0).ToString());
                                                                        dr.Dispose();
                                                                        ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            dr.Dispose();
                                                            using(cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                using(dr = cmd.ExecuteReader())
                                                                {
                                                                    if(dr.Read())
                                                                    {
                                                                        string status = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        if(status == "Pending")
                                                                        {
                                                                            using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                                cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                cmd.ExecuteNonQuery();
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //SilverLife 2
                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            dr.Dispose();
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    UserIdsKeep = dr.GetValue(0).ToString();
                                                    if (UserIdsKeep == "SilverLife 2")
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    countLine = int.Parse(dr.GetValue(0).ToString());
                                                                    if (countLine > 1)
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    SN = int.Parse(dr.GetValue(0).ToString());
                                                                                    ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string status = dr.GetValue(0).ToString();
                                                                                    dr.Dispose();
                                                                                    if (status == "Pending")
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //GoldLife 1
                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            dr.Dispose();
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    UserIdsKeep = dr.GetValue(0).ToString();
                                                    if (UserIdsKeep == "GoldLife 1")
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    countLine = int.Parse(dr.GetValue(0).ToString());
                                                                    if (countLine > 1)
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    SN = int.Parse(dr.GetValue(0).ToString());
                                                                                    dr.Dispose();
                                                                                    ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string status = dr.GetValue(0).ToString();
                                                                                    dr.Dispose();
                                                                                    if (status == "Pending")
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //GoldLife 2
                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            dr.Dispose();
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    UserIdsKeep = dr.GetValue(0).ToString();
                                                    if (UserIdsKeep == "GoldLife 2")
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    countLine = int.Parse(dr.GetValue(0).ToString());
                                                                    if (countLine > 1)
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    SN = int.Parse(dr.GetValue(0).ToString());
                                                                                    dr.Dispose();
                                                                                    ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string status = dr.GetValue(0).ToString();
                                                                                    dr.Dispose();
                                                                                    if (status == "Pending")
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //DiamondLife 1
                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            dr.Dispose();
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    UserIdsKeep = dr.GetValue(0).ToString();
                                                    if (UserIdsKeep == "DiamondLife 1")
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    countLine = int.Parse(dr.GetValue(0).ToString());
                                                                    if (countLine > 1)
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    SN = int.Parse(dr.GetValue(0).ToString());
                                                                                    dr.Dispose();
                                                                                    ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string status = dr.GetValue(0).ToString();
                                                                                    dr.Dispose();
                                                                                    if (status == "Pending")
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //DiamondLife 2
                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            dr.Dispose();
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    UserIdsKeep = dr.GetValue(0).ToString();
                                                    if (UserIdsKeep == "DiamondLife 2")
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    countLine = int.Parse(dr.GetValue(0).ToString());
                                                                    if (countLine > 1)
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    SN = int.Parse(dr.GetValue(0).ToString());
                                                                                    dr.Dispose();
                                                                                    ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string status = dr.GetValue(0).ToString();
                                                                                    dr.Dispose();
                                                                                    if (status == "Pending")
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //SapphireLife 1
                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            dr.Dispose();
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    UserIdsKeep = dr.GetValue(0).ToString();
                                                    if (UserIdsKeep == "SapphireLife 1")
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    countLine = int.Parse(dr.GetValue(0).ToString());
                                                                    if (countLine > 1)
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    SN = int.Parse(dr.GetValue(0).ToString());
                                                                                    ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string status = dr.GetValue(0).ToString();
                                                                                    dr.Dispose();
                                                                                    if (status == "Pending")
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //SapphireLife 2
                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            dr.Dispose();
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    UserIdsKeep = dr.GetValue(0).ToString();
                                                    if (UserIdsKeep == "SapphireLife 2")
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    countLine = int.Parse(dr.GetValue(0).ToString());
                                                                    if (countLine > 1)
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    SN = int.Parse(dr.GetValue(0).ToString());
                                                                                    dr.Dispose();
                                                                                    ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string status = dr.GetValue(0).ToString();
                                                                                    dr.Dispose();
                                                                                    if (status == "Pending")
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //EmeraldLife
                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and status=@status and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            dr.Dispose();
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    UserIdsKeep = dr.GetValue(0).ToString();
                                                    if (UserIdsKeep == "EmeraldLife")
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Count(userid) from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    countLine = int.Parse(dr.GetValue(0).ToString());
                                                                    if (countLine > 1)
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    SN = int.Parse(dr.GetValue(0).ToString());
                                                                                    dr.Dispose();
                                                                                    ResponseMsg += "Duplicate records:" + SN + ", ";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select status from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string status = dr.GetValue(0).ToString();
                                                                                    dr.Dispose();
                                                                                    if (status == "Pending")
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Update earnings set status=@status where userid=@userid and rank=@rank", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", PlacementID);
                                                                                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }









                                    }
                                }
                            }
                        }
                        //ResponseMsg = UserIdsKeep;
                    }
                }

                using(cmd = new SqlCommand("",con))
                {

                }
            }
        }

        public void Subscribe()
        {
            if (email == "")
            {
                ResponseMsg = "Empty field(s).";
            }
            else
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select email from subscribe where email=@email", con))
                    {
                        cmd.Parameters.AddWithValue("@email", email);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                ResponseMsg = "0";
                            }
                            else
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Insert into subscribe(email) values (@email)", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.ExecuteNonQuery();
                                    ResponseMsg = "1";
                                }
                            }
                        }
                    }
                }
            }
        }

        public void ViewReferralTracker()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Drop table ReferralTraceRun", con))
                {
                    cmd.ExecuteNonQuery();
                }

                using (cmd = new SqlCommand("SELECT Userid,Username,Datecreated,refid,SN into ReferralTraceRun FROM CommissionsRef where refid=@userid order by SN", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    cmd.ExecuteNonQuery();
                }

                using (cmd = new SqlCommand("Select * from ReferralTraceRun where refid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {

                        }
                        else
                        {
                            ResponseMsg = "Empty";
                        }
                    }
                }
            }
        }

        public void ViewWithdrawalTracker()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Drop table WithdrawalTraceRun", con))
                {
                    cmd.ExecuteNonQuery();
                }

                using (cmd = new SqlCommand("SELECT * into WithdrawalTraceRun FROM Withdrawals where userid=@userid order by SN", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    cmd.ExecuteNonQuery();
                }

                using (cmd = new SqlCommand("Select * from WithdrawalTraceRun where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {

                        }
                        else
                        {
                            ResponseMsg = "Empty";
                        }
                    }
                }
            }
        }

        public void SubmitWithdrawalCode()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Update register set code=@code,codestatus=@codestatus where userid=@userid", con))
                {
                    int yourRandomEmailString = 6; //maximum: 32 
                    string urlCode = Guid.NewGuid().ToString("N").Substring(0, yourRandomEmailString);
                    cmd.Parameters.AddWithValue("@code", urlCode);
                    cmd.Parameters.AddWithValue("@codestatus", 0);
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    cmd.ExecuteNonQuery();
                    ResponseMsg = urlCode;
                }
            }
        }

        public void SubmitWithdrawTrail()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select rank from withdrawTrail where userid=@userid and rank=@rank", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    cmd.Parameters.AddWithValue("@rank", rankW);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            ResponseMsg = "This withdrawal transaction may have been previously processed or uncompleted.";
                        }
                        else
                        {
                            //WithdrawTrail
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and rank=@rank", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserId);
                                cmd.Parameters.AddWithValue("@rank", rankW);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        ResponseMsg = "This withdrawal transaction may have been previously processed or uncompleted.";
                                    }
                                    else
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Select rank from withdrawtrail where userid=@userid and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                            cmd.Parameters.AddWithValue("@rank", rankW);
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    ResponseMsg = "This withdrawal may have been previously processed. ";
                                                }
                                                else
                                                {
                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Insert into WithdrawTrail(userid,name,rank,category,duration,amount,deduction,balance,status,dd,mm,yy,date) values (@userid,@name,@rank,@category,@duration,@amount,@deduction,@balance,@status,@dd,@mm,@yy,@date)", con))
                                                    {//userid,name,rank,category,amount,deduction,balance,status,dd,mm,yy,date
                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                        cmd.Parameters.AddWithValue("@name", nameW);
                                                        cmd.Parameters.AddWithValue("@rank", rankW);
                                                        cmd.Parameters.AddWithValue("@category", categoryW);
                                                        cmd.Parameters.AddWithValue("@duration", durationW);
                                                        cmd.Parameters.AddWithValue("@amount", amountW);
                                                        cmd.Parameters.AddWithValue("@deduction", deductionW);
                                                        cmd.Parameters.AddWithValue("@balance", balanceW);
                                                        cmd.Parameters.AddWithValue("@status", statusW);
                                                        cmd.Parameters.AddWithValue("@dd", ddW);
                                                        cmd.Parameters.AddWithValue("@mm", mmW);
                                                        cmd.Parameters.AddWithValue("@yy", yyW);
                                                        cmd.Parameters.AddWithValue("@date", dateW);
                                                        cmd.ExecuteNonQuery();
                                                        ResponseMsg = "Saved!";
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        public void SubmitWithdrawals()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();


                using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    cmd.Parameters.AddWithValue("@rank", MatrixRank);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && MatrixRank != "Referral Bonus")
                        {
                            ResponseMsg = "This earning has been previously processed!";
                        }
                        else
                        {
                            //dr.Dispose();
                            //using (cmd = new SqlCommand("Select code from register where userid=@userid", con))
                            //{
                            //    cmd.Parameters.AddWithValue("@userid", UserId);
                            //    using (dr = cmd.ExecuteReader())
                            //    {
                            //        if (dr.Read())
                            //        {
                            //            string getCode = dr.GetValue(0).ToString();
                            //            if (getCode == emailConfCODE)
                            //            {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and rank=@rank", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.Parameters.AddWithValue("@rank", MatrixRank);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read())
                                                    {
                                                        string rank = dr.GetValue(0).ToString();
                                                        if (rank == "Referral Bonus")
                                                        {
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank and status=@status", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        ResponseMsg = "You have a withdrawal for " + MatrixRank + " that is still pending. You can only make another withdrawal when the previous one is confirmed.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from withdrawals where userid=@userid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    string getSN = dr.GetValue(0).ToString();

                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select totearning,totwithdraw,newbalance from withdrawals where userid=@userid and sn=@sn", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                        cmd.Parameters.AddWithValue("@sn", getSN);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                            {

                                                                                                totearningW = dr.GetValue(0).ToString();
                                                                                                totwithdrawW = dr.GetValue(1).ToString();
                                                                                                prevbalanceW = dr.GetValue(2).ToString();

                                                                                                newbalanceW = (int.Parse(prevbalanceW) + int.Parse(thiswithdrawW)).ToString();
                                                                                                using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                                                                                                {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                                                                                                    cmd.Parameters.AddWithValue("@name", nameW);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                                                                                    cmd.Parameters.AddWithValue("@totearning", int.Parse(totearningW) + int.Parse(thiswithdrawW));
                                                                                                    cmd.Parameters.AddWithValue("@totwithdraw", int.Parse(totwithdrawW) + int.Parse(thiswithdrawW));
                                                                                                    cmd.Parameters.AddWithValue("@prevbalance", prevbalanceW);
                                                                                                    cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                                                                                                    cmd.Parameters.AddWithValue("@newbalance", newbalanceW);
                                                                                                    cmd.Parameters.AddWithValue("@dd", ddW);
                                                                                                    cmd.Parameters.AddWithValue("@mm", mmW);
                                                                                                    cmd.Parameters.AddWithValue("@yy", yyW);
                                                                                                    cmd.Parameters.AddWithValue("@date", dateW);
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();

                                                                                                    //Update Referral Earnings
                                                                                                    using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                                                                                                    {
                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                        using (dr = cmd.ExecuteReader())
                                                                                                        {
                                                                                                            if (dr.Read())
                                                                                                            {
                                                                                                                int amountdue = int.Parse(dr.GetValue(0).ToString());
                                                                                                                int deduction = int.Parse(dr.GetValue(1).ToString());
                                                                                                                int newDeduction = deduction + int.Parse(thiswithdrawW);
                                                                                                                int RefBalance = int.Parse(dr.GetValue(2).ToString());
                                                                                                                int newRefBalance = RefBalance - int.Parse(thiswithdrawW);

                                                                                                                using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@balance", newRefBalance);
                                                                                                                    cmd.Parameters.AddWithValue("@deductions", newDeduction);
                                                                                                                    cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                    dr.Dispose();
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }

                                                                                                    ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. The transfer process will be complete within 72 hours. Thank you.";
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                                                                                    {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                                                                                        cmd.Parameters.AddWithValue("@name", nameW);
                                                                                        cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                                                                        cmd.Parameters.AddWithValue("@totearning", thiswithdrawW);
                                                                                        cmd.Parameters.AddWithValue("@totwithdraw", thiswithdrawW);
                                                                                        cmd.Parameters.AddWithValue("@prevbalance", 0);
                                                                                        cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                                                                                        cmd.Parameters.AddWithValue("@newbalance", thiswithdrawW);
                                                                                        cmd.Parameters.AddWithValue("@dd", ddW);
                                                                                        cmd.Parameters.AddWithValue("@mm", mmW);
                                                                                        cmd.Parameters.AddWithValue("@yy", yyW);
                                                                                        cmd.Parameters.AddWithValue("@date", dateW);
                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                        cmd.ExecuteNonQuery();

                                                                                        //Update Referral Earnings
                                                                                        using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read())
                                                                                                {
                                                                                                    int amountdue = int.Parse(dr.GetValue(0).ToString());
                                                                                                    int deduction = int.Parse(dr.GetValue(1).ToString());
                                                                                                    int newDeduction = deduction + int.Parse(thiswithdrawW);
                                                                                                    int RefBalance = int.Parse(dr.GetValue(2).ToString());
                                                                                                    int newRefBalance = RefBalance - int.Parse(thiswithdrawW);

                                                                                                    using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                                                                                                    {
                                                                                                        cmd.Parameters.AddWithValue("@balance", newRefBalance);
                                                                                                        cmd.Parameters.AddWithValue("@deductions", newDeduction);
                                                                                                        cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                        dr.Dispose();
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }

                                                                                        ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. the transfer process will be complete within 72 hours. Thank you.";
                                                                                    }

                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            ResponseMsg = "This record already exists!";
                                                        }
                                                    }
                                                    else
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank and status=@status", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                            cmd.Parameters.AddWithValue("@rank", MatrixRank);
                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    ResponseMsg = "You have a withdrawal " + MatrixRank + " is still pending. You can only make another withdrawal when the previous one is confirmed.";
                                                                }
                                                                else
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select Max(SN) from withdrawals where userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                string getSN = dr.GetValue(0).ToString();

                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select totearning,totwithdraw,newbalance from withdrawals where userid=@userid and sn=@sn", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@sn", getSN);
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                        {

                                                                                            totearningW = dr.GetValue(0).ToString();
                                                                                            totwithdrawW = dr.GetValue(1).ToString();
                                                                                            prevbalanceW = dr.GetValue(2).ToString();

                                                                                            newbalanceW = (int.Parse(prevbalanceW) + int.Parse(thiswithdrawW)).ToString();
                                                                                            using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                                                                                            {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                                                                                                cmd.Parameters.AddWithValue("@name", nameW);
                                                                                                cmd.Parameters.AddWithValue("@rank", rankW);
                                                                                                cmd.Parameters.AddWithValue("@totearning", int.Parse(totearningW) + int.Parse(thiswithdrawW));
                                                                                                cmd.Parameters.AddWithValue("@totwithdraw", int.Parse(totwithdrawW) + int.Parse(thiswithdrawW));
                                                                                                cmd.Parameters.AddWithValue("@prevbalance", prevbalanceW);
                                                                                                cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                                                                                                cmd.Parameters.AddWithValue("@newbalance", newbalanceW);
                                                                                                cmd.Parameters.AddWithValue("@dd", ddW);
                                                                                                cmd.Parameters.AddWithValue("@mm", mmW);
                                                                                                cmd.Parameters.AddWithValue("@yy", yyW);
                                                                                                cmd.Parameters.AddWithValue("@date", dateW);
                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();
                                                                                                ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. The transfer process will be complete within 72 hours. Thank you.";
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                                                                                {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                                                                                    cmd.Parameters.AddWithValue("@name", nameW);
                                                                                    cmd.Parameters.AddWithValue("@rank", rankW);
                                                                                    cmd.Parameters.AddWithValue("@totearning", thiswithdrawW);
                                                                                    cmd.Parameters.AddWithValue("@totwithdraw", thiswithdrawW);
                                                                                    cmd.Parameters.AddWithValue("@prevbalance", 0);
                                                                                    cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                                                                                    cmd.Parameters.AddWithValue("@newbalance", thiswithdrawW);
                                                                                    cmd.Parameters.AddWithValue("@dd", ddW);
                                                                                    cmd.Parameters.AddWithValue("@mm", mmW);
                                                                                    cmd.Parameters.AddWithValue("@yy", yyW);
                                                                                    cmd.Parameters.AddWithValue("@date", dateW);
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                    cmd.ExecuteNonQuery();
                                                                                    ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. the transfer process will be complete within 72 hours. Thank you.";
                                                                                }

                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                            //            }
                            //            else
                            //            {
                            //                ResponseMsg = "Invalid Confirmation Code!";
                            //            }
                            //        }
                            //    }
                            //}
                        }
                    }
                }
                //using (cmd = new SqlCommand("Select SN,useridname,username from placement where userid=@userid", con))
                //{
                //    cmd.Parameters.AddWithValue("@userid", UserId);
                //    using (dr = cmd.ExecuteReader())
                //    {
                //        if (dr.Read())
                //        {
                //            int SNw = int.Parse(dr.GetValue(0).ToString());
                //            string partnerW = dr.GetValue(1).ToString();
                //            string getEmailW = dr.GetValue(2).ToString();

                //            dr.Dispose();
                //            using (cmd = new SqlCommand("Select count(sn) from placement where useridname=@partnername and username=@email", con))
                //            {
                //                cmd.Parameters.AddWithValue("@partnername", partnerW);
                //                cmd.Parameters.AddWithValue("@email", getEmailW);
                //                using (dr = cmd.ExecuteReader())
                //                {
                //                    if (dr.Read())
                //                    {
                //                        int getCountW = int.Parse(dr.GetValue(0).ToString());
                //                        if (getCountW > 1)
                //                        {
                //                            dr.Dispose();
                //                            using (cmd = new SqlCommand("Select userid from placement where useridname=@partnername and username=@email and sn<@sn", con))
                //                            {
                //                                cmd.Parameters.AddWithValue("@partnername", partnerW);
                //                                cmd.Parameters.AddWithValue("@email", getEmailW);
                //                                cmd.Parameters.AddWithValue("@sn", SNw);
                //                                using(dr = cmd.ExecuteReader())
                //                                {
                //                                    if(dr.Read())
                //                                    {
                //                                        dr.Dispose();
                //                                        using (da = new SqlDataAdapter())
                //                                        {
                //                                            DataSet ds = new DataSet();
                //                                            int i = 0;
                //                                            string sql = null;
                //                                            sql = "Select userid from placement where useridname=@partnername and username=@email and sn<@sn";
                //                                            using (cmd = new SqlCommand(sql, con))
                //                                            {
                //                                                da.SelectCommand = cmd;
                //                                                da.SelectCommand.Parameters.AddWithValue("@partnername", partnerW);
                //                                                da.SelectCommand.Parameters.AddWithValue("@email", getEmailW);
                //                                                da.SelectCommand.Parameters.AddWithValue("@sn", SNw);
                //                                                dr.Dispose();
                //                                                da.Fill(ds);
                //                                                int counter = 0;

                //                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                //                                                {
                //                                                    string UserIDw = ds.Tables[0].Rows[i].ItemArray[0].ToString();

                //                                                    using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank", con))
                //                                                    {
                //                                                        cmd.Parameters.AddWithValue("@userid", UserIDw);
                //                                                        cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                                        using (dr = cmd.ExecuteReader())
                //                                                        {
                //                                                            if (dr.Read() && i <= ds.Tables[0].Rows.Count - 1)
                //                                                            {
                //                                                                counter++;
                //                                                                if (counter == ds.Tables[0].Rows.Count - 1)
                //                                                                {
                //                                                                    dr.Dispose();
                //                                                                    using (cmd = new SqlCommand("Select code from register where userid=@userid", con))
                //                                                                    {
                //                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                        using (dr = cmd.ExecuteReader())
                //                                                                        {
                //                                                                            if (dr.Read())
                //                                                                            {
                //                                                                                string getCode = dr.GetValue(0).ToString();
                //                                                                                if (getCode == emailConfCODE)
                //                                                                                {
                //                                                                                    dr.Dispose();
                //                                                                                    using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and rank=@rank", con))
                //                                                                                    {
                //                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                        cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                                                                        using (dr = cmd.ExecuteReader())
                //                                                                                        {
                //                                                                                            if (dr.Read())
                //                                                                                            {
                //                                                                                                string rank = dr.GetValue(0).ToString();
                //                                                                                                if (rank == "Referral Bonus")
                //                                                                                                {
                //                                                                                                    dr.Dispose();
                //                                                                                                    using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank and status=@status", con))
                //                                                                                                    {
                //                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                        cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                        using (dr = cmd.ExecuteReader())
                //                                                                                                        {
                //                                                                                                            if (dr.Read())
                //                                                                                                            {
                //                                                                                                                ResponseMsg = "You have a withdrawal for " + MatrixRank + " that is still pending. You can only make another withdrawal when the previous one is confirmed.";
                //                                                                                                            }
                //                                                                                                            else
                //                                                                                                            {
                //                                                                                                                dr.Dispose();
                //                                                                                                                using (cmd = new SqlCommand("Select Max(SN) from withdrawals where userid=@userid", con))
                //                                                                                                                {
                //                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                                                    {
                //                                                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                                        {
                //                                                                                                                            string getSN = dr.GetValue(0).ToString();

                //                                                                                                                            dr.Dispose();
                //                                                                                                                            using (cmd = new SqlCommand("Select totearning,totwithdraw,newbalance from withdrawals where userid=@userid and sn=@sn", con))
                //                                                                                                                            {
                //                                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                cmd.Parameters.AddWithValue("@sn", getSN);
                //                                                                                                                                using (dr = cmd.ExecuteReader())
                //                                                                                                                                {
                //                                                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                                                    {

                //                                                                                                                                        totearningW = dr.GetValue(0).ToString();
                //                                                                                                                                        totwithdrawW = dr.GetValue(1).ToString();
                //                                                                                                                                        prevbalanceW = dr.GetValue(2).ToString();

                //                                                                                                                                        newbalanceW = (int.Parse(prevbalanceW) + int.Parse(thiswithdrawW)).ToString();
                //                                                                                                                                        using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                                                        {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                                                            cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                                            cmd.Parameters.AddWithValue("@totearning", int.Parse(totearningW) + int.Parse(thiswithdrawW));
                //                                                                                                                                            cmd.Parameters.AddWithValue("@totwithdraw", int.Parse(totwithdrawW) + int.Parse(thiswithdrawW));
                //                                                                                                                                            cmd.Parameters.AddWithValue("@prevbalance", prevbalanceW);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@newbalance", newbalanceW);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                                                            dr.Dispose();
                //                                                                                                                                            cmd.ExecuteNonQuery();

                //                                                                                                                                            //Update Referral Earnings
                //                                                                                                                                            using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                //                                                                                                                                            {
                //                                                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                                using (dr = cmd.ExecuteReader())
                //                                                                                                                                                {
                //                                                                                                                                                    if (dr.Read())
                //                                                                                                                                                    {
                //                                                                                                                                                        int amountdue = int.Parse(dr.GetValue(0).ToString());
                //                                                                                                                                                        int deduction = int.Parse(dr.GetValue(1).ToString());
                //                                                                                                                                                        int newDeduction = deduction + int.Parse(thiswithdrawW);
                //                                                                                                                                                        int RefBalance = int.Parse(dr.GetValue(2).ToString());
                //                                                                                                                                                        int newRefBalance = RefBalance - int.Parse(thiswithdrawW);

                //                                                                                                                                                        using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                //                                                                                                                                                        {
                //                                                                                                                                                            cmd.Parameters.AddWithValue("@balance", newRefBalance);
                //                                                                                                                                                            cmd.Parameters.AddWithValue("@deductions", newDeduction);
                //                                                                                                                                                            cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                                            dr.Dispose();
                //                                                                                                                                                            cmd.ExecuteNonQuery();
                //                                                                                                                                                        }
                //                                                                                                                                                    }
                //                                                                                                                                                }
                //                                                                                                                                            }

                //                                                                                                                                            ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. The transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                                                        }
                //                                                                                                                                    }
                //                                                                                                                                }
                //                                                                                                                            }
                //                                                                                                                        }
                //                                                                                                                        else
                //                                                                                                                        {
                //                                                                                                                            dr.Dispose();
                //                                                                                                                            using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                                            {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                                                cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                                cmd.Parameters.AddWithValue("@totearning", thiswithdrawW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@totwithdraw", thiswithdrawW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@prevbalance", 0);
                //                                                                                                                                cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@newbalance", thiswithdrawW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                                                cmd.ExecuteNonQuery();

                //                                                                                                                                //Update Referral Earnings
                //                                                                                                                                using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                //                                                                                                                                {
                //                                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                                                                    {
                //                                                                                                                                        if (dr.Read())
                //                                                                                                                                        {
                //                                                                                                                                            int amountdue = int.Parse(dr.GetValue(0).ToString());
                //                                                                                                                                            int deduction = int.Parse(dr.GetValue(1).ToString());
                //                                                                                                                                            int newDeduction = deduction + int.Parse(thiswithdrawW);
                //                                                                                                                                            int RefBalance = int.Parse(dr.GetValue(2).ToString());
                //                                                                                                                                            int newRefBalance = RefBalance - int.Parse(thiswithdrawW);

                //                                                                                                                                            using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                //                                                                                                                                            {
                //                                                                                                                                                cmd.Parameters.AddWithValue("@balance", newRefBalance);
                //                                                                                                                                                cmd.Parameters.AddWithValue("@deductions", newDeduction);
                //                                                                                                                                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                                dr.Dispose();
                //                                                                                                                                                cmd.ExecuteNonQuery();
                //                                                                                                                                            }
                //                                                                                                                                        }
                //                                                                                                                                    }
                //                                                                                                                                }

                //                                                                                                                                ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. the transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                                            }

                //                                                                                                                        }
                //                                                                                                                    }
                //                                                                                                                }
                //                                                                                                            }
                //                                                                                                        }
                //                                                                                                    }
                //                                                                                                }
                //                                                                                                else
                //                                                                                                {
                //                                                                                                    ResponseMsg = "This record already exists!";
                //                                                                                                }
                //                                                                                            }
                //                                                                                            else
                //                                                                                            {
                //                                                                                                dr.Dispose();
                //                                                                                                using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank and status=@status", con))
                //                                                                                                {
                //                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                    cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                                    {
                //                                                                                                        if (dr.Read())
                //                                                                                                        {
                //                                                                                                            ResponseMsg = "You have a withdrawal " + MatrixRank + " is still pending. You can only make another withdrawal when the previous one is confirmed.";
                //                                                                                                        }
                //                                                                                                        else
                //                                                                                                        {
                //                                                                                                            dr.Dispose();
                //                                                                                                            using (cmd = new SqlCommand("Select Max(SN) from withdrawals where userid=@userid", con))
                //                                                                                                            {
                //                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                using (dr = cmd.ExecuteReader())
                //                                                                                                                {
                //                                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                                    {
                //                                                                                                                        string getSN = dr.GetValue(0).ToString();

                //                                                                                                                        dr.Dispose();
                //                                                                                                                        using (cmd = new SqlCommand("Select totearning,totwithdraw,newbalance from withdrawals where userid=@userid and sn=@sn", con))
                //                                                                                                                        {
                //                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                            cmd.Parameters.AddWithValue("@sn", getSN);
                //                                                                                                                            using (dr = cmd.ExecuteReader())
                //                                                                                                                            {
                //                                                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                                                {

                //                                                                                                                                    totearningW = dr.GetValue(0).ToString();
                //                                                                                                                                    totwithdrawW = dr.GetValue(1).ToString();
                //                                                                                                                                    prevbalanceW = dr.GetValue(2).ToString();

                //                                                                                                                                    newbalanceW = (int.Parse(prevbalanceW) + int.Parse(thiswithdrawW)).ToString();
                //                                                                                                                                    using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                                                    {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                                                        cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@rank", rankW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@totearning", int.Parse(totearningW) + int.Parse(thiswithdrawW));
                //                                                                                                                                        cmd.Parameters.AddWithValue("@totwithdraw", int.Parse(totwithdrawW) + int.Parse(thiswithdrawW));
                //                                                                                                                                        cmd.Parameters.AddWithValue("@prevbalance", prevbalanceW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@newbalance", newbalanceW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                                                        dr.Dispose();
                //                                                                                                                                        cmd.ExecuteNonQuery();
                //                                                                                                                                        ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. The transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                                                    }
                //                                                                                                                                }
                //                                                                                                                            }
                //                                                                                                                        }
                //                                                                                                                    }
                //                                                                                                                    else
                //                                                                                                                    {
                //                                                                                                                        dr.Dispose();
                //                                                                                                                        using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                                        {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                                            cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@rank", rankW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@totearning", thiswithdrawW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@totwithdraw", thiswithdrawW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@prevbalance", 0);
                //                                                                                                                            cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@newbalance", thiswithdrawW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                                            cmd.ExecuteNonQuery();
                //                                                                                                                            ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. the transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                                        }

                //                                                                                                                    }
                //                                                                                                                }
                //                                                                                                            }
                //                                                                                                        }
                //                                                                                                    }
                //                                                                                                }

                //                                                                                            }
                //                                                                                        }
                //                                                                                    }
                //                                                                                }
                //                                                                                else
                //                                                                                {
                //                                                                                    ResponseMsg = "Invalid Confirmation Code!";
                //                                                                                }
                //                                                                            }
                //                                                                        }
                //                                                                    }
                //                                                                }
                //                                                            }
                //                                                            else
                //                                                            {
                //                                                                ResponseMsg = "You have one/more of your accounts (e.g " + UserIDw + ") that should have attained the rank (" + MatrixRank + ") before " + UserId + ". You will have to build that/those account(s) before proceeding with this withdrawal.";
                //                                                            }
                //                                                        }
                //                                                    }
                //                                                }
                //                                            }
                //                                        }
                //                                    }
                //                                    else
                //                                    {
                //                                        dr.Dispose();
                //                                        using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank", con))
                //                                        {
                //                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                            cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                            using (dr = cmd.ExecuteReader())
                //                                            {
                //                                                if (dr.Read())
                //                                                {
                //                                                    ResponseMsg = "This earning has been previously processed!";
                //                                                }
                //                                                else
                //                                                {
                //                                                    dr.Dispose();
                //                                                    using (cmd = new SqlCommand("Select code from register where userid=@userid", con))
                //                                                    {
                //                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                        using (dr = cmd.ExecuteReader())
                //                                                        {
                //                                                            if (dr.Read())
                //                                                            {
                //                                                                string getCode = dr.GetValue(0).ToString();
                //                                                                if (getCode == emailConfCODE)
                //                                                                {
                //                                                                    dr.Dispose();
                //                                                                    using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and rank=@rank", con))
                //                                                                    {
                //                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                        cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                                                        using (dr = cmd.ExecuteReader())
                //                                                                        {
                //                                                                            if (dr.Read())
                //                                                                            {
                //                                                                                string rank = dr.GetValue(0).ToString();
                //                                                                                if (rank == "Referral Bonus")
                //                                                                                {
                //                                                                                    dr.Dispose();
                //                                                                                    using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank and status=@status", con))
                //                                                                                    {
                //                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                        cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                        using (dr = cmd.ExecuteReader())
                //                                                                                        {
                //                                                                                            if (dr.Read())
                //                                                                                            {
                //                                                                                                ResponseMsg = "You have a withdrawal for " + MatrixRank + " that is still pending. You can only make another withdrawal when the previous one is confirmed.";
                //                                                                                            }
                //                                                                                            else
                //                                                                                            {
                //                                                                                                dr.Dispose();
                //                                                                                                using (cmd = new SqlCommand("Select Max(SN) from withdrawals where userid=@userid", con))
                //                                                                                                {
                //                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                                    {
                //                                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                        {
                //                                                                                                            string getSN = dr.GetValue(0).ToString();

                //                                                                                                            dr.Dispose();
                //                                                                                                            using (cmd = new SqlCommand("Select totearning,totwithdraw,newbalance from withdrawals where userid=@userid and sn=@sn", con))
                //                                                                                                            {
                //                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                cmd.Parameters.AddWithValue("@sn", getSN);
                //                                                                                                                using (dr = cmd.ExecuteReader())
                //                                                                                                                {
                //                                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                                    {

                //                                                                                                                        totearningW = dr.GetValue(0).ToString();
                //                                                                                                                        totwithdrawW = dr.GetValue(1).ToString();
                //                                                                                                                        prevbalanceW = dr.GetValue(2).ToString();

                //                                                                                                                        newbalanceW = (int.Parse(prevbalanceW) + int.Parse(thiswithdrawW)).ToString();
                //                                                                                                                        using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                                        {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                                            cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                            cmd.Parameters.AddWithValue("@totearning", int.Parse(totearningW) + int.Parse(thiswithdrawW));
                //                                                                                                                            cmd.Parameters.AddWithValue("@totwithdraw", int.Parse(totwithdrawW) + int.Parse(thiswithdrawW));
                //                                                                                                                            cmd.Parameters.AddWithValue("@prevbalance", prevbalanceW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@newbalance", newbalanceW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                                            dr.Dispose();
                //                                                                                                                            cmd.ExecuteNonQuery();

                //                                                                                                                            //Update Referral Earnings
                //                                                                                                                            using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                //                                                                                                                            {
                //                                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                using (dr = cmd.ExecuteReader())
                //                                                                                                                                {
                //                                                                                                                                    if (dr.Read())
                //                                                                                                                                    {
                //                                                                                                                                        int amountdue = int.Parse(dr.GetValue(0).ToString());
                //                                                                                                                                        int deduction = int.Parse(dr.GetValue(1).ToString());
                //                                                                                                                                        int newDeduction = deduction + int.Parse(thiswithdrawW);
                //                                                                                                                                        int RefBalance = int.Parse(dr.GetValue(2).ToString());
                //                                                                                                                                        int newRefBalance = RefBalance - int.Parse(thiswithdrawW);

                //                                                                                                                                        using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                //                                                                                                                                        {
                //                                                                                                                                            cmd.Parameters.AddWithValue("@balance", newRefBalance);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@deductions", newDeduction);
                //                                                                                                                                            cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                            dr.Dispose();
                //                                                                                                                                            cmd.ExecuteNonQuery();
                //                                                                                                                                        }
                //                                                                                                                                    }
                //                                                                                                                                }
                //                                                                                                                            }

                //                                                                                                                            ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. The transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                                        }
                //                                                                                                                    }
                //                                                                                                                }
                //                                                                                                            }
                //                                                                                                        }
                //                                                                                                        else
                //                                                                                                        {
                //                                                                                                            dr.Dispose();
                //                                                                                                            using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                            {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                                cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                cmd.Parameters.AddWithValue("@totearning", thiswithdrawW);
                //                                                                                                                cmd.Parameters.AddWithValue("@totwithdraw", thiswithdrawW);
                //                                                                                                                cmd.Parameters.AddWithValue("@prevbalance", 0);
                //                                                                                                                cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                                cmd.Parameters.AddWithValue("@newbalance", thiswithdrawW);
                //                                                                                                                cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                                cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                                cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                                cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                                cmd.ExecuteNonQuery();

                //                                                                                                                //Update Referral Earnings
                //                                                                                                                using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                //                                                                                                                {
                //                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                                                    {
                //                                                                                                                        if (dr.Read())
                //                                                                                                                        {
                //                                                                                                                            int amountdue = int.Parse(dr.GetValue(0).ToString());
                //                                                                                                                            int deduction = int.Parse(dr.GetValue(1).ToString());
                //                                                                                                                            int newDeduction = deduction + int.Parse(thiswithdrawW);
                //                                                                                                                            int RefBalance = int.Parse(dr.GetValue(2).ToString());
                //                                                                                                                            int newRefBalance = RefBalance - int.Parse(thiswithdrawW);

                //                                                                                                                            using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                //                                                                                                                            {
                //                                                                                                                                cmd.Parameters.AddWithValue("@balance", newRefBalance);
                //                                                                                                                                cmd.Parameters.AddWithValue("@deductions", newDeduction);
                //                                                                                                                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                dr.Dispose();
                //                                                                                                                                cmd.ExecuteNonQuery();
                //                                                                                                                            }
                //                                                                                                                        }
                //                                                                                                                    }
                //                                                                                                                }

                //                                                                                                                ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. the transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                            }

                //                                                                                                        }
                //                                                                                                    }
                //                                                                                                }
                //                                                                                            }
                //                                                                                        }
                //                                                                                    }
                //                                                                                }
                //                                                                                else
                //                                                                                {
                //                                                                                    ResponseMsg = "This record already exists!";
                //                                                                                }
                //                                                                            }
                //                                                                            else
                //                                                                            {
                //                                                                                dr.Dispose();
                //                                                                                using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank and status=@status", con))
                //                                                                                {
                //                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                    cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                    {
                //                                                                                        if (dr.Read())
                //                                                                                        {
                //                                                                                            ResponseMsg = "You have a withdrawal " + MatrixRank + " is still pending. You can only make another withdrawal when the previous one is confirmed.";
                //                                                                                        }
                //                                                                                        else
                //                                                                                        {
                //                                                                                            dr.Dispose();
                //                                                                                            using (cmd = new SqlCommand("Select Max(SN) from withdrawals where userid=@userid", con))
                //                                                                                            {
                //                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                using (dr = cmd.ExecuteReader())
                //                                                                                                {
                //                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                    {
                //                                                                                                        string getSN = dr.GetValue(0).ToString();

                //                                                                                                        dr.Dispose();
                //                                                                                                        using (cmd = new SqlCommand("Select totearning,totwithdraw,newbalance from withdrawals where userid=@userid and sn=@sn", con))
                //                                                                                                        {
                //                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                            cmd.Parameters.AddWithValue("@sn", getSN);
                //                                                                                                            using (dr = cmd.ExecuteReader())
                //                                                                                                            {
                //                                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                                {

                //                                                                                                                    totearningW = dr.GetValue(0).ToString();
                //                                                                                                                    totwithdrawW = dr.GetValue(1).ToString();
                //                                                                                                                    prevbalanceW = dr.GetValue(2).ToString();

                //                                                                                                                    newbalanceW = (int.Parse(prevbalanceW) + int.Parse(thiswithdrawW)).ToString();
                //                                                                                                                    using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                                    {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                                        cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@rank", rankW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@totearning", int.Parse(totearningW) + int.Parse(thiswithdrawW));
                //                                                                                                                        cmd.Parameters.AddWithValue("@totwithdraw", int.Parse(totwithdrawW) + int.Parse(thiswithdrawW));
                //                                                                                                                        cmd.Parameters.AddWithValue("@prevbalance", prevbalanceW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@newbalance", newbalanceW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                                        dr.Dispose();
                //                                                                                                                        cmd.ExecuteNonQuery();
                //                                                                                                                        ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. The transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                                    }
                //                                                                                                                }
                //                                                                                                            }
                //                                                                                                        }
                //                                                                                                    }
                //                                                                                                    else
                //                                                                                                    {
                //                                                                                                        dr.Dispose();
                //                                                                                                        using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                        {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                            cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                            cmd.Parameters.AddWithValue("@rank", rankW);
                //                                                                                                            cmd.Parameters.AddWithValue("@totearning", thiswithdrawW);
                //                                                                                                            cmd.Parameters.AddWithValue("@totwithdraw", thiswithdrawW);
                //                                                                                                            cmd.Parameters.AddWithValue("@prevbalance", 0);
                //                                                                                                            cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                            cmd.Parameters.AddWithValue("@newbalance", thiswithdrawW);
                //                                                                                                            cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                            cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                            cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                            cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                            cmd.ExecuteNonQuery();
                //                                                                                                            ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. the transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                        }

                //                                                                                                    }
                //                                                                                                }
                //                                                                                            }
                //                                                                                        }
                //                                                                                    }
                //                                                                                }

                //                                                                            }
                //                                                                        }
                //                                                                    }
                //                                                                }
                //                                                                else
                //                                                                {
                //                                                                    ResponseMsg = "Invalid Confirmation Code!";
                //                                                                }
                //                                                            }
                //                                                        }
                //                                                    }
                //                                                }
                //                                            }
                //                                        }
                //                                    }
                //                                }
                //                            }                                            
                //                        }
                //                        else
                //                        {
                //                            dr.Dispose();
                //                            using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank", con))
                //                            {
                //                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                using(dr = cmd.ExecuteReader())
                //                                {
                //                                    if(dr.Read())
                //                                    {
                //                                        ResponseMsg = "This earning has been previously processed!";
                //                                    }
                //                                    else
                //                                    {
                //                                        dr.Dispose();
                //                                        using (cmd = new SqlCommand("Select code from register where userid=@userid", con))
                //                                        {
                //                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                            using (dr = cmd.ExecuteReader())
                //                                            {
                //                                                if (dr.Read())
                //                                                {
                //                                                    string getCode = dr.GetValue(0).ToString();
                //                                                    if (getCode == emailConfCODE)
                //                                                    {
                //                                                        dr.Dispose();
                //                                                        using (cmd = new SqlCommand("Select rank from withdrawals where userid=@userid and rank=@rank", con))
                //                                                        {
                //                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                            cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                                            using (dr = cmd.ExecuteReader())
                //                                                            {
                //                                                                if (dr.Read())
                //                                                                {
                //                                                                    string rank = dr.GetValue(0).ToString();
                //                                                                    if (rank == "Referral Bonus")
                //                                                                    {
                //                                                                        dr.Dispose();
                //                                                                        using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank and status=@status", con))
                //                                                                        {
                //                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                            cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                            using (dr = cmd.ExecuteReader())
                //                                                                            {
                //                                                                                if (dr.Read())
                //                                                                                {
                //                                                                                    ResponseMsg = "You have a withdrawal for " + MatrixRank + " that is still pending. You can only make another withdrawal when the previous one is confirmed.";
                //                                                                                }
                //                                                                                else
                //                                                                                {
                //                                                                                    dr.Dispose();
                //                                                                                    using (cmd = new SqlCommand("Select Max(SN) from withdrawals where userid=@userid", con))
                //                                                                                    {
                //                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                        using (dr = cmd.ExecuteReader())
                //                                                                                        {
                //                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                            {
                //                                                                                                string getSN = dr.GetValue(0).ToString();

                //                                                                                                dr.Dispose();
                //                                                                                                using (cmd = new SqlCommand("Select totearning,totwithdraw,newbalance from withdrawals where userid=@userid and sn=@sn", con))
                //                                                                                                {
                //                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                    cmd.Parameters.AddWithValue("@sn", getSN);
                //                                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                                    {
                //                                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                        {

                //                                                                                                            totearningW = dr.GetValue(0).ToString();
                //                                                                                                            totwithdrawW = dr.GetValue(1).ToString();
                //                                                                                                            prevbalanceW = dr.GetValue(2).ToString();

                //                                                                                                            newbalanceW = (int.Parse(prevbalanceW) + int.Parse(thiswithdrawW)).ToString();
                //                                                                                                            using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                            {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                                cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                cmd.Parameters.AddWithValue("@totearning", int.Parse(totearningW) + int.Parse(thiswithdrawW));
                //                                                                                                                cmd.Parameters.AddWithValue("@totwithdraw", int.Parse(totwithdrawW) + int.Parse(thiswithdrawW));
                //                                                                                                                cmd.Parameters.AddWithValue("@prevbalance", prevbalanceW);
                //                                                                                                                cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                                cmd.Parameters.AddWithValue("@newbalance", newbalanceW);
                //                                                                                                                cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                                cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                                cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                                cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                                dr.Dispose();
                //                                                                                                                cmd.ExecuteNonQuery();

                //                                                                                                                //Update Referral Earnings
                //                                                                                                                using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                //                                                                                                                {
                //                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                                                    {
                //                                                                                                                        if (dr.Read())
                //                                                                                                                        {
                //                                                                                                                            int amountdue = int.Parse(dr.GetValue(0).ToString());
                //                                                                                                                            int deduction = int.Parse(dr.GetValue(1).ToString());
                //                                                                                                                            int newDeduction = deduction + int.Parse(thiswithdrawW);
                //                                                                                                                            int RefBalance = int.Parse(dr.GetValue(2).ToString());
                //                                                                                                                            int newRefBalance = RefBalance - int.Parse(thiswithdrawW);

                //                                                                                                                            using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                //                                                                                                                            {
                //                                                                                                                                cmd.Parameters.AddWithValue("@balance", newRefBalance);
                //                                                                                                                                cmd.Parameters.AddWithValue("@deductions", newDeduction);
                //                                                                                                                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                                dr.Dispose();
                //                                                                                                                                cmd.ExecuteNonQuery();
                //                                                                                                                            }
                //                                                                                                                        }
                //                                                                                                                    }
                //                                                                                                                }

                //                                                                                                                ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. The transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                            }
                //                                                                                                        }
                //                                                                                                    }
                //                                                                                                }
                //                                                                                            }
                //                                                                                            else
                //                                                                                            {
                //                                                                                                dr.Dispose();
                //                                                                                                using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                    cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                    cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                    cmd.Parameters.AddWithValue("@totearning", thiswithdrawW);
                //                                                                                                    cmd.Parameters.AddWithValue("@totwithdraw", thiswithdrawW);
                //                                                                                                    cmd.Parameters.AddWithValue("@prevbalance", 0);
                //                                                                                                    cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                    cmd.Parameters.AddWithValue("@newbalance", thiswithdrawW);
                //                                                                                                    cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                    cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                    cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                    cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                    cmd.ExecuteNonQuery();

                //                                                                                                    //Update Referral Earnings
                //                                                                                                    using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                //                                                                                                    {
                //                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                        using (dr = cmd.ExecuteReader())
                //                                                                                                        {
                //                                                                                                            if (dr.Read())
                //                                                                                                            {
                //                                                                                                                int amountdue = int.Parse(dr.GetValue(0).ToString());
                //                                                                                                                int deduction = int.Parse(dr.GetValue(1).ToString());
                //                                                                                                                int newDeduction = deduction + int.Parse(thiswithdrawW);
                //                                                                                                                int RefBalance = int.Parse(dr.GetValue(2).ToString());
                //                                                                                                                int newRefBalance = RefBalance - int.Parse(thiswithdrawW);

                //                                                                                                                using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                //                                                                                                                {
                //                                                                                                                    cmd.Parameters.AddWithValue("@balance", newRefBalance);
                //                                                                                                                    cmd.Parameters.AddWithValue("@deductions", newDeduction);
                //                                                                                                                    cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                //                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                                    dr.Dispose();
                //                                                                                                                    cmd.ExecuteNonQuery();
                //                                                                                                                }
                //                                                                                                            }
                //                                                                                                        }
                //                                                                                                    }

                //                                                                                                    ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. the transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                }

                //                                                                                            }
                //                                                                                        }
                //                                                                                    }
                //                                                                                }
                //                                                                            }
                //                                                                        }
                //                                                                    }
                //                                                                    else
                //                                                                    {
                //                                                                        ResponseMsg = "This record already exists!";
                //                                                                    }
                //                                                                }
                //                                                                else
                //                                                                {
                //                                                                    dr.Dispose();
                //                                                                    using (cmd = new SqlCommand("Select userid from withdrawals where userid=@userid and rank=@rank and status=@status", con))
                //                                                                    {
                //                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                        cmd.Parameters.AddWithValue("@rank", MatrixRank);
                //                                                                        cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                        using (dr = cmd.ExecuteReader())
                //                                                                        {
                //                                                                            if (dr.Read())
                //                                                                            {
                //                                                                                ResponseMsg = "You have a withdrawal " + MatrixRank + " is still pending. You can only make another withdrawal when the previous one is confirmed.";
                //                                                                            }
                //                                                                            else
                //                                                                            {
                //                                                                                dr.Dispose();
                //                                                                                using (cmd = new SqlCommand("Select Max(SN) from withdrawals where userid=@userid", con))
                //                                                                                {
                //                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                    using (dr = cmd.ExecuteReader())
                //                                                                                    {
                //                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                        {
                //                                                                                            string getSN = dr.GetValue(0).ToString();

                //                                                                                            dr.Dispose();
                //                                                                                            using (cmd = new SqlCommand("Select totearning,totwithdraw,newbalance from withdrawals where userid=@userid and sn=@sn", con))
                //                                                                                            {
                //                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                cmd.Parameters.AddWithValue("@sn", getSN);
                //                                                                                                using (dr = cmd.ExecuteReader())
                //                                                                                                {
                //                                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                //                                                                                                    {

                //                                                                                                        totearningW = dr.GetValue(0).ToString();
                //                                                                                                        totwithdrawW = dr.GetValue(1).ToString();
                //                                                                                                        prevbalanceW = dr.GetValue(2).ToString();

                //                                                                                                        newbalanceW = (int.Parse(prevbalanceW) + int.Parse(thiswithdrawW)).ToString();
                //                                                                                                        using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                                        {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                            cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                            cmd.Parameters.AddWithValue("@rank", rankW);
                //                                                                                                            cmd.Parameters.AddWithValue("@totearning", int.Parse(totearningW) + int.Parse(thiswithdrawW));
                //                                                                                                            cmd.Parameters.AddWithValue("@totwithdraw", int.Parse(totwithdrawW) + int.Parse(thiswithdrawW));
                //                                                                                                            cmd.Parameters.AddWithValue("@prevbalance", prevbalanceW);
                //                                                                                                            cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                            cmd.Parameters.AddWithValue("@newbalance", newbalanceW);
                //                                                                                                            cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                            cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                            cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                            cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                            dr.Dispose();
                //                                                                                                            cmd.ExecuteNonQuery();
                //                                                                                                            ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. The transfer process will be complete within 72 hours. Thank you.";
                //                                                                                                        }
                //                                                                                                    }
                //                                                                                                }
                //                                                                                            }
                //                                                                                        }
                //                                                                                        else
                //                                                                                        {
                //                                                                                            dr.Dispose();
                //                                                                                            using (cmd = new SqlCommand("Insert into Withdrawals(name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date,userid,status) values (@name,@rank,@totearning,@totwithdraw,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid,@status)", con))
                //                                                                                            {//name,rank,totearning,totwithdraw,prevbalance,thiswithdraw,newbalance,dd,mm,yy,date
                //                                                                                                cmd.Parameters.AddWithValue("@name", nameW);
                //                                                                                                cmd.Parameters.AddWithValue("@rank", rankW);
                //                                                                                                cmd.Parameters.AddWithValue("@totearning", thiswithdrawW);
                //                                                                                                cmd.Parameters.AddWithValue("@totwithdraw", thiswithdrawW);
                //                                                                                                cmd.Parameters.AddWithValue("@prevbalance", 0);
                //                                                                                                cmd.Parameters.AddWithValue("@thiswithdraw", thiswithdrawW);
                //                                                                                                cmd.Parameters.AddWithValue("@newbalance", thiswithdrawW);
                //                                                                                                cmd.Parameters.AddWithValue("@dd", ddW);
                //                                                                                                cmd.Parameters.AddWithValue("@mm", mmW);
                //                                                                                                cmd.Parameters.AddWithValue("@yy", yyW);
                //                                                                                                cmd.Parameters.AddWithValue("@date", dateW);
                //                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                //                                                                                                cmd.Parameters.AddWithValue("@status", "Pending");
                //                                                                                                cmd.ExecuteNonQuery();
                //                                                                                                ResponseMsg = "Success!. Your withdrawal is awaiting confirmation. the transfer process will be complete within 72 hours. Thank you.";
                //                                                                                            }

                //                                                                                        }
                //                                                                                    }
                //                                                                                }
                //                                                                            }
                //                                                                        }
                //                                                                    }

                //                                                                }
                //                                                            }
                //                                                        }
                //                                                    }
                //                                                    else
                //                                                    {
                //                                                        ResponseMsg = "Invalid Confirmation Code!";
                //                                                    }
                //                                                }
                //                                            }
                //                                        }
                //                                    }
                //                                }
                //                            }
                //                        }
                //                    }
                //                }
                //            }
                //        }
                //    }
                //}
            }
        }

        public void checkBank()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Select name,bankname,accountno from bkretrieve where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read() && !dr.IsDBNull(0))
                        {
                            ResponseMsg = "1";
                        }
                        else
                        {
                            ResponseMsg = "0";
                        }
                    }
                }
            }
        }

        public void GetWithdrawals()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                //ref bonus
                using (cmd = new SqlCommand("Select count(refid) from commissionsref where refid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            int getcount = int.Parse(dr.GetValue(0).ToString());
                            int total = getcount * 1000;

                            int sumWithdrawPaid = 0;
                            int sumWithdrawPending = 0;
                            // Correction codes for negative value for referral bonuses
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select sum(thiswithdraw) from withdrawals where rank=@rank and status=@status and userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                cmd.Parameters.AddWithValue("@status", "Paid");
                                cmd.Parameters.AddWithValue("@userid", UserId);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read() && !dr.IsDBNull(0))
                                    {
                                        sumWithdrawPaid = int.Parse(dr.GetValue(0).ToString());
                                    }
                                    else
                                    {
                                        sumWithdrawPaid = 0;
                                    }
                                }
                            }


                            dr.Dispose();
                            using (cmd = new SqlCommand("Select sum(thiswithdraw) from withdrawals where rank=@rank and status=@status and userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                cmd.Parameters.AddWithValue("@status", "Pending");
                                cmd.Parameters.AddWithValue("@userid", UserId);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read() && !dr.IsDBNull(0))
                                    {
                                        sumWithdrawPending = int.Parse(dr.GetValue(0).ToString());
                                    }
                                    else
                                    {
                                        sumWithdrawPending = 0;
                                    }
                                }
                            }

                            int balance = total - (sumWithdrawPaid + sumWithdrawPending);
                            getReferralBonus = balance.ToString();
                        }
                    }
                }

                dr.Dispose();
                using(cmd = new SqlCommand("Select userid from withdrawals where rank=@rank and userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@rank", MatrixRank);
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && MatrixRank != "Referral Bonus")
                        {
                            ResponseMsg = "You may have been previously paid for this rank or its still been processed! Do confirm from your withdrawal tracker.";
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select amountdue from earnings where rank=@rank and userid=@userid and status!=@status and status=@statuscheck", con))
                            {
                                cmd.Parameters.AddWithValue("@rank", MatrixRank);
                                cmd.Parameters.AddWithValue("@userid", UserId);
                                cmd.Parameters.AddWithValue("@status", "Paid");
                                cmd.Parameters.AddWithValue("@statuscheck", "Pending");
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read() && !dr.IsDBNull(0))
                                    {
                                        AmountWithdraw = dr.GetValue(0).ToString();

                                        if (MatrixRank == "SilverLife 1")
                                        {
                                            AmountFood = "2000";
                                            AmountCash = "3000";
                                            Amountcar = "0";
                                            AmountTrip = "0";
                                            AmountSUV = "0";
                                            AmountScholarship = "0";
                                            AmountLand = "0";
                                            DurationWithdraw = "0";
                                            ResponseMsg = "Done!";
                                        }
                                        else if (MatrixRank == "SilverLife 2")
                                        {
                                            AmountFood = "10000";
                                            AmountCash = "30000";
                                            Amountcar = "0";
                                            AmountTrip = "0";
                                            AmountSUV = "0";
                                            AmountScholarship = "0";
                                            AmountLand = "0";
                                            DurationWithdraw = "0";
                                            ResponseMsg = "Done!";
                                        }
                                        else if (MatrixRank == "GoldLife 1")
                                        {
                                            AmountFood = "12000";
                                            AmountCash = "60000";
                                            Amountcar = "0";
                                            AmountTrip = "0";
                                            AmountSUV = "0";
                                            AmountScholarship = "0";
                                            AmountLand = "0";
                                            DurationWithdraw = "0";
                                            ResponseMsg = "Done!";
                                        }
                                        else if (MatrixRank == "GoldLife 2")
                                        {
                                            AmountFood = "30000";
                                            AmountCash = "120000";
                                            Amountcar = "0";
                                            AmountTrip = "0";
                                            AmountSUV = "0";
                                            AmountScholarship = "0";
                                            AmountLand = "0";
                                            DurationWithdraw = "0";
                                            ResponseMsg = "Done!";
                                        }
                                        else if (MatrixRank == "DiamondLife 1")
                                        {
                                            AmountFood = "50000";
                                            AmountCash = "250000";
                                            Amountcar = "0";
                                            AmountTrip = "0";
                                            AmountSUV = "0";
                                            AmountScholarship = "0";
                                            AmountLand = "0";
                                            DurationWithdraw = "0";
                                            ResponseMsg = "Done!";
                                        }
                                        else if (MatrixRank == "DiamondLife 2")
                                        {
                                            AmountFood = "50000";
                                            AmountCash = "350000";
                                            Amountcar = "0";
                                            AmountTrip = "0";
                                            AmountSUV = "0";
                                            AmountScholarship = "0";
                                            AmountLand = "0";
                                            DurationWithdraw = "5";
                                            ResponseMsg = "Done!";
                                        }
                                        else if (MatrixRank == "SapphireLife 1")
                                        {
                                            AmountFood = "100000";
                                            AmountCash = "1000000";
                                            Amountcar = "0";
                                            AmountTrip = "0";
                                            AmountSUV = "0";
                                            AmountScholarship = "0";
                                            AmountLand = "0";
                                            DurationWithdraw = "5";
                                            ResponseMsg = "Done!";
                                        }
                                        else if (MatrixRank == "SapphireLife 2")
                                        {
                                            AmountFood = "0";
                                            AmountCash = "1000000";
                                            Amountcar = "4500000";
                                            AmountTrip = "1000000";
                                            AmountSUV = "0";
                                            AmountScholarship = "0";
                                            AmountLand = "0";
                                            DurationWithdraw = "0";
                                            ResponseMsg = "Done!";
                                        }
                                        else if (MatrixRank == "EmeraldLife")
                                        {
                                            AmountFood = "0";
                                            AmountCash = "0";
                                            Amountcar = "0";
                                            AmountTrip = "0";
                                            AmountSUV = "15000000";
                                            AmountScholarship = "8000000";
                                            AmountLand = "5000000";
                                            DurationWithdraw = "0";
                                            ResponseMsg = "Done!";
                                        }

                                    }
                                    else
                                    {//You may not have achieved the selected Rank or have been previously paid for this rank!
                                        ResponseMsg = "You may not have achieved the selected Rank or have been previously paid for this rank!";
                                    }
                                }
                            }
                        }
                    }
                }                
            }
        }

        public void FinalRankChecker()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                int TotalDownlines = 0;
                int Silver1 = 4;
                int Silver1Counter = 0;
                string Silver1Ids = "";

                int Silver2 = 16;
                int Silver2Counter = 0;
                string Silver2Ids = "";

                int Gold1 = 64;
                int Gold1Counter = 0;
                string Gold1Ids = "";

                int Gold2 = 256;
                int Gold2Counter = 0;
                string Gold2Ids = "";

                int Diamond1 = 1024;
                int Diamond1Counter = 0;
                string Diamond1Ids = "";

                int Diamond2 = 4096;
                int Diamond2Counter = 0;
                string Diamond2Ids = "";

                int Sapphire1 = 16384;
                int Sapphire1Counter = 0;
                string Sapphire1Ids = "";

                int Sapphire2 = 65536;
                int Sapphire2Counter = 0;
                string Sapphire2Ids = "";

                int Emerald = 262144;
                int EmeraldCounter = 0;
                string EmeraldIds = "";

                string RankFinal = "";
                int TotalCounters = 0;



                //Get Total Downlines
                using (cmd = new SqlCommand("Select count(sn) from familyhierarchy", con))
                {
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            TotalDownlines = int.Parse(dr.GetValue(0).ToString());
                        }
                    }
                }

                //Get the Ranks

                using (cmd = new SqlCommand("Select count(parentid) from familyhierarchy where parentid=@parentid", con))
                {
                    cmd.Parameters.AddWithValue("@parentid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            Silver1 = int.Parse(dr.GetValue(0).ToString());
                            if(Silver1 == 0)
                            {
                                RankFinal = "NoRank";
                            }
                            if (Silver1 == 4)
                            {
                                RankFinal = "Silver1";
                            }
                            if (Silver1 < 4 && Silver1 > 0)
                            {
                                RankFinal = "Silver1";
                            }
                            if (TotalDownlines >= 4)
                            {
                                //Check for Silver 1 Ids to get Silver 2 Downlines
                                using (da = new SqlDataAdapter())
                                {
                                    DataSet ds = new DataSet();
                                    int i = 0;
                                    string sql = null;
                                    sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@parentid", placementid);
                                        dr.Dispose();
                                        da.Fill(ds);

                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                            if (i < ds.Tables[0].Rows.Count - 1)
                                            {
                                                if (Silver1Ids != "")
                                                {
                                                    Silver1Ids += " " + MemberID + " ";
                                                    Silver1Counter++;
                                                }
                                                else
                                                {
                                                    Silver1Ids += MemberID + " ";
                                                    Silver1Counter++;
                                                }
                                            }
                                            else if (i == ds.Tables[0].Rows.Count - 1)
                                            {
                                                if (Silver1Ids != "")
                                                {
                                                    Silver1Ids += " " + MemberID;
                                                    Silver1Counter++;
                                                }
                                                else
                                                {
                                                    Silver1Ids += MemberID;
                                                    Silver1Counter++;
                                                }
                                            }
                                        }
                                    }
                                    if (Silver1Counter < 4 && Silver1Counter > 0)
                                    {
                                        RankFinal = "Silver1";

                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read() && !dr.IsDBNull(0))
                                                {
                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                        cmd.ExecuteNonQuery();
                                                    }

                                                    using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                        using (dr = cmd.ExecuteReader())
                                                        {
                                                            if (dr.Read())
                                                            {
                                                                string STATUSWithd = dr.GetValue(1).ToString();
                                                                if (STATUSWithd == "Paid")
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                    {//userid,rank,amount,dated,status
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                        cmd.Parameters.AddWithValue("@amount", 5000);
                                                                        cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                        cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                        cmd.ExecuteNonQuery();
                                                                    }
                                                                }
                                                                else if (STATUSWithd == "Pending")
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                    {//userid,rank,amount,dated,status
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                        cmd.ExecuteNonQuery();
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    if (Silver1Counter == 4)
                                    {
                                        /////////////////////////////////////
                                        //      Inject Earnings Codes      //
                                        ////////////////////////////////////
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                        {
                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                string getRank;
                                                if (dr.Read() && !dr.IsDBNull(0))
                                                {
                                                    //do nothing
                                                    getRank = dr.GetValue(0).ToString();
                                                }
                                                else
                                                {
                                                    if (getrank == "SilverLife 1")
                                                    {

                                                    }
                                                    else
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    string SN = dr.GetValue(0).ToString();

                                                                    using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                                        dr.Dispose();
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {

                                                                            }
                                                                            else
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@username", placementname);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                                    cmd.Parameters.AddWithValue("@amountdue", 5000);
                                                                                    cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                    cmd.Parameters.AddWithValue("@balance", getBalance + 5000);
                                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                    cmd.ExecuteNonQuery();

                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                     dr.Dispose();
                                                                     using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                     {
                                                                         cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                         using (dr = cmd.ExecuteReader())
                                                                         {
                                                                             if (dr.Read())
                                                                             {

                                                                             }
                                                                             else
                                                                             {
                                                                                 dr.Dispose();
                                                                                 using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                 { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                     cmd.Parameters.AddWithValue("@username", placementname);
                                                                                     cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                                                     cmd.Parameters.AddWithValue("@amountdue", 5000);
                                                                                     cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                     cmd.Parameters.AddWithValue("@balance", 5000);
                                                                                     cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                     cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                     cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                     cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                     cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                     cmd.ExecuteNonQuery();
                                                                                 }
                                                                             }
                                                                         }
                                                                     }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        ////////////////////////////////////


                                        RankFinal = "Silver1";
                                        TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                        int count;
                                        string[] splitUserIds;
                                        char[] splitchar1 = { ' ' };
                                        splitUserIds = Silver1Ids.Split(splitchar1);
                                        UserIdsKeep = "";
                                        //DrawMatrixNewCounter = 0;
                                        int fullLength = splitUserIds.Length;

                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                        {
                                            string SplitedUserID = splitUserIds[count];

                                            if (TotalCounters <= TotalDownlines)
                                            {
                                                da.Dispose();
                                                using (da = new SqlDataAdapter())
                                                {
                                                    ds = new DataSet();
                                                    i = 0;
                                                    sql = null;
                                                    sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                    using (cmd = new SqlCommand(sql, con))
                                                    {
                                                        da.SelectCommand = cmd;
                                                        da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                        dr.Dispose();
                                                        da.Fill(ds);

                                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                        {
                                                            string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                            if (i < ds.Tables[0].Rows.Count - 1)
                                                            {
                                                                if (Silver2Ids != "")
                                                                {
                                                                    Silver2Ids += " " + MemberID + " ";
                                                                    Silver2Counter++;
                                                                }
                                                                else
                                                                {
                                                                    Silver2Ids += MemberID + " ";
                                                                    Silver2Counter++;
                                                                }
                                                            }
                                                            else if (i == ds.Tables[0].Rows.Count - 1)
                                                            {
                                                                if (Silver2Ids != "")
                                                                {
                                                                    Silver2Ids += " " + MemberID;
                                                                    Silver2Counter++;
                                                                }
                                                                else
                                                                {
                                                                    Silver2Ids += MemberID;
                                                                    Silver2Counter++;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        //Set the Silver 2 Rank
                                        if (Silver2Counter < 16 && Silver2Counter > 0)
                                        {
                                            RankFinal = "Silver2";


                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                            cmd.ExecuteNonQuery();
                                                        }

                                                        using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    string STATUSWithd = dr.GetValue(1).ToString();
                                                                    if (STATUSWithd == "Paid")
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                        {//userid,rank,amount,dated,status
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                            cmd.Parameters.AddWithValue("@amount", 40000);
                                                                            cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                            cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                    else if (STATUSWithd == "Pending")
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                        {//userid,rank,amount,dated,status
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        if (Silver2Counter == 16)
                                        {
                                            /////////////////////////////////////
                                            //      Inject Earnings Codes      //
                                            ////////////////////////////////////
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    string getRank;
                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                    {
                                                        //do nothing
                                                        getRank = dr.GetValue(0).ToString();
                                                    }
                                                    else
                                                    {
                                                        if (getrank == "SilverLife 2")
                                                        {

                                                        }
                                                        else
                                                        {
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    {
                                                                        string SN = dr.GetValue(0).ToString();

                                                                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                            dr.Dispose();
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                }
                                                                            }
                                                                        }
                                                                         dr.Dispose();
                                                                         using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                         {
                                                                             cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                             cmd.Parameters.AddWithValue("@userid", placementid);
                                                                             using (dr = cmd.ExecuteReader())
                                                                             {
                                                                                 if (dr.Read())
                                                                                 {

                                                                                 }
                                                                                 else
                                                                                 {
                                                                                     dr.Dispose();
                                                                                     using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                     { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                         cmd.Parameters.AddWithValue("@username", placementname);
                                                                                         cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                                         cmd.Parameters.AddWithValue("@amountdue", 40000);
                                                                                         cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                         cmd.Parameters.AddWithValue("@balance", getBalance + 40000);
                                                                                         cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                         cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                         cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                         cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                         cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                         cmd.ExecuteNonQuery();

                                                                                     }
                                                                                 }
                                                                             }
                                                                         }
                                                                    }
                                                                    else
                                                                    {
                                                                         dr.Dispose();
                                                                         using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                         {
                                                                             cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                             cmd.Parameters.AddWithValue("@userid", placementid);
                                                                             using (dr = cmd.ExecuteReader())
                                                                             {
                                                                                 if (dr.Read())
                                                                                 {

                                                                                 }
                                                                                 else
                                                                                 {
                                                                                     dr.Dispose();
                                                                                     using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                     { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                         cmd.Parameters.AddWithValue("@username", placementname);
                                                                                         cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                                         cmd.Parameters.AddWithValue("@amountdue", 40000);
                                                                                         cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                         cmd.Parameters.AddWithValue("@balance", 40000);
                                                                                         cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                         cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                         cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                         cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                         cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                         cmd.ExecuteNonQuery();
                                                                                     }
                                                                                 }
                                                                             }
                                                                         }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                            ////////////////////////////////////

                                            RankFinal = "Gold";
                                            TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                            splitUserIds = Silver2Ids.Split(splitchar1);
                                            UserIdsKeep = "";
                                            //DrawMatrixNewCounter = 0;
                                            fullLength = splitUserIds.Length;

                                            for (count = 0; count <= splitUserIds.Length - 1; count++)
                                            {
                                                string SplitedUserID = splitUserIds[count];

                                                if (TotalCounters <= TotalDownlines)
                                                {
                                                    da.Dispose();
                                                    using (da = new SqlDataAdapter())
                                                    {
                                                        ds = new DataSet();
                                                        i = 0;
                                                        sql = null;
                                                        sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                        using (cmd = new SqlCommand(sql, con))
                                                        {
                                                            da.SelectCommand = cmd;
                                                            da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                            dr.Dispose();
                                                            da.Fill(ds);

                                                            for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                            {
                                                                string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                if (i < ds.Tables[0].Rows.Count - 1)
                                                                {
                                                                    if (Gold1Ids != "")
                                                                    {
                                                                        Gold1Ids += " " + MemberID + " ";
                                                                        Gold1Counter++;
                                                                    }
                                                                    else
                                                                    {
                                                                        Gold1Ids += MemberID + " ";
                                                                        Gold1Counter++;
                                                                    }
                                                                }
                                                                else if (i == ds.Tables[0].Rows.Count - 1)
                                                                {
                                                                    if(Gold1Ids != "")
                                                                    {
                                                                        Gold1Ids +=  " " + MemberID;
                                                                        Gold1Counter++;
                                                                    }
                                                                    else
                                                                    {
                                                                        Gold1Ids += MemberID;
                                                                        Gold1Counter++;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                            //Set the Gold 1 Rank
                                            if (Gold1Counter < 64 && Gold1Counter > 0)
                                            {
                                                RankFinal = "Gold1";

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string STATUSWithd = dr.GetValue(1).ToString();
                                                                        if (STATUSWithd == "Paid")
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                            {//userid,rank,amount,dated,status
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                cmd.Parameters.AddWithValue("@amount", 72000);
                                                                                cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                cmd.ExecuteNonQuery();
                                                                            }
                                                                        }
                                                                        else if (STATUSWithd == "Pending")
                                                                        {
                                                                            dr.Dispose();
                                                                            using(cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                            {//userid,rank,amount,dated,status
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                cmd.ExecuteNonQuery();
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if (Gold1Counter == 64)
                                            {
                                                /////////////////////////////////////
                                                //      Inject Earnings Codes      //
                                                ////////////////////////////////////
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        string getRank;
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //do nothing
                                                            getRank = dr.GetValue(0).ToString();
                                                        }
                                                        else
                                                        {
                                                            if (getrank == "GoldLife 1")
                                                            {

                                                            }
                                                            else
                                                            {
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                        {
                                                                            string SN = dr.GetValue(0).ToString();

                                                                            using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@sn", SN);
                                                                                dr.Dispose();
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                    {
                                                                                        getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                    }
                                                                                }
                                                                            }
                                                                             dr.Dispose();
                                                                             using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                             {
                                                                                 cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                 cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                 using (dr = cmd.ExecuteReader())
                                                                                 {
                                                                                     if (dr.Read())
                                                                                     {

                                                                                     }
                                                                                     else
                                                                                     {
                                                                                         dr.Dispose();
                                                                                         using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                         { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                             cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                             cmd.Parameters.AddWithValue("@username", placementname);
                                                                                             cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                             cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                                                             cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                             cmd.Parameters.AddWithValue("@balance", getBalance + 72000);
                                                                                             cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                             cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                             cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                             cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                             cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                             cmd.ExecuteNonQuery();

                                                                                         }
                                                                                     }
                                                                                 }
                                                                             }
                                                                        }
                                                                        else
                                                                        {
                                                                             dr.Dispose();
                                                                             using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                             {
                                                                                 cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                 cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                 using (dr = cmd.ExecuteReader())
                                                                                 {
                                                                                     if (dr.Read())
                                                                                     {

                                                                                     }
                                                                                     else
                                                                                     {
                                                                                         dr.Dispose();
                                                                                         using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                         { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                             cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                             cmd.Parameters.AddWithValue("@username", placementname);
                                                                                             cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                             cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                                                             cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                             cmd.Parameters.AddWithValue("@balance", 72000);
                                                                                             cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                             cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                             cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                             cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                             cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                             cmd.ExecuteNonQuery();
                                                                                         }
                                                                                     }
                                                                                 }
                                                                             }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                ////////////////////////////////////

                                                RankFinal = "Gold1";
                                                TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                splitUserIds = Gold1Ids.Split(splitchar1);
                                                UserIdsKeep = "";
                                                //DrawMatrixNewCounter = 0;
                                                fullLength = splitUserIds.Length;

                                                for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                {
                                                    string SplitedUserID = splitUserIds[count];

                                                    if (TotalCounters <= TotalDownlines)
                                                    {
                                                        da.Dispose();
                                                        using (da = new SqlDataAdapter())
                                                        {
                                                            ds = new DataSet();
                                                            i = 0;
                                                            sql = null;
                                                            sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);

                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    if (i < ds.Tables[0].Rows.Count - 1)
                                                                    {
                                                                        if (Gold2Ids != "")
                                                                        {
                                                                            Gold2Ids += " " + MemberID + " ";
                                                                            Gold2Counter++;
                                                                        }
                                                                        else
                                                                        {
                                                                            Gold2Ids += MemberID + " ";
                                                                            Gold2Counter++;
                                                                        }
                                                                    }
                                                                    else if (i == ds.Tables[0].Rows.Count - 1)
                                                                    {
                                                                        if (Gold2Ids != "")
                                                                        {
                                                                            Gold2Ids += " " + MemberID;
                                                                            Gold2Counter++;
                                                                        }
                                                                        else
                                                                        {
                                                                            Gold2Ids += MemberID;
                                                                            Gold2Counter++;
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                ////Check if Rank was missed between 1 and 2
                                                //if(Gold1Counter == 64 && Gold2Counter < 256 && Gold2Counter > 0)
                                                //{
                                                //    dr.Dispose();
                                                //    using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                //    {
                                                //        cmd.Parameters.AddWithValue("@userid", placementid);
                                                //        cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                //        using (dr = cmd.ExecuteReader())
                                                //        {
                                                //            string getRank;
                                                //            if (dr.Read() && !dr.IsDBNull(0))
                                                //            {
                                                //                //do nothing
                                                //                getRank = dr.GetValue(0).ToString();
                                                //            }
                                                //            else
                                                //            {
                                                //                if (getrank == "GoldLife 1")
                                                //                {

                                                //                }
                                                //                else
                                                //                {
                                                //                    dr.Dispose();
                                                //                    using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                //                    {
                                                //                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                //                        using (dr = cmd.ExecuteReader())
                                                //                        {
                                                //                            if (dr.Read() && !dr.IsDBNull(0))
                                                //                            {
                                                //                                string SN = dr.GetValue(0).ToString();

                                                //                                using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                //                                {
                                                //                                    cmd.Parameters.AddWithValue("@sn", SN);
                                                //                                    dr.Dispose();
                                                //                                    using (dr = cmd.ExecuteReader())
                                                //                                    {
                                                //                                        if (dr.Read() && !dr.IsDBNull(0))
                                                //                                        {
                                                //                                            getBalance = int.Parse(dr.GetValue(0).ToString());
                                                //                                        }
                                                //                                    }
                                                //                                }
                                                //                                dr.Dispose();
                                                //                                using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                //                                { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                //                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                //                                    cmd.Parameters.AddWithValue("@username", placementname);
                                                //                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                //                                    cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                //                                    cmd.Parameters.AddWithValue("@deductions", 0);
                                                //                                    cmd.Parameters.AddWithValue("@balance", getBalance + 72000);
                                                //                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                //                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                //                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                //                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                //                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                //                                    cmd.ExecuteNonQuery();

                                                //                                }
                                                //                            }
                                                //                            else
                                                //                            {
                                                //                                dr.Dispose();
                                                //                                using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                //                                { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                //                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                //                                    cmd.Parameters.AddWithValue("@username", placementname);
                                                //                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                //                                    cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                //                                    cmd.Parameters.AddWithValue("@deductions", 0);
                                                //                                    cmd.Parameters.AddWithValue("@balance", 72000);
                                                //                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                //                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                //                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                //                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                //                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                //                                    cmd.ExecuteNonQuery();
                                                //                                }
                                                //                            }
                                                //                        }
                                                //                    }
                                                //                }
                                                //            }
                                                //        }
                                                //    }
                                                //}

                                                //Set the Gold 2 Rank
                                                if (Gold2Counter < 256 && Gold2Counter > 0)
                                                {
                                                    RankFinal = "Gold2";

                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                        cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                        using (dr = cmd.ExecuteReader())
                                                        {
                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                            {
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                    cmd.ExecuteNonQuery();
                                                                }

                                                                using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        if (dr.Read())
                                                                        {
                                                                            string STATUSWithd = dr.GetValue(1).ToString();
                                                                            if (STATUSWithd == "Paid")
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                {//userid,rank,amount,dated,status
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.Parameters.AddWithValue("@amount", 150000);
                                                                                    cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                    cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else if (STATUSWithd == "Pending")
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                {//userid,rank,amount,dated,status
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                if (Gold2Counter == 256)
                                                {
                                                    /////////////////////////////////////
                                                    //      Inject Earnings Codes      //
                                                    ////////////////////////////////////
                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                        cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                        using (dr = cmd.ExecuteReader())
                                                        {
                                                            string getRank;
                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                            {
                                                                //do nothing
                                                                getRank = dr.GetValue(0).ToString();
                                                            }
                                                            else
                                                            {
                                                                if (getrank == "GoldLife 2")
                                                                {

                                                                }
                                                                else
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                string SN = dr.GetValue(0).ToString();

                                                                                using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@sn", SN);
                                                                                    dr.Dispose();
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                        {
                                                                                            getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                        }
                                                                                    }
                                                                                }
                                                                                 dr.Dispose();
                                                                                 using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                 {
                                                                                     cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                     using (dr = cmd.ExecuteReader())
                                                                                     {
                                                                                         if (dr.Read())
                                                                                         {

                                                                                         }
                                                                                         else
                                                                                         {
                                                                                             dr.Dispose();
                                                                                             using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                             { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                 cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                 cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                 cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                                 cmd.Parameters.AddWithValue("@amountdue", 150000);
                                                                                                 cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                 cmd.Parameters.AddWithValue("@balance", getBalance + 150000);
                                                                                                 cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                 cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                 cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                 cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                 cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                 cmd.ExecuteNonQuery();

                                                                                             }
                                                                                         }
                                                                                     }
                                                                                 }
                                                                            }
                                                                            else
                                                                            {
                                                                                 dr.Dispose();
                                                                                 using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                 {
                                                                                     cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                     using (dr = cmd.ExecuteReader())
                                                                                     {
                                                                                         if (dr.Read())
                                                                                         {

                                                                                         }
                                                                                         else
                                                                                         {
                                                                                             dr.Dispose();
                                                                                             using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                             { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                 cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                 cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                 cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                                 cmd.Parameters.AddWithValue("@amountdue", 150000);
                                                                                                 cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                 cmd.Parameters.AddWithValue("@balance", 150000);
                                                                                                 cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                 cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                 cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                 cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                 cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                 cmd.ExecuteNonQuery();
                                                                                             }
                                                                                         }
                                                                                     }
                                                                                 }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    ////////////////////////////////////

                                                    RankFinal = "Diamond";
                                                    TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                    splitUserIds = Gold2Ids.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    fullLength = splitUserIds.Length;

                                                    for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                    {
                                                        string SplitedUserID = splitUserIds[count];

                                                        if (TotalCounters <= TotalDownlines)
                                                        {
                                                            da.Dispose();
                                                            using (da = new SqlDataAdapter())
                                                            {
                                                                ds = new DataSet();
                                                                i = 0;
                                                                sql = null;
                                                                sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                using (cmd = new SqlCommand(sql, con))
                                                                {
                                                                    da.SelectCommand = cmd;
                                                                    da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                    dr.Dispose();
                                                                    da.Fill(ds);

                                                                    for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                    {
                                                                        string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                        if (i < ds.Tables[0].Rows.Count - 1)
                                                                        {
                                                                            if (Diamond1Ids != "")
                                                                            {
                                                                                Diamond1Ids += " " + MemberID + " ";
                                                                                Diamond1Counter++;
                                                                            }
                                                                            else
                                                                            {
                                                                                Diamond1Ids += MemberID + " ";
                                                                                Diamond1Counter++;
                                                                            }
                                                                        }
                                                                        else if (i == ds.Tables[0].Rows.Count - 1)
                                                                        {
                                                                            if (Diamond1Ids != "")
                                                                            {
                                                                                Diamond1Ids += " " + MemberID;
                                                                                Diamond1Counter++;
                                                                            }
                                                                            else
                                                                            {
                                                                                Diamond1Ids += MemberID;
                                                                                Diamond1Counter++;
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    //Set the Diaomond 1 Rank
                                                    if (Diamond1Counter < 1024 && Diamond1Counter > 0)
                                                    {
                                                        RankFinal = "Diamond1";

                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                        cmd.ExecuteNonQuery();
                                                                    }

                                                                    using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                string STATUSWithd = dr.GetValue(1).ToString();
                                                                                if (STATUSWithd == "Paid")
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                    {//userid,rank,amount,dated,status
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                        cmd.Parameters.AddWithValue("@amount", 300000);
                                                                                        cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else if (STATUSWithd == "Pending")
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                    {//userid,rank,amount,dated,status
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    if (Diamond1Counter == 1024)
                                                    {
                                                        /////////////////////////////////////
                                                        //      Inject Earnings Codes      //
                                                        ////////////////////////////////////
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                string getRank;
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    //do nothing
                                                                    getRank = dr.GetValue(0).ToString();
                                                                }
                                                                else
                                                                {
                                                                    if (getrank == "DiamondLife 1")
                                                                    {

                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    string SN = dr.GetValue(0).ToString();

                                                                                    using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                                                        dr.Dispose();
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                            {
                                                                                                getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                     dr.Dispose();
                                                                                     using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                     {
                                                                                         cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                         using (dr = cmd.ExecuteReader())
                                                                                         {
                                                                                             if (dr.Read())
                                                                                             {

                                                                                             }
                                                                                             else
                                                                                             {
                                                                                                 dr.Dispose();
                                                                                                 using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                 { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                     cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                     cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                                     cmd.Parameters.AddWithValue("@amountdue", 300000);
                                                                                                     cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                     cmd.Parameters.AddWithValue("@balance", getBalance + 300000);
                                                                                                     cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                     cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                     cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                     cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                     cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                     cmd.ExecuteNonQuery();

                                                                                                 }
                                                                                             }
                                                                                         }
                                                                                     }
                                                                                }
                                                                                else
                                                                                {
                                                                                     dr.Dispose();
                                                                                     using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                     {
                                                                                         cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                         using (dr = cmd.ExecuteReader())
                                                                                         {
                                                                                             if (dr.Read())
                                                                                             {

                                                                                             }
                                                                                             else
                                                                                             {
                                                                                                 dr.Dispose();
                                                                                                 using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                 { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                     cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                     cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                                     cmd.Parameters.AddWithValue("@amountdue", 300000);
                                                                                                     cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                     cmd.Parameters.AddWithValue("@balance", 300000);
                                                                                                     cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                     cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                     cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                     cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                     cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                     cmd.ExecuteNonQuery();
                                                                                                 }
                                                                                             }
                                                                                         }
                                                                                     }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        ////////////////////////////////////

                                                        RankFinal = "Diamond1";
                                                        TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                        splitUserIds = Diamond1Ids.Split(splitchar1);
                                                        UserIdsKeep = "";
                                                        //DrawMatrixNewCounter = 0;
                                                        fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            string SplitedUserID = splitUserIds[count];

                                                            if (TotalCounters <= TotalDownlines)
                                                            {
                                                                da.Dispose();
                                                                using (da = new SqlDataAdapter())
                                                                {
                                                                    ds = new DataSet();
                                                                    i = 0;
                                                                    sql = null;
                                                                    sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                    using (cmd = new SqlCommand(sql, con))
                                                                    {
                                                                        da.SelectCommand = cmd;
                                                                        da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                        dr.Dispose();
                                                                        da.Fill(ds);

                                                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                        {
                                                                            string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                            if (i < ds.Tables[0].Rows.Count - 1)
                                                                            {
                                                                                if (Diamond2Ids != "")
                                                                                {
                                                                                    Diamond2Ids += " " + MemberID + " ";
                                                                                    Diamond2Counter++;
                                                                                }
                                                                                else
                                                                                {
                                                                                    Diamond2Ids += MemberID + " ";
                                                                                    Diamond2Counter++;
                                                                                }
                                                                            }
                                                                            else if (i == ds.Tables[0].Rows.Count - 1)
                                                                            {
                                                                                if (Diamond2Ids != "")
                                                                                {
                                                                                    Diamond2Ids += " " + MemberID;
                                                                                    Diamond2Counter++;
                                                                                }
                                                                                else
                                                                                {
                                                                                    Diamond2Ids += MemberID;
                                                                                    Diamond2Counter++;
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        //Set the Diaomond 2 Rank
                                                        if (Diamond2Counter < 4096 && Diamond2Counter > 0)
                                                        {
                                                            RankFinal = "Diamond2";

                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string STATUSWithd = dr.GetValue(1).ToString();
                                                                                    if (STATUSWithd == "Paid")
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                        {//userid,rank,amount,dated,status
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                            cmd.Parameters.AddWithValue("@amount", 600000);
                                                                                            cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                    else if (STATUSWithd == "Pending")
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                        {//userid,rank,amount,dated,status
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (Diamond2Counter == 4096)
                                                        {
                                                            /////////////////////////////////////
                                                            //      Inject Earnings Codes      //
                                                            ////////////////////////////////////
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    string getRank;
                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    {
                                                                        //do nothing
                                                                        getRank = dr.GetValue(0).ToString();
                                                                    }
                                                                    else
                                                                    {
                                                                        if (getrank == "DiamondLife 2")
                                                                        {

                                                                        }
                                                                        else
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                    {
                                                                                        string SN = dr.GetValue(0).ToString();

                                                                                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                                            dr.Dispose();
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                                {
                                                                                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                         dr.Dispose();
                                                                                         using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                         {
                                                                                             cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                             cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                             using (dr = cmd.ExecuteReader())
                                                                                             {
                                                                                                 if (dr.Read())
                                                                                                 {

                                                                                                 }
                                                                                                 else
                                                                                                 {
                                                                                                     dr.Dispose();
                                                                                                     using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                     { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                         cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                         cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                                         cmd.Parameters.AddWithValue("@amountdue", 600000);
                                                                                                         cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                         cmd.Parameters.AddWithValue("@balance", getBalance + 600000);
                                                                                                         cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                         cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                         cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                         cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                         cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                         cmd.ExecuteNonQuery();

                                                                                                     }
                                                                                                 }
                                                                                             }
                                                                                         }
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                         dr.Dispose();
                                                                                         using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                         {
                                                                                             cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                             cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                             using (dr = cmd.ExecuteReader())
                                                                                             {
                                                                                                 if (dr.Read())
                                                                                                 {

                                                                                                 }
                                                                                                 else
                                                                                                 {
                                                                                                     dr.Dispose();
                                                                                                     using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                     { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                         cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                         cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                                         cmd.Parameters.AddWithValue("@amountdue", 600000);
                                                                                                         cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                         cmd.Parameters.AddWithValue("@balance", 600000);
                                                                                                         cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                         cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                         cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                         cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                         cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                         cmd.ExecuteNonQuery();
                                                                                                     }
                                                                                                 }
                                                                                             }
                                                                                         }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            ////////////////////////////////////

                                                            RankFinal = "Sapphire";
                                                            TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                            splitUserIds = Diamond2Ids.Split(splitchar1);
                                                            UserIdsKeep = "";
                                                            //DrawMatrixNewCounter = 0;
                                                            fullLength = splitUserIds.Length;

                                                            for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                            {
                                                                string SplitedUserID = splitUserIds[count];

                                                                if (TotalCounters <= TotalDownlines)
                                                                {
                                                                    da.Dispose();
                                                                    using (da = new SqlDataAdapter())
                                                                    {
                                                                        ds = new DataSet();
                                                                        i = 0;
                                                                        sql = null;
                                                                        sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                        using (cmd = new SqlCommand(sql, con))
                                                                        {
                                                                            da.SelectCommand = cmd;
                                                                            da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                            dr.Dispose();
                                                                            da.Fill(ds);

                                                                            for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                            {
                                                                                string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                if (i < ds.Tables[0].Rows.Count - 1)
                                                                                {
                                                                                    if (Sapphire1Ids != "")
                                                                                    {
                                                                                        Sapphire1Ids += " " + MemberID + " ";
                                                                                        Sapphire1Counter++;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        Sapphire1Ids += MemberID + " ";
                                                                                        Sapphire1Counter++;
                                                                                    }
                                                                                }
                                                                                else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                {
                                                                                    if (Sapphire1Ids != "")
                                                                                    {
                                                                                        Sapphire1Ids += " " + MemberID;
                                                                                        Sapphire1Counter++;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        Sapphire1Ids += MemberID;
                                                                                        Sapphire1Counter++;
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                            //Set the Sapphire 1 Rank
                                                            if (Sapphire1Counter < 16384 && Sapphire1Counter > 0)
                                                            {
                                                                RankFinal = "Sapphire1";

                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                cmd.ExecuteNonQuery();
                                                                            }

                                                                            using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        string STATUSWithd = dr.GetValue(1).ToString();
                                                                                        if (STATUSWithd == "Paid")
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                            {//userid,rank,amount,dated,status
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                cmd.Parameters.AddWithValue("@amount", 1500000);
                                                                                                cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                cmd.ExecuteNonQuery();
                                                                                            }
                                                                                        }
                                                                                        else if (STATUSWithd == "Pending")
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                            {//userid,rank,amount,dated,status
                                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                cmd.ExecuteNonQuery();
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                            if (Sapphire1Counter == 16384)
                                                            {
                                                                /////////////////////////////////////
                                                                //      Inject Earnings Codes      //
                                                                ////////////////////////////////////
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        dr.Dispose();
                                                                        string getRank = dr.GetValue(0).ToString();
                                                                        if (getrank == "SapphireLife 1")
                                                                        {

                                                                        }
                                                                        else
                                                                        {
                                                                            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                                    {
                                                                                        string SN = dr.GetValue(0).ToString();

                                                                                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                                            dr.Dispose();
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                                {
                                                                                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                         dr.Dispose();
                                                                                         using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                         {
                                                                                             cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                             cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                             using (dr = cmd.ExecuteReader())
                                                                                             {
                                                                                                 if (dr.Read())
                                                                                                 {

                                                                                                 }
                                                                                                 else
                                                                                                 {
                                                                                                     dr.Dispose();
                                                                                                     using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                     { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                         cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                         cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                         cmd.Parameters.AddWithValue("@amountdue", 1500000);
                                                                                                         cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                         cmd.Parameters.AddWithValue("@balance", getBalance + 1500000);
                                                                                                         cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                         cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                         cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                         cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                         cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                         cmd.ExecuteNonQuery();

                                                                                                     }
                                                                                                 }
                                                                                             }
                                                                                         }
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                         dr.Dispose();
                                                                                         using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                         {
                                                                                             cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                             cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                             using (dr = cmd.ExecuteReader())
                                                                                             {
                                                                                                 if (dr.Read())
                                                                                                 {

                                                                                                 }
                                                                                                 else
                                                                                                 {
                                                                                                     dr.Dispose();
                                                                                                     using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                     { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                         cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                         cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                                         cmd.Parameters.AddWithValue("@amountdue", 1500000);
                                                                                                         cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                         cmd.Parameters.AddWithValue("@balance", 1500000);
                                                                                                         cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                         cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                         cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                         cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                         cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                         cmd.ExecuteNonQuery();
                                                                                                     }
                                                                                                 }
                                                                                             }
                                                                                         }
                                                                                    }
                                                                                }
                                                                             }
                                                                          }
                                                                       }
                                                                    }
                                                                }

                                                                ////////////////////////////////////

                                                                RankFinal = "Sapphire1";
                                                                TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                                splitUserIds = Sapphire1Ids.Split(splitchar1);
                                                                UserIdsKeep = "";
                                                                //DrawMatrixNewCounter = 0;
                                                                fullLength = splitUserIds.Length;

                                                                for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                                {
                                                                    string SplitedUserID = splitUserIds[count];

                                                                    if (TotalCounters <= TotalDownlines)
                                                                    {
                                                                        da.Dispose();
                                                                        using (da = new SqlDataAdapter())
                                                                        {
                                                                            ds = new DataSet();
                                                                            i = 0;
                                                                            sql = null;
                                                                            sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                            using (cmd = new SqlCommand(sql, con))
                                                                            {
                                                                                da.SelectCommand = cmd;
                                                                                da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                                dr.Dispose();
                                                                                da.Fill(ds);

                                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                                {
                                                                                    string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                    if (i < ds.Tables[0].Rows.Count - 1)
                                                                                    {
                                                                                        if (Sapphire2Ids != "")
                                                                                        {
                                                                                            Sapphire2Ids += " " + MemberID + " ";
                                                                                            Sapphire2Counter++;
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            Sapphire2Ids += MemberID + " ";
                                                                                            Sapphire2Counter++;
                                                                                        }
                                                                                    }
                                                                                    else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                    {
                                                                                        if (Sapphire2Ids != "")
                                                                                        {
                                                                                            Sapphire2Ids += " " + MemberID;
                                                                                            Sapphire2Counter++;
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            Sapphire2Ids += MemberID;
                                                                                            Sapphire2Counter++;
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                //Set the Sapphire 2 Rank
                                                                if (Sapphire2Counter < 65536 && Sapphire2Counter > 0)
                                                                {
                                                                    RankFinal = "Sapphire2";

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read())
                                                                                        {
                                                                                            string STATUSWithd = dr.GetValue(1).ToString();
                                                                                            if (STATUSWithd == "Paid")
                                                                                            {
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                                {//userid,rank,amount,dated,status
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                    cmd.Parameters.AddWithValue("@amount", 6500000);
                                                                                                    cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                            else if (STATUSWithd == "Pending")
                                                                                            {
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                                {//userid,rank,amount,dated,status
                                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                if (Sapphire2Counter == 65536)
                                                                {
                                                                    /////////////////////////////////////
                                                                    //      Inject Earnings Codes      //
                                                                    ////////////////////////////////////
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            string getRank;
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                //do nothing
                                                                                getRank = dr.GetValue(0).ToString();
                                                                            }
                                                                            else
                                                                            {
                                                                                if (getrank == "SapphireLife 2")
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                            {
                                                                                                string SN = dr.GetValue(0).ToString();

                                                                                                using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                    dr.Dispose();
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                                        {
                                                                                                            getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                                 dr.Dispose();
                                                                                                 using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                                 {
                                                                                                     cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                     using (dr = cmd.ExecuteReader())
                                                                                                     {
                                                                                                         if (dr.Read())
                                                                                                         {

                                                                                                         }
                                                                                                         else
                                                                                                         {
                                                                                                             dr.Dispose();
                                                                                                             using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                             { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                                 cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                 cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                                 cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                                 cmd.Parameters.AddWithValue("@amountdue", 6500000);
                                                                                                                 cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                                 cmd.Parameters.AddWithValue("@balance", getBalance + 6500000);
                                                                                                                 cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                 cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                 cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                 cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                                 cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                                 cmd.ExecuteNonQuery();

                                                                                                             }
                                                                                                         }
                                                                                                     }
                                                                                                 }
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                 dr.Dispose();
                                                                                                 using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                                 {
                                                                                                     cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                     using (dr = cmd.ExecuteReader())
                                                                                                     {
                                                                                                         if (dr.Read())
                                                                                                         {

                                                                                                         }
                                                                                                         else
                                                                                                         {
                                                                                                             dr.Dispose();
                                                                                                             using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                             { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                                 cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                 cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                                 cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                                                 cmd.Parameters.AddWithValue("@amountdue", 6500000);
                                                                                                                 cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                                 cmd.Parameters.AddWithValue("@balance", 6500000);
                                                                                                                 cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                 cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                 cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                 cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                                 cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                                 cmd.ExecuteNonQuery();
                                                                                                             }
                                                                                                         }
                                                                                                     }
                                                                                                 }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }

                                                                    ////////////////////////////////////

                                                                    RankFinal = "Emerald";
                                                                    TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;

                                                                    splitUserIds = Sapphire2Ids.Split(splitchar1);
                                                                    UserIdsKeep = "";
                                                                    //DrawMatrixNewCounter = 0;
                                                                    fullLength = splitUserIds.Length;

                                                                    for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                                    {
                                                                        string SplitedUserID = splitUserIds[count];

                                                                        if (TotalCounters <= TotalDownlines)
                                                                        {
                                                                            da.Dispose();
                                                                            using (da = new SqlDataAdapter())
                                                                            {
                                                                                ds = new DataSet();
                                                                                i = 0;
                                                                                sql = null;
                                                                                sql = "Select memberid from familyhierarchy where parentid=@parentid order by SN";
                                                                                using (cmd = new SqlCommand(sql, con))
                                                                                {
                                                                                    da.SelectCommand = cmd;
                                                                                    da.SelectCommand.Parameters.AddWithValue("@parentid", SplitedUserID);
                                                                                    dr.Dispose();
                                                                                    da.Fill(ds);

                                                                                    for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                                    {
                                                                                        string MemberID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                                        if (i < ds.Tables[0].Rows.Count - 1)
                                                                                        {
                                                                                            if (EmeraldIds != "")
                                                                                            {
                                                                                                EmeraldIds += " " + MemberID + " ";
                                                                                                EmeraldCounter++;
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                EmeraldIds += MemberID + " ";
                                                                                                EmeraldCounter++;
                                                                                            }
                                                                                        }
                                                                                        else if (i == ds.Tables[0].Rows.Count - 1)
                                                                                        {
                                                                                            if (EmeraldIds != "")
                                                                                            {
                                                                                                EmeraldIds += " " + MemberID;
                                                                                                EmeraldCounter++;
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                EmeraldIds += MemberID;
                                                                                                EmeraldCounter++;
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    //Set the Emerald Rank
                                                                    if (EmeraldCounter < 262144 && EmeraldCounter > 0)
                                                                    {
                                                                        RankFinal = "Emerald";

                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select sn from earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Delete earnings where userid=@userid and rank=@rank", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }

                                                                                    using (cmd = new SqlCommand("Select userid,status from withdrawals where userid=@userid and rank=@rank", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                        cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string STATUSWithd = dr.GetValue(1).ToString();
                                                                                                if (STATUSWithd == "Paid")
                                                                                                {
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Insert into MinusFunds(userid,rank,amount,dated,status) values (@userid,@rank,@amount,@dated,@status)", con))
                                                                                                    {//userid,rank,amount,dated,status
                                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                        cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                        cmd.Parameters.AddWithValue("@amount", 28000000);
                                                                                                        cmd.Parameters.AddWithValue("@dated", DateTime.Now.ToShortDateString());
                                                                                                        cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }
                                                                                                else if (STATUSWithd == "Pending")
                                                                                                {
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Delete withdrawals where userid=@userid and rank=@rank", con))
                                                                                                    {//userid,rank,amount,dated,status
                                                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                        cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    if (EmeraldCounter == 262144)
                                                                    {
                                                                        /////////////////////////////////////
                                                                        //      Inject Earnings Codes      //
                                                                        ////////////////////////////////////
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select rank from Earnings where userid=@userid and rank=@rank", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                string getRank;
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {
                                                                                    //do nothing
                                                                                    getRank = dr.GetValue(0).ToString();
                                                                                }
                                                                                else
                                                                                {
                                                                                    if (getrank == "EmeraldLife")
                                                                                    {

                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                                {
                                                                                                    string SN = dr.GetValue(0).ToString();

                                                                                                    using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                                                    {
                                                                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                                                                        dr.Dispose();
                                                                                                        using (dr = cmd.ExecuteReader())
                                                                                                        {
                                                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                                                            {
                                                                                                                getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                     dr.Dispose();
                                                                                                     using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                                     {
                                                                                                         cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                         using (dr = cmd.ExecuteReader())
                                                                                                         {
                                                                                                             if (dr.Read())
                                                                                                             {

                                                                                                             }
                                                                                                             else
                                                                                                             {
                                                                                                                 dr.Dispose();
                                                                                                                 using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                                 { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                     cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                                     cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                                     cmd.Parameters.AddWithValue("@amountdue", 28000000);
                                                                                                                     cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                                     cmd.Parameters.AddWithValue("@balance", getBalance + 28000000);
                                                                                                                     cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                     cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                     cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                     cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                                     cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                                     cmd.ExecuteNonQuery();

                                                                                                                 }
                                                                                                             }
                                                                                                         }
                                                                                                     }
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                     dr.Dispose();
                                                                                                     using (cmd = new SqlCommand("Select rank from earnings where rank=@rank and userid=@userid", con))
                                                                                                     {
                                                                                                         cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                         cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                         using (dr = cmd.ExecuteReader())
                                                                                                         {
                                                                                                             if (dr.Read())
                                                                                                             {

                                                                                                             }
                                                                                                             else
                                                                                                             {
                                                                                                                 dr.Dispose();
                                                                                                                 using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                                                                 { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                                                                     cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                                                     cmd.Parameters.AddWithValue("@username", placementname);
                                                                                                                     cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                                                     cmd.Parameters.AddWithValue("@amountdue", 28000000);
                                                                                                                     cmd.Parameters.AddWithValue("@deductions", 0);
                                                                                                                     cmd.Parameters.AddWithValue("@balance", 28000000);
                                                                                                                     cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                     cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                     cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                     cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                                     cmd.Parameters.AddWithValue("@status", "Pending");
                                                                                                                     cmd.ExecuteNonQuery();
                                                                                                                 }
                                                                                                             }
                                                                                                         }
                                                                                                     }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }

                                                                        ////////////////////////////////////

                                                                        RankFinal = "Emerald Life Complete";
                                                                        TotalCounters = Silver1Counter + Silver2Counter + Gold1Counter + Gold2Counter + Diamond1Counter + Diamond2Counter + Sapphire1Counter + Sapphire2Counter + EmeraldCounter;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        else
                        {
                            RankFinal = "No Rank";
                        }                      
                    }
                }

                //Update Downlines Count
                dr.Dispose();
                using (cmd = new SqlCommand("Select userid from downlinescount where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", placementid);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            //Update
                            dr.Dispose();
                            using (cmd = new SqlCommand("Update downlinescount set downlines=@downlines,rank=@rank where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@downlines", TotalDownlines);
                                cmd.Parameters.AddWithValue("@rank", RankFinal);
                                cmd.Parameters.AddWithValue("@userid", placementid);
                                cmd.ExecuteNonQuery();
                            }
                        }
                        else
                        {
                            //Insert
                            dr.Dispose();
                            using (cmd = new SqlCommand("Insert into downlinescount (userid,downlines,rank) values (@userid,@downlines,@rank)", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", placementid);
                                cmd.Parameters.AddWithValue("@downlines", TotalDownlines);
                                cmd.Parameters.AddWithValue("@rank", RankFinal);
                                cmd.ExecuteNonQuery();
                            }
                        }
                    }
                }
            }
        }

        public void GetRankLevel()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select rank from downlinescount where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            matrixRank = dr.GetValue(0).ToString();
                        }
                        else
                        {
                            matrixRank = "";
                        }
                    }
                }
            }
        }

        public void CompressedMatrixGenerator()
        {
            using (con2 = new SqlConnection(conn))
            {
                con2.Open();

                using (da = new SqlDataAdapter())
                {
                    DataSet ds = new DataSet();
                    int i = 0;
                    string sql = null;
                    sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                    using (cmd1 = new SqlCommand(sql, con2))
                    {
                        da.SelectCommand = cmd1;
                        da.SelectCommand.Parameters.AddWithValue("@placementid", UserId);
                        //dr.Dispose();
                        da.Fill(ds);



                        int count = ds.Tables[0].Rows.Count;

                        //Silver Stage 2
                        for (i = 0; i <= ds.Tables[0].Rows.Count-1; i++)
                        {
                            string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                            string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                            string UserIDc = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                            string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                            //string Rank = "SilverLife 2";
                            string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();
                            trailer++;


                            Register reg = new Register();
                            reg.placementid = UserIDc;
                            reg.DrawMatrixNew();

                            Register regg = new Register();
                            regg.placementid = UserIDc;
                            regg.placementname = UserIDName;
                            regg.FinalRankChecker();




                            string RunningRank = "";
                            using (cmd1 = new SqlCommand("Select rank from downlinescount where userid=@userid", con2))
                            {
                                cmd1.Parameters.AddWithValue("@userid", UserIDc);
                                using (dr1 = cmd1.ExecuteReader())
                                {
                                    if (dr1.Read() && !dr1.IsDBNull(0))
                                    {
                                        matrixRank = dr1.GetValue(0).ToString();
                                        RunningRank = matrixRank;
                                    }
                                    else
                                    {
                                        matrixRank = "NoRank";
                                        RunningRank = "NoRank";
                                    }
                                }
                            }

                            int length = UserIDName.Length;
                            if(length > 8)
                            {
                                int balance = length - 8;

                                UserIDName = UserIDName.Substring(0, UserIDName.Length - balance);
                            }

                            if (count == 4)
                            {
                                if (trailer == 1)
                                {
                                    CompName1 = UserIDName;
                                    CompID1 = UserIDc;
                                    CompRank1 = RunningRank;
                                }
                                else if (trailer == 2)
                                {
                                    CompName2 = UserIDName;
                                    CompID2 = UserIDc;
                                    CompRank2 = RunningRank;
                                }
                                else if (trailer == 3)
                                {
                                    CompName3 = UserIDName;
                                    CompID3 = UserIDc;
                                    CompRank3 = RunningRank;
                                }
                                else if (trailer == 4)
                                {
                                    CompName4 = UserIDName;
                                    CompID4 = UserIDc;
                                    CompRank4 = RunningRank;
                                }
                            }
                            else if (count == 3)
                            {
                                if (trailer == 1)
                                {
                                    CompName1 = UserIDName;
                                    CompID1 = UserIDc;
                                    CompRank1 = RunningRank;
                                }
                                else if (trailer == 2)
                                {
                                    CompName2 = UserIDName;
                                    CompID2 = UserIDc;
                                    CompRank2 = RunningRank;
                                }
                                else if (trailer == 3)
                                {
                                    CompName3 = UserIDName;
                                    CompID3 = UserIDc;
                                    CompRank3 = RunningRank;
                                }
                            }
                            else if (count == 2)
                            {
                                if (trailer == 1)
                                {
                                    CompName1 = UserIDName;
                                    CompID1 = UserIDc;
                                    CompRank1 = RunningRank;
                                }
                                else if (trailer == 2)
                                {
                                    CompName2 = UserIDName;
                                    CompID2 = UserIDc;
                                    CompRank2 = RunningRank;
                                }
                            }
                            else if (count == 1)
                            {
                                if (trailer == 1)
                                {
                                    CompName1 = UserIDName;
                                    CompID1 = UserIDc;
                                    CompRank1 = RunningRank;
                                }
                            }
                        }
                    }
                }
            }
        }

        #region MatrixConverter
        public void MatrixLinkConverterSilver()
        {
            if (countLine == 1)
            {
                if (DrawMatrixNewCounter == 1)
                {
                    MatrixLink = "Silver_1_1";
                    MatrixRank = "Silver 1";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 2)
                {
                    MatrixLink = "Silver_1_2";
                    MatrixRank = "Silver 1";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 3)
                {
                    MatrixLink = "Silver_1_3";
                    MatrixRank = "Silver 1";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 4)
                {
                    MatrixLink = "Silver_1_4";
                    MatrixRank = "Silver 1";
                    Silver = 1;
                }
            }
            else if (countLine == 2)
            {
                if (DrawMatrixNewCounter == 5)
                {
                    MatrixLink = "Silver_2_1";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 6)
                {
                    MatrixLink = "Silver_2_2";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 7)
                {
                    MatrixLink = "Silver_2_3";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 8)
                {
                    MatrixLink = "Silver_2_4";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 9)
                {
                    MatrixLink = "Silver_2_5";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 10)
                {
                    MatrixLink = "Silver_2_6";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 11)
                {
                    MatrixLink = "Silver_2_7";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 12)
                {
                    MatrixLink = "Silver_2_8";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 13)
                {
                    MatrixLink = "Silver_2_9";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 14)
                {
                    MatrixLink = "Silver_2_10";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 15)
                {
                    MatrixLink = "Silver_2_11";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 16)
                {
                    MatrixLink = "Silver_2_12";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 17)
                {
                    MatrixLink = "Silver_2_13";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 18)
                {
                    MatrixLink = "Silver_2_14";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 19)
                {
                    MatrixLink = "Silver_2_15";
                    MatrixRank = "Silver 2";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter == 20)
                {
                    MatrixLink = "Gold_1_0";
                    MatrixRank = "Gold";
                    Silver = 1;
                }
                else if (DrawMatrixNewCounter > 20 && DrawMatrixNewCounter < 32)
                {
                    MatrixLink = "Gold_1_0";
                    MatrixRank = "Gold";
                    Silver = 1;
                }
            }

            try
            {
                if (Silver == 1)
                {
                    using (con1 = new SqlConnection(conn))
                    {
                        con1.Open();
                        using (cmd1 = new SqlCommand("Select downlines from downlinescount where userid=@userid", con1))
                        {
                            cmd1.Parameters.AddWithValue("@userid", placementid);
                            using (dr1 = cmd1.ExecuteReader())
                            {
                                if (dr1.Read() && !dr1.IsDBNull(0))
                                {

                                    //update
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Update downlinescount set downlines=@downlines,rank=@rank where userid=@userid", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }
                                }
                                else
                                {

                                    //insert
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Insert into downlinescount (userid,downlines,rank) values (@userid,@downlines,@rank)", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void MatrixLinkConverterGold()
        {
            //if (countLine == 1)
            //{
                if (DrawMatrixNewCounter == 36 || DrawMatrixNewCounter > 36 && DrawMatrixNewCounter < 52)
                {
                    MatrixLink = "Gold_1_1";
                    MatrixRank = "Gold 1";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 52 || DrawMatrixNewCounter > 52 && DrawMatrixNewCounter < 68)
                {
                    MatrixLink = "Gold_1_2";
                    MatrixRank = "Gold 1";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 68 || DrawMatrixNewCounter > 68 && DrawMatrixNewCounter < 84)
                {
                    MatrixLink = "Gold_1_3";
                    MatrixRank = "Gold 1";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 84)
                {
                    MatrixLink = "Gold_1_4";
                    MatrixRank = "Gold 1";
                    Gold = 1;
                }
            //}
            //else if (countLine == 2)
            //{
                else if (DrawMatrixNewCounter == 100)
                {
                    MatrixLink = "Gold_2_1";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 116)
                {
                    MatrixLink = "Gold_2_2";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 132)
                {
                    MatrixLink = "Gold_2_3";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 148)
                {
                    MatrixLink = "Gold_2_4";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 164)
                {
                    MatrixLink = "Gold_2_5";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 180)
                {
                    MatrixLink = "Gold_2_6";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 196)
                {
                    MatrixLink = "Gold_2_7";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 212)
                {
                    MatrixLink = "Gold_2_8";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 228)
                {
                    MatrixLink = "Gold_2_9";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 244)
                {
                    MatrixLink = "Gold_2_10";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 260)
                {
                    MatrixLink = "Gold_2_11";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 276)
                {
                    MatrixLink = "Gold_2_12";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 292)
                {
                    MatrixLink = "Gold_2_13";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 308)
                {
                    MatrixLink = "Gold_2_14";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 324)
                {
                    MatrixLink = "Gold_2_15";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter == 340)
                {
                    MatrixLink = "Diamond_1_0";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
                else if (DrawMatrixNewCounter > 340 && DrawMatrixNewCounter < 596)
                {
                    MatrixLink = "Diamond_1_0";
                    MatrixRank = "Gold 2";
                    Gold = 1;
                }
            //}
            
            try
            {
                if (Gold == 1)
                {
                    using (con1 = new SqlConnection(conn))
                    {
                        con1.Open();
                        using (cmd1 = new SqlCommand("Select downlines from downlinescount where userid=@userid", con1))
                        {
                            cmd1.Parameters.AddWithValue("@userid", placementid);
                            using (dr1 = cmd1.ExecuteReader())
                            {
                                if (dr1.Read() && !dr1.IsDBNull(0))
                                {

                                    //update
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Update downlinescount set downlines=@downlines,rank=@rank where userid=@userid", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }
                                }
                                else
                                {

                                    //insert
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Insert into downlinescount (userid,downlines,rank) values (@userid,@downlines,@rank)", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void MatrixLinkConverterDiamond()
        {
            if (countLine == 1)
            {
                if (DrawMatrixNewCounter == 596)
                {
                    MatrixLink = "Diamond_1_1";
                    MatrixRank = "Diamond 1";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 852)
                {
                    MatrixLink = "Diamond_1_2";
                    MatrixRank = "Diamond 1";
                }
                else if (DrawMatrixNewCounter == 1108)
                {
                    MatrixLink = "Diamond_1_3";
                    MatrixRank = "Diamond 1";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 1364)
                {
                    MatrixLink = "Diamond_1_4";
                    MatrixRank = "Diamond 1";
                    Diamond = 1;
                }
            }
            else if (countLine == 2)
            {
                if (DrawMatrixNewCounter == 1620)
                {
                    MatrixLink = "Diamond_2_1";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 1876)
                {
                    MatrixLink = "Diamond_2_2";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 2132)
                {
                    MatrixLink = "Diamond_2_3";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 2388)
                {
                    MatrixLink = "Diamond_2_4";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 2644)
                {
                    MatrixLink = "Diamond_2_5";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 2900)
                {
                    MatrixLink = "Diamond_2_6";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 3156)
                {
                    MatrixLink = "Diamond_2_7";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 3412)
                {
                    MatrixLink = "Diamond_2_8";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 3668)
                {
                    MatrixLink = "Diamond_2_9";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 3924)
                {
                    MatrixLink = "Diamond_2_10";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 4180)
                {
                    MatrixLink = "Diamond_2_11";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 4436)
                {
                    MatrixLink = "Diamond_2_12";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 4692)
                {
                    MatrixLink = "Diamond_2_13";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 4948)
                {
                    MatrixLink = "Diamond_2_14";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 5204)
                {
                    MatrixLink = "Diamond_2_15";
                    MatrixRank = "Diamond 2";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter == 5460)
                {
                    MatrixLink = "Sapphire_1_0";
                    MatrixRank = "Sapphire";
                    Diamond = 1;
                }
                else if (DrawMatrixNewCounter > 5460 && DrawMatrixNewCounter < 9556)
                {
                    MatrixLink = "Sapphire_1_0";
                    MatrixRank = "Sapphire";
                    Diamond = 1;
                }
            }
            try
            {
                if (Diamond == 1)
                {
                    using (con1 = new SqlConnection(conn))
                    {
                        con1.Open();
                        using (cmd1 = new SqlCommand("Select downlines from downlinescount where userid=@userid", con1))
                        {
                            cmd1.Parameters.AddWithValue("@userid", placementid);
                            using (dr1 = cmd1.ExecuteReader())
                            {
                                if (dr1.Read() && !dr1.IsDBNull(0))
                                {
                                    //update
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Update downlinescount set downlines=@downlines,rank=@rank where userid=@userid", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }

                                }
                                else
                                {   //insert
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Insert into downlinescount (userid,downlines,rank) values (@userid,@downlines,@rank)", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                

            }
        }

        public void MatrixLinkConverterSapphire()
        {
            if (countLine == 1)
            {
                if (DrawMatrixNewCounter == 9556)
                {
                    MatrixLink = "Sapphire_1_1";
                    MatrixRank = "Sapphire 1";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 13652)
                {
                    MatrixLink = "Sapphire_1_2";
                    MatrixRank = "Sapphire 1";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 17748)
                {
                    MatrixLink = "Sapphire_1_3";
                    MatrixRank = "Sapphire 1";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 21844)
                {
                    MatrixLink = "Sapphire_1_4";
                    MatrixRank = "Sapphire 1";
                    Sapphire = 1;
                }
            }
            else if(countLine == 2)
            {
                if (DrawMatrixNewCounter == 25940)
                {
                    MatrixLink = "Sapphire_2_1";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 30036)
                {
                    MatrixLink = "Sapphire_2_2";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 34132)
                {
                    MatrixLink = "Sapphire_2_3";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 38228)
                {
                    MatrixLink = "Sapphire_2_4";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 42324)
                {
                    MatrixLink = "Sapphire_2_5";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 46420)
                {
                    MatrixLink = "Sapphire_2_6";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 50516)
                {
                    MatrixLink = "Sapphire_2_7";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 54612)
                {
                    MatrixLink = "Sapphire_2_8";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 58708)
                {
                    MatrixLink = "Sapphire_2_9";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 62804)
                {
                    MatrixLink = "Sapphire_2_10";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 66900)
                {
                    MatrixLink = "Sapphire_2_11";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 70996)
                {
                    MatrixLink = "Sapphire_2_12";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 75092)
                {
                    MatrixLink = "Sapphire_2_13";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 79188)
                {
                    MatrixLink = "Sapphire_2_14";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 83284)
                {
                    MatrixLink = "Sapphire_2_15";
                    MatrixRank = "Sapphire 2";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter == 87380)
                {
                    MatrixLink = "Emerald_1_0";
                    MatrixRank = "Emerald";
                    Sapphire = 1;
                }
                else if (DrawMatrixNewCounter > 87380 && DrawMatrixNewCounter < 152916)
                {
                    MatrixLink = "Emerald_1_0";
                    MatrixRank = "Emerald";
                    Sapphire = 1;
                }
            }
            try
            {
                if (Sapphire == 1)
                {
                    using (con1 = new SqlConnection(conn))
                    {
                        con1.Open();
                        using (cmd1 = new SqlCommand("Select downlines from downlinescount where userid=@userid", con1))
                        {
                            cmd1.Parameters.AddWithValue("@userid", placementid);
                            using (dr1 = cmd1.ExecuteReader())
                            {
                                if (dr1.Read() && !dr1.IsDBNull(0))
                                {
                                    //update
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Update downlinescount set downlines=@downlines,rank=@rank where userid=@userid", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }
                                }
                                else
                                {
                                    //insert
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Insert into downlinescount (userid,downlines,rank) values (@userid,@downlines,@rank)", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void MatrixLinkConverterEmerald()
        {
            if (DrawMatrixNewCounter == 152916)
            {
                MatrixLink = "Emerald_1_1";
                MatrixRank = "Emerald";
                Emerald = 1;
            }
            else if (DrawMatrixNewCounter == 218452)
            {
                MatrixLink = "Emerald_1_2";
                MatrixRank = "Emerald";
                Emerald = 1;
            }
            else if (DrawMatrixNewCounter == 283988)
            {
                MatrixLink = "Emerald_1_3";
                MatrixRank = "Emerald";
                Emerald = 1;
            }
            else if (DrawMatrixNewCounter == 349524)
            {
                MatrixLink = "Emerald_1_4";
                MatrixRank = "Emerald";
                Emerald = 1;
            }
            try
            {
                if (Emerald == 1)
                {
                    using (con1 = new SqlConnection(conn))
                    {
                        con1.Open();
                        using (cmd1 = new SqlCommand("Select downlines from downlinescount where userid=@userid", con1))
                        {
                            cmd1.Parameters.AddWithValue("@userid", placementid);
                            using (dr1 = cmd1.ExecuteReader())
                            {
                                if (dr1.Read() && !dr1.IsDBNull(0))
                                {
                                    //update
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Update downlinescount set downlines=@downlines,rank=@rank where userid=@userid", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }
                                }
                                else
                                {
                                    //insert
                                    dr1.Dispose();
                                    using (cmd1 = new SqlCommand("Insert into downlinescount (userid,downlines,rank) values (@userid,@downlines,@rank)", con1))
                                    {
                                        cmd1.Parameters.AddWithValue("@userid", placementid);
                                        cmd1.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                        cmd1.Parameters.AddWithValue("@rank", MatrixRank);
                                        cmd1.ExecuteNonQuery();
                                    }

                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {

            }
        } 
        #endregion

        public void DrawMatrixNew()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Delete FamilyHierarchy", con))
                    {
                        cmd.ExecuteNonQuery();
                    }

                    using (cmd = new SqlCommand("Select placementid from placement where placementid=@placementid", con))
                    {
                        cmd.Parameters.AddWithValue("@placementid", placementid);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                using (cmd = new SqlCommand("Select partnername from register where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                    dr.Dispose();
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            placementname = dr.GetValue(0).ToString();
                                        }
                                    }
                                }

                                using (cmd = new SqlCommand("Delete matrixplace", con))
                                {
                                    cmd.ExecuteNonQuery();
                                }

                                using (cmd = new SqlCommand("Delete matrixplace1", con))
                                {
                                    cmd.ExecuteNonQuery();
                                }

                                using (cmd = new SqlCommand("Delete matrixplacecount", con))
                                {
                                    cmd.ExecuteNonQuery();
                                }

                                using (cmd = new SqlCommand("Delete matrixplacecount1", con))
                                {
                                    cmd.ExecuteNonQuery();
                                }

                                using (cmd = new SqlCommand("Delete FamilyHierarchy", con))
                                {
                                    cmd.ExecuteNonQuery();
                                }

                                using (da = new SqlDataAdapter())
                                {
                                    //, con
                                    DataSet ds = new DataSet();
                                    int i = 0;
                                    string sql = null;
                                    sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                    using (cmd = new SqlCommand(sql, con))
                                    {
                                        da.SelectCommand = cmd;
                                        da.SelectCommand.Parameters.AddWithValue("@placementid", placementid);
                                        dr.Dispose();
                                        da.Fill(ds);

                                        //Silver Stage 1
                                        for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                        {
                                            countLine = 1;
                                            string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                            string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                            string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                            string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                            string Rank = "SilverLife 1";
                                            string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                            int CountChecker = 0;
                                            using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read())
                                                    {
                                                        CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                    }
                                                }
                                            }
                                            if (CountChecker == 4)
                                            {
                                                // do nothing
                                            }
                                            else
                                            {
                                                using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                {//placementid,placementname,userid,useridname,rank,datereg
                                                    cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                    cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                    cmd.Parameters.AddWithValue("@userid", UserID);
                                                    cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                    cmd.Parameters.AddWithValue("@rank", Rank);
                                                    cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                    cmd.ExecuteNonQuery();
                                                }

                                                using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                {//placementid,placementname,userid,useridname,rank,datereg
                                                    cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                    cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                    cmd.Parameters.AddWithValue("@userid", UserID);
                                                    cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                    cmd.Parameters.AddWithValue("@rank", Rank);
                                                    cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                    cmd.ExecuteNonQuery();
                                                }

                                                using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@memberid", UserID);
                                                    cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                    cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {

                                                        }
                                                        else
                                                        {
                                                            using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                            DrawMatrixNewCounter++;
                                            UserIdsKeep += UserID + " ";

                                        }
                                        //Put the method here
                                        MatrixLinkConverterSilver();
                                        if (DrawMatrixNewCounter < 4)
                                        {
                                            using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", placementid);
                                                cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read())
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                            cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                            cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                            cmd.ExecuteNonQuery();
                                                        }

                                                        using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                            cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                            cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                            cmd.ExecuteNonQuery();
                                                        }
                                                    }
                                                    else
                                                    {
                                                        using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                        {//userid,rank,downlines
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                            cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                            cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                            dr.Dispose();
                                                            cmd.ExecuteNonQuery();
                                                        }

                                                        using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                        {//userid,rank,downlines
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                                            cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                            cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                            dr.Dispose();
                                                            cmd.ExecuteNonQuery();
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        if (DrawMatrixNewCounter == 4)
                                        {
                                            //dr.Dispose();
                                            //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                            //{
                                            //    cmd.Parameters.AddWithValue("@userid", placementid);
                                            //    //cmd.Parameters.AddWithValue("@username", placementname);
                                            //    cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                            //    using (dr = cmd.ExecuteReader())
                                            //    {
                                            //        if (dr.Read() && !dr.IsDBNull(0))
                                            //        {
                                            //            //do nothing
                                            //        }
                                            //        else
                                            //        {
                                            //            dr.Dispose();
                                            //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                            //            {
                                            //                cmd.Parameters.AddWithValue("@userid", placementid);
                                            //                using (dr = cmd.ExecuteReader())
                                            //                {
                                            //                    if (dr.Read() && !dr.IsDBNull(0))
                                            //                    {
                                            //                        string SN = dr.GetValue(0).ToString();

                                            //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                            //                        {
                                            //                            cmd.Parameters.AddWithValue("@sn", SN);
                                            //                            dr.Dispose();
                                            //                            using (dr = cmd.ExecuteReader())
                                            //                            {
                                            //                                if (dr.Read() && !dr.IsDBNull(0))
                                            //                                {
                                            //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                            //                                }
                                            //                            }
                                            //                        }
                                            //                        dr.Dispose();
                                            //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                            //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                            //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                            //                            cmd.Parameters.AddWithValue("@username", placementname);
                                            //                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                            //                            cmd.Parameters.AddWithValue("@amountdue", 5000);
                                            //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                            //                            cmd.Parameters.AddWithValue("@balance", getBalance + 5000);
                                            //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                            //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                            //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                            //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                            //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                            //                            cmd.ExecuteNonQuery();

                                            //                        }
                                            //                    }
                                            //                    else
                                            //                    {
                                            //                        dr.Dispose();
                                            //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                            //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                            //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                            //                            cmd.Parameters.AddWithValue("@username", placementname);
                                            //                            cmd.Parameters.AddWithValue("@rank", "SilverLife 1");
                                            //                            cmd.Parameters.AddWithValue("@amountdue", 5000);
                                            //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                            //                            cmd.Parameters.AddWithValue("@balance", 5000);
                                            //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                            //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                            //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                            //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                            //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                            //                            cmd.ExecuteNonQuery();

                                            //                        }
                                            //                    }
                                            //                }
                                            //            }
                                            //        }
                                            //    }
                                            //}
                                        }
                                    }
                                }

                                //Silver 2
                                if (DrawMatrixNewCounter == 4)
                                {
                                    using (SqlDataAdapter da = new SqlDataAdapter())
                                    {
                                        //UserIdsKeep = "";
                                        //DrawMatrixNewCounter = 0;
                                        int count;
                                        string[] splitUserIds;
                                        char[] splitchar1 = { ' ' };
                                        splitUserIds = UserIdsKeep.Split(splitchar1);
                                        UserIdsKeep = "";
                                        //DrawMatrixNewCounter = 0;
                                        if (!splitUserIds.Contains(" "))
                                        {
                                            int fullLength = splitUserIds.Length;

                                            for (count = 0; count <= splitUserIds.Length - 1; count++)
                                            {
                                                
                                                // if (DrawMatrixNewCounter <= fullLength)
                                                // {
                                                string SplitedUserID = splitUserIds[count];

                                                DataSet ds = new DataSet();
                                                int i = 0;
                                                string sql = null;
                                                sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                using (cmd = new SqlCommand(sql, con))
                                                {
                                                    da.SelectCommand = cmd;
                                                    da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                    dr.Dispose();
                                                    da.Fill(ds);


                                                    //Silver Stage 2
                                                    for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                    {
                                                        string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                        string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                        string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                        string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                        string Rank = "SilverLife 2";
                                                        string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                        int CountChecker = 0;
                                                        using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                }
                                                            }
                                                        }
                                                        if (CountChecker == 4)
                                                        {
                                                            // do nothing
                                                        }
                                                        else
                                                        {
                                                            using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                            {//placementid,placementname,userid,useridname,rank,datereg
                                                                cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                                cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                cmd.Parameters.AddWithValue("@rank", Rank);
                                                                cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                            {//placementid,placementname,userid,useridname,rank,datereg
                                                                cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                                cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                cmd.Parameters.AddWithValue("@rank", Rank);
                                                                cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    {

                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        UserIdsKeep += UserID + " ";
                                                        DrawMatrixNewCounter++;
                                                        countLine = 2;
                                                    }
                                                    //Convert Method
                                                    MatrixLinkConverterSilver();
                                                    //if (DrawMatrixNewCounter > 4 && DrawMatrixNewCounter < 16)
                                                    if (DrawMatrixNewCounter > 4 && DrawMatrixNewCounter < 20)
                                                    {
                                                        using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                        cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                        cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                        cmd.ExecuteNonQuery();
                                                                    }

                                                                    using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                        cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                        cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                        cmd.ExecuteNonQuery();
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                    {//userid,rank,downlines
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                        cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                        cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                        dr.Dispose();
                                                                        cmd.ExecuteNonQuery();
                                                                    }

                                                                    using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                    {//userid,rank,downlines
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                        cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                        cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                        dr.Dispose();
                                                                        cmd.ExecuteNonQuery();
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    //if (DrawMatrixNewCounter == 16)
                                                    if (DrawMatrixNewCounter == 20)
                                                    {
                                                        //dr.Dispose();
                                                        //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                        //{
                                                        //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                        //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                        //    cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                        //    using (dr = cmd.ExecuteReader())
                                                        //    {
                                                        //        if (dr.Read() && !dr.IsDBNull(0))
                                                        //        {
                                                        //            //do nothing
                                                        //        }
                                                        //        else
                                                        //        {
                                                        //            dr.Dispose();
                                                        //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                        //            {
                                                        //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                        //                using (dr = cmd.ExecuteReader())
                                                        //                {
                                                        //                    if (dr.Read() && !dr.IsDBNull(0))
                                                        //                    {
                                                        //                        string SN = dr.GetValue(0).ToString();

                                                        //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                        //                        {
                                                        //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                        //                            dr.Dispose();
                                                        //                            using (dr = cmd.ExecuteReader())
                                                        //                            {
                                                        //                                if (dr.Read() && !dr.IsDBNull(0))
                                                        //                                {
                                                        //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                        //                                }
                                                        //                            }
                                                        //                        }
                                                        //                        dr.Dispose();
                                                        //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                        //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                        //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                        //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                        //                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                        //                            cmd.Parameters.AddWithValue("@amountdue", 40000);
                                                        //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                        //                            cmd.Parameters.AddWithValue("@balance", getBalance + 40000);
                                                        //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                        //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                        //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                        //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                        //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                        //                            cmd.ExecuteNonQuery();

                                                        //                        }
                                                        //                    }
                                                        //                    else
                                                        //                    {
                                                        //                        dr.Dispose();
                                                        //                        getBalance = 0;

                                                        //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                        //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                        //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                        //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                        //                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                        //                            cmd.Parameters.AddWithValue("@amountdue", 40000);
                                                        //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                        //                            cmd.Parameters.AddWithValue("@balance", 40000);
                                                        //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                        //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                        //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                        //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                        //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                        //                            cmd.ExecuteNonQuery();

                                                        //                        }
                                                        //                    }
                                                        //                }
                                                        //            }
                                                        //        }
                                                        //    }
                                                        //}
                                                    }
                                                }
                                                //}
                                            }
                                        }
                                    }
                                }
                                else if(DrawMatrixNewCounter > 4)
                                {
                                    using (SqlDataAdapter da = new SqlDataAdapter())
                                    {
                                        //UserIdsKeep = "";
                                        ////DrawMatrixNewCounter = 0;
                                        int count;
                                        string[] splitUserIds;
                                        char[] splitchar1 = { ' ' };
                                        splitUserIds = UserIdsKeep.Split(splitchar1);
                                        UserIdsKeep = "";
                                        //DrawMatrixNewCounter = 0;
                                        if (!splitUserIds.Contains(" "))
                                        {
                                            int fullLength = splitUserIds.Length;

                                            for (count = 0; count <= splitUserIds.Length - 1; count++)
                                            {
                                                // if (DrawMatrixNewCounter <= fullLength)
                                                // {
                                                string SplitedUserID = splitUserIds[count];

                                                DataSet ds = new DataSet();
                                                int i = 0;
                                                string sql = null;
                                                sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                using (cmd = new SqlCommand(sql, con))
                                                {
                                                    da.SelectCommand = cmd;
                                                    da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                    dr.Dispose();
                                                    da.Fill(ds);


                                                    //Silver Stage 2
                                                    for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                    {
                                                        
                                                        string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                        string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                        string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                        string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                        string Rank = "SilverLife 2";
                                                        string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                        int CountChecker = 0;
                                                        using (cmd = new SqlCommand("Select Count(placementid) from matrixplace1 where placementid=@placementid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                }
                                                            }
                                                        }
                                                        if (CountChecker == 4)
                                                        {
                                                            // do nothing
                                                        }
                                                        else
                                                        {
                                                            using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                            {//placementid,placementname,userid,useridname,rank,datereg
                                                                cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                                cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                cmd.Parameters.AddWithValue("@rank", Rank);
                                                                cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                            {//placementid,placementname,userid,useridname,rank,datereg
                                                                cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                cmd.Parameters.AddWithValue("@userid", UserID);
                                                                cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                cmd.Parameters.AddWithValue("@rank", Rank);
                                                                cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    {

                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        UserIdsKeep += UserID + " ";
                                                        DrawMatrixNewCounter++;
                                                        countLine = 2;
                                                    }
                                                    //Convert Method
                                                    MatrixLinkConverterSilver();
                                                    //if (DrawMatrixNewCounter > 4 && DrawMatrixNewCounter < 16)
                                                    if (DrawMatrixNewCounter > 4 && DrawMatrixNewCounter < 20)
                                                    {
                                                        using (cmd = new SqlCommand("Select userid from matrixplacecount1 where userid=@userid and rank=@rank", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    dr.Dispose();                                                                   
                                                                    using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                        cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                        cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                        cmd.ExecuteNonQuery();
                                                                    }
                                                                }
                                                                else
                                                                {                                                                    
                                                                    using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                    {//userid,rank,downlines
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                                        cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                        cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                        dr.Dispose();
                                                                        cmd.ExecuteNonQuery();
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    //if (DrawMatrixNewCounter == 16)
                                                    if (DrawMatrixNewCounter == 20)
                                                    {
                                                        //dr.Dispose();
                                                        //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                        //{
                                                        //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                        //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                        //    cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                        //    using (dr = cmd.ExecuteReader())
                                                        //    {
                                                        //        if (dr.Read() && !dr.IsDBNull(0))
                                                        //        {
                                                        //            //do nothing
                                                        //        }
                                                        //        else
                                                        //        {
                                                        //            dr.Dispose();
                                                        //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                        //            {
                                                        //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                        //                using (dr = cmd.ExecuteReader())
                                                        //                {
                                                        //                    if (dr.Read() && !dr.IsDBNull(0))
                                                        //                    {
                                                        //                        string SN = dr.GetValue(0).ToString();

                                                        //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                        //                        {
                                                        //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                        //                            dr.Dispose();
                                                        //                            using (dr = cmd.ExecuteReader())
                                                        //                            {
                                                        //                                if (dr.Read() && !dr.IsDBNull(0))
                                                        //                                {
                                                        //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                        //                                }
                                                        //                            }
                                                        //                        }
                                                        //                        dr.Dispose();
                                                        //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                        //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                        //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                        //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                        //                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                        //                            cmd.Parameters.AddWithValue("@amountdue", 40000);
                                                        //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                        //                            cmd.Parameters.AddWithValue("@balance", getBalance + 40000);
                                                        //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                        //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                        //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                        //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                        //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                        //                            cmd.ExecuteNonQuery();

                                                        //                        }
                                                        //                    }
                                                        //                    else
                                                        //                    {
                                                        //                        dr.Dispose();
                                                        //                        getBalance = 0;

                                                        //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                        //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                        //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                        //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                        //                            cmd.Parameters.AddWithValue("@rank", "SilverLife 2");
                                                        //                            cmd.Parameters.AddWithValue("@amountdue", 40000);
                                                        //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                        //                            cmd.Parameters.AddWithValue("@balance", 40000);
                                                        //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                        //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                        //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                        //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                        //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                        //                            cmd.ExecuteNonQuery();

                                                        //                        }
                                                        //                    }
                                                        //                }
                                                        //            }
                                                        //        }
                                                        //    }
                                                        //}
                                                    }
                                                }
                                                //}
                                            }
                                        }
                                    }
                                }

                                

                                /////////////////////
                                ////GOLD SECTION/////
                                /////////////////////
                                using (cmd = new SqlCommand("Select count(placementid) from matrixplace", con))
                                {
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int getCount = int.Parse(dr.GetValue(0).ToString());
                                            if (getCount > 20)
                                            {
                                                //Gold 1
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Gold Stage 1
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    countLine = 1;
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "GoldLife 1";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 16)
                                                                    if (CountChecker == 20)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterGold();
                                                                //if (DrawMatrixNewCounter > 16 && DrawMatrixNewCounter < 64)
                                                                if (DrawMatrixNewCounter > 20 && DrawMatrixNewCounter < 84)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 64)
                                                                if (DrawMatrixNewCounter == 84)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 72000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();

                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 72000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            //}
                                                        }
                                                    }
                                                }
                                                //Gold 2
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Gold Stage 2
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "GoldLife 2";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 64)
                                                                    if (CountChecker == 84)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                    countLine = 2;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterGold();
                                                                //if (DrawMatrixNewCounter > 64 && DrawMatrixNewCounter < 256)
                                                                if (DrawMatrixNewCounter > 84 && DrawMatrixNewCounter < 276)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 256)
                                                                if (DrawMatrixNewCounter == 276)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 150000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 150000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 150000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 150000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //Gold 1
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            countLine = 1;
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Gold Stage 1
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "GoldLife 1";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace1 where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 16)
                                                                    if (CountChecker == 20)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterGold();
                                                                //if (DrawMatrixNewCounter > 16 && DrawMatrixNewCounter < 64)
                                                                if (DrawMatrixNewCounter > 20 && DrawMatrixNewCounter < 84)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount1 where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

//                                                                if (DrawMatrixNewCounter == 64)
                                                                if (DrawMatrixNewCounter == 84)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 72000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();

                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "GoldLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 72000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 72000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            //}
                                                        }
                                                    }
                                                }
                                                //Gold 2
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Gold Stage 2
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "GoldLife 2";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace1 where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 64)
                                                                    if (CountChecker == 84)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                    countLine = 2;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterGold();
                                                                //if (DrawMatrixNewCounter > 64 && DrawMatrixNewCounter < 256)
                                                                if (DrawMatrixNewCounter > 84 && DrawMatrixNewCounter < 276)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount1 where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 256)
                                                                if (DrawMatrixNewCounter == 276)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 150000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 150000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "GoldLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 150000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 150000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            
                                
                                        

                                ///////////////////////
                                ////Diamond Life//////
                                /////////////////////
                                //Diamond 1
                                using (cmd = new SqlCommand("Select count(placementid) from matrixplace", con))
                                {
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int getCount = int.Parse(dr.GetValue(0).ToString());
                                            //if (getCount > 340)
                                            if (getCount > 360)
                                            {
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            countLine = 1;
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Diamond Stage 1
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "DiamondLife 1";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 256)
                                                                    if (CountChecker == 276)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterDiamond();
                                                                //if (DrawMatrixNewCounter > 256 && DrawMatrixNewCounter < 1024)
                                                                if (DrawMatrixNewCounter > 276 && DrawMatrixNewCounter < 1044)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 1024)
                                                                if (DrawMatrixNewCounter == 1044)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 300000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 300000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 300000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 300000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            // }
                                                        }
                                                    }
                                                }
                                                //Diamond 2
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //DiamondLife 2
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "DiamondLife 2";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 1024)
                                                                    if (CountChecker == 1044)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                    countLine = 2;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterDiamond();
                                                                //if (DrawMatrixNewCounter > 1024 && DrawMatrixNewCounter < 4096)
                                                                if (DrawMatrixNewCounter > 1044 && DrawMatrixNewCounter < 4116)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 4096)
                                                                if (DrawMatrixNewCounter == 4116)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 600000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 600000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 600000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 600000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            //}
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            countLine = 1;
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Diamond Stage 1
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "DiamondLife 1";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace1 where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 256)
                                                                    if (CountChecker == 276)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterDiamond();
                                                                //if (DrawMatrixNewCounter > 256 && DrawMatrixNewCounter < 1024)
                                                                if (DrawMatrixNewCounter > 276 && DrawMatrixNewCounter < 1044)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount1 where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 1024)
                                                                if (DrawMatrixNewCounter == 1044)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 300000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 300000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 300000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 300000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            // }
                                                        }
                                                    }
                                                }
                                                //Diamond 2
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //DiamondLife 2
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "DiamondLife 2";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace1 where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 1024)
                                                                    if (CountChecker == 1044)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                    countLine = 2;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterDiamond();
                                                                //if (DrawMatrixNewCounter > 1024 && DrawMatrixNewCounter < 4096)
                                                                if (DrawMatrixNewCounter > 1044 && DrawMatrixNewCounter < 4116)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount1 where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 4096)
                                                                if (DrawMatrixNewCounter == 4116)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 600000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 600000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "DiamondLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 600000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 600000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            //}
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }






                                ////////////////////////////////////
                                /////////Sapphire Life/////////////
                                //////////////////////////////////
                                //Sapphire 1
                                using (cmd = new SqlCommand("Select count(placementid) from matrixplace", con))
                                {
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int getCount = int.Parse(dr.GetValue(0).ToString());
                                            //if (getCount > 5460)
                                            if (getCount > 5480)
                                            {
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            countLine = 1;
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //SapphireLife 1
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "SapphireLife 1";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 4096)
                                                                    if (CountChecker == 4116)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterSapphire();
                                                                //if (DrawMatrixNewCounter > 4096 && DrawMatrixNewCounter < 16384)
                                                                if (DrawMatrixNewCounter > 4116 && DrawMatrixNewCounter < 16404)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 16384)
                                                                if (DrawMatrixNewCounter == 16404)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 1500000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 1500000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 1500000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 1500000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            //}
                                                        }
                                                    }
                                                }
                                                //Sapphire 2
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Sapphire Stage 2
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "SapphireLife 2";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 16384)
                                                                    if (CountChecker == 16404)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                    countLine = 2;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterSapphire();
                                                                //if (DrawMatrixNewCounter > 16384 && DrawMatrixNewCounter < 65536)
                                                                if (DrawMatrixNewCounter > 16404 && DrawMatrixNewCounter < 65556)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 65536)
                                                                if (DrawMatrixNewCounter == 65556)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 6500000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 6500000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 6500000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 6500000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            // }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            countLine = 1;
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //SapphireLife 1
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "SapphireLife 1";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace1 where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 4096)
                                                                    if (CountChecker == 4116)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }

                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterSapphire();
                                                                //if (DrawMatrixNewCounter > 4096 && DrawMatrixNewCounter < 16384)
                                                                if (DrawMatrixNewCounter > 4116 && DrawMatrixNewCounter < 16404)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount1 where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 16384)
                                                                if (DrawMatrixNewCounter == 16404)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 1500000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 1500000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 1");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 1500000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 1500000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            //}
                                                        }
                                                    }
                                                }
                                                //Sapphire 2
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Sapphire Stage 2
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "SapphireLife 2";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace1 where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 16384)
                                                                    if (CountChecker == 16404)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                    countLine = 2;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterSapphire();
                                                                //if (DrawMatrixNewCounter > 16384 && DrawMatrixNewCounter < 65536)
                                                                if (DrawMatrixNewCounter > 16404 && DrawMatrixNewCounter < 65556)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount1 where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 65536)
                                                                if (DrawMatrixNewCounter == 65556)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 6500000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 6500000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "SapphireLife 2");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 6500000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 6500000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            // }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }






                                //////////////////////////////////
                                ///////////Emerald Life//////////
                                /////////////////////////////////
                                //Emerald 1
                                using (cmd = new SqlCommand("Select count(placementid) from matrixplace", con))
                                {
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int getCount = int.Parse(dr.GetValue(0).ToString());
                                            
                                            //if (getCount > 87380)
                                            if (getCount > 87400)
                                            {
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Emerald
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "EmeraldLife";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    //if (CountChecker == 65536)
                                                                    if (CountChecker == 65556)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }


                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                        using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                            cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                            cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                                {

                                                                                }
                                                                                else
                                                                                {
                                                                                    using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                        cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterEmerald();
                                                                //if (DrawMatrixNewCounter > 65536 && DrawMatrixNewCounter < 262144)
                                                                if (DrawMatrixNewCounter > 65556 && DrawMatrixNewCounter < 262164)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }

                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 262144)
                                                                if (DrawMatrixNewCounter == 262164)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 28000000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 28000000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 28000000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 28000000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            // }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                using (SqlDataAdapter da = new SqlDataAdapter())
                                                {
                                                    //UserIdsKeep = "";
                                                    ////DrawMatrixNewCounter = 0;
                                                    int count;
                                                    string[] splitUserIds;
                                                    char[] splitchar1 = { ' ' };
                                                    splitUserIds = UserIdsKeep.Split(splitchar1);
                                                    UserIdsKeep = "";
                                                    //DrawMatrixNewCounter = 0;
                                                    if (!splitUserIds.Contains(" "))
                                                    {
                                                        int fullLength = splitUserIds.Length;

                                                        for (count = 0; count <= splitUserIds.Length - 1; count++)
                                                        {
                                                            //if (DrawMatrixNewCounter <= fullLength)
                                                            //{
                                                            string SplitedUserID = splitUserIds[count];

                                                            DataSet ds = new DataSet();
                                                            int i = 0;
                                                            string sql = null;
                                                            sql = "Select placementid,placementname,userid,useridname,datereg from placement where placementid=@placementid";
                                                            using (cmd = new SqlCommand(sql, con))
                                                            {
                                                                da.SelectCommand = cmd;
                                                                da.SelectCommand.Parameters.AddWithValue("@placementid", SplitedUserID);
                                                                dr.Dispose();
                                                                da.Fill(ds);


                                                                //Emerald
                                                                for (i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                                                                {
                                                                    string PlacementID = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                                                    string PlacementName = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                                                    string UserID = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                                                    string UserIDName = ds.Tables[0].Rows[i].ItemArray[3].ToString();
                                                                    string Rank = "EmeraldLife";
                                                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[4].ToString();

                                                                    int CountChecker = 0;
                                                                    using (cmd = new SqlCommand("Select Count(placementid) from matrixplace1 where placementid=@placementid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                CountChecker = int.Parse(dr.GetValue(0).ToString());
                                                                            }
                                                                        }
                                                                    }
                                                                    
                                                                    //if (CountChecker == 65536)
                                                                    if (CountChecker == 65556)
                                                                    {
                                                                        // do nothing
                                                                    }
                                                                    else
                                                                    {
                                                                        using (cmd = new SqlCommand("Insert into MatrixPlace (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                       using (cmd = new SqlCommand("Insert into MatrixPlace1 (placementid,placementname,userid,useridname,rank,datereg) values (@placementid,@placementname,@userid,@useridname,@rank,@datereg)", con))
                                                                        {//placementid,placementname,userid,useridname,rank,datereg
                                                                            cmd.Parameters.AddWithValue("@placementid", PlacementID);
                                                                            cmd.Parameters.AddWithValue("@placementname", PlacementName);
                                                                            cmd.Parameters.AddWithValue("@userid", UserID);
                                                                            cmd.Parameters.AddWithValue("@useridname", UserIDName);
                                                                            cmd.Parameters.AddWithValue("@rank", Rank);
                                                                            cmd.Parameters.AddWithValue("@datereg", DateReg);
                                                                            cmd.ExecuteNonQuery();
                                                                        }

                                                                       using (cmd = new SqlCommand("Select * from FamilyHierarchy where memberid=@memberid and name=@name and parentid=@parentid", con))
                                                                       {
                                                                           cmd.Parameters.AddWithValue("@memberid", UserID);
                                                                           cmd.Parameters.AddWithValue("@name", UserIDName + " " + UserID);
                                                                           cmd.Parameters.AddWithValue("@parentid", PlacementID);
                                                                           using (dr = cmd.ExecuteReader())
                                                                           {
                                                                               if (dr.Read() && !dr.IsDBNull(0))
                                                                               {

                                                                               }
                                                                               else
                                                                               {
                                                                                   using (cmd = new SqlCommand("INSERT INTO [dbo].[FamilyHierarchy]([MemberId],[Name],[ParentID])VALUES(@memberid,@name,@parentid)", con))
                                                                                   {
                                                                                       cmd.Parameters.AddWithValue("@memberid", UserID.Trim().ToUpper());
                                                                                       cmd.Parameters.AddWithValue("@name", UserIDName.Trim().ToUpper() + " " + UserID.Trim().ToUpper());
                                                                                       cmd.Parameters.AddWithValue("@parentid", PlacementID.Trim().ToUpper());
                                                                                       dr.Dispose();
                                                                                       cmd.ExecuteNonQuery();
                                                                                   }
                                                                               }
                                                                           }
                                                                       }
                                                                    }
                                                                    UserIdsKeep += UserID + " ";
                                                                    DrawMatrixNewCounter++;
                                                                }
                                                                //Convert Method
                                                                MatrixLinkConverterEmerald();
                                                                //if (DrawMatrixNewCounter > 65536 && DrawMatrixNewCounter < 262144)
                                                                if (DrawMatrixNewCounter > 65556 && DrawMatrixNewCounter < 262164)
                                                                {
                                                                    using (cmd = new SqlCommand("Select userid from matrixplacecount1 where userid=@userid and rank=@rank", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", placementid);
                                                                        cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update MatrixPlacecount1 set downlines=@downlines,link=@link where userid=@userid and rank=@rank", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                using (cmd = new SqlCommand("Insert into MatrixPlaceCount1 (userid,rank,downlines,link) values (@userid,@rank,@downlines,@link)", con))
                                                                                {//userid,rank,downlines
                                                                                    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                                    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                                    cmd.Parameters.AddWithValue("@downlines", DrawMatrixNewCounter);
                                                                                    cmd.Parameters.AddWithValue("@link", MatrixLink);
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                //if (DrawMatrixNewCounter == 262144)
                                                                if (DrawMatrixNewCounter == 262164)
                                                                {
                                                                    //dr.Dispose();
                                                                    //using (cmd = new SqlCommand("Select amountdue from Earnings where userid=@userid and rank=@rank", con))
                                                                    //{
                                                                    //    cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //    //cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //    cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                    //    using (dr = cmd.ExecuteReader())
                                                                    //    {
                                                                    //        if (dr.Read() && !dr.IsDBNull(0))
                                                                    //        {
                                                                    //            //do nothing
                                                                    //        }
                                                                    //        else
                                                                    //        {
                                                                    //            dr.Dispose();
                                                                    //            using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid", con))
                                                                    //            {
                                                                    //                cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                using (dr = cmd.ExecuteReader())
                                                                    //                {
                                                                    //                    if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                    {
                                                                    //                        string SN = dr.GetValue(0).ToString();

                                                                    //                        using (cmd = new SqlCommand("Select balance from earnings where sn=@sn", con))
                                                                    //                        {
                                                                    //                            cmd.Parameters.AddWithValue("@sn", SN);
                                                                    //                            dr.Dispose();
                                                                    //                            using (dr = cmd.ExecuteReader())
                                                                    //                            {
                                                                    //                                if (dr.Read() && !dr.IsDBNull(0))
                                                                    //                                {
                                                                    //                                    getBalance = int.Parse(dr.GetValue(0).ToString());
                                                                    //                                }
                                                                    //                            }
                                                                    //                        }
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 28000000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", getBalance + 28000000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                    else
                                                                    //                    {
                                                                    //                        dr.Dispose();
                                                                    //                        using (cmd = new SqlCommand("Insert into Earnings (userid,username,rank,amountdue,deductions,balance,dd,mm,yy,date,status) values (@userid,@username,@rank,@amountdue,@deductions,@balance,@dd,@mm,@yy,@date,@status)", con))
                                                                    //                        { //rank,amountdue,deductions,balance,dd,mm,yy,date,status
                                                                    //                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                                    //                            cmd.Parameters.AddWithValue("@username", placementname);
                                                                    //                            cmd.Parameters.AddWithValue("@rank", "EmeraldLife");
                                                                    //                            cmd.Parameters.AddWithValue("@amountdue", 28000000);
                                                                    //                            cmd.Parameters.AddWithValue("@deductions", 0);
                                                                    //                            cmd.Parameters.AddWithValue("@balance", 28000000);
                                                                    //                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    //                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    //                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    //                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    //                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    //                            cmd.ExecuteNonQuery();

                                                                    //                        }
                                                                    //                    }
                                                                    //                }
                                                                    //            }
                                                                    //        }
                                                                    //    }
                                                                    //}
                                                                }
                                                            }
                                                            // }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }



                            }
                            else
                            {

                            }
                        }
                    }



                }
            }
            catch (Exception)
            {
                
            }
        }
                              
        public void DrawMatrix()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    string MaxSN;
                    //using(cmd = new SqlCommand("drop table MatrixPlace", con))
                    //{
                    //    cmd.ExecuteNonQuery();
                    //}
                    //using (cmd = new SqlCommand("SELECT [PlacementID], [PlacementName], [UserID], [UserIDName], [DateReg] into MatrixPlace FROM [Placement] WHERE ([PlacementID] = @PlacementID2)", con))
                    //{
                    //    cmd.Parameters.AddWithValue("@PlacementID2", UserId);
                    //    cmd.ExecuteNonQuery();
                    //}
                    using (cmd = new SqlCommand("Select placementid from MatrixPlace where placementid=@placementid", con))
                    {
                        cmd.Parameters.AddWithValue("@placementid", placementid);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select count(placementid) from MatrixPlace", con))
                                {
                                    // cmd.Parameters.AddWithValue("@userid", placementid);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int matrixCount = int.Parse(dr.GetValue(0).ToString());
                                            //DrawMatrixNewCounter = matrixCount;
                                            //MatrixLinkConverterSilver();
                                            //MatrixLinkConverterGold();
                                            //MatrixLinkConverterDiamond();
                                            //MatrixLinkConverterSapphire();
                                            //MatrixLinkConverterEmerald();
                                            //Enter downline count
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select count(userid) from matrixplace1", con))
                                            {
                                                //cmd.Parameters.AddWithValue("@userid", placementid);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                    {
                                                        getDownlines = int.Parse(dr.GetValue(0).ToString());
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Update downlinescount set downlines=@downlines where userid=@userid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@downlines", getDownlines);
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.ExecuteNonQuery();
                                                        }
                                                    }
                                                    else
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Insert into downlinescount (userid,downlines) values (@userid,@downlines)", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", placementid);
                                                            cmd.Parameters.AddWithValue("@downlines", getDownlines);
                                                            cmd.ExecuteNonQuery();
                                                        }
                                                    }
                                                }
                                            }
                                            //MatrixLink = MatrixLink;
                                        }
                                        else
                                        {
                                            ResponseMsg = "Cannot read data at this time, please try again later.";
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "No data present.";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void ViewWalletTracker()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Drop table WalletTraceRun", con))
                {
                    cmd.ExecuteNonQuery();
                }

                using (cmd = new SqlCommand("SELECT AddAmount,DeductAmount,PreviousTotal,CurrentTotal,Purpose,Date,UserID,SN into WalletTraceRun FROM WalletTrace where userid=@userid order by SN", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    cmd.ExecuteNonQuery();
                }
            }
        }

        public void ViewEarnings()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Drop table EarningsView", con))
                {
                    cmd.ExecuteNonQuery();
                }

                using(cmd = new SqlCommand("Select rank,amountdue,deductions,balance,status,date,SN into EarningsView from earnings where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId); 
                    cmd.ExecuteNonQuery();
                }
            }
        }

        public void SaveTestimony()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                int counter = 0;
                int yourRandomStringLengthP = 32; //maximum: 32 
                string uniquecode = Guid.NewGuid().ToString("N").Substring(0, yourRandomStringLengthP);
                if(testimonylocation == "NIGERIA")
                {
                    testimonycurrency = "NGN";
                }
                else 
                {
                    testimonycurrency = "USD";
                }
                using (cmd = new SqlCommand("Select testimonial from testimony where testimonial=@testimonial and name=@name", con))
                {
                    cmd.Parameters.AddWithValue("@testimonial", testimony);
                    cmd.Parameters.AddWithValue("@name", testimonyname);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            ResponseMsg = "PUBLISH FAILED! : This exact testimony content for this name already exists.";
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select testimonial from testimony where count=@count and currency=@currency", con))
                            {
                                cmd.Parameters.AddWithValue("@count", 2);
                                cmd.Parameters.AddWithValue("@currency", testimonycurrency);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Update testimony set count=@count where count=@prevcount and currency=@currency", con))
                                        {
                                            cmd.Parameters.AddWithValue("@count", 1);
                                            cmd.Parameters.AddWithValue("@prevcount", 2);
                                            cmd.Parameters.AddWithValue("@currency", testimonycurrency);
                                            cmd.ExecuteNonQuery();

                                            using (cmd = new SqlCommand("Insert into testimony(uniquecode,name,testimonial,date,currency,location,count) values (@uniquecode,@name,@testimonial,@date,@currency,@location,@count)", con))
                                            {
                                                cmd.Parameters.AddWithValue("@uniquecode", uniquecode);
                                                cmd.Parameters.AddWithValue("@name", testimonyname);
                                                cmd.Parameters.AddWithValue("@testimonial", testimony);
                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                cmd.Parameters.AddWithValue("@currency", testimonycurrency);
                                                cmd.Parameters.AddWithValue("@location", testimonylocation);
                                                cmd.Parameters.AddWithValue("@count", 2);
                                                dr.Dispose();
                                                cmd.ExecuteNonQuery();
                                                counter++;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Insert into testimony(uniquecode,name,testimonial,date,currency,location,count) values (@uniquecode,@name,@testimonial,@date,@currency,@location,@count)", con))
                                        {
                                            cmd.Parameters.AddWithValue("@uniquecode", uniquecode);
                                            cmd.Parameters.AddWithValue("@name", testimonyname);
                                            cmd.Parameters.AddWithValue("@testimonial", testimony);
                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                            cmd.Parameters.AddWithValue("@currency", testimonycurrency);
                                            cmd.Parameters.AddWithValue("@location", testimonylocation);
                                            cmd.Parameters.AddWithValue("@count", 2);
                                            dr.Dispose();
                                            cmd.ExecuteNonQuery();
                                            counter++;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (counter > 0)
                {
                    ResponseMsg = "Your testimony has been saved and will be published soon!";
                }
            }
        }

        public void SetAutoPurchase()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select auto from autopurchase where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Update autopurchase set auto=@auto where email=@email", con))
                            {
                                cmd.Parameters.AddWithValue("@auto", autoOption);
                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "You have requested CMAIS to " + autoOption + " the auto-purchase feature.";
                            }
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Insert into autopurchase(email,auto) values (@email,@auto)", con))
                            {
                                cmd.Parameters.AddWithValue("@auto", autoOption);
                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "You have requested CMAIS to " + autoOption + " the auto-purchase feature.";
                            }
                        }
                    }
                }
            }
        }
        //1
        public void TransferEarningsToFund()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                int retriveAmount = int.Parse(dr.GetValue(0).ToString());
                                if (retriveAmount > TransferAmount)
                                {
                                    int EarningWalletBalance = retriveAmount - TransferAmount;

                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                    {
                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                        using (dr = cmd.ExecuteReader())
                                        {
                                            if (dr.Read())
                                            {
                                                int PreviousFundWalletAmount = int.Parse(dr.GetValue(0).ToString());

                                                int newFundWalletAmount = PreviousFundWalletAmount + TransferAmount;

                                                dr.Dispose();
                                                //Update Fund Wallet Balance
                                                using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                    cmd.Parameters.AddWithValue("@amount", newFundWalletAmount);
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    cmd.ExecuteNonQuery();

                                                    using (cmd = new SqlCommand("Insert into wallettrace(Userid,email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@userid,@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                        cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                        cmd.Parameters.AddWithValue("@deductamount", 0);
                                                        cmd.Parameters.AddWithValue("@previoustotal", PreviousFundWalletAmount);
                                                        cmd.Parameters.AddWithValue("@currenttotal", newFundWalletAmount);
                                                        cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' from your Earnings Wallet.");
                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                        cmd.ExecuteNonQuery();
                                                    }
                                                }

                                                //Update Earnings Wallet Balance
                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                    cmd.Parameters.AddWithValue("@amount", EarningWalletBalance);
                                                    cmd.ExecuteNonQuery();

                                                    using (cmd = new SqlCommand("Insert into earningswallettrace(userid,email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@userid,@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                        cmd.Parameters.AddWithValue("@addamount", 0);
                                                        cmd.Parameters.AddWithValue("@deductamount", TransferAmount);
                                                        cmd.Parameters.AddWithValue("@previoustotal", retriveAmount);
                                                        cmd.Parameters.AddWithValue("@currenttotal", EarningWalletBalance);
                                                        cmd.Parameters.AddWithValue("@purpose", "Transfer of earnings of '" + TransferAmount + "' from Earnings to Fund Wallet by you - " + UserId + "-" + SessionEmail + ".");
                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                        cmd.ExecuteNonQuery();
                                                    }

                                                    ResponseMsg = "Transfer Completed!";
                                                }
                                            }
                                        }
                                    }
                                }
                                else if (retriveAmount == TransferAmount && TransferAmount > 0)
                                {
                                    int EarningWalletBalance = retriveAmount - TransferAmount;

                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                    {
                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                        using (dr = cmd.ExecuteReader())
                                        {
                                            if (dr.Read())
                                            {
                                                int PreviousFundWalletAmount = int.Parse(dr.GetValue(0).ToString());

                                                int newFundWalletAmount = PreviousFundWalletAmount + TransferAmount;

                                                dr.Dispose();
                                                //Update Fund Wallet Balance
                                                using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                    cmd.Parameters.AddWithValue("@amount", newFundWalletAmount);
                                                    cmd.ExecuteNonQuery();

                                                    using (cmd = new SqlCommand("Insert into wallettrace(userid,email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@userid,@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                        cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                        cmd.Parameters.AddWithValue("@deductamount", 0);
                                                        cmd.Parameters.AddWithValue("@previoustotal", PreviousFundWalletAmount);
                                                        cmd.Parameters.AddWithValue("@currenttotal", newFundWalletAmount);
                                                        cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' from your Earnings Wallet.");
                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                        cmd.ExecuteNonQuery();
                                                    }
                                                }

                                                //Update Earnings Wallet Balance
                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                    cmd.Parameters.AddWithValue("@amount", EarningWalletBalance);
                                                    cmd.ExecuteNonQuery();

                                                    using (cmd = new SqlCommand("Insert into earningswallettrace(userid,email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@userid,@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                        cmd.Parameters.AddWithValue("@addamount", 0);
                                                        cmd.Parameters.AddWithValue("@deductamount", TransferAmount);
                                                        cmd.Parameters.AddWithValue("@previoustotal", retriveAmount);
                                                        cmd.Parameters.AddWithValue("@currenttotal", EarningWalletBalance);
                                                        cmd.Parameters.AddWithValue("@purpose", "Transfer of earnings of '" + TransferAmount + "' from Earnings to Fund Wallet by you - " + UserId + "-" + SessionEmail + ".");
                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                        cmd.ExecuteNonQuery();
                                                    }

                                                    ResponseMsg = "Transfer Completed!";
                                                }
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    ResponseMsg = "Ensure you are transferring a real value.";
                                }
                            }
                            else
                            {
                                //Quickly select the total earnings and insert into total earnings before selecting again
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select SUM(amtwithdrawable) from earnings where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            totalwalletbalance = dr.GetValue(0).ToString();

                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select thiswithdraw from withdrawals where email=@email and userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read())
                                                    {
                                                        using (cmd = new SqlCommand("Select SUM(thiswithdraw) from withdrawals where email=@email and userid=@userid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                            dr.Dispose();
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    totalwithdrawal = dr.GetValue(0).ToString();

                                                                    int balance = int.Parse(totalwalletbalance) - int.Parse(totalwithdrawal);
                                                                    totalwalletbalance = balance.ToString();

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Insert into earningswallet(userid,email,amount,date) values (@userid,@email,@amount,@date)", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }


                                                                    //Now start the transfer
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                int retriveAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                if (retriveAmount > TransferAmount)
                                                                                {
                                                                                    int EarningWalletBalance = retriveAmount - TransferAmount;

                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                int PreviousFundWalletAmount = int.Parse(dr.GetValue(0).ToString());

                                                                                                int newFundWalletAmount = PreviousFundWalletAmount + TransferAmount;

                                                                                                dr.Dispose();
                                                                                                //Update Fund Wallet Balance
                                                                                                using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                    cmd.Parameters.AddWithValue("@amount", newFundWalletAmount);
                                                                                                    cmd.ExecuteNonQuery();

                                                                                                    using (cmd = new SqlCommand("Insert into wallettrace(userid,email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@userid,@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                        cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                        cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                        cmd.Parameters.AddWithValue("@previoustotal", PreviousFundWalletAmount);
                                                                                                        cmd.Parameters.AddWithValue("@currenttotal", newFundWalletAmount);
                                                                                                        cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' from your Earnings Wallet.");
                                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }

                                                                                                //Update Earnings Wallet Balance
                                                                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                    cmd.Parameters.AddWithValue("@amount", EarningWalletBalance);
                                                                                                    cmd.ExecuteNonQuery();

                                                                                                    using (cmd = new SqlCommand("Insert into earningswallettrace(userid,email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@userid,@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                        cmd.Parameters.AddWithValue("@addamount", 0);
                                                                                                        cmd.Parameters.AddWithValue("@deductamount", TransferAmount);
                                                                                                        cmd.Parameters.AddWithValue("@previoustotal", retriveAmount);
                                                                                                        cmd.Parameters.AddWithValue("@currenttotal", EarningWalletBalance);
                                                                                                        cmd.Parameters.AddWithValue("@purpose", "Transfer of earnings of '" + TransferAmount + "' from Earnings to Fund Wallet by you - " + UserId + "-" + SessionEmail + ".");
                                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }

                                                                                                    ResponseMsg = "Transfer Completed!";
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                                else if (retriveAmount == TransferAmount && TransferAmount > 0)
                                                                                {
                                                                                    int EarningWalletBalance = retriveAmount - TransferAmount;

                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                int PreviousFundWalletAmount = int.Parse(dr.GetValue(0).ToString());

                                                                                                int newFundWalletAmount = PreviousFundWalletAmount + TransferAmount;

                                                                                                dr.Dispose();
                                                                                                //Update Fund Wallet Balance
                                                                                                using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                    cmd.Parameters.AddWithValue("@amount", newFundWalletAmount);
                                                                                                    cmd.ExecuteNonQuery();

                                                                                                    using (cmd = new SqlCommand("Insert into wallettrace(userid,email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@userid,@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                        cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                        cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                        cmd.Parameters.AddWithValue("@previoustotal", PreviousFundWalletAmount);
                                                                                                        cmd.Parameters.AddWithValue("@currenttotal", newFundWalletAmount);
                                                                                                        cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' from your Earnings Wallet.");
                                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }

                                                                                                //Update Earnings Wallet Balance
                                                                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                    cmd.Parameters.AddWithValue("@amount", EarningWalletBalance);
                                                                                                    cmd.ExecuteNonQuery();

                                                                                                    using (cmd = new SqlCommand("Insert into earningswallettrace(userid,email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@userid,@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                        cmd.Parameters.AddWithValue("@addamount", 0);
                                                                                                        cmd.Parameters.AddWithValue("@deductamount", TransferAmount);
                                                                                                        cmd.Parameters.AddWithValue("@previoustotal", retriveAmount);
                                                                                                        cmd.Parameters.AddWithValue("@currenttotal", EarningWalletBalance);
                                                                                                        cmd.Parameters.AddWithValue("@purpose", "Transfer of earnings of '" + TransferAmount + "' from Earnings to Fund Wallet by you - " + UserId + "-" + SessionEmail + ".");
                                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }

                                                                                                    ResponseMsg = "Transfer Completed!";
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    ResponseMsg = "Ensure you are transferring a real value.";
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    totalwithdrawal = "0";

                                                                    int balance = int.Parse(totalwalletbalance) - int.Parse(totalwithdrawal);
                                                                    totalwalletbalance = balance.ToString();

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Insert into earningswallet(email,amount,date,userid) values (@email,@amount,@date,@userid)", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }


                                                                            //Now start the transfer
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        int retriveAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                        if (retriveAmount > TransferAmount)
                                                                                        {
                                                                                            int EarningWalletBalance = retriveAmount - TransferAmount;

                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int PreviousFundWalletAmount = int.Parse(dr.GetValue(0).ToString());

                                                                                                        int newFundWalletAmount = PreviousFundWalletAmount + TransferAmount;

                                                                                                        dr.Dispose();
                                                                                                        //Update Fund Wallet Balance
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                            cmd.Parameters.AddWithValue("@amount", newFundWalletAmount);
                                                                                                            cmd.ExecuteNonQuery();

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", PreviousFundWalletAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newFundWalletAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' from your Earnings Wallet.");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }

                                                                                                        //Update Earnings Wallet Balance
                                                                                                        using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                            cmd.Parameters.AddWithValue("@amount", EarningWalletBalance);
                                                                                                            cmd.ExecuteNonQuery();

                                                                                                            using (cmd = new SqlCommand("Insert into earningswallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", retriveAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", EarningWalletBalance);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Transfer of earnings of '" + TransferAmount + "' from Earnings to Fund Wallet by you - " + UserId + "-" + SessionEmail + ".");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            ResponseMsg = "Transfer Completed!";
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        else if (retriveAmount == TransferAmount && TransferAmount > 0)
                                                                                        {
                                                                                            int EarningWalletBalance = retriveAmount - TransferAmount;

                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int PreviousFundWalletAmount = int.Parse(dr.GetValue(0).ToString());

                                                                                                        int newFundWalletAmount = PreviousFundWalletAmount + TransferAmount;

                                                                                                        dr.Dispose();
                                                                                                        //Update Fund Wallet Balance
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                            cmd.Parameters.AddWithValue("@amount", newFundWalletAmount);
                                                                                                            cmd.ExecuteNonQuery();

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", PreviousFundWalletAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newFundWalletAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' from your Earnings Wallet.");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }

                                                                                                        //Update Earnings Wallet Balance
                                                                                                        using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                            cmd.Parameters.AddWithValue("@amount", EarningWalletBalance);
                                                                                                            cmd.ExecuteNonQuery();

                                                                                                            using (cmd = new SqlCommand("Insert into earningswallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", retriveAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", EarningWalletBalance);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Transfer of earnings of '" + TransferAmount + "' from Earnings to Fund Wallet by you - " + UserId + "-" + SessionEmail + ".");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            ResponseMsg = "Transfer Completed!";
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            ResponseMsg = "Ensure you are transferring a real value.";
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        totalwithdrawal = "0";
                                                        int balance = int.Parse(totalwalletbalance) - int.Parse(totalwithdrawal);
                                                        totalwalletbalance = balance.ToString();

                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                        cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                        cmd.ExecuteNonQuery();
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Insert into earningswallet(email,amount,date,userid) values (@email,@amount,@date,@userid)", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                        cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                        cmd.ExecuteNonQuery();
                                                                    }
                                                                }


                                                                //Now start the transfer
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        if (dr.Read())
                                                                        {
                                                                            int retriveAmount = int.Parse(dr.GetValue(0).ToString());
                                                                            if (retriveAmount > TransferAmount)
                                                                            {
                                                                                int EarningWalletBalance = retriveAmount - TransferAmount;

                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read())
                                                                                        {
                                                                                            int PreviousFundWalletAmount = int.Parse(dr.GetValue(0).ToString());

                                                                                            int newFundWalletAmount = PreviousFundWalletAmount + TransferAmount;

                                                                                            dr.Dispose();
                                                                                            //Update Fund Wallet Balance
                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                cmd.Parameters.AddWithValue("@amount", newFundWalletAmount);
                                                                                                cmd.ExecuteNonQuery();

                                                                                                using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                    cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                    cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                    cmd.Parameters.AddWithValue("@previoustotal", PreviousFundWalletAmount);
                                                                                                    cmd.Parameters.AddWithValue("@currenttotal", newFundWalletAmount);
                                                                                                    cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' from your Earnings Wallet.");
                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }

                                                                                            //Update Earnings Wallet Balance
                                                                                            using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                cmd.Parameters.AddWithValue("@amount", EarningWalletBalance);
                                                                                                cmd.ExecuteNonQuery();

                                                                                                using (cmd = new SqlCommand("Insert into earningswallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                    cmd.Parameters.AddWithValue("@addamount", 0);
                                                                                                    cmd.Parameters.AddWithValue("@deductamount", TransferAmount);
                                                                                                    cmd.Parameters.AddWithValue("@previoustotal", retriveAmount);
                                                                                                    cmd.Parameters.AddWithValue("@currenttotal", EarningWalletBalance);
                                                                                                    cmd.Parameters.AddWithValue("@purpose", "Transfer of earnings of '" + TransferAmount + "' from Earnings to Fund Wallet by you - " + UserId + "-" + SessionEmail + ".");
                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                ResponseMsg = "Transfer Completed!";
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            else if (retriveAmount == TransferAmount && TransferAmount > 0)
                                                                            {
                                                                                int EarningWalletBalance = retriveAmount - TransferAmount;

                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read())
                                                                                        {
                                                                                            int PreviousFundWalletAmount = int.Parse(dr.GetValue(0).ToString());

                                                                                            int newFundWalletAmount = PreviousFundWalletAmount + TransferAmount;

                                                                                            dr.Dispose();
                                                                                            //Update Fund Wallet Balance
                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid+@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                cmd.Parameters.AddWithValue("@amount", newFundWalletAmount);
                                                                                                cmd.ExecuteNonQuery();

                                                                                                using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                    cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                    cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                    cmd.Parameters.AddWithValue("@previoustotal", PreviousFundWalletAmount);
                                                                                                    cmd.Parameters.AddWithValue("@currenttotal", newFundWalletAmount);
                                                                                                    cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' from your Earnings Wallet.");
                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }

                                                                                            //Update Earnings Wallet Balance
                                                                                            using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                cmd.Parameters.AddWithValue("@amount", EarningWalletBalance);
                                                                                                cmd.ExecuteNonQuery();

                                                                                                using (cmd = new SqlCommand("Insert into earningswallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                                    cmd.Parameters.AddWithValue("@addamount", 0);
                                                                                                    cmd.Parameters.AddWithValue("@deductamount", TransferAmount);
                                                                                                    cmd.Parameters.AddWithValue("@previoustotal", retriveAmount);
                                                                                                    cmd.Parameters.AddWithValue("@currenttotal", EarningWalletBalance);
                                                                                                    cmd.Parameters.AddWithValue("@purpose", "Transfer of earnings of '" + TransferAmount + "' from Earnings to Fund Wallet by you - " + UserId + "-" + SessionEmail + ".");
                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                ResponseMsg = "Transfer Completed!";
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                ResponseMsg = "Ensure you are transferring a real value.";
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            totalwalletbalance = "0";
                                        }

                                    }
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception)
            {
                
            }
        }

        public void PayCryptoEarnings()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select email,amountbtc,tranid from cryptoatm where sn=@sn", con))
                {
                    cmd.Parameters.AddWithValue("@sn", SN);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            string emailNow = dr.GetValue(0).ToString();
                            decimal amountbtcNow = Decimal.Parse(dr.GetValue(1).ToString());
                            string tranidNow = dr.GetValue(2).ToString();
                            using(cmd = new SqlCommand("Select tranid from cryptoearnings where status=@status and email=@email and amountbtc=@amountbtc", con))
                            {
                                cmd.Parameters.AddWithValue("@status", "Paid");
                                cmd.Parameters.AddWithValue("@email", emailNow);
                                cmd.Parameters.AddWithValue("@amountbtc", amountbtcNow);

                                dr.Dispose();
                                using(dr = cmd.ExecuteReader())
                                {
                                    if(dr.Read() && !dr.IsDBNull(0))
                                    {
                                        ResponseMsg = "Payment for this Transaction ID has been previously completed.";                                          
                                    }
                                    else
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Insert into cryptoearnings(email,amountbtc,tranid,month,year,percentearned,earnings,paydate,status) values (@email,@amountbtc,@tranid,@month,@year,@percentearned,@earnings,@paydate,@status)", con))
                                        {//email,amountbtc,tranid,month,year,percentearned,earnings,paydate,status
                                            cmd.Parameters.AddWithValue("@email", emailNow);
                                            cmd.Parameters.AddWithValue("@amountbtc", amountbtcNow);
                                            cmd.Parameters.AddWithValue("@tranid", tranidNow);
                                            cmd.Parameters.AddWithValue("@month", DateTime.Now.Month);
                                            cmd.Parameters.AddWithValue("@year", DateTime.Now.Year);
                                            cmd.Parameters.AddWithValue("@percentearned", percentearned);
                                            decimal earnings = amountbtcNow * percentearned / 100;
                                            cmd.Parameters.AddWithValue("@earnings", earnings);
                                            cmd.Parameters.AddWithValue("@paydate", DateTime.Now.ToShortDateString());
                                            cmd.Parameters.AddWithValue("@status", "Paid");
                                            cmd.ExecuteNonQuery();
                                            ResponseMsg = "Payment completed!";
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            ResponseMsg = "Invalid SN";
                        }
                    }
                }
            }
        }

        public void CryptoConfirmFunds()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();//email,name,bookname,bookurl,amountusd,amountbtc,date,investstart,investend,tranid,dd,mm,yy,receivedstatus,investmentstatus
                using(cmd = new SqlCommand("Select sn from cryptoatm where receivedstatus=@receivedstatus and sn=@sn", con))
                {
                    cmd.Parameters.AddWithValue("@receivedstatus", "Yes");
                    cmd.Parameters.AddWithValue("@sn", SN);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            ResponseMsg = "This transaction has been previously confirmed!";
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select amountusd from cryptoatm where email=@email and sn=@sn", con))
                            {
                                    cmd.Parameters.AddWithValue("@email", depositemail);
                                    cmd.Parameters.AddWithValue("@sn", SN);
                                    using(dr = cmd.ExecuteReader())
                                    {
                                        if(dr.Read())
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Update cryptoATM set amountbtc=@amountbtc,investstart=@investstart,receivedstatus=@receivedstatus,investmentstatus=@investmentstatus where sn=@sn", con))
                                            {
                                                cmd.Parameters.AddWithValue("@investstart", DateTime.Now.ToShortDateString());
                                                cmd.Parameters.AddWithValue("@amountbtc", depositamount);
                                                cmd.Parameters.AddWithValue("@receivedstatus", "Yes");
                                                cmd.Parameters.AddWithValue("@investmentstatus", "Trading");
                                                cmd.Parameters.AddWithValue("@sn", SN);
                                                cmd.ExecuteNonQuery();

                                                ResponseMsg = "Confirmed!";
                                            }

                                            //using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                            //{//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                            //    cmd.Parameters.AddWithValue("@email", depositemail);
                                            //    cmd.Parameters.AddWithValue("@addamount", depositamount);
                                            //    cmd.Parameters.AddWithValue("@deductamount", 0);
                                            //    cmd.Parameters.AddWithValue("@previoustotal", getamount);
                                            //    cmd.Parameters.AddWithValue("@currenttotal", result);
                                            //    cmd.Parameters.AddWithValue("@purpose", "Confirmation of payments deposit of '" + depositamount + "' by admin");
                                            //    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                            //    cmd.ExecuteNonQuery();
                                            //    ResponseMsg = "Confirmed!";
                                            //}
                                        }

                                        

                                    }
                                
                            }
                        }
                    }
                }
            }
        }

        public void ViewWithdrawByUserID()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                
                using(cmd = new SqlCommand("Drop table withdrawalpending", con))
                {
                    cmd.ExecuteNonQuery();
                }

                using (cmd = new SqlCommand("Select * into withdrawalpending from withdrawals where userid = @userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    cmd.ExecuteNonQuery();
                }
            }
        }

        public void ViewWithdrawPending()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();

                using (cmd = new SqlCommand("Drop table withdrawalpending", con))
                {
                    cmd.ExecuteNonQuery();
                }

                using(cmd = new SqlCommand("Select * into withdrawalpending from withdrawals where status=@status", con))
                {
                    cmd.Parameters.AddWithValue("@status","Pending");
                    cmd.ExecuteNonQuery();
                }
            }
        }


        public void ConfirmWithdrawalPayByGroup()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();

                for (GoSN = startSN; GoSN <= stopSN; GoSN++)
                {
                    using(cmd = new SqlCommand("Select userid,thiswithdraw from withdrawalpending where SN=@sn and status=@status", con))
                    {
                        cmd.Parameters.AddWithValue("@status", "Pending");
                        cmd.Parameters.AddWithValue("@sn", GoSN);
                        using(dr = cmd.ExecuteReader())
                        {
                            if(dr.Read())
                            {
                                UserId = dr.GetValue(0).ToString();
                                amountW = dr.GetValue(1).ToString();


                                dr.Dispose();
                                using (cmd = new SqlCommand("Select Sn,rank,userid,thiswithdraw from withdrawals where sn=@sn and status=@status", con))
                                {
                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                    cmd.Parameters.AddWithValue("@sn", GoSN);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            WRank = dr.GetValue(1).ToString();
                                            Wuserid = dr.GetValue(2).ToString();
                                            thiswithdrawW = dr.GetValue(3).ToString();
                                        }
                                    }
                                }

                                dr.Dispose();
                                using (cmd = new SqlCommand("Select amount from minusfunds where userid=@userid and status=@status", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", Wuserid);
                                    cmd.Parameters.AddWithValue("@status", "Undeducted");
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int getAmount = int.Parse(dr.GetValue(0).ToString());
                                            int result = int.Parse(thiswithdrawW) - getAmount;

                                            if (result == 0)
                                            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Update MinusFunds set amount=@amount,status=@status where userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@amount", result);
                                                    cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                    cmd.Parameters.AddWithValue("@status", "Deducted");
                                                    cmd.ExecuteNonQuery();

                                                    ResponseMsg = "You have been deducted for an overpayment previously made, you currently do not have any withdrawals to make.";
                                                }
                                            }
                                            else if (result > 0)
                                            {
                                                if (WRank != "Referral Bonus")
                                                {
                                                    using (cmd = new SqlCommand("Update withdrawals set thiswithdraw=@amount where userid=@userid and rank=@rank and sn=@sn", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@amount", result);
                                                        cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                        cmd.Parameters.AddWithValue("@rank", WRank);
                                                        cmd.Parameters.AddWithValue("@sn", GoSN);
                                                        cmd.ExecuteNonQuery();
                                                    }

                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Select Sn,rank,userid from withdrawals where status=@status and sn=@sn", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@status", "Paid");
                                                        cmd.Parameters.AddWithValue("@sn", GoSN);
                                                        using (dr = cmd.ExecuteReader())
                                                        {
                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                            {
                                                                ResponseMsg = "This withdrawal transaction has been previously confirmed!";
                                                            }
                                                            else
                                                            {
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("select status from withdrawals where sn=@sn and status=@status", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                                    cmd.Parameters.AddWithValue("@sn", GoSN);
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        if (dr.Read())
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Update withdrawals set status=@status where sn=@sn", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                cmd.Parameters.AddWithValue("@sn", GoSN);
                                                                                cmd.ExecuteNonQuery();
                                                                            }


                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select rank,name,thiswithdraw,userid from withdrawals where sn=@sn and status=@status", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@sn", GoSN);
                                                                                cmd.Parameters.AddWithValue("@status", "Paid");
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        string rank = dr.GetValue(0).ToString();
                                                                                        string name = dr.GetValue(1).ToString();
                                                                                        string amount = dr.GetValue(2).ToString();
                                                                                        string userid = dr.GetValue(3).ToString();
                                                                                        using (cmd = new SqlCommand("Insert into withdrawTracker(userid,name,rank,amount,comment) values (@userid,@name,@rank,@amount,@comment)", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", userid);
                                                                                            cmd.Parameters.AddWithValue("@name", name);
                                                                                            cmd.Parameters.AddWithValue("@amount", result);
                                                                                            cmd.Parameters.AddWithValue("@rank", rank);
                                                                                            cmd.Parameters.AddWithValue("@comment", "" + name + " - " + userid + " received " + result + " as " + rank + " earnings after overpayment deduction was made.");
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();
                                                                                            ResponseMsg = "Done!";
                                                                                        }
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Update MinusFunds set amount=@amount,status=@status where userid=@userid", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@amount", "0");
                                                                                            cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                                                            cmd.Parameters.AddWithValue("@status", "Deducted");
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        ResponseMsg = "Record cannot be found!";
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            ResponseMsg = "This withdrawal transaction has been previously confirmed!";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                ResponseMsg = "You have been deducted for an overpayment previously made, you currently have only #" + result + " withdrawal to make.";

                                            }
                                            else
                                            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Update MinusFunds set amount=@amount,status=@status where userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@amount", result.ToString().Replace("-", ""));
                                                    cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                    cmd.Parameters.AddWithValue("@status", "Undeducted");
                                                    cmd.ExecuteNonQuery();

                                                    ResponseMsg = "You have been deducted for an overpayment previously made and still have some overpaid balance left, you currently do not have any withdrawals to make.";
                                                }
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select Sn,rank,userid from withdrawals where status=@status and sn=@sn", con))
                                            {
                                                cmd.Parameters.AddWithValue("@status", "Paid");
                                                cmd.Parameters.AddWithValue("@sn", GoSN);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                    {
                                                        ResponseMsg = "This withdrawal transaction has been previously confirmed!";
                                                    }
                                                    else
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("select status from withdrawals where sn=@sn and status=@status", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                            cmd.Parameters.AddWithValue("@sn", GoSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Update withdrawals set status=@status where sn=@sn", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@status", "Paid");
                                                                        cmd.Parameters.AddWithValue("@sn", GoSN);
                                                                        cmd.ExecuteNonQuery();
                                                                    }

                                                                    if (WRank == "Referral Bonus")
                                                                    {
                                                                        //using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                                                                        //{
                                                                        //    cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                                        //    using (dr = cmd.ExecuteReader())
                                                                        //    {
                                                                        //        if (dr.Read())
                                                                        //        {
                                                                        //            int amountdue = int.Parse(dr.GetValue(0).ToString());
                                                                        //            int deduction = int.Parse(dr.GetValue(1).ToString());
                                                                        //            int newDeduction = deduction + int.Parse(amountW);
                                                                        //            int RefBalance = int.Parse(dr.GetValue(2).ToString());
                                                                        //            int newRefBalance = RefBalance - int.Parse(amountW);

                                                                        //            using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                                                                        //            {
                                                                        //                cmd.Parameters.AddWithValue("@balance", newRefBalance);
                                                                        //                cmd.Parameters.AddWithValue("@deductions", newDeduction);
                                                                        //                cmd.Parameters.AddWithValue("@rank", WRank);
                                                                        //                cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                                        //                dr.Dispose();
                                                                        //                cmd.ExecuteNonQuery();
                                                                        //            }
                                                                        //        }
                                                                        //    }
                                                                        //}
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("update earnings set status=@newstatus where rank=@rank and userid=@userid and status=@status", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@rank", WRank);
                                                                            cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                                            cmd.Parameters.AddWithValue("@newstatus", "Paid");
                                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select rank,name,thiswithdraw,userid from withdrawals where sn=@sn and status=@status", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@sn", GoSN);
                                                                        cmd.Parameters.AddWithValue("@status", "Paid");
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                string rank = dr.GetValue(0).ToString();
                                                                                string name = dr.GetValue(1).ToString();
                                                                                string amount = dr.GetValue(2).ToString();
                                                                                string userid = dr.GetValue(3).ToString();
                                                                                using (cmd = new SqlCommand("Insert into withdrawTracker(userid,name,rank,amount,comment) values (@userid,@name,@rank,@amount,@comment)", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", userid);
                                                                                    cmd.Parameters.AddWithValue("@name", name);
                                                                                    cmd.Parameters.AddWithValue("@amount", amount);
                                                                                    cmd.Parameters.AddWithValue("@rank", rank);
                                                                                    cmd.Parameters.AddWithValue("@comment", "" + name + " - " + userid + " received " + amount + " as " + rank + " earnings.");
                                                                                    dr.Dispose();
                                                                                    cmd.ExecuteNonQuery();
                                                                                    ResponseMsg = "Done!";
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                ResponseMsg = "Record cannot be found!";
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    ResponseMsg = "This withdrawal transaction has been previously confirmed!";
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                //no results
                            }
                        }
                    }                    
                }
            }
        }


        public void ConfirmWithdrawalPay()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                
                using(cmd = new SqlCommand("Select Sn,rank,userid,thiswithdraw from withdrawals where sn=@sn", con))
                {
                    cmd.Parameters.AddWithValue("@sn", SN);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read() && !dr.IsDBNull(0))
                        {
                            WRank = dr.GetValue(1).ToString();
                            Wuserid = dr.GetValue(2).ToString();
                            thiswithdrawW = dr.GetValue(3).ToString();
                        }
                    }
                }

                dr.Dispose();
                using (cmd = new SqlCommand("Select amount from minusfunds where userid=@userid and status=@status", con))
                {
                    cmd.Parameters.AddWithValue("@userid", Wuserid);
                    cmd.Parameters.AddWithValue("@status", "Undeducted");
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            int getAmount = int.Parse(dr.GetValue(0).ToString());
                            int result = int.Parse(thiswithdrawW) - getAmount;

                            if (result == 0)
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update MinusFunds set amount=@amount,status=@status where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@amount", result);
                                    cmd.Parameters.AddWithValue("@userid", Wuserid);
                                    cmd.Parameters.AddWithValue("@status", "Deducted");
                                    cmd.ExecuteNonQuery();

                                    ResponseMsg = "You have been deducted for an overpayment previously made, you currently do not have any withdrawals to make.";
                                }
                            }
                            else if (result > 0)
                            {
                                if (WRank != "Referral Bonus")
                                {
                                    using (cmd = new SqlCommand("Update withdrawals set thiswithdraw=@amount where userid=@userid and rank=@rank and sn=@sn", con))
                                    {
                                        cmd.Parameters.AddWithValue("@amount", result);
                                        cmd.Parameters.AddWithValue("@userid", Wuserid);
                                        cmd.Parameters.AddWithValue("@rank", WRank);
                                        cmd.Parameters.AddWithValue("@sn", SN);
                                        dr.Dispose();
                                        cmd.ExecuteNonQuery();
                                    }

                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Select Sn,rank,userid from withdrawals where status=@status and sn=@sn", con))
                                    {
                                        cmd.Parameters.AddWithValue("@status", "Paid");
                                        cmd.Parameters.AddWithValue("@sn", SN);
                                        using (dr = cmd.ExecuteReader())
                                        {
                                            if (dr.Read() && !dr.IsDBNull(0))
                                            {
                                                ResponseMsg = "This withdrawal transaction has been previously confirmed!";
                                            }
                                            else
                                            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("select status from withdrawals where sn=@sn and status=@status", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                                    cmd.Parameters.AddWithValue("@sn", SN);
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read())
                                                        {
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Update withdrawals set status=@status where sn=@sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@status", "Paid");
                                                                cmd.Parameters.AddWithValue("@sn", SN);
                                                                cmd.ExecuteNonQuery();
                                                            }


                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select rank,name,thiswithdraw,userid from withdrawals where sn=@sn and status=@status", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@sn", SN);
                                                                cmd.Parameters.AddWithValue("@status", "Paid");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string rank = dr.GetValue(0).ToString();
                                                                        string name = dr.GetValue(1).ToString();
                                                                        string amount = dr.GetValue(2).ToString();
                                                                        string userid = dr.GetValue(3).ToString();
                                                                        using (cmd = new SqlCommand("Insert into withdrawTracker(userid,name,rank,amount,comment) values (@userid,@name,@rank,@amount,@comment)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@userid", userid);
                                                                            cmd.Parameters.AddWithValue("@name", name);
                                                                            cmd.Parameters.AddWithValue("@amount", result);
                                                                            cmd.Parameters.AddWithValue("@rank", rank);
                                                                            cmd.Parameters.AddWithValue("@comment", "" + name + " - " + userid + " received " + result + " as " + rank + " earnings after overpayment deduction was made.");
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Done!";
                                                                        }
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update MinusFunds set amount=@amount,status=@status where userid=@userid", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@amount", "0");
                                                                            cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                                            cmd.Parameters.AddWithValue("@status", "Deducted");
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        ResponseMsg = "Record cannot be found!";
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            ResponseMsg = "This withdrawal transaction has been previously confirmed!";
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                ResponseMsg = "You have been deducted for an overpayment previously made, you currently have only #" + result + " withdrawal to make.";

                            }
                            else
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update MinusFunds set amount=@amount,status=@status where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@amount", result.ToString().Replace("-", ""));
                                    cmd.Parameters.AddWithValue("@userid", Wuserid);
                                    cmd.Parameters.AddWithValue("@status", "Undeducted");
                                    cmd.ExecuteNonQuery();

                                    ResponseMsg = "You have been deducted for an overpayment previously made and still have some overpaid balance left, you currently do not have any withdrawals to make.";
                                }
                            }
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select Sn,rank,userid from withdrawals where status=@status and sn=@sn", con))
                            {
                                cmd.Parameters.AddWithValue("@status", "Paid");
                                cmd.Parameters.AddWithValue("@sn", SN);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read() && !dr.IsDBNull(0))
                                    {
                                        ResponseMsg = "This withdrawal transaction has been previously confirmed!";
                                    }
                                    else
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("select status from withdrawals where sn=@sn and status=@status", con))
                                        {
                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                            cmd.Parameters.AddWithValue("@sn", SN);
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Update withdrawals set status=@status where sn=@sn", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@status", "Paid");
                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                        cmd.ExecuteNonQuery();
                                                    }

                                                    if (WRank == "Referral Bonus")
                                                    {
                                                        //using (cmd = new SqlCommand("Select amountdue,deductions,balance from referralearnings where userid=@userid", con))
                                                        //{
                                                        //    cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                        //    using (dr = cmd.ExecuteReader())
                                                        //    {
                                                        //        if (dr.Read())
                                                        //        {
                                                        //            int amountdue = int.Parse(dr.GetValue(0).ToString());
                                                        //            int deduction = int.Parse(dr.GetValue(1).ToString());
                                                        //            int newDeduction = deduction + int.Parse(amountW);
                                                        //            int RefBalance = int.Parse(dr.GetValue(2).ToString());
                                                        //            int newRefBalance = RefBalance - int.Parse(amountW);

                                                        //            using (cmd = new SqlCommand("update referralearnings set balance=@balance,deductions=@deductions where userid=@userid", con))
                                                        //            {
                                                        //                cmd.Parameters.AddWithValue("@balance", newRefBalance);
                                                        //                cmd.Parameters.AddWithValue("@deductions", newDeduction);
                                                        //                cmd.Parameters.AddWithValue("@rank", WRank);
                                                        //                cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                        //                dr.Dispose();
                                                        //                cmd.ExecuteNonQuery();
                                                        //            }
                                                        //        }
                                                        //    }
                                                        //}
                                                    }
                                                    else
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("update earnings set status=@newstatus where rank=@rank and userid=@userid and status=@status", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@rank", WRank);
                                                            cmd.Parameters.AddWithValue("@userid", Wuserid);
                                                            cmd.Parameters.AddWithValue("@newstatus", "Paid");
                                                            cmd.Parameters.AddWithValue("@status", "Pending");
                                                            cmd.ExecuteNonQuery();
                                                        }
                                                    }

                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Select rank,name,thiswithdraw,userid from withdrawals where sn=@sn and status=@status", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                        cmd.Parameters.AddWithValue("@status", "Paid");
                                                        using (dr = cmd.ExecuteReader())
                                                        {
                                                            if (dr.Read())
                                                            {
                                                                string rank = dr.GetValue(0).ToString();
                                                                string name = dr.GetValue(1).ToString();
                                                                string amount = dr.GetValue(2).ToString();
                                                                string userid = dr.GetValue(3).ToString();
                                                                using (cmd = new SqlCommand("Insert into withdrawTracker(userid,name,rank,amount,comment) values (@userid,@name,@rank,@amount,@comment)", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", userid);
                                                                    cmd.Parameters.AddWithValue("@name", name);
                                                                    cmd.Parameters.AddWithValue("@amount", amount);
                                                                    cmd.Parameters.AddWithValue("@rank", rank);
                                                                    cmd.Parameters.AddWithValue("@comment", "" + name + " - " + userid + " received " + amount + " as " + rank + " earnings.");
                                                                    dr.Dispose();
                                                                    cmd.ExecuteNonQuery();
                                                                    ResponseMsg = "Done!";
                                                                }
                                                            }
                                                            else
                                                            {
                                                                ResponseMsg = "Record cannot be found!";
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    ResponseMsg = "This withdrawal transaction has been previously confirmed!";
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        //2
        public void FundWallet()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select Sn from paydetails where confirmed=@confirmed and sn=@sn", con))
                    {
                        cmd.Parameters.AddWithValue("@confirmed", "Yes");
                        cmd.Parameters.AddWithValue("@sn", SN);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                ResponseMsg = "This transaction has been previously confirmed!";
                            }
                            else
                            {
                                using (cmd = new SqlCommand("Select amount from wallet where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    //cmd.Parameters.AddWithValue("@email", depositemail);
                                    dr.Dispose();
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            int getamount = int.Parse(dr.GetValue(0).ToString());
                                            decimal result = getamount + depositamount;
                                            dr.Dispose();
                                            using (TransactionScope scope = new TransactionScope())
                                            {
                                                using (cmd = new SqlCommand("Update wallet set amount=@amount where userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    cmd.Parameters.AddWithValue("@amount", result);
                                                    //cmd.Parameters.AddWithValue("@email", depositemail);
                                                    cmd.ExecuteNonQuery();

                                                    using (cmd = new SqlCommand("Update paydetails set confirmed=@confirmed where SN=@sn", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                        cmd.Parameters.AddWithValue("@confirmed", "Yes");
                                                        cmd.ExecuteNonQuery();
                                                    }

                                                    int total = getmonibags * 5000;
                                                    int balance = amount - total;

                                                    using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                        cmd.Parameters.AddWithValue("@email", depositemail);
                                                        cmd.Parameters.AddWithValue("@addamount", depositamount);
                                                        cmd.Parameters.AddWithValue("@deductamount", 0);
                                                        cmd.Parameters.AddWithValue("@previoustotal", getamount);
                                                        cmd.Parameters.AddWithValue("@currenttotal", result);
                                                        cmd.Parameters.AddWithValue("@purpose", "Confirmation of payments deposit of '" + depositamount + "' by admin");
                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                        cmd.ExecuteNonQuery();
                                                        ResponseMsg = "Confirmed!";
                                                    }
                                                }
                                                scope.Complete();
                                            }
                                        }
                                        else
                                        {
                                            //ResponseMsg = "Cannot read information for this data.";
                                            dr.Dispose();
                                            using (TransactionScope scope = new TransactionScope())
                                            {
                                                using (cmd = new SqlCommand("Insert into wallet (email,amount,userid) values (@email,@amount,@userid)", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    cmd.Parameters.AddWithValue("@email", depositemail);
                                                    cmd.Parameters.AddWithValue("@amount", depositamount);
                                                    cmd.ExecuteNonQuery();

                                                    using (cmd = new SqlCommand("Update paydetails set confirmed=@confirmed where SN=@sn", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@sn", SN);
                                                        cmd.Parameters.AddWithValue("@confirmed", "Yes");
                                                        cmd.ExecuteNonQuery();
                                                    }

                                                    using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                        cmd.Parameters.AddWithValue("@email", depositemail);
                                                        cmd.Parameters.AddWithValue("@addamount", depositamount);
                                                        cmd.Parameters.AddWithValue("@deductamount", 0);
                                                        cmd.Parameters.AddWithValue("@previoustotal", 0);
                                                        cmd.Parameters.AddWithValue("@currenttotal", depositamount);
                                                        cmd.Parameters.AddWithValue("@purpose", "Confirmation of payments deposit of '" + depositamount + "' by admin");
                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                        cmd.ExecuteNonQuery();
                                                        ResponseMsg = "Confirmed!";
                                                    }
                                                }
                                                scope.Complete();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }
        //3
        public void ConfirmWithdrawal()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select amtwithdrawn from withdrawtrack where SN=@sn", con))
                    {
                        cmd.Parameters.AddWithValue("@sn", SN);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                string amtwithdrawn = dr.GetValue(0).ToString();
                                if (amtwithdrawn == RespDepositAmount)
                                {
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Update withdrawtrack set dd=@dd,mm=@mm,yy=@yy,date=@date,status=@status where SN=@sn", con))
                                    {
                                        cmd.Parameters.AddWithValue("@sn", SN);
                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                        cmd.Parameters.AddWithValue("@status", "Sent");
                                        cmd.ExecuteNonQuery();
                                        ResponseMsg = "Done!";
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }
        //4
        public void GetWithdrawalInfo()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select email,amtwithdrawn,userid from withdrawtrack where SN=@sn", con))
                    {
                        cmd.Parameters.AddWithValue("@sn", SN);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                RespDepositEmail = dr.GetValue(0).ToString();
                                depositamount = decimal.Parse(dr.GetValue(1).ToString());
                                RespDepositAmount = depositamount.ToString();
                                RespUserId = dr.GetValue(2).ToString();

                                dr.Dispose();
                                using (cmd = new SqlCommand("Select name,bankname,accountno from bkretrieve where username=@email and userid=@userid", con))
                                {

                                    cmd.Parameters.AddWithValue("@email", RespDepositEmail);
                                    cmd.Parameters.AddWithValue("@userid", RespUserId);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            string name = dr.GetValue(0).ToString();
                                            string bankname = dr.GetValue(1).ToString();
                                            string accountno = dr.GetValue(2).ToString();
                                            string userid = RespUserId;
                                            RespDepositName = RespUserId + "-" + name + " - " + bankname + " - " + accountno;
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Cannot read information for this data.";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void GetCryptoDepositInfo()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select name,amountusd,email from cryptoatm where SN=@sn", con))
                {
                    cmd.Parameters.AddWithValue("@sn", SN);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            depositname = dr.GetValue(0).ToString();
                            depositamount = decimal.Parse(dr.GetValue(1).ToString());
                            RespDepositName = depositname;
                            RespDepositAmount = depositamount.ToString();
                            RespDepositEmail = dr.GetValue(2).ToString();
                        }
                        else
                        {
                            ResponseMsg = "Cannot read information for this data.";
                        }
                    }
                }
            }
        }

        public void RemoveFunds()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Select amount from wallet where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            WalletAmount = int.Parse(dr.GetValue(0).ToString());
                            if (WalletAmount >= int.Parse(amountW))
                            {
                                int newAmount = WalletAmount - int.Parse(amountW);
                                dr.Dispose();
                                using(cmd = new SqlCommand("Update wallet set amount=@amount where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@amount", newAmount);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                    
                                }
                                //WalletTrace
                                using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                    cmd.Parameters.AddWithValue("@email", "Security@winninglife");
                                    cmd.Parameters.AddWithValue("@addamount", 0);
                                    cmd.Parameters.AddWithValue("@deductamount", amountW);
                                    cmd.Parameters.AddWithValue("@previoustotal", WalletAmount);
                                    cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                    cmd.Parameters.AddWithValue("@purpose", "Removal of funds of '" + amountW + "' by Admin.");
                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                    ResponseMsg = "The Wallet balance for " + UserId + " has been set to " + newAmount.ToString() + ". Prevous Balance was - " + WalletAmount + ".";
                                }
                            }
                            else
                            {
                                ResponseMsg = "Invalid Amount (too low or too high)!";
                            }
                        }
                    }
                }
            }
        }

        public void SetStatus()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Select userid,partnername from register where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            string get = dr.GetValue(1).ToString();
                            dr.Dispose();
                            using (cmd = new SqlCommand("Update register set accountstatus=@accountstatus where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@accountstatus", accountstatus);
                                cmd.Parameters.AddWithValue("@userid", UserId);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "You have just set " + get + " - " + UserId + " 's account status to " + accountstatus + ".";
                            }
                        }
                        else
                        {
                            ResponseMsg = "Invalid UserID!";
                        }
                    }
                }
                
            }
        }

        public void GetNameInfo()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Select partnername,email,phone from register where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            ResponseMsg = dr.GetValue(0).ToString();
                            email = dr.GetValue(1).ToString();
                            phone = dr.GetValue(2).ToString();
                        }
                        else
                        {
                            ResponseMsg = "Invalid Name!";
                        }
                    }
                }
            }
        }

        public void GetEarningsDueByRanks()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Drop table EarningsByRank", con))
                {
                    cmd.ExecuteNonQuery();
                }

                using (cmd = new SqlCommand("SELECT [UserID], [Username], [Rank], [AmountDue], [Deductions], [Balance], [Date], [Status], [SN]  into EarningsByRank FROM [Earnings] where rank=@rank ORDER BY [SN]", con))
                {
                    cmd.Parameters.AddWithValue("@rank", rankW);
                    cmd.ExecuteNonQuery();
                }
            }
        }

        public void UpdateNameInfo()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();

                using (cmd = new SqlCommand("Select userid from placement where userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            ResponseMsg = "This user has already been placed, you cannot edit the details!";
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select partnername from register where userid=@userid", con))
                            {
                                cmd.Parameters.AddWithValue("@userid", UserId);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read())
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Update register set partnername=@partnername,email=@email,phone=@phone where userid=@userid", con))
                                        {
                                            cmd.Parameters.AddWithValue("@partnername", partnername);
                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                            cmd.Parameters.AddWithValue("@email", email);
                                            cmd.Parameters.AddWithValue("@phone", phone);
                                            cmd.ExecuteNonQuery();
                                            ResponseMsg = "Success!";
                                        }
                                    }
                                    else
                                    {
                                        ResponseMsg = "Invalid Name and UserID!";
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        public void GetWithdrawInfo()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select name,thiswithdraw,userid from withdrawals where SN=@sn", con))
                    {
                        cmd.Parameters.AddWithValue("@sn", SN);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                depositname = dr.GetValue(0).ToString();
                                depositamount = decimal.Parse(dr.GetValue(1).ToString());
                                RespDepositName = depositname;
                                RespDepositAmount = depositamount.ToString();
                                RespUserId = dr.GetValue(2).ToString();

                                dr.Dispose();
                                using(cmd = new SqlCommand("Select bankname,accountno from bkretrieve where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", RespUserId);
                                    using(dr = cmd.ExecuteReader())
                                    {
                                        if(dr.Read())
                                        {
                                            bankname = dr.GetValue(0).ToString();
                                            accountno = dr.GetValue(1).ToString();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Cannot read information for this data.";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {

            }
        }

        //5
        public void GetDepositInfo()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select depositorname,amount,email,userid from paydetails where SN=@sn", con))
                    {
                        cmd.Parameters.AddWithValue("@sn", SN);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                depositname = dr.GetValue(0).ToString();
                                depositamount = decimal.Parse(dr.GetValue(1).ToString());
                                RespDepositName = depositname;
                                RespDepositAmount = depositamount.ToString();
                                RespDepositEmail = dr.GetValue(2).ToString();
                                RespUserId = dr.GetValue(3).ToString();
                            }
                            else
                            {
                                ResponseMsg = "Cannot read information for this data.";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void GetCountry()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select country from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            string getCountry = dr.GetValue(0).ToString();
                            ResponseMsg = getCountry;
                        }
                    }
                }
            }
        }
        //6
        public void GetWalletRegBalance()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                walletbalance = dr.GetValue(0).ToString();
                                walletBalanceInt = int.Parse(dr.GetValue(0).ToString());
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select country from register where email=@email and user=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", RespUserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            string getCountry = dr.GetValue(0).ToString();
                                            if (getCountry == "NIGERIA")
                                            {
                                                walletbalance = walletbalance + " NGN";
                                            }
                                            else
                                            {
                                                walletbalance = walletbalance + " USD";
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Wallet records for this member does not exist.";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void GetCurrencyCost()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select ngn,usd from programtracker where program=@program", con))
                {
                    cmd.Parameters.AddWithValue("@program", program);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            NGN = dr.GetValue(0).ToString();
                            USD = dr.GetValue(1).ToString();
                        }
                        else
                        {
                            ResponseMsg = "The Programs and prices has not been set up.";
                        }
                    }
                }
            }
        }
        //7
        public void LoginRegister()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select email from register where email=@email and password=@password and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@email", regloginphone);
                        cmd.Parameters.AddWithValue("@password", reglogpassword);

                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                ResponseMsg = "Email Correct!";
                            }
                            else
                            {
                                ResponseMsg = "Email Wrong!";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }
        //8
        public void GetWalletBalance()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    if (email != "")
                    {
                        using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                        {
                            cmd.Parameters.AddWithValue("@userid", UserId);
                            cmd.Parameters.AddWithValue("@email", email);
                            using (dr = cmd.ExecuteReader())
                            {
                                if (dr.Read())
                                {
                                    walletbalance = dr.GetValue(0).ToString();
                                    ResponseMsg = "" + walletbalance + " NGN";
                                }
                                else
                                {
                                    ResponseMsg = "Wallet records for this member does not exist.";
                                }
                            }
                        }
                    }
                    else
                    {
                        ResponseMsg = "Enter a valid Email.";
                    }
                    //        }
                    //    }
                    //}
                }
            }
            catch (Exception)
            {
                
            }
        }
        //9
        public void SendPayDetails()
        {
            //try
            //{
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    if (tellerno != "" && tellerno != "None")
                    {
                        using (cmd = new SqlCommand("Select tellerno from paydetails where tellerno=@tellerno and bankname=@bankname", con))
                        {
                            cmd.Parameters.AddWithValue("@tellerno", tellerno);
                            cmd.Parameters.AddWithValue("@bankname", depositbank);
                            using (dr = cmd.ExecuteReader())
                            {
                                if (dr.Read() && !dr.IsDBNull(0))
                                {
                                    ResponseMsg = "Teller No. is invalid or has been previously submitted.";
                                }
                                else
                                {
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Insert into paydetails(depositorname,email,amount,paymode,bankname,tellerno,remarks,paydate,confirmed,Userid) values (@depositorname,@email,@amount,@paymode,@bankname,@tellerno,@remarks,@paydate,@confirmed,@userid)", con))
                                    {
                                        cmd.Parameters.AddWithValue("@depositorname", depositorname);
                                        cmd.Parameters.AddWithValue("@email", depositoremail);
                                        cmd.Parameters.AddWithValue("@amount", depositoramount);
                                        cmd.Parameters.AddWithValue("@paymode", depositorpaymode);
                                        cmd.Parameters.AddWithValue("@bankname", depositbank);
                                        cmd.Parameters.AddWithValue("@tellerno", tellerno);
                                        cmd.Parameters.AddWithValue("@remarks", remarks);
                                        cmd.Parameters.AddWithValue("@paydate", depositorpaydate);
                                        cmd.Parameters.AddWithValue("@confirmed", "No");
                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                        cmd.ExecuteNonQuery();
                                        ResponseMsg = "Success!";
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        using (cmd = new SqlCommand("Insert into paydetails(depositorname,email,amount,paymode,bankname,tellerno,remarks,paydate,confirmed,userid) values (@depositorname,@email,@amount,@paymode,@bankname,@tellerno,@remarks,@paydate,@confirmed,@userid)", con))
                        {
                            cmd.Parameters.AddWithValue("@depositorname", depositorname);
                            cmd.Parameters.AddWithValue("@email", depositoremail);
                            cmd.Parameters.AddWithValue("@amount", depositoramount);
                            cmd.Parameters.AddWithValue("@paymode", depositorpaymode);
                            cmd.Parameters.AddWithValue("@bankname", depositbank);
                            cmd.Parameters.AddWithValue("@tellerno", tellerno);
                            cmd.Parameters.AddWithValue("@remarks", remarks);
                            cmd.Parameters.AddWithValue("@paydate", depositorpaydate);
                            cmd.Parameters.AddWithValue("@confirmed", "No");
                            cmd.Parameters.AddWithValue("@userid", UserId);
                            cmd.ExecuteNonQuery();
                            ResponseMsg = "Success!";
                        }
                    }
                }
            //}
            //catch (Exception)
            //{                
            //    //throw;
            //}
        }

        public void BALinkGenerator()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("select email from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", GetBALinkUsername);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select code from BALink where email=@email", con))
                            {
                                cmd.Parameters.AddWithValue("@email", GetBALinkUsername);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read() && !dr.IsDBNull(0))
                                    {
                                        ResponseMsg = "INVALID OPERATION!: User already has a referral link!";
                                    }
                                    else
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Insert into BALink(email,url,code) values (@email,@url,@code)", con))
                                        {
                                            cmd.Parameters.AddWithValue("@email", GetBALinkUsername);
                                            cmd.Parameters.AddWithValue("@url", GetBALinkUrl);
                                            cmd.Parameters.AddWithValue("@code", GetBALinkCode);
                                            cmd.ExecuteNonQuery();
                                            ResponseMsg = "Referral link saved!";
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            ResponseMsg = "Wrong Username details.";
                        }
                    }
                }
            }
        }

        public void SBALinkGenerator()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                // string getBACode;
                //GetBALinkCode = dr.GetValue(0).ToString();
                using (cmd = new SqlCommand("select email from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", GetSBALinkUsername);
                   // dr.Dispose();
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select sbacode from SBALink where email=@email", con))
                            {
                                cmd.Parameters.AddWithValue("@email", GetSBALinkUsername);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read() && !dr.IsDBNull(0))
                                    {
                                        ResponseMsg = "INVALID OPERATION!: User already has a Refer a friend referral link!";
                                    }
                                    else
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Insert into SBALink(email,url,bacode,sbacode) values (@email,@url,@bacode,@sbacode)", con))
                                        {
                                            cmd.Parameters.AddWithValue("@email", GetSBALinkUsername);
                                            cmd.Parameters.AddWithValue("@url", GetSBALinkUrl);
                                            cmd.Parameters.AddWithValue("@bacode", GetBALinkCode);
                                            cmd.Parameters.AddWithValue("@sbacode", GetSBALinkCode);
                                            cmd.ExecuteNonQuery();
                                            ResponseMsg = "Refer a friend Referral link saved!";
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            ResponseMsg = "Wrong Username details.";
                        }
                    }
                }

            }
        }

        public void SBAReg()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("select email from balink where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", GetBALinkUsername);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Select sbausername from sba where sbausername=@sbausername", con))
                            {
                                cmd.Parameters.AddWithValue("@sbausername", GetSBAUsername);
                                using (dr = cmd.ExecuteReader())
                                {
                                    if (dr.Read() && !dr.IsDBNull(0))
                                    {
                                        ResponseMsg = "INVALID OPERATION!: User already has a Sub-Ambassador!";
                                    }
                                    else
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Select email from register where email=@sbausername", con))
                                        {
                                            cmd.Parameters.AddWithValue("@sbausername", GetSBAUsername);
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Insert into SBA(bausername,sbausername) values (@bausername,@sbausername)", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@bausername", GetBALinkUsername);
                                                        cmd.Parameters.AddWithValue("@sbausername", GetSBAUsername);
                                                        cmd.ExecuteNonQuery();
                                                        ResponseMsg = "SBA Created!";
                                                    }
                                                }
                                                else
                                                {
                                                    ResponseMsg = "Cannot make a Non-registered WinningLife User an SBA!";
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            ResponseMsg = "Invalid Brand Ambassador!";
                        }
                    }
                }
            }
        }

        public void MustardFund()
        {
            int getMaxSN = 0;
            using (con = new SqlConnection(conn))
            {
                con.Open();
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                //FIRST CHECK IF THE WALLET BALANCE IS ENOUGH AND DEDUCT THE COST HERE TOO, UPDATE THE WALLET BALANCE AFTER PURCHASE//
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                using (cmd = new SqlCommand("Select codestatus from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", email);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            string codestatus = dr.GetValue(0).ToString();
                            if (codestatus == "1")
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int amount = int.Parse(dr.GetValue(0).ToString());
                                            if (amount > 10000)
                                            {

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from Mustard", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 2) + 1;
                                                            Pay2SN = (Pay1SN * 2) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 2 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 2;
                                                            }
                                                            else
                                                            {
                                                                ParentSN = (AssignedSN - 1) / 2;
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 2) + 1;
                                                            Pay2SN = (Pay1SN * 2) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 2 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 2;
                                                            }
                                                            else
                                                            {
                                                                ParentSN = (AssignedSN - 1) / 2;
                                                            }

                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from mustard where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (TransactionScope scope = new TransactionScope())
                                                                        {
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (cmd = new SqlCommand("Insert into mustard(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();

                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update mustard set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }


                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 10000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of MustardFund Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            scope.Complete();
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (TransactionScope scope = new TransactionScope())
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Insert into mustard(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                            {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                                cmd.Parameters.AddWithValue("@cost", cost);
                                                                                                cmd.Parameters.AddWithValue("@qty", qty);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                                cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                                cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();


                                                                                                //Send Emails
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string getlink = dr.GetValue(0).ToString();

                                                                                                            //Send Email
                                                                                                            //create the mail message
                                                                                                            MailMessage mail = new MailMessage();
                                                                                                            //set the FROM address
                                                                                                            mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                            //set the RECIPIENTS
                                                                                                            mail.To.Add(email);
                                                                                                            //Add Attachments
                                                                                                            //if (FileUploadMustard1.HasFile)
                                                                                                            //{
                                                                                                            //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                            //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                            //}
                                                                                                            //enter a SUBJECT
                                                                                                            mail.Subject = "Your E-Book from WinningLife";
                                                                                                            //Enter the message BODY
                                                                                                            mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                            //set the mail server (default should be smtp.1and1.com)
                                                                                                            SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                            //Enter your full e-mail address and password
                                                                                                            smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                            try
                                                                                                            {
                                                                                                                //send the message 
                                                                                                                smtp.Send(mail);

                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Update mustard set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                    cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            catch (Exception)
                                                                                                            {
                                                                                                                //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }


                                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@email", email);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                            int newAmount = getPreviousAmount - 10000;
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of MustardFund Product by '" + email + "'");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 500;
                                                            int commissionSBAamount60 = 300;
                                                            int commissionBAamount40 = 200;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                cmd.Parameters.AddWithValue("@amount", 10000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            
                                                            using (cmd = new SqlCommand("Select email from Mustard where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 0);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            //////////////////////////////////////////////////////////////////////
                                                            ////////////////////////////CONTINUE WITH THIS LATER/////////////////
                                                            ////////////////////////////////////////////////////////////////////
                                                            //using (cmd = new SqlCommand("Select auto from autopurchase where email=@email", con))
                                                            //{
                                                            //    cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                            //    using(dr = cmd.ExecuteReader())
                                                            //    {
                                                            //        if(dr.Read())
                                                            //        {
                                                            //            string getstate = dr.GetValue(0).ToString();
                                                            //            if(getstate == "Enabled")
                                                            //            {

                                                            //            }
                                                            //            //else if(getstate ==)
                                                            //        }
                                                            //    }
                                                            //}
                                                            /////////////////////////////////////
                                                            /////////////////////////////////////
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select email from Mustard where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 20000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 15000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 5000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 10000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else if (amount == 10000)
                                            {

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from Mustard", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 2) + 1;
                                                            Pay2SN = (Pay1SN * 2) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 2 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 2;
                                                            }
                                                            else
                                                            {
                                                                ParentSN = (AssignedSN - 1) / 2;
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 2) + 1;
                                                            Pay2SN = (Pay1SN * 2) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 2 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 2;
                                                            }
                                                            else
                                                            {
                                                                ParentSN = (AssignedSN - 1) / 2;
                                                            }

                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from mustard where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    partnername = dr.GetValue(0).ToString();

                                                                                    using (cmd = new SqlCommand("Insert into mustard(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                    {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                        cmd.Parameters.AddWithValue("@email", email);
                                                                                        cmd.Parameters.AddWithValue("@name", partnername);
                                                                                        cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                        cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                        cmd.Parameters.AddWithValue("@cost", cost);
                                                                                        cmd.Parameters.AddWithValue("@qty", qty);
                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                        cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                        cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                        cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();

                                                                                        //Send Emails
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read())
                                                                                                {
                                                                                                    string getlink = dr.GetValue(0).ToString();

                                                                                                    //Send Email
                                                                                                    //create the mail message
                                                                                                    MailMessage mail = new MailMessage();
                                                                                                    //set the FROM address
                                                                                                    mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                    //set the RECIPIENTS
                                                                                                    mail.To.Add(email);
                                                                                                    //Add Attachments
                                                                                                    //if (FileUploadMustard1.HasFile)
                                                                                                    //{
                                                                                                    //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                    //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                    //}
                                                                                                    //enter a SUBJECT
                                                                                                    mail.Subject = "Your E-Book from WinningLife";
                                                                                                    //Enter the message BODY
                                                                                                    mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                    //set the mail server (default should be smtp.1and1.com)
                                                                                                    SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                    //Enter your full e-mail address and password
                                                                                                    smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                    try
                                                                                                    {
                                                                                                        //send the message 
                                                                                                        smtp.Send(mail);

                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update mustard set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                            cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                    catch (Exception)
                                                                                                    {
                                                                                                        //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }

                                                                                        using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read())
                                                                                                {
                                                                                                    int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                    int newAmount = getPreviousAmount - 10000;
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                    {
                                                                                                        cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                        cmd.Parameters.AddWithValue("@email", email);
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }

                                                                                                    using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                        cmd.Parameters.AddWithValue("@email", email);
                                                                                                        cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                        cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                        cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                        cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                        cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of MustardFund Product by '" + email + "'");
                                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (cmd = new SqlCommand("Insert into mustard(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();


                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update mustard set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }


                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 10000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of MustardFund Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 500;
                                                            int commissionSBAamount60 = 300;
                                                            int commissionBAamount40 = 200;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                cmd.Parameters.AddWithValue("@amount", 10000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            using (cmd = new SqlCommand("Select email from Mustard where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 0);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            using (cmd = new SqlCommand("Select email from Mustard where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 20000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 15000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 5000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 10000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                ResponseMsg = "Insufficient Wallet Balance for this transaction.";
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Your Email has not been confirmed, go to profile and confirm your email.";
                            }
                        }
                    }
                }
            }
        }

        public void HealthWealth360()
        {
            int getMaxSN = 0;
            using (con = new SqlConnection(conn))
            {
                con.Open();
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                //FIRST CHECK IF THE WALLET BALANCE IS ENOUGH AND DEDUCT THE COST HERE TOO, UPDATE THE WALLET BALANCE AFTER PURCHASE//
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                using (cmd = new SqlCommand("Select codestatus from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", email);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            string codestatus = dr.GetValue(0).ToString();
                            if (codestatus == "1")
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int amount = int.Parse(dr.GetValue(0).ToString());
                                            if (amount > 10000)
                                            {

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from HealthWealth360", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 2) + 1;
                                                            Pay2SN = (Pay1SN * 2) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 2 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 2;
                                                            }
                                                            else
                                                            {
                                                                ParentSN = (AssignedSN - 1) / 2;
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 2) + 1;
                                                            Pay2SN = (Pay1SN * 2) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 2 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 2;
                                                            }
                                                            else
                                                            {
                                                                ParentSN = (AssignedSN - 1) / 2;
                                                            }

                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from HealthWealth360 where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    partnername = dr.GetValue(0).ToString();

                                                                                    using (TransactionScope scope = new TransactionScope())
                                                                                    {

                                                                                        using (cmd = new SqlCommand("Insert into HealthWealth360(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();


                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update healthwealth360 set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }

                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 10000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of 360HealthWealth Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();

                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (TransactionScope scope = new TransactionScope())
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Insert into HealthWealth360(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                            {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                                cmd.Parameters.AddWithValue("@cost", cost);
                                                                                                cmd.Parameters.AddWithValue("@qty", qty);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                                cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                                cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();

                                                                                                //Send Emails
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string getlink = dr.GetValue(0).ToString();

                                                                                                            //Send Email
                                                                                                            //create the mail message
                                                                                                            MailMessage mail = new MailMessage();
                                                                                                            //set the FROM address
                                                                                                            mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                            //set the RECIPIENTS
                                                                                                            mail.To.Add(email);
                                                                                                            //Add Attachments
                                                                                                            //if (FileUploadMustard1.HasFile)
                                                                                                            //{
                                                                                                            //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                            //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                            //}
                                                                                                            //enter a SUBJECT
                                                                                                            mail.Subject = "Your E-Book from WinningLife";
                                                                                                            //Enter the message BODY
                                                                                                            mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                            //set the mail server (default should be smtp.1and1.com)
                                                                                                            SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                            //Enter your full e-mail address and password
                                                                                                            smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                            try
                                                                                                            {
                                                                                                                //send the message 
                                                                                                                smtp.Send(mail);

                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Update healthwealth360 set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                    cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            catch (Exception)
                                                                                                            {
                                                                                                                //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@email", email);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                            int newAmount = getPreviousAmount - 10000;
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of 360HealthWealth Product by '" + email + "'");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 500;
                                                            int commissionSBAamount60 = 300;
                                                            int commissionBAamount40 = 200;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                cmd.Parameters.AddWithValue("@amount", 10000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            using (cmd = new SqlCommand("Select email from HealthWealth360 where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 2500);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 2500);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            using (cmd = new SqlCommand("Select email from HealthWealth360 where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 20000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 5000);
                                                                            cmd.Parameters.AddWithValue("@balance", 10000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 10000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "360HealthWealth");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "360HealthWealth");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "360HealthWealth");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else if (amount == 10000)
                                            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from HealthWealth360", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 2) + 1;
                                                            Pay2SN = (Pay1SN * 2) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 2 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 2;
                                                            }
                                                            else
                                                            {
                                                                ParentSN = (AssignedSN - 1) / 2;
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 2) + 1;
                                                            Pay2SN = (Pay1SN * 2) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 2 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 2;
                                                            }
                                                            else
                                                            {
                                                                ParentSN = (AssignedSN - 1) / 2;
                                                            }

                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from HealthWealth360 where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    partnername = dr.GetValue(0).ToString();
                                                                                    using (TransactionScope scope = new TransactionScope())
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Insert into HealthWealth360(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();

                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update healthwealth360 set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }

                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 10000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of 360HealthWealth Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        scope.Complete();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (TransactionScope scope = new TransactionScope())
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Insert into HealthWealth360(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                            {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                                cmd.Parameters.AddWithValue("@cost", cost);
                                                                                                cmd.Parameters.AddWithValue("@qty", qty);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                                cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                                cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();

                                                                                                //Send Emails
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string getlink = dr.GetValue(0).ToString();

                                                                                                            //Send Email
                                                                                                            //create the mail message
                                                                                                            MailMessage mail = new MailMessage();
                                                                                                            //set the FROM address
                                                                                                            mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                            //set the RECIPIENTS
                                                                                                            mail.To.Add(email);
                                                                                                            //Add Attachments
                                                                                                            //if (FileUploadMustard1.HasFile)
                                                                                                            //{
                                                                                                            //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                            //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                            //}
                                                                                                            //enter a SUBJECT
                                                                                                            mail.Subject = "Your E-Book from WinningLife";
                                                                                                            //Enter the message BODY
                                                                                                            mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                            //set the mail server (default should be smtp.1and1.com)
                                                                                                            SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                            //Enter your full e-mail address and password
                                                                                                            smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                            try
                                                                                                            {
                                                                                                                //send the message 
                                                                                                                smtp.Send(mail);

                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Update healthwealth360 set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                    cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            catch (Exception)
                                                                                                            {
                                                                                                                //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@email", email);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                            int newAmount = getPreviousAmount - 10000;
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of 360HealthWealth Product by '" + email + "'");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 500;
                                                            int commissionSBAamount60 = 300;
                                                            int commissionBAamount40 = 200;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                cmd.Parameters.AddWithValue("@amount", 10000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            using (cmd = new SqlCommand("Select email from HealthWealth360 where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 2500);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 2500);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            using (cmd = new SqlCommand("Select email from HealthWealth360 where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "360HealthWealth");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 20000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 5000);
                                                                            cmd.Parameters.AddWithValue("@balance", 10000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 10000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "360HealthWealth");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "360HealthWealth");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "360HealthWealth");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                ResponseMsg = "Insufficient Wallet Balance for this transaction.";
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Your Email has not been confirmed, go to profile and confirm your email.";
                            }
                        }
                    }
                }
            }
        }

        public void LandPaceStarter()
        {
            int getMaxSN = 0;
            using (con = new SqlConnection(conn))
            {
                con.Open();
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                //FIRST CHECK IF THE WALLET BALANCE IS ENOUGH AND DEDUCT THE COST HERE TOO, UPDATE THE WALLET BALANCE AFTER PURCHASE//
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                using (cmd = new SqlCommand("Select codestatus from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", email);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            string codestatus = dr.GetValue(0).ToString();
                            if (codestatus == "1")
                            {
                                dr.Dispose();

                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int amount = int.Parse(dr.GetValue(0).ToString());
                                            if (amount > 20000)
                                            {

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from LandPaceStarter", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 3) + 1;
                                                            Pay2SN = (Pay1SN * 3) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 3 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 3;
                                                            }
                                                            else
                                                            {
                                                                int front = AssignedSN + 1;
                                                                int back = AssignedSN - 1;
                                                                if (front % 3 == 0)
                                                                {
                                                                    ParentSN = front / 3;
                                                                }
                                                                else if (back % 3 == 0)
                                                                {
                                                                    ParentSN = back / 3;
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 3) + 1;
                                                            Pay2SN = (Pay1SN * 3) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 3 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 3;
                                                            }
                                                            else
                                                            {
                                                                int front = AssignedSN + 1;
                                                                int back = AssignedSN - 1;
                                                                if (front % 3 == 0)
                                                                {
                                                                    ParentSN = front / 3;
                                                                }
                                                                else if (back % 3 == 0)
                                                                {
                                                                    ParentSN = back / 3;
                                                                }
                                                            }
                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from LandPaceStarter where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    partnername = dr.GetValue(0).ToString();

                                                                                    using (TransactionScope scope = new TransactionScope())
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Insert into LandPaceStarter(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();

                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update landpacestarter set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }

                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 20000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of LandPaceStarter Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        scope.Complete();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (TransactionScope scope = new TransactionScope())
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Insert into LandPaceStarter(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                            {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                                cmd.Parameters.AddWithValue("@cost", cost);
                                                                                                cmd.Parameters.AddWithValue("@qty", qty);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                                cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                                cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();

                                                                                                //Send Emails
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string getlink = dr.GetValue(0).ToString();

                                                                                                            //Send Email
                                                                                                            //create the mail message
                                                                                                            MailMessage mail = new MailMessage();
                                                                                                            //set the FROM address
                                                                                                            mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                            //set the RECIPIENTS
                                                                                                            mail.To.Add(email);
                                                                                                            //Add Attachments
                                                                                                            //if (FileUploadMustard1.HasFile)
                                                                                                            //{
                                                                                                            //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                            //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                            //}
                                                                                                            //enter a SUBJECT
                                                                                                            mail.Subject = "Your E-Book from WinningLife";
                                                                                                            //Enter the message BODY
                                                                                                            mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                            //set the mail server (default should be smtp.1and1.com)
                                                                                                            SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                            //Enter your full e-mail address and password
                                                                                                            smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                            try
                                                                                                            {
                                                                                                                //send the message 
                                                                                                                smtp.Send(mail);

                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Update landpacestarter set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                    cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            catch (Exception)
                                                                                                            {
                                                                                                                //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@email", email);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                            int newAmount = getPreviousAmount - 20000;
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of LandPaceStarter Product by '" + email + "'");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 1000;
                                                            int commissionSBAamount60 = 600;
                                                            int commissionBAamount40 = 400;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                cmd.Parameters.AddWithValue("@amount", 20000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            using (cmd = new SqlCommand("Select email from LandPaceStarter where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 20000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 0);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 20000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            using (cmd = new SqlCommand("Select email from LandPaceStarter where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 50000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 0);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 20000);
                                                                            cmd.Parameters.AddWithValue("@balance", 30000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 20000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "LandPaceStarter");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "LandPaceStarter");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "LandPaceStarter");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else if (amount == 20000)
                                            {

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from LandPaceStarter", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 3) + 1;
                                                            Pay2SN = (Pay1SN * 3) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 3 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 3;
                                                            }
                                                            else
                                                            {
                                                                int front = AssignedSN + 1;
                                                                int back = AssignedSN - 1;
                                                                if (front % 3 == 0)
                                                                {
                                                                    ParentSN = front / 3;
                                                                }
                                                                else if (back % 3 == 0)
                                                                {
                                                                    ParentSN = back / 3;
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 3) + 1;
                                                            Pay2SN = (Pay1SN * 3) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 3 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 3;
                                                            }
                                                            else
                                                            {
                                                                int front = AssignedSN + 1;
                                                                int back = AssignedSN - 1;
                                                                if (front % 3 == 0)
                                                                {
                                                                    ParentSN = front / 3;
                                                                }
                                                                else if (back % 3 == 0)
                                                                {
                                                                    ParentSN = back / 3;
                                                                }
                                                            }
                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from LandPaceStarter where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    partnername = dr.GetValue(0).ToString();

                                                                                    using (TransactionScope scope = new TransactionScope())
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Insert into LandPaceStarter(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();


                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update landpacestarter set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }


                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 20000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of LandPaceStarter Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        scope.Complete();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (TransactionScope scope = new TransactionScope())
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Insert into LandPaceStarter(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                            {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                                cmd.Parameters.AddWithValue("@cost", cost);
                                                                                                cmd.Parameters.AddWithValue("@qty", qty);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                                cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                                cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();

                                                                                                //Send Emails
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string getlink = dr.GetValue(0).ToString();

                                                                                                            //Send Email
                                                                                                            //create the mail message
                                                                                                            MailMessage mail = new MailMessage();
                                                                                                            //set the FROM address
                                                                                                            mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                            //set the RECIPIENTS
                                                                                                            mail.To.Add(email);
                                                                                                            //Add Attachments
                                                                                                            //if (FileUploadMustard1.HasFile)
                                                                                                            //{
                                                                                                            //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                            //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                            //}
                                                                                                            //enter a SUBJECT
                                                                                                            mail.Subject = "Your E-Book from WinningLife";
                                                                                                            //Enter the message BODY
                                                                                                            mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                            //set the mail server (default should be smtp.1and1.com)
                                                                                                            SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                            //Enter your full e-mail address and password
                                                                                                            smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                            try
                                                                                                            {
                                                                                                                //send the message 
                                                                                                                smtp.Send(mail);

                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Update landpacestarter set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                    cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            catch (Exception)
                                                                                                            {
                                                                                                                //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@email", email);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                            int newAmount = getPreviousAmount - 20000;
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of LandPaceStarter Product by '" + email + "'");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 1000;
                                                            int commissionSBAamount60 = 600;
                                                            int commissionBAamount40 = 400;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                cmd.Parameters.AddWithValue("@amount", 20000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            using (cmd = new SqlCommand("Select email from LandPaceStarter where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 20000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 0);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 20000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            using (cmd = new SqlCommand("Select email from LandPaceStarter where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "LandPaceStarter");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 50000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 0);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 20000);
                                                                            cmd.Parameters.AddWithValue("@balance", 30000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 20000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "LandPaceStarter");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "LandPaceStarter");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "LandPaceStarter");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                ResponseMsg = "Insufficient Wallet Balance for this transaction.";
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Your Email has not been confirmed, go to profile and confirm your email.";
                            }
                        }
                    }
                }
            }
        }

        public void LandPaceGold()
        {
            int getMaxSN = 0;
            using (con = new SqlConnection(conn))
            {
                con.Open();
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                //FIRST CHECK IF THE WALLET BALANCE IS ENOUGH AND DEDUCT THE COST HERE TOO, UPDATE THE WALLET BALANCE AFTER PURCHASE//
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                using (cmd = new SqlCommand("Select codestatus from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", email);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            string codestatus = dr.GetValue(0).ToString();
                            if (codestatus == "1")
                            {
                                dr.Dispose();

                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int amount = int.Parse(dr.GetValue(0).ToString());
                                            if (amount > 40000)
                                            {

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from LandPaceGold", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 3) + 1;
                                                            Pay2SN = (Pay1SN * 3) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 3 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 3;
                                                            }
                                                            else
                                                            {
                                                                int front = AssignedSN + 1;
                                                                int back = AssignedSN - 1;
                                                                if (front % 3 == 0)
                                                                {
                                                                    ParentSN = front / 3;
                                                                }
                                                                else if (back % 3 == 0)
                                                                {
                                                                    ParentSN = back / 3;
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 3) + 1;
                                                            Pay2SN = (Pay1SN * 3) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 3 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 3;
                                                            }
                                                            else
                                                            {
                                                                int front = AssignedSN + 1;
                                                                int back = AssignedSN - 1;
                                                                if (front % 3 == 0)
                                                                {
                                                                    ParentSN = front / 3;
                                                                }
                                                                else if (back % 3 == 0)
                                                                {
                                                                    ParentSN = back / 3;
                                                                }
                                                            }
                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from LandPaceGold where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    partnername = dr.GetValue(0).ToString();

                                                                                    using (TransactionScope scope = new TransactionScope())
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Insert into LandPaceGold(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();

                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update landpacegold set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }

                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 40000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of LandPaceGold Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        scope.Complete();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (TransactionScope scope = new TransactionScope())
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Insert into LandPaceGold(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                            {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                                cmd.Parameters.AddWithValue("@cost", cost);
                                                                                                cmd.Parameters.AddWithValue("@qty", qty);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                                cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                                cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();

                                                                                                //Send Emails
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string getlink = dr.GetValue(0).ToString();

                                                                                                            //Send Email
                                                                                                            //create the mail message
                                                                                                            MailMessage mail = new MailMessage();
                                                                                                            //set the FROM address
                                                                                                            mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                            //set the RECIPIENTS
                                                                                                            mail.To.Add(email);
                                                                                                            //Add Attachments
                                                                                                            //if (FileUploadMustard1.HasFile)
                                                                                                            //{
                                                                                                            //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                            //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                            //}
                                                                                                            //enter a SUBJECT
                                                                                                            mail.Subject = "Your E-Book from WinningLife";
                                                                                                            //Enter the message BODY
                                                                                                            mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                            //set the mail server (default should be smtp.1and1.com)
                                                                                                            SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                            //Enter your full e-mail address and password
                                                                                                            smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                            try
                                                                                                            {
                                                                                                                //send the message 
                                                                                                                smtp.Send(mail);

                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Update landpacegold set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                    cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            catch (Exception)
                                                                                                            {
                                                                                                                //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@email", email);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                            int newAmount = getPreviousAmount - 40000;
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of LandPaceGold Product by '" + email + "'");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 2000;
                                                            int commissionSBAamount60 = 1200;
                                                            int commissionBAamount40 = 800;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                cmd.Parameters.AddWithValue("@amount", 40000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            using (cmd = new SqlCommand("Select email from LandPaceGold where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 40000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 0);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 40000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            using (cmd = new SqlCommand("Select email from LandPaceGold where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 100000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 0);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 40000);
                                                                            cmd.Parameters.AddWithValue("@balance", 60000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 40000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "LandPaceGold");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "LandPaceGold");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "LandPaceGold");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else if (amount == 40000)
                                            {

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from LandPaceGold", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 3) + 1;
                                                            Pay2SN = (Pay1SN * 3) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 3 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 3;
                                                            }
                                                            else
                                                            {
                                                                int front = AssignedSN + 1;
                                                                int back = AssignedSN - 1;
                                                                if (front % 3 == 0)
                                                                {
                                                                    ParentSN = front / 3;
                                                                }
                                                                else if (back % 3 == 0)
                                                                {
                                                                    ParentSN = back / 3;
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            Pay1SN = (AssignedSN * 3) + 1;
                                                            Pay2SN = (Pay1SN * 3) + 1;
                                                            //Modulus "%" operator, if equal to zero, then its even else odd
                                                            if (AssignedSN % 3 == 0)
                                                            {
                                                                ParentSN = AssignedSN / 3;
                                                            }
                                                            else
                                                            {
                                                                int front = AssignedSN + 1;
                                                                int back = AssignedSN - 1;
                                                                if (front % 3 == 0)
                                                                {
                                                                    ParentSN = front / 3;
                                                                }
                                                                else if (back % 3 == 0)
                                                                {
                                                                    ParentSN = back / 3;
                                                                }
                                                            }
                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from LandPaceGold where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    partnername = dr.GetValue(0).ToString();

                                                                                    using (TransactionScope scope = new TransactionScope())
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Insert into LandPaceGold(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();

                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update landpacegold set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }

                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 40000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of LandPaceGold Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                        scope.Complete();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();
                                                                                        using (TransactionScope scope = new TransactionScope())
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Insert into LandPaceGold(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                            {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                                cmd.Parameters.AddWithValue("@cost", cost);
                                                                                                cmd.Parameters.AddWithValue("@qty", qty);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                                cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                                cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();

                                                                                                //Send Emails
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string getlink = dr.GetValue(0).ToString();

                                                                                                            //Send Email
                                                                                                            //create the mail message
                                                                                                            MailMessage mail = new MailMessage();
                                                                                                            //set the FROM address
                                                                                                            mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                            //set the RECIPIENTS
                                                                                                            mail.To.Add(email);
                                                                                                            //Add Attachments
                                                                                                            //if (FileUploadMustard1.HasFile)
                                                                                                            //{
                                                                                                            //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                            //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                            //}
                                                                                                            //enter a SUBJECT
                                                                                                            mail.Subject = "Your E-Book from WinningLife";
                                                                                                            //Enter the message BODY
                                                                                                            mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                            //set the mail server (default should be smtp.1and1.com)
                                                                                                            SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                            //Enter your full e-mail address and password
                                                                                                            smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                            try
                                                                                                            {
                                                                                                                //send the message 
                                                                                                                smtp.Send(mail);

                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Update landpacegold set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                    cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            catch (Exception)
                                                                                                            {
                                                                                                                //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@email", email);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                            int newAmount = getPreviousAmount - 40000;
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of LandPaceGold Product by '" + email + "'");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 2000;
                                                            int commissionSBAamount60 = 1200;
                                                            int commissionBAamount40 = 800;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                cmd.Parameters.AddWithValue("@amount", 40000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            using (cmd = new SqlCommand("Select email from LandPaceGold where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 40000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 0);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 40000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            using (cmd = new SqlCommand("Select email from LandPaceGold where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "LandPaceGold");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 100000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 0);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 40000);
                                                                            cmd.Parameters.AddWithValue("@balance", 60000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 40000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "LandPaceGold");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "LandPaceGold");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "LandPaceGold");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                ResponseMsg = "Insufficient Wallet Balance for this transaction.";
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Your Email has not been confirmed, go to profile and confirm your email.";
                            }
                        }
                    }
                }
            }
        }

        public void CryptoATM()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                //FIRST CHECK IF THE WALLET BALANCE IS ENOUGH AND DEDUCT THE COST HERE TOO, UPDATE THE WALLET BALANCE AFTER PURCHASE//
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                using (cmd = new SqlCommand("Select codestatus from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", email);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            string codestatus = dr.GetValue(0).ToString();
                            if (codestatus == "1")
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            partnername = dr.GetValue(0).ToString();
                                            
                                            //var uri1 = String.Format("https://blockchain.info/tobtc?currency=USD&value={0}", amountusd);

                                            //WebClient client1 = new WebClient();
                                            //client1.UseDefaultCredentials = true;
                                            //var data1 = client1.DownloadString(uri1);

                                            //amountbtc = Convert.ToDecimal(data1);
                                            //amountbtc = Math.Round(amountbtc, 0);

                                            using (TransactionScope scope = new TransactionScope())
                                            {
                                                dr.Dispose();
                                                using(cmd = new SqlCommand("Select tranid from cryptoatm where tranid=@tranid", con))
                                                { 
                                                    cmd.Parameters.AddWithValue("@tranid", tranid);
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read())
                                                        {
                                                            ResponseMsg = "This transaction has been previously submitted.";
                                                        }
                                                        else
                                                        {
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Insert into CryptoATM(email,name,bookname,bookurl,amountusd,amountbtc,date,investstart,investend,tranid,dd,mm,yy,receivedstatus,investmentstatus) values (@email,@name,@bookname,@bookurl,@amountusd,@amountbtc,@date,@investstart,@investend,@tranid,@dd,@mm,@yy,@receivedstatus,@investmentstatus)", con))
                                                            {//email,name,bookname,bookurl,amountusd,amountbtc,date,investstart,investend,tranid,dd,mm,yy,sentstatus
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                cmd.Parameters.AddWithValue("@amountusd", amountusd);
                                                                cmd.Parameters.AddWithValue("@amountbtc", amountbtc);
                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                cmd.Parameters.AddWithValue("@investstart", 0);
                                                                cmd.Parameters.AddWithValue("@investend", 0);
                                                                cmd.Parameters.AddWithValue("@tranid", tranid);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@receivedstatus", 0);
                                                                cmd.Parameters.AddWithValue("@investmentstatus", 0);
                                                                cmd.ExecuteNonQuery();

                                                                ResponseMsg = "Your request is been processed.";
                                                            }
                                                        }
                                                    }


                                                    //Send Emails
                                                    dr.Dispose();
                                                    using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                    {
                                                        cmd.Parameters.AddWithValue("@bookname", bookname);
                                                        using (dr = cmd.ExecuteReader())
                                                        {
                                                            if (dr.Read())
                                                            {
                                                                string getlink = dr.GetValue(0).ToString();

                                                                //Send Email
                                                                //create the mail message
                                                                MailMessage mail = new MailMessage();
                                                                //set the FROM address
                                                                mail.From = new MailAddress("cryptoatm@WinningLife.com");
                                                                //set the RECIPIENTS
                                                                mail.To.Add(email);
                                                                //Add Attachments
                                                                //if (FileUploadMustard1.HasFile)
                                                                //{
                                                                //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                //}
                                                                //enter a SUBJECT
                                                                mail.Subject = "Your CryptoATM purchase from WinningLife";
                                                                //Enter the message BODY
                                                                mail.Body = "From WinningLife:" + " You have just submitted a request to purchase an Investment Slot in CryptoATM worth '" + amountbtc + "BTC'. Make the exact transfer to our Luno wallet address and your Investment setup will be set up within 24hours after deposit is confirmed. - WinningLife Team";
                                                                //set the mail server (default should be smtp.1and1.com)
                                                                SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                //Enter your full e-mail address and password
                                                                smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                //try
                                                                //{
                                                                //    //send the message 
                                                                //    smtp.Send(mail);

                                                                //    dr.Dispose();
                                                                //    using (cmd = new SqlCommand("Update cryptoatm set sentstatus=@sendstatus where tranid=@tranid", con))
                                                                //    {
                                                                //        cmd.Parameters.AddWithValue("@assignedsn", tranid);
                                                                //        cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                //        cmd.ExecuteNonQuery();
                                                                //    }
                                                                //}
                                                                //catch (Exception)
                                                                //{
                                                                //    //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                //}
                                                                ResponseMsg = "Your request is been processed.";
                                                            }
                                                        }
                                                    }
                                                    scope.Complete();
                                                }
                                            }
                                        }
                                    }
                                }
                                //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                string GetRefCode;
                                decimal commissionusd = Math.Round((amountusd * 5) / 100, 4); //5% for every referral
                                using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            GetRefCode = dr.GetValue(0).ToString();
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select sbacode from sbalink where sbacode=@code", con))
                                            {
                                                cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read())
                                                    {
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                        {//code,status,amount,useremail,program
                                                            //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                            cmd.Parameters.AddWithValue("@position", "BA");
                                                            cmd.Parameters.AddWithValue("@amount", commissionusd);
                                                            cmd.Parameters.AddWithValue("@useremail", email);
                                                            cmd.Parameters.AddWithValue("@program", "CryptoATM");
                                                            cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                            cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                            cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                            cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                            cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                            cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                            cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                            cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                            cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                            cmd.ExecuteNonQuery();
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //dr.Dispose();
                                                        //using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                        //{
                                                        //    cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                        //    using (dr = cmd.ExecuteReader())
                                                        //    {
                                                        //        if (dr.Read())
                                                        //        {
                                                        //            string bacode = dr.GetValue(0).ToString();
                                                        //            string sbacode = dr.GetValue(1).ToString();

                                                        //            dr.Dispose();
                                                        //            //BA 40%
                                                        //            using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                        //            {//code,status,amount,useremail,program
                                                        //                cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                        //                cmd.Parameters.AddWithValue("@position", "BA");
                                                        //                cmd.Parameters.AddWithValue("@amount", commissionbtc);
                                                        //                cmd.Parameters.AddWithValue("@useremail", email);
                                                        //                cmd.Parameters.AddWithValue("@program", "CryptoATM");
                                                        //                cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                        //                cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                        //                cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                        //                cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                        //                cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                        //                cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                        //                cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                        //                cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                        //                cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                        //                cmd.ExecuteNonQuery();
                                                        //            }
                                                        //        }
                                                        //    }
                                                        //}
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                //Track all purchases in PurchaseTrack
                                using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                {//email,program,amount,dd,mm,yy
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@program", "CryptoATM");
                                    cmd.Parameters.AddWithValue("@amount", amountusd);
                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                    cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                    dr.Dispose();
                                    cmd.ExecuteNonQuery();
                                }

                            }
                            else
                            {
                                ResponseMsg = "Your Email has not been confirmed, go to profile and confirm your email.";
                            }
                        }
                    }
                }
            }
        }        

        //Classy Vacations
        public void ClassyVacations()
        {
            int getMaxSN = 0;
            using (con = new SqlConnection(conn))
            {
                con.Open();
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                //FIRST CHECK IF THE WALLET BALANCE IS ENOUGH AND DEDUCT THE COST HERE TOO, UPDATE THE WALLET BALANCE AFTER PURCHASE//
                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                using (cmd = new SqlCommand("Select codestatus from register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", email);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            string codestatus = dr.GetValue(0).ToString();
                            if (codestatus == "1")
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            int amount = int.Parse(dr.GetValue(0).ToString());
                                            if (amount > 60000)
                                            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from CVI1", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;

                                                            ParentSN = (AssignedSN - 1) / 4;

                                                            C1Pay1SN = (AssignedSN * 4) + 1;
                                                            C1Pay2SN = (C1Pay1SN * 4) - 11;
                                                            C1Pay3SN = (C1Pay1SN * 4) - 7;
                                                            C1Pay4SN = (C1Pay1SN * 4) - 3;
                                                            C1Pay5SN = (C1Pay1SN * 4) + 1;

                                                            C1Pay1Amt = 20000;
                                                            C1Pay2Amt = 10000;
                                                            C1Pay3Amt = 10000;
                                                            C1Pay4Amt = 10000;
                                                            C1Pay5Amt = 10000;

                                                            ///
                                                            // Cycle 2 Line 1
                                                            ///
                                                            C2Pay16SN = C1Pay5SN + (4 * 16);
                                                            C2Pay32SN = C2Pay16SN + (4 * 16);
                                                            C2Pay48SN = C2Pay16SN + (4 * 32);
                                                            C2Pay64SN = C2Pay16SN + (4 * 48);
                                                            C2Pay80SN = C2Pay16SN + (4 * 64);


                                                            C2Pay16Amt = 100000;
                                                            C2Pay32Amt = 100000;
                                                            C2Pay48Amt = 100000;
                                                            C2Pay64Amt = 100000;
                                                            C2Pay80Amt = 100000;
                                                            
                                                            
                                                           #region CommentedSection_MayReuse
		 //C2Pay1SN = C1Pay5SN + (4 * 1);
                                                            //C2Pay2SN = C1Pay5SN + (4 * 2);
                                                            //C2Pay3SN = C1Pay5SN + (4 * 3);
                                                            //C2Pay4SN = C1Pay5SN + (4 * 4);
                                                            //C2Pay5SN = C1Pay5SN + (4 * 5);
                                                            //C2Pay6SN = C1Pay5SN + (4 * 6);
                                                            //C2Pay7SN = C1Pay5SN + (4 * 7);
                                                            //C2Pay8SN = C1Pay5SN + (4 * 8);
                                                            //C2Pay9SN = C1Pay5SN + (4 * 9);
                                                            //C2Pay10SN = C1Pay5SN + (4 * 10);
                                                            //C2Pay11SN = C1Pay5SN + (4 * 11);
                                                            //C2Pay12SN = C1Pay5SN + (4 * 12);
                                                            //C2Pay13SN = C1Pay5SN + (4 * 13);
                                                            //C2Pay14SN = C1Pay5SN + (4 * 14);
                                                            //C2Pay15SN = C1Pay5SN + (4 * 15);
                                                            //C2Pay16SN = C1Pay5SN + (4 * 16);

                                                            //////
                                                            //C2Pay1Amt = 100000;
                                                            //C2Pay2Amt = 100000;
                                                            //C2Pay3Amt = 100000;
                                                            //C2Pay4Amt = 100000;
                                                            //C2Pay5Amt = 100000;
                                                            //C2Pay6Amt = 100000;
                                                            //C2Pay7Amt = 100000;
                                                            //C2Pay8Amt = 100000;
                                                            //C2Pay9Amt = 100000;
                                                            //C2Pay10Amt = 100000;
                                                            //C2Pay11Amt = 100000;
                                                            //C2Pay12Amt = 100000;
                                                            //C2Pay13Amt = 100000;
                                                            //C2Pay14Amt = 100000;
                                                            //C2Pay15Amt = 100000;
                                                            //C2Pay16Amt = 100000;
                                                            //////


                                                            ///
                                                            // Cycle 2 Line 2
                                                            ///
                                                            //C2Pay17SN = C2Pay16SN + (4 * 1);
                                                            //C2Pay18SN = C2Pay16SN + (4 * 2);
                                                            //C2Pay19SN = C2Pay16SN + (4 * 3);
                                                            //C2Pay20SN = C2Pay16SN + (4 * 4);
                                                            //C2Pay21SN = C2Pay16SN + (4 * 5);
                                                            //C2Pay22SN = C2Pay16SN + (4 * 6);
                                                            //C2Pay23SN = C2Pay16SN + (4 * 7);
                                                            //C2Pay24SN = C2Pay16SN + (4 * 8);
                                                            //C2Pay25SN = C2Pay16SN + (4 * 9);
                                                            //C2Pay26SN = C2Pay16SN + (4 * 10);
                                                            //C2Pay27SN = C2Pay16SN + (4 * 11);
                                                            //C2Pay28SN = C2Pay16SN + (4 * 12);
                                                            //C2Pay29SN = C2Pay16SN + (4 * 13);
                                                            //C2Pay30SN = C2Pay16SN + (4 * 14);
                                                            //C2Pay31SN = C2Pay16SN + (4 * 15);
                                                            //C2Pay32SN = C2Pay16SN + (4 * 16);
                                                            //C2Pay33SN = C2Pay16SN + (4 * 17);
                                                            //C2Pay34SN = C2Pay16SN + (4 * 18);
                                                            //C2Pay35SN = C2Pay16SN + (4 * 19);
                                                            //C2Pay36SN = C2Pay16SN + (4 * 20);
                                                            //C2Pay37SN = C2Pay16SN + (4 * 21);
                                                            //C2Pay38SN = C2Pay16SN + (4 * 22);
                                                            //C2Pay39SN = C2Pay16SN + (4 * 23);
                                                            //C2Pay40SN = C2Pay16SN + (4 * 24);
                                                            //C2Pay41SN = C2Pay16SN + (4 * 25);
                                                            //C2Pay42SN = C2Pay16SN + (4 * 26);
                                                            //C2Pay43SN = C2Pay16SN + (4 * 27);
                                                            //C2Pay44SN = C2Pay16SN + (4 * 28);
                                                            //C2Pay45SN = C2Pay16SN + (4 * 29);
                                                            //C2Pay46SN = C2Pay16SN + (4 * 30);
                                                            //C2Pay47SN = C2Pay16SN + (4 * 31);
                                                            //C2Pay48SN = C2Pay16SN + (4 * 32);
                                                            //C2Pay49SN = C2Pay16SN + (4 * 33);
                                                            //C2Pay50SN = C2Pay16SN + (4 * 34);
                                                            //C2Pay51SN = C2Pay16SN + (4 * 35);
                                                            //C2Pay52SN = C2Pay16SN + (4 * 36);
                                                            //C2Pay53SN = C2Pay16SN + (4 * 37);
                                                            //C2Pay54SN = C2Pay16SN + (4 * 38);
                                                            //C2Pay55SN = C2Pay16SN + (4 * 39);
                                                            //C2Pay56SN = C2Pay16SN + (4 * 40);
                                                            //C2Pay57SN = C2Pay16SN + (4 * 41);
                                                            //C2Pay58SN = C2Pay16SN + (4 * 42);
                                                            //C2Pay59SN = C2Pay16SN + (4 * 43);
                                                            //C2Pay60SN = C2Pay16SN + (4 * 44);
                                                            //C2Pay61SN = C2Pay16SN + (4 * 45);
                                                            //C2Pay62SN = C2Pay16SN + (4 * 46);
                                                            //C2Pay63SN = C2Pay16SN + (4 * 47);]
                                                            //C2Pay64SN = C2Pay16SN + (4 * 48);
                                                            //C2Pay65SN = C2Pay16SN + (4 * 49);
                                                            //C2Pay66SN = C2Pay16SN + (4 * 50);
                                                            //C2Pay67SN = C2Pay16SN + (4 * 51);
                                                            //C2Pay68SN = C2Pay16SN + (4 * 52);
                                                            //C2Pay69SN = C2Pay16SN + (4 * 53);
                                                            //C2Pay70SN = C2Pay16SN + (4 * 54);
                                                            //C2Pay71SN = C2Pay16SN + (4 * 55);
                                                            //C2Pay72SN = C2Pay16SN + (4 * 56);
                                                            //C2Pay73SN = C2Pay16SN + (4 * 57);
                                                            //C2Pay74SN = C2Pay16SN + (4 * 58);
                                                            //C2Pay75SN = C2Pay16SN + (4 * 59);
                                                            //C2Pay76SN = C2Pay16SN + (4 * 60);
                                                            //C2Pay77SN = C2Pay16SN + (4 * 61);
                                                            //C2Pay78SN = C2Pay16SN + (4 * 62);
                                                            //C2Pay79SN = C2Pay16SN + (4 * 63);
                                                            //C2Pay80SN = C2Pay16SN + (4 * 64);

                                                            //////

                                                            //C2Pay17Amt = 100000;
                                                            //C2Pay18Amt = 100000;
                                                            //C2Pay19Amt = 100000;
                                                            //C2Pay20Amt = 100000;
                                                            //C2Pay21Amt = 100000;
                                                            //C2Pay22Amt = 100000;
                                                            //C2Pay23Amt = 100000;
                                                            //C2Pay24Amt = 100000;
                                                            //C2Pay25Amt = 100000;
                                                            //C2Pay26Amt = 100000;
                                                            //C2Pay27Amt = 100000;
                                                            //C2Pay28Amt = 100000;
                                                            //C2Pay29Amt = 100000;
                                                            //C2Pay30Amt = 100000;
                                                            //C2Pay31Amt = 100000;
                                                            //C2Pay32Amt = 100000;
                                                            //C2Pay33Amt = 100000;
                                                            //C2Pay34Amt = 100000;
                                                            //C2Pay35Amt = 100000;
                                                            //C2Pay36Amt = 100000;
                                                            //C2Pay37Amt = 100000;
                                                            //C2Pay38Amt = 100000;
                                                            //C2Pay39Amt = 100000;
                                                            //C2Pay40Amt = 100000;
                                                            //C2Pay41Amt = 100000;
                                                            //C2Pay42Amt = 100000;
                                                            //C2Pay43Amt = 100000;
                                                            //C2Pay44Amt = 100000;
                                                            //C2Pay45Amt = 100000;
                                                            //C2Pay46Amt = 100000;
                                                            //C2Pay47Amt = 100000;
                                                            //C2Pay48Amt = 100000;
                                                            //C2Pay49Amt = 100000;
                                                            //C2Pay50Amt = 100000;
                                                            //C2Pay51Amt = 100000;
                                                            //C2Pay52Amt = 100000;
                                                            //C2Pay53Amt = 100000;
                                                            //C2Pay54Amt = 100000;
                                                            //C2Pay55Amt = 100000;
                                                            //C2Pay56Amt = 100000;
                                                            //C2Pay57Amt = 100000;
                                                            //C2Pay58Amt = 100000;
                                                            //C2Pay59Amt = 100000;
                                                            //C2Pay60Amt = 100000;
                                                            //C2Pay61Amt = 100000;
                                                            //C2Pay62Amt = 100000;
                                                            //C2Pay63Amt = 100000;
                                                            //C2Pay64Amt = 100000;
                                                            //C2Pay65Amt = 100000;
                                                            //C2Pay66Amt = 100000;
                                                            //C2Pay67Amt = 100000;
                                                            //C2Pay68Amt = 100000;
                                                            //C2Pay69Amt = 100000;
                                                            //C2Pay70Amt = 100000;
                                                            //C2Pay71Amt = 100000;
                                                            //C2Pay72Amt = 100000;
                                                            //C2Pay73Amt = 100000;
                                                            //C2Pay74Amt = 100000;
                                                            //C2Pay75Amt = 100000;
                                                            //C2Pay76Amt = 100000;
                                                            //C2Pay77Amt = 100000;
                                                            //C2Pay78Amt = 100000;
                                                            //C2Pay79Amt = 100000;
                                                            //C2Pay80Amt = 100000;
                                                            ////// 
	#endregion
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            ParentSN = (AssignedSN - 1) / 4;

                                                            C1Pay1SN = (AssignedSN * 4) + 1;
                                                            C1Pay2SN = (C1Pay1SN * 4) - 11;
                                                            C1Pay3SN = (C1Pay1SN * 4) - 7;
                                                            C1Pay4SN = (C1Pay1SN * 4) - 3;
                                                            C1Pay5SN = (C1Pay1SN * 4) + 1;

                                                            C1Pay1Amt = 20000;
                                                            C1Pay2Amt = 10000;
                                                            C1Pay3Amt = 10000;
                                                            C1Pay4Amt = 10000;
                                                            C1Pay5Amt = 10000;

                                                            ///
                                                            // Cycle 2 Line 1
                                                            ///
                                                            C2Pay16SN = C1Pay5SN + (4 * 16);
                                                            C2Pay32SN = C2Pay16SN + (4 * 16);
                                                            C2Pay48SN = C2Pay16SN + (4 * 32);
                                                            C2Pay64SN = C2Pay16SN + (4 * 48);
                                                            C2Pay80SN = C2Pay16SN + (4 * 64);


                                                            C2Pay16Amt = 100000;
                                                            C2Pay32Amt = 100000;
                                                            C2Pay48Amt = 100000;
                                                            C2Pay64Amt = 100000;
                                                            C2Pay80Amt = 100000;
                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from cvi1 where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (TransactionScope scope = new TransactionScope())
                                                                        {
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (cmd = new SqlCommand("Insert into cvi1(email,name,date,assignedSN,c1Pay1SN,c1Pay2SN,c1Pay3SN,c1Pay4SN,c1Pay5SN,c2Pay16SN,c2Pay32SN,c2Pay48SN,c2Pay64SN,c2Pay80SN,c1Pay1Amt,c1Pay2Amt,c1Pay3Amt,c1Pay4Amt,c1Pay5Amt,c2Pay16Amt,c2Pay32Amt,c2Pay48Amt,c2Pay64Amt,c2Pay80Amt,ParentSN,EndSN) values (@email,@name,@date,@assignedSN,@c1Pay1SN,@c1Pay2SN,@c1Pay3SN,@c1Pay4SN,@c1Pay5SN,@c2Pay16SN,@c2Pay32SN,@c2Pay48SN,@c2Pay64SN,@c2Pay80SN,@c1Pay1Amt,@c1Pay2Amt,@c1Pay3Amt,@c1Pay4Amt,@c1Pay5Amt,@c2Pay16Amt,@c2Pay32Amt,@c2Pay48Amt,@c2Pay64Amt,@c2Pay80Amt,@parentSN,@endSN)", con))
                                                                                        {//email,name,date,assignedSN,c1Pay1SN,c1Pay2SN,c1Pay3SN,c1Pay4SN,c1Pay5SN,c2Pay1SN,c2Pay2SN,c2Pay3SN,c2Pay4SN,c2Pay5SN,c2Pay6SN,c2Pay7SN,c2Pay8SN,c2Pay9SN,c2Pay10SN,c2Pay11SN,c2Pay12SN,c2Pay13SN,c2Pay14SN,c2Pay15SN,c2Pay16SN,c2Pay17SN,c2Pay18SN,c2Pay19SN,c2Pay20SN,c2Pay21SN,c2Pay22SN,c2Pay23SN,c2Pay24SN,c2Pay25SN,c2Pay26SN,c2Pay27SN,c2Pay28SN,c2Pay29SN,c2Pay30SN,c2Pay31SN,c2Pay32SN,c2Pay33SN,c2Pay34SN,c2Pay35SN,c2Pay36SN,c2Pay37SN,c2Pay38SN,c2Pay39SN,c2Pay40SN,c2Pay41SN,c2Pay42SN,c2Pay43SN,c2Pay44SN,c2Pay45SN,c2Pay46SN,c2Pay47SN,c2Pay48SN,c2Pay49SN,c2Pay50SN,c2Pay51SN,c2Pay52SN,c2Pay53SN,c2Pay54SN,c2Pay55SN,c2Pay56SN,c2Pay57SN,c2Pay58SN,c2Pay59SN,c2Pay60SN,c2Pay61SN,c2Pay62SN,c2Pay63SN,c2Pay64SN,c2Pay65SN,c2Pay66SN,c2Pay67SN,c2Pay68SN,c2Pay69SN,c2Pay70SN,c2Pay71SN,c2Pay72SN,c2Pay73SN,c2Pay74SN,c2Pay75SN,c2Pay76SN,c2Pay77SN,c2Pay78SN,c2Pay79SN,c2Pay80SN,c1Pay1Amt,c1Pay2Amt,c1Pay3Amt,c1Pay4Amt,c1Pay5Amt,c2Pay1Amt,c2Pay2Amt,c2Pay3Amt,c2Pay4Amt,c2Pay5Amt,c2Pay6Amt,c2Pay7Amt,c2Pay8Amt,c2Pay9Amt,c2Pay10Amt,c2Pay11Amt,c2Pay12Amt,c2Pay13Amt,c2Pay14Amt,c2Pay15Amt,c2Pay16Amt,c2Pay17Amt,c2Pay18Amt,c2Pay19Amt,c2Pay20Amt,c2Pay21Amt,c2Pay22Amt,c2Pay23Amt,c2Pay24Amt,c2Pay25Amt,c2Pay26Amt,c2Pay27Amt,c2Pay28Amt,c2Pay29Amt,c2Pay30Amt,c2Pay31Amt,c2Pay32Amt,c2Pay33Amt,c2Pay34Amt,c2Pay35Amt,c2Pay36Amt,c2Pay37Amt,c2Pay38Amt,c2Pay39Amt,c2Pay40Amt,c2Pay41Amt,c2Pay42Amt,c2Pay43Amt,c2Pay44Amt,c2Pay45Amt,c2Pay46Amt,c2Pay47Amt,c2Pay48Amt,c2Pay49Amt,c2Pay50Amt,c2Pay51Amt,c2Pay52Amt,c2Pay53Amt,c2Pay54Amt,c2Pay55Amt,c2Pay56Amt,c2Pay57Amt,c2Pay58Amt,c2Pay59Amt,c2Pay60Amt,c2Pay61Amt,c2Pay62Amt,c2Pay63Amt,c2Pay64Amt,c2Pay65Amt,c2Pay66Amt,c2Pay67Amt,c2Pay68Amt,c2Pay69Amt,c2Pay70Amt,c2Pay71Amt,c2Pay72Amt,c2Pay73Amt,c2Pay74Amt,c2Pay75Amt,c2Pay76Amt,c2Pay77Amt,c2Pay78Amt,c2Pay79Amt,c2Pay80Amt,parentSN,endSN
                                                                                            //email,
                                                                                            //name,
                                                                                            //date,
                                                                                            //assignedSN,
                                                                                            //c1Pay1SN,
                                                                                            //c1Pay2SN,
                                                                                            //c1Pay3SN,
                                                                                            //c1Pay4SN,
                                                                                            //c1Pay5SN,
                                                                                            //c2Pay1SN,
                                                                                            //c2Pay2SN,
                                                                                            //c2Pay3SN,
                                                                                            //c2Pay4SN,
                                                                                            //c2Pay5SN,
                                                                                            //c2Pay6SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay7SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay8SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay9SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay10SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay11SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay12SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay13SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay14SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay15SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay16SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay17SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay18SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay19SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay20SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay21SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay22SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay23SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay24SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay25SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay26SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay27SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay28SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay29SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay30SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay31SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay32SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay33SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay34SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay35SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay36SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay37SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay38SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay39SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay40SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay41SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay42SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay43SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay44SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay45SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay46SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay47SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay48SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay49SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay50SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay51SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay52SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay53SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay54SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay55SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay56SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay57SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay58SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay59SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay60SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay61SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay62SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay63SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay64SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay65SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay66SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay67SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay68SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay69SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay70SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay71SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay72SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay73SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay74SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay75SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay76SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay77SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay78SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay79SN,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay80SN,
                                                                                            //cmd.Parameters.AddWithValue("@c1Pay1Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c1Pay2Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c1Pay3Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c1Pay4Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c1Pay5Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay1Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay2Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay3Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay4Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay5Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay6Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay7Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay8Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay9Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay10Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay11Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay12Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay13Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay14Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay15Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay16Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay17Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay18Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay19Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay20Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay21Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay22Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay23Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay24Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay25Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay26Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay27Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay28Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay29Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay30Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay31Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay32Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay33Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay34Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay35Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay36Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay37Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay38Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay39Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay40Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay41Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay42Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay43Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay44Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay45Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay46Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay47Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay48Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay49Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay50Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay51Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay52Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay53Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay54Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay55Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay56Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay57Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay58Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay59Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay60Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay61Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay62Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay63Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay64Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay65Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay66Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay67Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay68Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay69Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay70Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay71Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay72Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay73Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay74Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay75Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay76Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay77Amt,
                                                                                            //cmd.Parameters.AddWithValue("@c2Pay78Amt,
                                                                                            cmd.Parameters.AddWithValue("@c2Pay79Amt", "");
                                                                                            cmd.Parameters.AddWithValue("@c2Pay80Amt", "");
                                                                                            cmd.Parameters.AddWithValue("@parentSN", "");
                                                                                            cmd.Parameters.AddWithValue("@endSN","" );
                                                                                         
                                                                                            
                                                                                            
                                                                                            
                                                                                            
                                                                                            
                                                                                            
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();

                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update mustard set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }


                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 10000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of MustardFund Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                            scope.Complete();
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (TransactionScope scope = new TransactionScope())
                                                                                        {
                                                                                            using (cmd = new SqlCommand("Insert into mustard(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                            {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                cmd.Parameters.AddWithValue("@name", partnername);
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                                cmd.Parameters.AddWithValue("@cost", cost);
                                                                                                cmd.Parameters.AddWithValue("@qty", qty);
                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                                cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                                cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                                dr.Dispose();
                                                                                                cmd.ExecuteNonQuery();


                                                                                                //Send Emails
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            string getlink = dr.GetValue(0).ToString();

                                                                                                            //Send Email
                                                                                                            //create the mail message
                                                                                                            MailMessage mail = new MailMessage();
                                                                                                            //set the FROM address
                                                                                                            mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                            //set the RECIPIENTS
                                                                                                            mail.To.Add(email);
                                                                                                            //Add Attachments
                                                                                                            //if (FileUploadMustard1.HasFile)
                                                                                                            //{
                                                                                                            //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                            //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                            //}
                                                                                                            //enter a SUBJECT
                                                                                                            mail.Subject = "Your E-Book from WinningLife";
                                                                                                            //Enter the message BODY
                                                                                                            mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                            //set the mail server (default should be smtp.1and1.com)
                                                                                                            SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                            //Enter your full e-mail address and password
                                                                                                            smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                            try
                                                                                                            {
                                                                                                                //send the message 
                                                                                                                smtp.Send(mail);

                                                                                                                dr.Dispose();
                                                                                                                using (cmd = new SqlCommand("Update mustard set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                    cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                    cmd.ExecuteNonQuery();
                                                                                                                }
                                                                                                            }
                                                                                                            catch (Exception)
                                                                                                            {
                                                                                                                //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }


                                                                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@email", email);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                            int newAmount = getPreviousAmount - 10000;
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }

                                                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                                cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of MustardFund Product by '" + email + "'");
                                                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            scope.Complete();
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 500;
                                                            int commissionSBAamount60 = 300;
                                                            int commissionBAamount40 = 200;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                cmd.Parameters.AddWithValue("@amount", 10000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1

                                                            using (cmd = new SqlCommand("Select email from Mustard where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 0);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            //////////////////////////////////////////////////////////////////////
                                                            ////////////////////////////CONTINUE WITH THIS LATER/////////////////
                                                            ////////////////////////////////////////////////////////////////////
                                                            //using (cmd = new SqlCommand("Select auto from autopurchase where email=@email", con))
                                                            //{
                                                            //    cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                            //    using(dr = cmd.ExecuteReader())
                                                            //    {
                                                            //        if(dr.Read())
                                                            //        {
                                                            //            string getstate = dr.GetValue(0).ToString();
                                                            //            if(getstate == "Enabled")
                                                            //            {

                                                            //            }
                                                            //            //else if(getstate ==)
                                                            //        }
                                                            //    }
                                                            //}
                                                            /////////////////////////////////////
                                                            /////////////////////////////////////
                                                            dr.Dispose();
                                                            using (cmd = new SqlCommand("Select email from Mustard where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 20000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 15000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 5000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 10000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else if (amount == 60000)
                                            {

                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select Max(SN) from Mustard", con))
                                                {
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = int.Parse(dr.GetValue(0).ToString());
                                                            AssignedSN = getMaxSN + 1;
                                                            ParentSN = (AssignedSN - 1) / 4;
                                                           
                                                        }
                                                        else
                                                        {
                                                            //Since Mustard is 2 X 2  //NB: 3 X 3 calculation is different
                                                            getMaxSN = 0;
                                                            AssignedSN = getMaxSN + 1;
                                                            ParentSN = 0;

                                                        }

                                                        string getEmail;
                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select email from mustard where sn=@sn", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@sn", getMaxSN);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    getEmail = dr.GetValue(0).ToString();
                                                                    if (getEmail == email)
                                                                    {
                                                                        ResponseMsg = "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.";
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    partnername = dr.GetValue(0).ToString();

                                                                                    using (cmd = new SqlCommand("Insert into mustard(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                    {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                        cmd.Parameters.AddWithValue("@email", email);
                                                                                        cmd.Parameters.AddWithValue("@name", partnername);
                                                                                        cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                        cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                        cmd.Parameters.AddWithValue("@cost", cost);
                                                                                        cmd.Parameters.AddWithValue("@qty", qty);
                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                        cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                        cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                        cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                        dr.Dispose();
                                                                                        cmd.ExecuteNonQuery();

                                                                                        //Send Emails
                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read())
                                                                                                {
                                                                                                    string getlink = dr.GetValue(0).ToString();

                                                                                                    //Send Email
                                                                                                    //create the mail message
                                                                                                    MailMessage mail = new MailMessage();
                                                                                                    //set the FROM address
                                                                                                    mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                    //set the RECIPIENTS
                                                                                                    mail.To.Add(email);
                                                                                                    //Add Attachments
                                                                                                    //if (FileUploadMustard1.HasFile)
                                                                                                    //{
                                                                                                    //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                    //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                    //}
                                                                                                    //enter a SUBJECT
                                                                                                    mail.Subject = "Your E-Book from WinningLife";
                                                                                                    //Enter the message BODY
                                                                                                    mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                    //set the mail server (default should be smtp.1and1.com)
                                                                                                    SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                    //Enter your full e-mail address and password
                                                                                                    smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                    try
                                                                                                    {
                                                                                                        //send the message 
                                                                                                        smtp.Send(mail);

                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update mustard set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                            cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                    catch (Exception)
                                                                                                    {
                                                                                                        //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }

                                                                                        using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            using (dr = cmd.ExecuteReader())
                                                                                            {
                                                                                                if (dr.Read())
                                                                                                {
                                                                                                    int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                    int newAmount = getPreviousAmount - 10000;
                                                                                                    dr.Dispose();
                                                                                                    using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                    {
                                                                                                        cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                        cmd.Parameters.AddWithValue("@email", email);
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }

                                                                                                    using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                    {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                        cmd.Parameters.AddWithValue("@email", email);
                                                                                                        cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                        cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                        cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                        cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                        cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of MustardFund Product by '" + email + "'");
                                                                                                        cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                        cmd.ExecuteNonQuery();
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                                    {
                                                                        if (getMaxSN == 1 || getMaxSN == 0)
                                                                        {
                                                                            dr.Dispose();
                                                                            using (cmd = new SqlCommand("Select partnername from register where email=@email", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                using (dr = cmd.ExecuteReader())
                                                                                {
                                                                                    if (dr.Read())
                                                                                    {
                                                                                        partnername = dr.GetValue(0).ToString();

                                                                                        using (cmd = new SqlCommand("Insert into mustard(email,name,bookname,bookurl,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy,sentstatus) values (@email,@name,@bookname,@bookurl,@cost,@qty,@date,@assignedsn,@pay1sn,@pay2sn,@parentsn,@dd,@mm,@yy,@sentstatus)", con))
                                                                                        {//email,name,cost,qty,date,assignedsn,pay1sn,pay2sn,parentsn,dd,mm,yy
                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                            cmd.Parameters.AddWithValue("@name", partnername);
                                                                                            cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                            cmd.Parameters.AddWithValue("@bookurl", bookurl);
                                                                                            cmd.Parameters.AddWithValue("@cost", cost);
                                                                                            cmd.Parameters.AddWithValue("@qty", qty);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                            cmd.Parameters.AddWithValue("@pay1sn", Pay1SN);
                                                                                            cmd.Parameters.AddWithValue("@pay2sn", Pay2SN);
                                                                                            cmd.Parameters.AddWithValue("@parentsn", ParentSN);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@sentstatus", 0);
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();


                                                                                            //Send Emails
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select link from booklinks where book=@bookname", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@bookname", bookname);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        string getlink = dr.GetValue(0).ToString();

                                                                                                        //Send Email
                                                                                                        //create the mail message
                                                                                                        MailMessage mail = new MailMessage();
                                                                                                        //set the FROM address
                                                                                                        mail.From = new MailAddress("purchase@WinningLife.com");
                                                                                                        //set the RECIPIENTS
                                                                                                        mail.To.Add(email);
                                                                                                        //Add Attachments
                                                                                                        //if (FileUploadMustard1.HasFile)
                                                                                                        //{
                                                                                                        //    string FileName = System.IO.Path.GetFileName(FileUploadMustard1.PostedFile.FileName);
                                                                                                        //    mail.Attachments.Add(new Attachment(FileUploadMustard1.PostedFile.InputStream, FileName));
                                                                                                        //}
                                                                                                        //enter a SUBJECT
                                                                                                        mail.Subject = "Your E-Book from WinningLife";
                                                                                                        //Enter the message BODY
                                                                                                        mail.Body = "From WinningLife:" + " You have just received attached here a copy of the E-Book " + bookname + " recently purchased on MustardFund. Kindly download the book by clicking this link - " + getlink + ". Happy reading! - CM Team";
                                                                                                        //set the mail server (default should be smtp.1and1.com)
                                                                                                        SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                                                                                        //Enter your full e-mail address and password
                                                                                                        smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");

                                                                                                        try
                                                                                                        {
                                                                                                            //send the message 
                                                                                                            smtp.Send(mail);

                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Update mustard set sentstatus=@sendstatus where assignedsn=@assignedsn", con))
                                                                                                            {
                                                                                                                cmd.Parameters.AddWithValue("@assignedsn", AssignedSN);
                                                                                                                cmd.Parameters.AddWithValue("@sendstatus", "1");
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                            }
                                                                                                        }
                                                                                                        catch (Exception)
                                                                                                        {
                                                                                                            //Response.Write("<script>Alert('Number of emails sent: " + i + "')</script>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }


                                                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                {
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                                                        int newAmount = getPreviousAmount - 10000;
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }

                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date)", con))
                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                            cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                            cmd.Parameters.AddWithValue("@purpose", "Purchase of 1 qty of MustardFund Product by '" + email + "'");
                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                            cmd.ExecuteNonQuery();
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (ResponseMsg != "CMAIS detected an invalid operation. Try again later to avoid an auto-block on your CM Account.")
                                                        {
                                                            //Save BA & SBA Commissions (Strictly for MUSTARDFUND) // Change this for others as suits each package
                                                            string GetRefCode;
                                                            int commissionBAamount = 500;
                                                            int commissionSBAamount60 = 300;
                                                            int commissionBAamount40 = 200;
                                                            using (cmd = new SqlCommand("Select ref from register where email=@email", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        GetRefCode = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Select code from balink where code=@code", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                    {//code,status,amount,useremail,program
                                                                                        //datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy
                                                                                        cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                        cmd.Parameters.AddWithValue("@position", "BA");
                                                                                        cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                        cmd.Parameters.AddWithValue("@useremail", email);
                                                                                        cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                        cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                        cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                        cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                        cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                        cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                        cmd.ExecuteNonQuery();
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    dr.Dispose();
                                                                                    using (cmd = new SqlCommand("Select bacode,sbacode from sbalink where sbacode=@sbacode", con))
                                                                                    {
                                                                                        cmd.Parameters.AddWithValue("@sbacode", GetRefCode);
                                                                                        using (dr = cmd.ExecuteReader())
                                                                                        {
                                                                                            if (dr.Read())
                                                                                            {
                                                                                                string bacode = dr.GetValue(0).ToString();
                                                                                                string sbacode = dr.GetValue(1).ToString();

                                                                                                dr.Dispose();
                                                                                                //BA 40%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "BA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount40);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }

                                                                                                //SBA 60%
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "SBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionSBAamount60);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }//Add an else statement for your own referrers
                                                                                            else
                                                                                            {
                                                                                                //SPecial BA
                                                                                                using (cmd = new SqlCommand("Insert into commissions(code,position,amount,useremail,program,status,datecreated,datecreateddd,datecreatedmm,datecreatedyy,datepaid,datepaiddd,datepaidmm,datepaidyy) values (@code,@position,@amount,@useremail,@program,@status,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@datepaid,@datepaiddd,@datepaidmm,@datepaidyy)", con))
                                                                                                {//code,status,amount,useremail,program
                                                                                                    cmd.Parameters.AddWithValue("@code", GetRefCode);
                                                                                                    cmd.Parameters.AddWithValue("@position", "CBA");
                                                                                                    cmd.Parameters.AddWithValue("@amount", commissionBAamount);
                                                                                                    cmd.Parameters.AddWithValue("@useremail", email);
                                                                                                    cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                                                    cmd.Parameters.AddWithValue("@status", "Not Paid");
                                                                                                    cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                    cmd.Parameters.AddWithValue("@datepaid", DateTime.Now.ToShortDateString());
                                                                                                    cmd.Parameters.AddWithValue("@datepaiddd", DateTime.Now.Day);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidmm", DateTime.Now.Month);
                                                                                                    cmd.Parameters.AddWithValue("@datepaidyy", DateTime.Now.Year);
                                                                                                    dr.Dispose();
                                                                                                    cmd.ExecuteNonQuery();
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Track all purchases in PurchaseTrack
                                                            using (cmd = new SqlCommand("Insert into purchasetracker(email,program,amount,dd,mm,yy,purchasedate) values (@email,@program,@amount,@dd,@mm,@yy,@purchasedate)", con))
                                                            {//email,program,amount,dd,mm,yy
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                cmd.Parameters.AddWithValue("@amount", 10000);
                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                cmd.Parameters.AddWithValue("@purchasedate", DateTime.Now.ToShortDateString());
                                                                dr.Dispose();
                                                                cmd.ExecuteNonQuery();
                                                            }

                                                            //Compute the Bonus Payments - Stage 1
                                                            using (cmd = new SqlCommand("Select email from Mustard where pay1sn=@pay1sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay1sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 1");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 5000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 0);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //Compute the Bonus Payments - Stage 2
                                                            using (cmd = new SqlCommand("Select email from Mustard where pay2sn=@pay2sn", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@pay2sn", AssignedSN);
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        string getEmailBonus = dr.GetValue(0).ToString();
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into earnings(email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date) values (@email,@program,@paydesc,@amtdue,@amtwithdrawable,@amtrecycled,@balance,@dd,@mm,@yy,@date)", con))
                                                                        {//email,program,paydesc,amtdue,amtwithdrawable,amtrecycled,balance,dd,mm,yy,date
                                                                            cmd.Parameters.AddWithValue("@email", getEmailBonus);
                                                                            cmd.Parameters.AddWithValue("@program", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@paydesc", "Stage 2");
                                                                            cmd.Parameters.AddWithValue("@amtdue", 20000);
                                                                            cmd.Parameters.AddWithValue("@amtwithdrawable", 15000);
                                                                            cmd.Parameters.AddWithValue("@amtrecycled", 0);
                                                                            cmd.Parameters.AddWithValue("@balance", 5000);
                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                            cmd.Parameters.AddWithValue("date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //waiting Tbl - No left to meet the just purchased placement target.
                                                            //Do the calculations first
                                                            int waitingSN = Pay2SN - AssignedSN;
                                                            int waitingAmt = waitingSN * 10000;
                                                            using (cmd = new SqlCommand("Select NoLeft from waitingtbl where package=@package", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Update waitingtbl set noleft=@noleft,amtrequired=@amtrequired where package=@package", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (cmd = new SqlCommand("Insert into waitingtbl(package,noleft,amtrequired,date) values (@package,@noleft,@amtrequired,@date)", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@package", "MustardFund");
                                                                            cmd.Parameters.AddWithValue("@noleft", waitingSN);
                                                                            cmd.Parameters.AddWithValue("@amtrequired", waitingAmt);
                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                            dr.Dispose();
                                                                            cmd.ExecuteNonQuery();
                                                                            ResponseMsg = "Successful Placement! Your download will be emailed to you in a few hours. Ensure your email has been confirmed to receive this E-Book !";
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }///// CLose up here
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                ResponseMsg = "Insufficient Wallet Balance for this transaction.";
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Your Email has not been confirmed, go to profile and confirm your email.";
                            }
                        }
                    }
                }
            }
        }
        
        public void ProgramTracker()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select program from programtracker where program=@program", con))
                {
                    cmd.Parameters.AddWithValue("@program", GetProgram);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            ResponseMsg = "This program has been previously set up.";
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Insert into programtracker(program,ngn,usd) values (@program,@ngn,@usd)", con))
                            {
                                cmd.Parameters.AddWithValue("@program", GetProgram);
                                cmd.Parameters.AddWithValue("@ngn", GetNGN);
                                cmd.Parameters.AddWithValue("@usd", GetUSD);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Success!";
                            }
                        }
                    }
                }
            }
        }
        
        //10
        public void TransferFunds()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select userid from register where userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        //cmd.Parameters.AddWithValue("@email", email);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", SessionUserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    dr.Dispose();
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            WalletAmount = int.Parse(dr.GetValue(0).ToString());

                                            if (WalletAmount >= TransferAmount)
                                            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select email from register where userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read())
                                                        {
                                                            email = dr.GetValue(0).ToString();
                                                            using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                                            {
                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                dr.Dispose();
                                                                using (dr = cmd.ExecuteReader())
                                                                {
                                                                    if (dr.Read())
                                                                    {
                                                                        int getPreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                                        int newReceiveramount = getPreviousAmount + TransferAmount;
                                                                        dr.Dispose();
                                                                        using (TransactionScope scope = new TransactionScope())
                                                                        {
                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                cmd.Parameters.AddWithValue("@amount", newReceiveramount);
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                cmd.ExecuteNonQuery();
                                                                            }

                                                                            int newGiverAmount = WalletAmount - TransferAmount;
                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", SessionUserId);
                                                                                cmd.Parameters.AddWithValue("@amount", newGiverAmount);
                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                cmd.ExecuteNonQuery();
                                                                            }

                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                cmd.Parameters.AddWithValue("@previoustotal", getPreviousAmount);
                                                                                cmd.Parameters.AddWithValue("@currenttotal", newReceiveramount);
                                                                                cmd.Parameters.AddWithValue("@purpose", "Confirmation of receipt of '" + TransferAmount + "' from '" + SessionUserId + "-" + SessionEmail + "' to " + UserId + " - " + email + "");
                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                cmd.ExecuteNonQuery();
                                                                            }

                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                cmd.Parameters.AddWithValue("@previoustotal", WalletAmount);
                                                                                cmd.Parameters.AddWithValue("@currenttotal", newGiverAmount);
                                                                                cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' by '" + SessionUserId + "-" + SessionEmail + "' to '" + UserId + "'-" + email + ".");
                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                cmd.Parameters.AddWithValue("@userid", SessionUserId);
                                                                                cmd.ExecuteNonQuery();
                                                                                ResponseMsg = "Success!";
                                                                            }
                                                                            scope.Complete();
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        dr.Dispose();
                                                                        using (TransactionScope scope = new TransactionScope())
                                                                        {
                                                                            using (cmd = new SqlCommand("Insert into Wallet(email,amount,userid) values (@email,@amount,@userid)", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                cmd.Parameters.AddWithValue("@amount", TransferAmount);
                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                cmd.ExecuteNonQuery();
                                                                                ResponseMsg = "Success!";
                                                                            }

                                                                            int newGiverAmount = WalletAmount - TransferAmount;
                                                                            using (cmd = new SqlCommand("Update wallet set amount=@amount where email=@email and userid=@userid", con))
                                                                            {
                                                                                cmd.Parameters.AddWithValue("@userid", SessionUserId);
                                                                                cmd.Parameters.AddWithValue("@amount", newGiverAmount);
                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                cmd.ExecuteNonQuery();
                                                                            }

                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                cmd.Parameters.AddWithValue("@email", email);
                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                cmd.Parameters.AddWithValue("@previoustotal", 0);
                                                                                cmd.Parameters.AddWithValue("@currenttotal", TransferAmount);
                                                                                cmd.Parameters.AddWithValue("@purpose", "Confirmation of receipt of '" + TransferAmount + "' from '" + SessionUserId + "-" + SessionEmail + "' to " + UserId + " - " + email + "");
                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                cmd.ExecuteNonQuery();
                                                                            }

                                                                            using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                            {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                cmd.Parameters.AddWithValue("@addamount", TransferAmount);
                                                                                cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                cmd.Parameters.AddWithValue("@previoustotal", WalletAmount);
                                                                                cmd.Parameters.AddWithValue("@currenttotal", newGiverAmount);
                                                                                cmd.Parameters.AddWithValue("@purpose", "Confirmation of transfer deposit of '" + TransferAmount + "' by '" + SessionUserId + "-" + SessionEmail + "' to '" + UserId + "'-" + email + ".");
                                                                                cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                cmd.Parameters.AddWithValue("@userid", SessionUserId);
                                                                                cmd.ExecuteNonQuery();
                                                                                ResponseMsg = "Success!";
                                                                            }
                                                                            scope.Complete();
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                ResponseMsg = "Insufficient balance for this transfer!";
                                            }

                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "Invalid Recipient Account";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }
        
        //11 - COme back her to edit right
        public void LoadDashboard()
        {
            //try
            //{
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    //Load Latest Earnings
                    using (cmd = new SqlCommand("Select Max(SN) from earnings where userid=@userid and status=@status", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@status", "Pending");
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                int getSN = int.Parse(dr.GetValue(0).ToString());
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select rank,username,amountdue,status,date from earnings where sn=@sn", con))
                                {
                                    cmd.Parameters.AddWithValue("@sn", getSN);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            EarningsRank = dr.GetValue(0).ToString();
                                            EarningsName = dr.GetValue(1).ToString();
                                            EarningsAmount = dr.GetValue(2).ToString();
                                            EarningsStatus = dr.GetValue(3).ToString();
                                            EarningsDate = dr.GetValue(4).ToString();

                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select gender from register where userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read() && !dr.IsDBNull(0))
                                                    {
                                                        EarningsGender = dr.GetValue(0).ToString();
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    //CM Member Name
                    using (cmd = new SqlCommand("Select partnername from register where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@email", getUsername);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                partnername = dr.GetValue(0).ToString();
                            }
                        }
                    }
                    //CM Member Since
                    using (cmd = new SqlCommand("Select mm,yy from register where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@email", getUsername);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                int month = int.Parse(dr.GetValue(0).ToString());
                                string MonthConvert = "";
                                if (month == 1)
                                {
                                    MonthConvert = "January";
                                }
                                else if (month == 2)
                                {
                                    MonthConvert = "February";
                                }
                                else if (month == 3)
                                {
                                    MonthConvert = "March";
                                }
                                else if (month == 4)
                                {
                                    MonthConvert = "April";
                                }
                                else if (month == 5)
                                {
                                    MonthConvert = "May";
                                }
                                else if (month == 6)
                                {
                                    MonthConvert = "June";
                                }
                                else if (month == 7)
                                {
                                    MonthConvert = "July";
                                }
                                else if (month == 8)
                                {
                                    MonthConvert = "August";
                                }
                                else if (month == 9)
                                {
                                    MonthConvert = "September";
                                }
                                else if (month == 10)
                                {
                                    MonthConvert = "October";
                                }
                                else if (month == 11)
                                {
                                    MonthConvert = "November";
                                }
                                else if (month == 12)
                                {
                                    MonthConvert = "December";
                                }
                                membersince = "CM member since " + MonthConvert + " " + dr.GetValue(1).ToString();
                            }
                        }
                    }
                    //Load Username
                    using (cmd = new SqlCommand("Select email from register where email=@email", con))
                    {
                        cmd.Parameters.AddWithValue("@email", getUsername);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                username = dr.GetValue(0).ToString();
                            }
                        }
                    }
                    //Load Total Earnings
                    using (cmd = new SqlCommand("Select SUM(amountdue) from earnings where userid=@userid and status=@status", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@status", "Pending");
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                totalearnings = int.Parse(dr.GetValue(0).ToString());
                            }
                            else
                            {
                                totalearnings = 0;
                            }
                        }
                    }
                    //Load Total withdrawals
                    using (cmd = new SqlCommand("Select SUM(thiswithdraw) from withdrawals where userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                totwithdrawals = int.Parse(dr.GetValue(0).ToString());
                            }
                            else
                            {
                                totwithdrawals = 0;
                            }
                        }
                    }
                    //Load Current registered Location
                    using (cmd = new SqlCommand("Select country from Register where email=@email", con))
                    {
                        cmd.Parameters.AddWithValue("@email", getUsername);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                reglocation = dr.GetValue(0).ToString();
                            }
                        }
                    }
                    //Load Status
                    using (cmd = new SqlCommand("Select accountstatus from register where email=@email", con))
                    {
                        cmd.Parameters.AddWithValue("@email", getUsername);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                accountstatus = dr.GetValue(0).ToString();
                            }
                        }
                    }
                    //Load Refer a friend Link
                    using (cmd = new SqlCommand("Select url from sbalink where email=@email", con))
                    {
                        cmd.Parameters.AddWithValue("@email", getUsername);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                referAfriendlink = dr.GetValue(0).ToString();
                            }
                        }
                    }

                    //Load Total referrals
                    //using (cmd = new SqlCommand("Select count(referralid) from placement where referralid=@userid", con))
                    //{
                    //    cmd.Parameters.AddWithValue("@userid", UserId);
                    //    using (dr = cmd.ExecuteReader())
                    //    {
                    //        if (dr.Read())
                    //        {
                    //            referAfriendlink = dr.GetValue(0).ToString();
                    //        }
                    //    }
                    //}

                    //Load Money in Wallet
                    using (cmd = new SqlCommand("Select Amount from wallet where userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                walletbalance = dr.GetValue(0).ToString();
                            }
                        }
                    }

                    //Load Rank
                    using (cmd = new SqlCommand("Select rank from downlinescount where userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                matrixRank = dr.GetValue(0).ToString();
                            }
                            else
                            {
                                matrixRank = "";
                            }
                        }
                    }

                    //Load Downlines
                    using (cmd = new SqlCommand("Select downlines from downlinescount where userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                getDownlines = int.Parse(dr.GetValue(0).ToString());
                            }
                        }
                    }

                    //Load Referral Bonus
                    dr.Dispose();
                    using (cmd = new SqlCommand("Select count(refid) from commissionsref where refid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using(dr = cmd.ExecuteReader())
                        {
                            if(dr.Read())
                            {
                                int getcount = int.Parse(dr.GetValue(0).ToString());
                                int total = getcount * 1000;

                                int sumWithdrawPaid = 0;
                                int sumWithdrawPending = 0;
                                // Correction codes for negative value for referral bonuses
                                dr.Dispose();
                                using(cmd = new SqlCommand("Select sum(thiswithdraw) from withdrawals where rank=@rank and status=@status and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                    cmd.Parameters.AddWithValue("@status", "Paid");
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    using(dr = cmd.ExecuteReader())
                                    {
                                        if(dr.Read() && !dr.IsDBNull(0))
                                        {
                                            sumWithdrawPaid = int.Parse(dr.GetValue(0).ToString());
                                        }
                                        else
                                        {
                                            sumWithdrawPaid = 0;                                            
                                        }
                                    }
                                }


                                dr.Dispose();
                                using (cmd = new SqlCommand("Select sum(thiswithdraw) from withdrawals where rank=@rank and status=@status and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@rank", "Referral Bonus");
                                    cmd.Parameters.AddWithValue("@status", "Pending");
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            sumWithdrawPending = int.Parse(dr.GetValue(0).ToString());
                                        }
                                        else
                                        {
                                            sumWithdrawPending = 0;
                                        }
                                    }
                                }

                                int balance = total - (sumWithdrawPaid + sumWithdrawPending);
                                getReferralBonus = balance.ToString() + " --------- Pending: #" + sumWithdrawPending;
                            }
                        }
                    }

                    //Load Recent Referral
                    using (da = new SqlDataAdapter())
                    {
                        //, con
                        DataSet ds = new DataSet();
                        int i = 0;
                        int checker = 0;
                        string sql = null;
                        sql = "Select username,userid,datecreated from CommissionsRef where refid=@refid";
                        using (cmd = new SqlCommand(sql, con))
                        {
                            da.SelectCommand = cmd;
                            da.SelectCommand.Parameters.AddWithValue("@refid", UserId);
                            dr.Dispose();
                            da.Fill(ds);
                            countRef = ds.Tables[0].Rows.Count;
                            referAfriendlink = countRef.ToString();
                            //Silver Stage 1
                            for (i = 0; i <= ds.Tables[0].Rows.Count-1; i++)
                            {
                                if (i >= 0)
                                {
                                    string ReferralName = ds.Tables[0].Rows[i].ItemArray[0].ToString();
                                    string ReferralID = ds.Tables[0].Rows[i].ItemArray[1].ToString();
                                    string DateReg = ds.Tables[0].Rows[i].ItemArray[2].ToString();
                                    checker++;

                                    if (checker == 1)
                                    {
                                        LoadReferralName4 = ReferralName;
                                        LoadReferralID4 = ReferralID;
                                        LoadReferralDate4 = DateReg;
                                    }
                                    else if (checker == 2)
                                    {
                                        LoadReferralName3 = ReferralName;
                                        LoadReferralID3 = ReferralID;
                                        LoadReferralDate3 = DateReg;
                                    }
                                    else if (checker == 3)
                                    {
                                        LoadReferralName2 = ReferralName;
                                        LoadReferralID2 = ReferralID;
                                        LoadReferralDate2 = DateReg;
                                    }
                                    else if (checker == 4)
                                    {
                                        LoadReferralName1 = ReferralName;
                                        LoadReferralID1 = ReferralID;
                                        LoadReferralDate1 = DateReg;
                                    }
                                }
                            }
                        }
                    }
                }
            //}
            //catch (Exception)
            //{
                
            //}
        }

        public void ResetPassword()
        {
            try
            {
                using(con = new SqlConnection(conn))
                {
                    con.Open();
                    using(cmd = new SqlCommand("Select password from register where userid=@userid and email=@email and code=@code", con))
                    {
                        cmd.Parameters.AddWithValue("@email", email);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@code ", emailConfCODE);
                        using(dr = cmd.ExecuteReader())
                        {
                            if(dr.Read())
                            {
                                ResponseMsgCode = dr.GetValue(0).ToString();
                            }
                            else
                            {
                                ResponseMsg = "Cannot read Code";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }
        
        public void ResetPasswordEmail()
        {
            //try
            //{
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select email from register where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@email", email);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                dr.Dispose();
                                int yourRandomEmailString = 6; //maximum: 32 
                                string urlCode = Guid.NewGuid().ToString("N").Substring(0, yourRandomEmailString);

                                int yourRandomPasswordString = 8; //maximum: 32 
                                string urlPasword = Guid.NewGuid().ToString("N").Substring(0, yourRandomPasswordString);
                                using(cmd = new SqlCommand("Update register set code=@code,password=@password where userid=@userid and email=@email", con))
                                {
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@code", urlCode);
                                    cmd.Parameters.AddWithValue("@password", urlPasword);
                                    cmd.ExecuteNonQuery();

                                    ResponseMsgCode = urlCode;
                                }
                            }
                            else
                            {
                                ResponseMsg = "Invalid Email!";
                            }
                        }
                    }
                }
            //}
            //catch (Exception)
            //{
                
            //}
        }
        
        //12
        public void ChangePassword()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select password from register where email=@email and password=@password and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                        cmd.Parameters.AddWithValue("@password", oldpassword);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update register set password=@password where password=@oldpassword and email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@oldpassword", oldpassword);
                                    cmd.Parameters.AddWithValue("@password", newpassword);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.ExecuteNonQuery();
                                    ResponseMsg = "Success!";
                                }
                            }
                            else
                            {
                                ResponseMsg = "Invalid Password";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void ForgotPasswordCode()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                //using(cmd = new SqlCommand(""))
            }
        }

        public void ForgotPassword()
        {
            try
            {
                if (email != "")
                {
                    using (con = new SqlConnection(conn))
                    {
                        con.Open();
                        using (cmd = new SqlCommand("Select email from register where email=@email", con))
                        {
                            cmd.Parameters.AddWithValue("@email", email);
                            using (dr = cmd.ExecuteReader())
                            {
                                if (dr.Read())
                                {

                                }
                                else
                                {
                                    ResponseMsg = "Invalid Email!";
                                }
                            }
                        }
                    }
                }
                else
                {
                    ResponseMsg = "Enter your Registered email in the User ID box!";
                }
            }
            catch (Exception)
            {
                
            }
        }
        
        //13
        public void LoadPersonalDetails()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("select email,partnername,phone,userid from Register where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                LoadEmail = dr.GetValue(0).ToString();
                                LoadName = dr.GetValue(1).ToString();
                                LoadPhone = dr.GetValue(2).ToString();
                                LoadUserID = dr.GetValue(3).ToString();

                                dr.Dispose();
                                using (cmd = new SqlCommand("Select name,bankname,accountno from bkretrieve where userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            username = dr.GetValue(0).ToString();
                                            bankname = dr.GetValue(1).ToString();
                                            accountno = dr.GetValue(2).ToString();
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception)
            {
                
            }
        }

        public void LoadBitcoinDetails()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("select email,partnername,phone from Register where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            LoadEmail = dr.GetValue(0).ToString();
                            LoadName = dr.GetValue(1).ToString();
                            LoadPhone = dr.GetValue(2).ToString();
                        }
                    }
                }
            }
        }
        
        //14
        public void NOK()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select userid from NOK where username=@username and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@username", SessionEmail);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                ResponseMsg = "Next of Kin details has been previously saved!";
                            }
                            else
                            {
                                using (cmd = new SqlCommand("Insert into NOK(username,name,nokname,nokrelationship,phone,userid) values (@username,@name,@nokname,@nokrelationship,@phone,@userid)", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", SessionEmail);
                                    cmd.Parameters.AddWithValue("@name", partnername);
                                    cmd.Parameters.AddWithValue("@nokname", nokname);
                                    cmd.Parameters.AddWithValue("@nokrelationship", nokrelationship);
                                    cmd.Parameters.AddWithValue("@phone", phone);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    dr.Dispose();
                                    cmd.ExecuteNonQuery();
                                    ResponseMsg = "Success!";
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception)
            {
                
            }
        }

        //15
        public void BankSave()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select username from bkretrieve where username=@username and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@username", SessionEmail);
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                ResponseMsg = "Bank details already previously saved!";
                            }
                            else
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select partnername from register where email=@username and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@username", SessionEmail);
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read())
                                        {
                                            string getName = dr.GetValue(0).ToString();
                                            if (getName == partnername)
                                            {
                                                using (cmd = new SqlCommand("Insert into BKRetrieve(username,name,bankname,accountno,userid) values (@username,@name,@bankname,@accountno,@userid)", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@username", SessionEmail);
                                                    cmd.Parameters.AddWithValue("@name", partnername);
                                                    cmd.Parameters.AddWithValue("@bankname", bankname);
                                                    cmd.Parameters.AddWithValue("@accountno", accountno);
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    dr.Dispose();
                                                    cmd.ExecuteNonQuery();
                                                    ResponseMsg = "Success!";
                                                }

                                            }
                                            else
                                            {
                                                ResponseMsg = "Name Mismatch, your bank name must match with your registered name.";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void SaveEcomSignUp()
        {
            using (con = new SqlConnection(conn))
            {

                con.Open();
                using (cmd = new SqlCommand("Select phone from EmailEcomSignUp where phone=@phone", con))
                {
                    cmd.Parameters.AddWithValue("@phone", phone);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            ResponseMsg = "Phone number already exists!";
                            error1 = "error1";
                        }
                    }
                }


                if (error1 == "")
                {
                    dr.Dispose();
                    using (cmd = new SqlCommand("Select email from EmailEcomSignUp where email=@email", con))
                    {
                        cmd.Parameters.AddWithValue("@email", email);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                ResponseMsg = "Email already exists!";
                            }
                            else
                            {
                                using (cmd = new SqlCommand("Insert into EmailEcomSignUp(partnername,email,phone,city,state,country,businessname,domainname,businessnature,referrer,dd,mm,yy) values (@partnername,@email,@phone,@city,@state,@country,@businessname,@domainname,@businessnature,@referrer,@dd,@mm,@yy)", con))
                                {//partnername,email,phone,city,state,country,businessname,domainname,businessnature,referrer,dd,mm,yy
                                    //Generate Email Code
                                    cmd.Parameters.AddWithValue("@partnername", partnername);
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@phone", phone);
                                    cmd.Parameters.AddWithValue("@city", city.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@state", state.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@country", country.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@businessname", businessname.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@domainname", domainname.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@businessnature", businessnature.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@referrer", refCode);
                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                    dr.Dispose();
                                    cmd.ExecuteNonQuery();



                                    ResponseMsg = "Success!";
                                }
                            }
                        }
                    }
                }
                else
                {
                    ResponseMsg = "One or more phone number(s) already exists!";
                }
            }
        }

        public void SaveRegisterTest()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();


                int count = 349524;
                int i = 0;
                for (i = 0; i <= count; i++)
                {
                    int yourRandomEmailString = 6; //maximum: 32 
                    string urlCode = Guid.NewGuid().ToString("N").Substring(0, yourRandomEmailString);
                    using (cmd = new SqlCommand("Select userid from register where userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", urlCode);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                ResponseMsg = "UserID already exists!, kindly refresh your page and try again.";
                            }
                            else
                            {

                                using (cmd = new SqlCommand("Insert into register(password,partnername,email,phone,city,state,country,nationality,lastlogin,datereg,ref,currentdate,accountstatus,dd,mm,yy,code,codestatus,userid,gender,refid) values (@password,@partnername,@email,@phone,@city,@state,@country,@nationality,@lastlogin,@datereg,@ref,@currentdate,@accountstatus,@dd,@mm,@yy,@code,@codestatus,@userid,@gender,@refid)", con))
                                {

                                    
                                    cmd.Parameters.AddWithValue("@password", "patience");
                                    cmd.Parameters.AddWithValue("@partnername", "Emma Ogbewele");
                                    cmd.Parameters.AddWithValue("@email", "heforus@yahoo.com");
                                    cmd.Parameters.AddWithValue("@phone", "08075656565");
                                    cmd.Parameters.AddWithValue("@city", "Lagos");
                                    cmd.Parameters.AddWithValue("@state", "Lagos");
                                    cmd.Parameters.AddWithValue("@country", "Nigeria");
                                    cmd.Parameters.AddWithValue("@nationality", "Nigeria");
                                    cmd.Parameters.AddWithValue("@lastlogin", DateTime.Now);
                                    cmd.Parameters.AddWithValue("@datereg", DateTime.Now.ToShortDateString());
                                    cmd.Parameters.AddWithValue("@ref", "0000");
                                    cmd.Parameters.AddWithValue("@currentdate", DateTime.Now.ToShortDateString());
                                    cmd.Parameters.AddWithValue("@accountstatus", "Active");
                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                    cmd.Parameters.AddWithValue("@code", "emailConfCODE");
                                    cmd.Parameters.AddWithValue("@codestatus", "1");
                                    cmd.Parameters.AddWithValue("@userid", urlCode);
                                    cmd.Parameters.AddWithValue("@gender", "Male");
                                    cmd.Parameters.AddWithValue("@refid", "2B53663");
                                    dr.Dispose();
                                    cmd.ExecuteNonQuery();
                                }

                            }
                            
                        }
                    }
                }
                ResponseMsg = "Done" + i + " rows created.";
            }
        }
        
        //16
        public void SaveRegister()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select userid from register where userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                ResponseMsg = "UserID already exists!, kindly refresh your page and try again.";
                            }
                            else
                            {
                                using (cmd = new SqlCommand("Insert into register(password,partnername,email,phone,city,state,country,nationality,lastlogin,datereg,ref,currentdate,accountstatus,dd,mm,yy,code,codestatus,userid,gender,refid) values (@password,@partnername,@email,@phone,@city,@state,@country,@nationality,@lastlogin,@datereg,@ref,@currentdate,@accountstatus,@dd,@mm,@yy,@code,@codestatus,@userid,@gender,@refid)", con))
                                {
                                    //Generate Email Code
                                    cmd.Parameters.AddWithValue("@password", password);
                                    cmd.Parameters.AddWithValue("@partnername", partnername);
                                    cmd.Parameters.AddWithValue("@email", email);
                                    cmd.Parameters.AddWithValue("@phone", phone);
                                    cmd.Parameters.AddWithValue("@city", city.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@state", state.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@country", country.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@nationality", nationality.Trim().ToUpper());
                                    cmd.Parameters.AddWithValue("@lastlogin", DateTime.Now);
                                    cmd.Parameters.AddWithValue("@datereg", DateTime.Now.ToShortDateString());
                                    cmd.Parameters.AddWithValue("@ref", refCode);
                                    cmd.Parameters.AddWithValue("@currentdate", currentdate);
                                    cmd.Parameters.AddWithValue("@accountstatus", "Active");
                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                    cmd.Parameters.AddWithValue("@code", emailConfCODE);
                                    cmd.Parameters.AddWithValue("@codestatus", "0");
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@gender", gender);
                                    cmd.Parameters.AddWithValue("@refid", Referrer);
                                    dr.Dispose();
                                    cmd.ExecuteNonQuery();


                                    //Send Email - //Format this email section well
                                    //create the mail message
                                    //MailMessage mail = new MailMessage();
                                    ////set the FROM address
                                    //mail.From = new MailAddress("info@Winninglifeinternational.com");
                                    ////set the RECIPIENTS
                                    //mail.To.Add(email);
                                    ////enter a SUBJECT
                                    //mail.Subject = "Your Email Confirmation Code from WinningLife";
                                    ////Enter the message BODY
                                    //mail.Body = "From WinningLife International:<p>" + "<p>Thank you for registering on WinningLife International. <p><p>Your Email Confirmation Code is - <strong>" + emailConfCODE + "</strong. <p>To complete your registration kindly fund your wallet.</p> <p><p>- WinningLife International Team";
                                    ////set the mail server (default should be smtp.1and1.com)
                                    //SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                    ////Enter your full e-mail address and password
                                    //smtp.Credentials = new NetworkCredential("info@360healthwealth.com", "{fRA.8SJekqx");
                                    ////send the message 
                                    //smtp.Send(mail);

                                    // SendHtmlFormattedEmail(email, "Your Email Confirmation Code from WinningLife", body);

                                    ResponseMsg = "Success!";
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void NewsUpdateSubscription()
        {
            using(con = new SqlConnection(conn))
            {
                con.Open();
                using(cmd = new SqlCommand("Select email from subscription where email=@email", con))
                {
                    cmd.Parameters.AddWithValue("@email", email);
                    using(dr = cmd.ExecuteReader())
                    {
                        if(dr.Read())
                        {
                            ResponseMsg = "Email was previously saved!";
                        }
                        else
                        {
                            using (cmd = new SqlCommand("Insert into Subscription(email) values (@email)", con))
                            {
                                cmd.Parameters.AddWithValue("@email", email);
                                dr.Dispose();
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Success!";
                            }
                        }
                    }
                   
                }
            }
        }

        //17
        public void GetLoadWalletBalances()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                totalwalletbalance = dr.GetValue(0).ToString();
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        //18
        public void GetWalletBalances()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                totalwalletbalance = dr.GetValue(0).ToString();

                                dr.Dispose();
                                using (cmd = new SqlCommand("Select SUM(balance) from earnings where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            totalreusablebalance = dr.GetValue(0).ToString();
                                        }
                                        else
                                        {
                                            totalreusablebalance = "0";
                                        }
                                    }
                                }

                                dr.Dispose();
                                using (cmd = new SqlCommand("Select SUM(AmtWithdrawn) from withdrawtrack where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            totalwithdrawal = dr.GetValue(0).ToString();
                                        }
                                        else
                                        {
                                            totalwithdrawal = "0";
                                        }
                                    }
                                }
                            }
                            else
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select SUM(amtwithdrawable) from earnings where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            totalwalletbalance = dr.GetValue(0).ToString();

                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select thiswithdraw from withdrawals where email=@email and userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read())
                                                    {
                                                        using (cmd = new SqlCommand("Select SUM(thiswithdraw) from withdrawals where email=@email and userid=@userid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                            dr.Dispose();
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read() && !dr.IsDBNull(0))
                                                                {
                                                                    totalwithdrawal = dr.GetValue(0).ToString();

                                                                    int balance = int.Parse(totalwalletbalance) - int.Parse(totalwithdrawal);
                                                                    totalwalletbalance = balance.ToString();

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Insert into earningswallet(email,amount,date,userid) values (@email,@amount,@date,@userid)", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    totalwithdrawal = "0";

                                                                    int balance = int.Parse(totalwalletbalance) - int.Parse(totalwithdrawal);
                                                                    totalwalletbalance = balance.ToString();

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select amount from earningswallet where email=@email and userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read() && !dr.IsDBNull(0))
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Insert into earningswallet(email,amount,date,userid) values (@email,@amount,@date,@userid)", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                    cmd.Parameters.AddWithValue("@amount", totalwalletbalance);
                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                    cmd.ExecuteNonQuery();
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            totalwalletbalance = "0";
                                        }
                                    }
                                }

                                dr.Dispose();
                                using (cmd = new SqlCommand("Select SUM(balance) from earnings where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            totalreusablebalance = dr.GetValue(0).ToString();
                                        }
                                        else
                                        {
                                            totalreusablebalance = "0";
                                        }
                                    }
                                }

                                dr.Dispose();
                                using (cmd = new SqlCommand("Select SUM(AmtWithdrawn) from withdrawtrack where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            totalwithdrawal = dr.GetValue(0).ToString();
                                        }
                                        else
                                        {
                                            totalwithdrawal = "0";
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void GetWalletBalancePerProgram()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select SUM(amtwithdrawable) from earnings where email=@email and program=@program", con))
                {
                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                    cmd.Parameters.AddWithValue("@program", program);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            WalletbalanceWithdrawable = int.Parse(dr.GetValue(0).ToString());
                        }
                        else
                        {
                            WalletbalanceWithdrawable = 0;
                        }
                    }
                }

                dr.Dispose();
                using (cmd = new SqlCommand("Select SUM(balance) from earnings where email=@email and program=@program", con))
                {
                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                    cmd.Parameters.AddWithValue("@program", program);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read() && !dr.IsDBNull(0))
                        {
                            WalletbalanceRetained = int.Parse(dr.GetValue(0).ToString());
                        }
                        else
                        {
                            WalletbalanceRetained = 0;
                        }
                    }
                }
            }
        }

        public void GetPlacementIDs()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select count(assignedsn) from winninglife where email=@email and userid=@userid", con))
                {
                    cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                int counter = int.Parse(dr.GetValue(0).ToString());
                                if (counter == 1)
                                {
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Select assignedsn from mustard where email=@email and userid=@userid", con))
                                    {
                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                        using (dr = cmd.ExecuteReader())
                                        {
                                            if (dr.Read())
                                            {
                                                placementIDs = dr.GetValue(0).ToString();
                                            }
                                        }
                                    }
                                }
                                else if (counter > 1)
                                {
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Select assignedsn from mustard where email=@email and userid=@userid", con))
                                    {
                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                        using (dr = cmd.ExecuteReader())
                                        {
                                            while (dr.Read())
                                            {
                                                placementIDs += dr.GetValue(0).ToString() + " ";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                //else if (programPack == "360HealthWealth")
                //{
                //    using (cmd = new SqlCommand("Select count(assignedsn) from mustard where email=@email", con))
                //    {
                //        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //        using (dr = cmd.ExecuteReader())
                //        {
                //            if (dr.Read())
                //            {
                //                int counter = int.Parse(dr.GetValue(0).ToString());
                //                if (counter == 1)
                //                {
                //                    dr.Dispose();
                //                    using (cmd = new SqlCommand("Select assignedsn from healthwealth360 where email=@email", con))
                //                    {
                //                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //                        using (dr = cmd.ExecuteReader())
                //                        {
                //                            if (dr.Read())
                //                            {
                //                                placementIDs = dr.GetValue(0).ToString();
                //                            }
                //                        }
                //                    }
                //                }
                //                else if (counter > 1)
                //                {
                //                    dr.Dispose();
                //                    using (cmd = new SqlCommand("Select assignedsn from healthwealth360 where email=@email", con))
                //                    {
                //                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //                        using (dr = cmd.ExecuteReader())
                //                        {
                //                            while (dr.Read())
                //                            {
                //                                placementIDs += dr.GetValue(0).ToString() + " ";
                //                            }
                //                        }
                //                    }
                //                }
                //            }
                //        }
                //    }
                //}
                //else if (programPack == "LandPaceStarter")
                //{
                //    using (cmd = new SqlCommand("Select count(assignedsn) from mustard where email=@email", con))
                //    {
                //        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //        using (dr = cmd.ExecuteReader())
                //        {
                //            if (dr.Read())
                //            {
                //                int counter = int.Parse(dr.GetValue(0).ToString());
                //                if (counter == 1)
                //                {
                //                    dr.Dispose();
                //                    using (cmd = new SqlCommand("Select assignedsn from landpacestarter where email=@email", con))
                //                    {
                //                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //                        using (dr = cmd.ExecuteReader())
                //                        {
                //                            if (dr.Read())
                //                            {
                //                                placementIDs = dr.GetValue(0).ToString();
                //                            }
                //                        }
                //                    }
                //                }
                //                else if (counter > 1)
                //                {
                //                    dr.Dispose();
                //                    using (cmd = new SqlCommand("Select assignedsn from landpacestarter where email=@email", con))
                //                    {
                //                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //                        using (dr = cmd.ExecuteReader())
                //                        {
                //                            while (dr.Read())
                //                            {
                //                                placementIDs += dr.GetValue(0).ToString() + " ";
                //                            }
                //                        }
                //                    }
                //                }
                //            }
                //        }
                //    }
                //}
                //else if (programPack == "LandPaceGold")
                //{
                //    using (cmd = new SqlCommand("Select count(assignedsn) from mustard where email=@email", con))
                //    {
                //        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //        using (dr = cmd.ExecuteReader())
                //        {
                //            if (dr.Read())
                //            {
                //                int counter = int.Parse(dr.GetValue(0).ToString());
                //                if (counter == 1)
                //                {
                //                    dr.Dispose();
                //                    using (cmd = new SqlCommand("Select assignedsn from landpacestarter where email=@email", con))
                //                    {
                //                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //                        using (dr = cmd.ExecuteReader())
                //                        {
                //                            if (dr.Read())
                //                            {
                //                                placementIDs = dr.GetValue(0).ToString();
                //                            }
                //                        }
                //                    }
                //                }
                //                else if (counter > 1)
                //                {
                //                    dr.Dispose();
                //                    using (cmd = new SqlCommand("Select assignedsn from landpacestarter where email=@email", con))
                //                    {
                //                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                //                        using (dr = cmd.ExecuteReader())
                //                        {
                //                            while (dr.Read())
                //                            {
                //                                placementIDs += dr.GetValue(0).ToString() + " ";
                //                            }
                //                        }
                //                    }
                //                }
                //            }
                //        }
                //    }
                //}
            }
        }

        public void SaveBookLinks()
        {
            using (con = new SqlConnection(conn))
            {
                con.Open();
                using (cmd = new SqlCommand("Select book from booklinks where package=@package and book=@book", con))
                {
                    cmd.Parameters.AddWithValue("@package", programPack);
                    cmd.Parameters.AddWithValue("@book", bookname);
                    using (dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            ResponseMsg = "This book has been previously saved!";
                        }
                        else
                        {
                            dr.Dispose();
                            using (cmd = new SqlCommand("Insert into booklinks(package,book,link) values (@package,@book,@link)", con))
                            {
                                cmd.Parameters.AddWithValue("@package", programPack);
                                cmd.Parameters.AddWithValue("@book", bookname);
                                cmd.Parameters.AddWithValue("@link", bookurl);
                                cmd.ExecuteNonQuery();
                                ResponseMsg = "Success!";
                            }
                        }
                    }
                }
            }
        }

        public void LoadMatrixTbl()
        {
            int SNa;
            int CostA;
            int SNb;
            int Costb;
            using (con = new SqlConnection(conn))
            {
                con.Open();
                //Delete Hierarchy
                using (cmd = new SqlCommand(""))

                    if (programPack == "MustardFund")
                    {
                        using (cmd = new SqlCommand("Select count(assignedsn) from mustard where parentsn=@assignedsn", con))
                        {
                            cmd.Parameters.AddWithValue("@assignedsn", placementid);
                            using (dr = cmd.ExecuteReader())
                            {
                                if (dr.Read())
                                {
                                    int counter = int.Parse(dr.GetValue(0).ToString());
                                    if (counter == 1)
                                    {
                                        dr.Dispose();
                                        using (cmd = new SqlCommand("Select assignedsn,cost from mustard where parentsn=@assignedsn", con))
                                        {
                                            cmd.Parameters.AddWithValue("@assignedsn", placementid);
                                            using (dr = cmd.ExecuteReader())
                                            {
                                                if (dr.Read())
                                                {
                                                    SNa = int.Parse(dr.GetValue(0).ToString());
                                                    CostA = int.Parse(dr.GetValue(1).ToString());

                                                    dr.Dispose();
                                                    //using(cmd = new SqlCommand(""))
                                                }
                                            }
                                        }
                                    }
                                    else if (counter == 2)
                                    {

                                    }
                                }
                            }
                        }
                    }
                    else if (programPack == "360HealthWealth")
                    {

                    }
                    else if (programPack == "LandPaceStarter")
                    {

                    }
                    else if (programPack == "LandPaceGold")
                    {

                    }
            }
        }
        
        //19
        public void ConfirmEmailCode()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select code from register where code=@code", con))
                    {
                        cmd.Parameters.AddWithValue("@code", emailcode);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update register set code=@code,codestatus=@codestatus where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@code", emailcode);
                                    cmd.Parameters.AddWithValue("@codestatus", "1");
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    cmd.ExecuteNonQuery();
                                    ResponseMsg = "Success!";
                                }
                            }
                            else
                            {
                                ResponseMsg = "Invalid Email Code.";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        //20
        public void SendWithdrawalRequest()
        {
            try
            {
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select bankname from bkretrieve  where username=@username and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@username", SessionEmail);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Select Max(SN) from withdrawals where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    using (dr = cmd.ExecuteReader())
                                    {
                                        if (dr.Read() && !dr.IsDBNull(0))
                                        {
                                            string getSN = dr.GetValue(0).ToString();

                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select SUM(thiswithdraw) from withdrawals where email=@email and userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read())
                                                    {
                                                        int totalpreviouswithdraws = int.Parse(dr.GetValue(0).ToString());

                                                        dr.Dispose();
                                                        using (cmd = new SqlCommand("Select SUM(amtwithdrawable) from earnings where email=@email and userid=@userid", con))
                                                        {
                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                            using (dr = cmd.ExecuteReader())
                                                            {
                                                                if (dr.Read())
                                                                {
                                                                    int getamount = int.Parse(dr.GetValue(0).ToString());
                                                                    int requestamount = int.Parse(withdrawrequestamount);
                                                                    int balance = getamount - totalpreviouswithdraws;
                                                                    if (balance > requestamount)
                                                                    {
                                                                        dr.Dispose();


                                                                        using (cmd = new SqlCommand("Select totwithdraw,prevbalance from withdrawals where sn=@sn", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@sn", getSN);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string totwithdraw = dr.GetValue(0).ToString();
                                                                                    string prevbalance = dr.GetValue(1).ToString();
                                                                                    using (TransactionScope scope = new TransactionScope())
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Insert into withdrawtrack(email,prevbalance,amtwithdrawn,newbalance,dd,mm,yy,date,status,userid) values (@email,@prevbalance,@amtwithdrawn,@newbalance,@dd,@mm,@yy,@date,@status,@userid)", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                            cmd.Parameters.AddWithValue("@prevbalance", getamount - totalpreviouswithdraws);
                                                                                            cmd.Parameters.AddWithValue("@amtwithdrawn", requestamount);
                                                                                            cmd.Parameters.AddWithValue("@newbalance", balance);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@status", "Not Sent");
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }

                                                                                        using (cmd = new SqlCommand("Insert into withdrawals(email,totearning,totwithdraw,Prevbalance,thiswithdraw,NewBalance,dd,mm,yy,date,userid) values (@email,@totearning,@totwithdrawal,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid)", con))
                                                                                        {//@email,@totearning,@totwithdrawal,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                            cmd.Parameters.AddWithValue("@totearning", getamount);
                                                                                            cmd.Parameters.AddWithValue("@totwithdrawal", totalpreviouswithdraws + requestamount);
                                                                                            cmd.Parameters.AddWithValue("@prevbalance", prevbalance);
                                                                                            cmd.Parameters.AddWithValue("@thiswithdraw", requestamount);
                                                                                            cmd.Parameters.AddWithValue("@newbalance", (getamount - (totalpreviouswithdraws + requestamount)));
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }

                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                            cmd.Parameters.AddWithValue("@amount", balance);
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }

                                                                                        using (cmd = new SqlCommand("Insert into earningswallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                            cmd.Parameters.AddWithValue("@addamount", getamount - int.Parse(prevbalance));
                                                                                            cmd.Parameters.AddWithValue("@deductamount", totwithdraw);
                                                                                            cmd.Parameters.AddWithValue("@previoustotal", prevbalance);
                                                                                            cmd.Parameters.AddWithValue("@currenttotal", (getamount - (totalpreviouswithdraws + requestamount)));
                                                                                            cmd.Parameters.AddWithValue("@purpose", "Withdrawal of funds of '" + requestamount + "' by you - " + UserId + "-" + SessionEmail + ".");
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                            cmd.ExecuteNonQuery();
                                                                                            ResponseMsg = "Request Sent!, Successful withdrawal requests are processed with 3-5 working days.";
                                                                                        }
                                                                                        scope.Complete();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else if (balance == requestamount)
                                                                    {
                                                                        dr.Dispose();

                                                                        using (cmd = new SqlCommand("Select totwithdraw,prevbalance from withdrawals where sn=@sn", con))
                                                                        {
                                                                            cmd.Parameters.AddWithValue("@sn", getSN);
                                                                            using (dr = cmd.ExecuteReader())
                                                                            {
                                                                                if (dr.Read())
                                                                                {
                                                                                    string totwithdraw = dr.GetValue(0).ToString();
                                                                                    string prevbalance = dr.GetValue(1).ToString();
                                                                                    using (TransactionScope scope = new TransactionScope())
                                                                                    {
                                                                                        using (cmd = new SqlCommand("Insert into withdrawtrack(email,prevbalance,amtwithdrawn,newbalance,dd,mm,yy,date,status,userid) values (@email,@prevbalance,@amtwithdrawn,@newbalance,@dd,@mm,@yy,@date,@status,@userid)", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                            cmd.Parameters.AddWithValue("@prevbalance", getamount - totalpreviouswithdraws);
                                                                                            cmd.Parameters.AddWithValue("@amtwithdrawn", requestamount);
                                                                                            cmd.Parameters.AddWithValue("@newbalance", balance);
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            cmd.Parameters.AddWithValue("@status", "Not Sent");
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }

                                                                                        using (cmd = new SqlCommand("Insert into withdrawals(email,totearning,totwithdraw,Prevbalance,thiswithdraw,NewBalance,dd,mm,yy,date,userid) values (@email,@totearning,@totwithdrawal,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid)", con))
                                                                                        {//@email,@totearning,@totwithdrawal,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                            cmd.Parameters.AddWithValue("@totearning", getamount);
                                                                                            cmd.Parameters.AddWithValue("@totwithdrawal", totalpreviouswithdraws + requestamount);
                                                                                            cmd.Parameters.AddWithValue("@prevbalance", prevbalance);
                                                                                            cmd.Parameters.AddWithValue("@thiswithdraw", requestamount);
                                                                                            cmd.Parameters.AddWithValue("@newbalance", (getamount - (totalpreviouswithdraws + requestamount)));
                                                                                            cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                            cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                            cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                                            dr.Dispose();
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }

                                                                                        dr.Dispose();
                                                                                        using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                                        {
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                            cmd.Parameters.AddWithValue("@amount", balance);
                                                                                            cmd.ExecuteNonQuery();
                                                                                        }

                                                                                        using (cmd = new SqlCommand("Insert into earningswallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                            cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                                            cmd.Parameters.AddWithValue("@addamount", getamount - int.Parse(prevbalance));
                                                                                            cmd.Parameters.AddWithValue("@deductamount", totwithdraw);
                                                                                            cmd.Parameters.AddWithValue("@previoustotal", prevbalance);
                                                                                            cmd.Parameters.AddWithValue("@currenttotal", (getamount - (totalpreviouswithdraws + requestamount)));
                                                                                            cmd.Parameters.AddWithValue("@purpose", "Withdrawal of funds of '" + requestamount + "' by you - " + UserId + "-" + SessionEmail + ".");
                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                            cmd.ExecuteNonQuery();
                                                                                            ResponseMsg = "Request Sent!, Successful withdrawal requests are processed with 3-5 working days.";
                                                                                        }
                                                                                        scope.Complete();
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        ResponseMsg = "Insufficient Earnings Wallet Balance.";
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    ResponseMsg = "Insufficient Earnings Wallet Balance.";
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            dr.Dispose();
                                            using (cmd = new SqlCommand("Select SUM(amtwithdrawable) from earnings where email=@email and userid=@userid", con))
                                            {
                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                using (dr = cmd.ExecuteReader())
                                                {
                                                    if (dr.Read())
                                                    {
                                                        int getamount = int.Parse(dr.GetValue(0).ToString());
                                                        int requestamount = int.Parse(withdrawrequestamount);
                                                        if (getamount > requestamount)
                                                        {
                                                            dr.Dispose();
                                                            int balance = getamount - requestamount;

                                                            using (TransactionScope scope = new TransactionScope())
                                                            {
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Insert into withdrawtrack(email,prevbalance,amtwithdrawn,newbalance,dd,mm,yy,date,status,userid) values (@email,@prevbalance,@amtwithdrawn,@newbalance,@dd,@mm,@yy,@date,@status,@userid)", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    cmd.Parameters.AddWithValue("@prevbalance", getamount);
                                                                    cmd.Parameters.AddWithValue("@amtwithdrawn", requestamount);
                                                                    cmd.Parameters.AddWithValue("@newbalance", balance);
                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    cmd.Parameters.AddWithValue("@status", "Not Sent");
                                                                    cmd.ExecuteNonQuery();
                                                                }

                                                                using (cmd = new SqlCommand("Insert into withdrawals(email,totearning,totwithdraw,Prevbalance,thiswithdraw,NewBalance,dd,mm,yy,date,userid) values (@email,@totearning,@totwithdrawal,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid)", con))
                                                                {//@email,@totearning,@totwithdrawal,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    cmd.Parameters.AddWithValue("@totearning", getamount);
                                                                    cmd.Parameters.AddWithValue("@totwithdrawal", requestamount);
                                                                    cmd.Parameters.AddWithValue("@prevbalance", getamount - requestamount);
                                                                    cmd.Parameters.AddWithValue("@thiswithdraw", requestamount);
                                                                    cmd.Parameters.AddWithValue("@newbalance", getamount - requestamount);
                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    cmd.ExecuteNonQuery();
                                                                }

                                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    cmd.Parameters.AddWithValue("@amount", balance);
                                                                    cmd.ExecuteNonQuery();
                                                                }

                                                                using (cmd = new SqlCommand("Insert into earningswallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    cmd.Parameters.AddWithValue("@addamount", getamount);
                                                                    cmd.Parameters.AddWithValue("@deductamount", requestamount);
                                                                    cmd.Parameters.AddWithValue("@previoustotal", 0);
                                                                    cmd.Parameters.AddWithValue("@currenttotal", getamount - requestamount);
                                                                    cmd.Parameters.AddWithValue("@purpose", "Withdrawal of funds of '" + requestamount + "' by you - " + UserId + "-" + SessionEmail + ".");
                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                    cmd.ExecuteNonQuery();
                                                                    ResponseMsg = "Request Sent!, Successful withdrawal requests are processed with 3-5 working days.";
                                                                }
                                                                scope.Complete();
                                                            }
                                                        }
                                                        else if (getamount == requestamount)
                                                        {
                                                            dr.Dispose();
                                                            int balance = getamount - requestamount;

                                                            using (TransactionScope scope = new TransactionScope())
                                                            {
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Insert into withdrawtrack(email,prevbalance,amtwithdrawn,newbalance,dd,mm,yy,date,status,userid) values (@email,@prevbalance,@amtwithdrawn,@newbalance,@dd,@mm,@yy,@date,@status,@userid)", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    cmd.Parameters.AddWithValue("@prevbalance", getamount);
                                                                    cmd.Parameters.AddWithValue("@amtwithdrawn", requestamount);
                                                                    cmd.Parameters.AddWithValue("@newbalance", balance);
                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    cmd.Parameters.AddWithValue("@status", "Not Sent");
                                                                    cmd.ExecuteNonQuery();
                                                                }

                                                                using (cmd = new SqlCommand("Insert into withdrawals(email,totearning,totwithdraw,Prevbalance,thiswithdraw,NewBalance,dd,mm,yy,date,userid) values (@email,@totearning,@totwithdrawal,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date,@userid)", con))
                                                                {//@email,@totearning,@totwithdrawal,@prevbalance,@thiswithdraw,@newbalance,@dd,@mm,@yy,@date
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    cmd.Parameters.AddWithValue("@totearning", getamount);
                                                                    cmd.Parameters.AddWithValue("@totwithdrawal", requestamount);
                                                                    cmd.Parameters.AddWithValue("@prevbalance", getamount - requestamount);
                                                                    cmd.Parameters.AddWithValue("@thiswithdraw", requestamount);
                                                                    cmd.Parameters.AddWithValue("@newbalance", getamount - requestamount);
                                                                    cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                    cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                    cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToShortDateString());
                                                                    cmd.ExecuteNonQuery();
                                                                }

                                                                using (cmd = new SqlCommand("Update earningswallet set amount=@amount where email=@email and userid=@userid", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    cmd.Parameters.AddWithValue("@amount", balance);
                                                                    cmd.ExecuteNonQuery();
                                                                }

                                                                using (cmd = new SqlCommand("Insert into earningswallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                                                    cmd.Parameters.AddWithValue("@addamount", getamount);
                                                                    cmd.Parameters.AddWithValue("@deductamount", requestamount);
                                                                    cmd.Parameters.AddWithValue("@previoustotal", 0);
                                                                    cmd.Parameters.AddWithValue("@currenttotal", getamount - requestamount);
                                                                    cmd.Parameters.AddWithValue("@purpose", "Withdrawal of funds of '" + requestamount + "' by you - " + UserId + "-" + SessionEmail + ".");
                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                    cmd.ExecuteNonQuery();
                                                                    ResponseMsg = "Request Sent!, Successful withdrawal requests are processed with 3-5 working days.";
                                                                }
                                                                scope.Complete();
                                                            }
                                                        }
                                                        else
                                                        {
                                                            ResponseMsg = "Insufficient Earnings Wallet Balance.";
                                                        }
                                                    }
                                                    else
                                                    {
                                                        ResponseMsg = "Insufficient Earnings Wallet Balance.";
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ResponseMsg = "You do not have any registered bank details. Kindly update your profile.";
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }

        public void SavePlacement()
        {
            try
            {
                ///Sort out the ID track properly
                string place = "0";
                string refer = "0";
                string name = "0";
                string referid = "0";
                PID = placementid;
                using (con = new SqlConnection(conn))
                {
                    con.Open();

                    using(cmd = new SqlCommand("Select placementid from placement where userid=@placementid", con))
                    {
                        cmd.Parameters.AddWithValue("@placementid", placementid);
                        using(dr = cmd.ExecuteReader())
                        {
                            if(dr.Read() && !dr.IsDBNull(0))
                            {

                                //dr.Dispose();
                                //using (cmd = new SqlCommand("Select codestatus from register where email=@email and userid=@userid", con))
                                //{
                                //    cmd.Parameters.AddWithValue("@email", username);
                                //    cmd.Parameters.AddWithValue("@userid", UserId);
                                //    using (dr = cmd.ExecuteReader())
                                //    {
                                //        if (dr.Read())
                                //        {
                                //            string codestatus = dr.GetValue(0).ToString();
                                //            if (codestatus == "1")
                                //            {
                                                dr.Dispose();
                                                using (cmd = new SqlCommand("Select amount from wallet where email=@email and userid=@userid", con))
                                                {
                                                    cmd.Parameters.AddWithValue("@email", username);
                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                    using (dr = cmd.ExecuteReader())
                                                    {
                                                        if (dr.Read())
                                                        {
                                                            int PreviousAmount = int.Parse(dr.GetValue(0).ToString());
                                                            int newAmount = PreviousAmount - 9000;
                                                            if (PreviousAmount >= 9000)
                                                            {
                                                                dr.Dispose();
                                                                using (cmd = new SqlCommand("Select partnername from register where userid=@placementid", con))
                                                                {
                                                                    cmd.Parameters.AddWithValue("@placementid", placementid);
                                                                    using (dr = cmd.ExecuteReader())
                                                                    {
                                                                        if (dr.Read())
                                                                        {
                                                                            placementname = dr.GetValue(0).ToString();
                                                                            place = "1";
                                                                        }
                                                                        else
                                                                        {
                                                                            ResponseMsg = "Invalid Placement ID.";
                                                                        }
                                                                    }

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select partnername from register where userid=@referralid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@referralid", referralID);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                referralname = dr.GetValue(0).ToString();
                                                                                refer = "1";
                                                                            }
                                                                            else
                                                                            {
                                                                                ResponseMsg = "Invalid Referral ID.";
                                                                            }
                                                                        }
                                                                    }

                                                                    dr.Dispose();
                                                                    using (cmd = new SqlCommand("Select partnername from register where userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                useridname = dr.GetValue(0).ToString();
                                                                                name = "1";
                                                                            }
                                                                            else
                                                                            {
                                                                                ResponseMsg = "Invalid Placement ID.";
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                                if (refer == "1" && place == "1" && name == "1")
                                                                {
                                                                    dr.Dispose();
                                                                    //select max(sn) from placement where userid=@userid
                                                                    //select max(sn) from placement, 
                                                                    //if sn2 - sn1 < 4
                                                                    // 
                                                                    using (cmd = new SqlCommand("Select userid from placement where userid=@userid", con))
                                                                    {
                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                        using (dr = cmd.ExecuteReader())
                                                                        {
                                                                            if (dr.Read())
                                                                            {
                                                                                ResponseMsg = "Invalid Operation, you cannot place an account twice.";
                                                                            }
                                                                            else
                                                                            {
                                                                                dr.Dispose();
                                                                                using (cmd = new SqlCommand("Select count(placementID) from placement where placementid=@placementid", con))
                                                                                {
                                                                                    cmd.Parameters.AddWithValue("@placementid", placementid);
                                                                                    using (dr = cmd.ExecuteReader())
                                                                                    {
                                                                                        if (dr.Read() && !dr.IsDBNull(0))
                                                                                        {
                                                                                            int getPlaceCount = int.Parse(dr.GetValue(0).ToString());
                                                                                            if (getPlaceCount < 4)
                                                                                            {
                                                                                                dr.Dispose();
                                                                                                using (cmd = new SqlCommand("Select userid from placement where placementid=@placementid and userid=@userid", con))
                                                                                                {
                                                                                                    cmd.Parameters.AddWithValue("@placementid", placementid);
                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                    {
                                                                                                        if (dr.Read())
                                                                                                        {
                                                                                                            ResponseMsg = "Invalid Placement - Duplicate placement!";
                                                                                                        }
                                                                                                        else
                                                                                                        {
                                                                                                            string SIDidplacetrack1 = "0";
                                                                                                            dr.Dispose();
                                                                                                            using (cmd = new SqlCommand("Insert into placement(referralid,placementid,referralname,placementname,userid,useridname,username,idplacetrack,datereg,dd,mm,yy) values (@referralid,@placementid,@referralname,@placementname,@userid,@useridname,@username,@idplacetrack,@datereg,@dd,@mm,@yy)", con))
                                                                                                            {//referralid,placementid,referralname,placementname,idplacetrack,datereg,dd,mm,yy
                                                                                                                //Generate Email Code
                                                                                                                cmd.Parameters.AddWithValue("@referralid", referralID);
                                                                                                                cmd.Parameters.AddWithValue("@placementid", placementid);
                                                                                                                cmd.Parameters.AddWithValue("@referralname", referralname);
                                                                                                                cmd.Parameters.AddWithValue("@placementname", placementname);
                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                cmd.Parameters.AddWithValue("@useridname", useridname);
                                                                                                                cmd.Parameters.AddWithValue("@username", username);
                                                                                                                cmd.Parameters.AddWithValue("@idplacetrack", SIDidplacetrack1);
                                                                                                                cmd.Parameters.AddWithValue("@datereg", DateTime.Now.ToShortDateString());
                                                                                                                cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                dr.Dispose();
                                                                                                                cmd.ExecuteNonQuery();
                                                                                                                Checker = "ID1";

                                                                                                                //Update RankIds
                                                                                                                using (cmd = new SqlCommand("Update RankIds set idplacetrack1status=@idplacetrack1statusUP where idplacetrack1status=@idplacetrack1status and userid=@userid and username=@username", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                    cmd.Parameters.AddWithValue("@username", useridname);
                                                                                                                    cmd.Parameters.AddWithValue("@idplacetrack1status", "0");
                                                                                                                    cmd.Parameters.AddWithValue("@idplacetrack1statusUP", "1");
                                                                                                                    cmd.ExecuteNonQuery();

                                                                                                                }

                                                                                                                //Add referral Commission
                                                                                                                using (cmd = new SqlCommand("Select userid from commissionsref where refid=@refid and userid=@userid", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                    cmd.Parameters.AddWithValue("@refid", referralID);
                                                                                                                    using (dr = cmd.ExecuteReader())
                                                                                                                    {
                                                                                                                        if (dr.Read())
                                                                                                                        {

                                                                                                                        }
                                                                                                                        else
                                                                                                                        {//using (cmd = new SqlCommand("Insert into CommissionsRef(userid,username,refid,datecreated,datecreateddd,datecreatedmm,datecreatedyy,status) values (@userid,@username,@refid,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@status)", con))
                                                                                                                            using (cmd = new SqlCommand("Insert into CommissionsRef(userid,username,refid,datecreated,datecreateddd,datecreatedmm,datecreatedyy,status) values (@userid,@username,@refid,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@status)", con))
                                                                                                                            {//userid,refid,datecreated,datecreateddd,datecreatedmm,datecreatedyy
                                                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                                cmd.Parameters.AddWithValue("@username", useridname);
                                                                                                                                cmd.Parameters.AddWithValue("@refid", referralID);//This is the ID that gets the #1000
                                                                                                                                cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                                                cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                                                cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                                                cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                                                cmd.Parameters.AddWithValue("@status", 0);
                                                                                                                                dr.Dispose();
                                                                                                                                cmd.ExecuteNonQuery();

                                                                                                                            }
                                                                                                                        }
                                                                                                                    }
                                                                                                                }

                                                                                                                //Update Wallet
                                                                                                                using (cmd = new SqlCommand("Update wallet set amount=@amount where userid=@userid and email=@email", con))
                                                                                                                {
                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                    cmd.Parameters.AddWithValue("@email", username);
                                                                                                                    cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                    dr.Dispose();
                                                                                                                    cmd.ExecuteNonQuery();

                                                                                                                }

                                                                                                                //Wallet Tracker
                                                                                                                using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                                {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                    cmd.Parameters.AddWithValue("@email", username);
                                                                                                                    cmd.Parameters.AddWithValue("@addamount", amount);
                                                                                                                    cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                    cmd.Parameters.AddWithValue("@previoustotal", PreviousAmount);
                                                                                                                    cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                    cmd.Parameters.AddWithValue("@purpose", "9000' spent for purchase of new account.");
                                                                                                                    cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                    cmd.ExecuteNonQuery();

                                                                                                                    ResponseMsg = "Success!";
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                ResponseMsg = "Maximum placement reached.";
                                                                                            }
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            dr.Dispose();
                                                                                            using (cmd = new SqlCommand("Select userid from placement where userid=@userid", con))
                                                                                            {
                                                                                                cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                using (dr = cmd.ExecuteReader())
                                                                                                    if (dr.Read())
                                                                                                    {
                                                                                                        ResponseMsg = "Invalid Operation, you cannot place an account twice.";
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        dr.Dispose();
                                                                                                        using (cmd = new SqlCommand("Select userid from placement where placementid=@placementid and userid=@userid", con))
                                                                                                        {
                                                                                                            cmd.Parameters.AddWithValue("@placementid", placementid);
                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                            using (dr = cmd.ExecuteReader())
                                                                                                            {
                                                                                                                if (dr.Read())
                                                                                                                {
                                                                                                                    ResponseMsg = "Invalid Placement - Duplicate placement!";
                                                                                                                }
                                                                                                                else
                                                                                                                {
                                                                                                                    string SIDidplacetrack1 = "0";
                                                                                                                    using (cmd = new SqlCommand("Insert into placement(referralid,placementid,referralname,placementname,userid,useridname,username,idplacetrack,datereg,dd,mm,yy) values (@referralid,@placementid,@referralname,@placementname,@userid,@useridname,@username,@idplacetrack,@datereg,@dd,@mm,@yy)", con))
                                                                                                                    {//referralid,placementid,referralname,placementname,idplacetrack,datereg,dd,mm,yy
                                                                                                                        //Generate Email Code
                                                                                                                        cmd.Parameters.AddWithValue("@referralid", referralID);
                                                                                                                        cmd.Parameters.AddWithValue("@placementid", placementid);
                                                                                                                        cmd.Parameters.AddWithValue("@referralname", referralname);
                                                                                                                        cmd.Parameters.AddWithValue("@placementname", placementname);
                                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                        cmd.Parameters.AddWithValue("@useridname", useridname);
                                                                                                                        cmd.Parameters.AddWithValue("@username", username);
                                                                                                                        cmd.Parameters.AddWithValue("@idplacetrack", SIDidplacetrack1);
                                                                                                                        cmd.Parameters.AddWithValue("@datereg", DateTime.Now.ToShortDateString());
                                                                                                                        cmd.Parameters.AddWithValue("@dd", DateTime.Now.Day);
                                                                                                                        cmd.Parameters.AddWithValue("@mm", DateTime.Now.Month);
                                                                                                                        cmd.Parameters.AddWithValue("@yy", DateTime.Now.Year);
                                                                                                                        dr.Dispose();
                                                                                                                        cmd.ExecuteNonQuery();
                                                                                                                        Checker = "ID1";

                                                                                                                        //Update RankIds
                                                                                                                        using (cmd = new SqlCommand("Update RankIds set idplacetrack1status=@idplacetrack1statusUP where idplacetrack1status=@idplacetrack1status and userid=@userid and username=@username", con))
                                                                                                                        {
                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                            cmd.Parameters.AddWithValue("@username", useridname);
                                                                                                                            cmd.Parameters.AddWithValue("@idplacetrack1status", "0");
                                                                                                                            cmd.Parameters.AddWithValue("@idplacetrack1statusUP", "1");
                                                                                                                            cmd.ExecuteNonQuery();

                                                                                                                        }

                                                                                                                        //Add referral Commission
                                                                                                                        using (cmd = new SqlCommand("Select userid from commissionsref where refid=@refid and userid=@userid", con))
                                                                                                                        {
                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                            cmd.Parameters.AddWithValue("@refid", referralID);
                                                                                                                            using (dr = cmd.ExecuteReader())
                                                                                                                            {
                                                                                                                                if (dr.Read())
                                                                                                                                {

                                                                                                                                }
                                                                                                                                else
                                                                                                                                {
                                                                                                                                    using (cmd = new SqlCommand("Insert into CommissionsRef(userid,username,refid,datecreated,datecreateddd,datecreatedmm,datecreatedyy,status) values (@userid,@username,@refid,@datecreated,@datecreateddd,@datecreatedmm,@datecreatedyy,@status)", con))
                                                                                                                                    {//userid,refid,datecreated,datecreateddd,datecreatedmm,datecreatedyy
                                                                                                                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                                        cmd.Parameters.AddWithValue("@username", useridname);
                                                                                                                                        cmd.Parameters.AddWithValue("@refid", referralID);
                                                                                                                                        cmd.Parameters.AddWithValue("@datecreated", DateTime.Now.ToShortDateString());
                                                                                                                                        cmd.Parameters.AddWithValue("@datecreateddd", DateTime.Now.Day);
                                                                                                                                        cmd.Parameters.AddWithValue("@datecreatedmm", DateTime.Now.Month);
                                                                                                                                        cmd.Parameters.AddWithValue("@datecreatedyy", DateTime.Now.Year);
                                                                                                                                        cmd.Parameters.AddWithValue("@status", 0);
                                                                                                                                        dr.Dispose();
                                                                                                                                        cmd.ExecuteNonQuery();

                                                                                                                                    }
                                                                                                                                }
                                                                                                                            }
                                                                                                                        }

                                                                                                                        //Update Wallet
                                                                                                                        using (cmd = new SqlCommand("Update wallet set amount=@amount where userid=@userid and email=@email", con))
                                                                                                                        {
                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                            cmd.Parameters.AddWithValue("@email", username);
                                                                                                                            cmd.Parameters.AddWithValue("@amount", newAmount);
                                                                                                                            dr.Dispose();
                                                                                                                            cmd.ExecuteNonQuery();

                                                                                                                        }

                                                                                                                        //Wallet Tracker
                                                                                                                        using (cmd = new SqlCommand("Insert into wallettrace(email,addamount,deductamount,previoustotal,currenttotal,purpose,date,userid) values (@email,@addamount,@deductamount,@previoustotal,@currenttotal,@purpose,@date,@userid)", con))
                                                                                                                        {//email,addamount,deductamount,previoustotal,currenttotal,purpose,date
                                                                                                                            cmd.Parameters.AddWithValue("@email", email);
                                                                                                                            cmd.Parameters.AddWithValue("@addamount", amount);
                                                                                                                            cmd.Parameters.AddWithValue("@deductamount", 0);
                                                                                                                            cmd.Parameters.AddWithValue("@previoustotal", amount);
                                                                                                                            cmd.Parameters.AddWithValue("@currenttotal", newAmount);
                                                                                                                            cmd.Parameters.AddWithValue("@purpose", "'" + amount + "' spent for purchase of new account.");
                                                                                                                            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString());
                                                                                                                            cmd.Parameters.AddWithValue("@userid", UserId);
                                                                                                                            cmd.ExecuteNonQuery();
                                                                                                                            ResponseMsg = "Success!";
                                                                                                                        }


                                                                                                                    }
                                                                                                                }

                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    ResponseMsg = "One or both of the IDs you are entering is Invalid.";
                                                                }
                                                            }
                                                            else
                                                            {
                                                                ResponseMsg = "Insufficient Wallet balance.";
                                                            }
                                                        }
                                                        else
                                                        {
                                                            ResponseMsg = "Cannot read information for this wallet. Kindly fund your wallet.";
                                                        }
                                                    }
                                                }
                                //            }
                                //            else
                                //            {
                                //                ResponseMsg = "You have not confirmed your email. Go to Profile -> Confirm email before making a placement.";
                                //            }
                                //        }
                                //    }
                                //}
                            }
                            else
                            {
                                ResponseMsg = "This Placement ID has not been placed.";
                            }
                        }
                    }

                }
            }
            catch (Exception)
            {
                
            }
        }

        //21
        public void ResendCode()
        {
            try
            {
                int yourRandomStringLengthP = 8; //maximum: 32 
                emailConfCODE = Guid.NewGuid().ToString("N").Substring(0, yourRandomStringLengthP);
                using (con = new SqlConnection(conn))
                {
                    con.Open();
                    using (cmd = new SqlCommand("Select codestatus from register where email=@email and userid=@userid", con))
                    {
                        cmd.Parameters.AddWithValue("@userid", UserId);
                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                        using (dr = cmd.ExecuteReader())
                        {
                            if (dr.Read() && !dr.IsDBNull(0))
                            {
                                string getCode = dr.GetValue(0).ToString();
                                if (getCode == "1")
                                {
                                    ResponseMsg = "Email has been previously confirmed!";
                                }
                                else if (getCode == "0")
                                {
                                    dr.Dispose();
                                    using (cmd = new SqlCommand("Update register set code=@code where email=@email and codestatus=@codestatus and userid=@userid", con))
                                    {
                                        cmd.Parameters.AddWithValue("@userid", UserId);
                                        cmd.Parameters.AddWithValue("@code", emailConfCODE);
                                        cmd.Parameters.AddWithValue("@codestatus", "0");
                                        cmd.Parameters.AddWithValue("@email", SessionEmail);
                                        cmd.ExecuteNonQuery();

                                        //Send Email - COnfigure the email properly
                                        //create the mail message
                                        //MailMessage mail = new MailMessage();
                                        ////set the FROM address
                                        //mail.From = new MailAddress("info@winninglifeinternational.com");
                                        ////set the RECIPIENTS
                                        //mail.To.Add(SessionEmail);
                                        ////enter a SUBJECT
                                        //mail.Subject = "Your Email Confirmation Code from WinningLife";
                                        ////Enter the message BODY
                                        //mail.Body = "From WinningLife:" + " Your Email Confirmation Code is - " + emailConfCODE + ". - WinningLife International Team";
                                        ////set the mail server (default should be smtp.1and1.com)
                                        //SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                        ////Enter your full e-mail address and password
                                        //smtp.Credentials = new NetworkCredential("info@360healthwealth.com", "{fRA.8SJekqx");
                                        ////send the message 
                                        //smtp.Send(mail);


                                        ResponseMsg = "Code Sent!";
                                    }
                                }
                            }
                            else if (dr.IsDBNull(0))
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update register set code=@code,codestatus=@codestatus where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@code", emailConfCODE);
                                    cmd.Parameters.AddWithValue("@codestatus", "0");
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    cmd.ExecuteNonQuery();

                                    //Send Email
                                    //create the mail message
                                    MailMessage mail = new MailMessage();
                                    //set the FROM address
                                    mail.From = new MailAddress("no-reply@WinningLife.com");
                                    //set the RECIPIENTS
                                    mail.To.Add(SessionEmail);
                                    //enter a SUBJECT
                                    mail.Subject = "Your Email Confirmation Code from WinningLife";
                                    //Enter the message BODY
                                    mail.Body = "From WinningLife:" + " Your Email Confirmation Code is - " + emailConfCODE + ". - WinningLife Team";
                                    //set the mail server (default should be smtp.1and1.com)
                                    SmtpClient smtp = new SmtpClient("smtp.winninglifeinternational.com");
                                    //Enter your full e-mail address and password
                                    smtp.Credentials = new NetworkCredential("info@winninglifeinternational.com", "{fRA.8SJekqx!");
                                    //send the message 
                                    smtp.Send(mail);


                                    ResponseMsg = "Code Sent!";
                                }
                            }
                            else
                            {
                                dr.Dispose();
                                using (cmd = new SqlCommand("Update register set code=@code,codestatus=@codestatus where email=@email and userid=@userid", con))
                                {
                                    cmd.Parameters.AddWithValue("@userid", UserId);
                                    cmd.Parameters.AddWithValue("@code", emailConfCODE);
                                    cmd.Parameters.AddWithValue("@codestatus", "0");
                                    cmd.Parameters.AddWithValue("@email", SessionEmail);
                                    cmd.ExecuteNonQuery();

                                    //Send Email
                                    //create the mail message
                                    MailMessage mail = new MailMessage();
                                    //set the FROM address
                                    mail.From = new MailAddress("no-reply@WinningLife.com");
                                    //set the RECIPIENTS
                                    mail.To.Add(SessionEmail);
                                    //enter a SUBJECT
                                    mail.Subject = "Your Email Confirmation Code from WinningLife";
                                    //Enter the message BODY
                                    mail.Body = "From WinningLife:" + " Your Email Confirmation Code is - " + emailConfCODE + ". - CM Team";
                                    //set the mail server (default should be smtp.1and1.com)
                                    SmtpClient smtp = new SmtpClient("smtp.1and1.com");
                                    //Enter your full e-mail address and password
                                    smtp.Credentials = new NetworkCredential("no-reply@globalhelppartners.com", "AdamawaJalingo2017!");
                                    //send the message 
                                    smtp.Send(mail);


                                    ResponseMsg = "Code Sent!";
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                
            }
        }




        // stop here
    }
}